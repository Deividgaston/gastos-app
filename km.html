<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gastos 2N — KM</title>
  <style>
    :root{--bg:#0b0d12;--card:#121521;--ink:#e7ebf3;--muted:#8b92a7;--blue:#0a84ff;--line:#1e2230}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:-apple-system,system-ui,Segoe UI,Roboto}
    .top{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(11,13,18,.75);backdrop-filter:saturate(180%) blur(16px);z-index:10}
    .top h1{margin:0;font-size:17px;font-weight:600}
    .wrap{max-width:720px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    input,textarea{background:#0f1320;border:1px solid var(--line);border-radius:10px;padding:9px;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--ink);border-radius:12px;padding:9px 12px;cursor:pointer}
    .btn.primary{background:var(--blue);border:none}
    .muted{color:var(--muted);font-size:12px}
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#0f1320}
  </style>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header class="top">
    <button class="btn" onclick="history.back()">← Volver</button>
    <h1>Gastos de KM</h1>
    <span id="who" style="margin-left:auto" class="muted">…</span>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <div class="field"><label>Fecha</label><input id="date" type="date"></div>
        <div class="field"><label>Destino</label><input id="dest" placeholder="Cliente, ciudad…"></div>
        <div class="field"><label>Km empresa</label><input id="kmBusiness" type="number" min="0" step="0.1"></div>
        <div class="field"><label>Km personales</label><input id="kmPersonal" type="number" min="0" step="0.1"></div>
        <div class="field"><label>€/L gasolina</label><input id="pricePerL" type="number" min="0" step="0.001"></div>
        <div class="field"><label>Km totales del coche (odómetro)</label><input id="carOdometer" type="number" min="0" step="1"></div>
        <div class="field" style="grid-column:1/3"><label>Foto ticket (opcional)</label><input id="photo" type="file" accept="image/*"></div>
      </div>
      <div class="row" style="grid-template-columns:auto auto;justify-content:flex-end;margin-top:8px">
        <button id="save" class="btn primary">Guardar</button>
      </div>
      <p class="muted">Se guardará en <code>users/&lt;uid&gt;/km</code> y la foto en <code>km/&lt;uid&gt;/YYYY-MM/…</code>.</p>
    </section>

    <section class="card">
      <h3 style="margin:4px 0 8px">Resumen mensual</h3>
      <div class="list" id="list"></div>
      <div class="muted" id="tot"></div>
    </section>
  </main>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const firebaseConfig={
    apiKey:"AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain:"gastos-2n.firebaseapp.com",
    projectId:"gastos-2n",
    storageBucket:"gastos-2n.firebasestorage.app",
    messagingSenderId:"55010048795",
    appId:"1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(); const db=firebase.firestore(); const st=firebase.storage();

  auth.onAuthStateChanged(u=>{$('who').textContent=u?(u.email||u.uid):'No autenticado';});

  $('date').value = new Date().toISOString().slice(0,10);

  $('save').onclick=async()=>{
    try{
      const u=auth.currentUser; if(!u) return alert('Haz login');
      const date=$('date').value||new Date().toISOString().slice(0,10);
      const dest=$('dest').value.trim();
      const kmBusiness=Number($('kmBusiness').value||0);
      const kmPersonal=Number($('kmPersonal').value||0);
      const pricePerL=Number($('pricePerL').value||0);
      const carOdometer=Number($('carOdometer').value||0);
      let photoURL="", path="";
      const yyyyMM=date.slice(0,7);
      const file=$('photo').files[0];
      if(file){
        path=`km/${u.uid}/${yyyyMM}/${date}_${Date.now()}_${file.name.replace(/[^a-z0-9_.-]/gi,'_')}`;
        await st.ref(path).put(file);
        photoURL=await st.ref(path).getDownloadURL();
      }
      await db.collection(`users/${u.uid}/km`).add({
        date:new Date(date), dest, kmBusiness, kmPersonal, pricePerL, carOdometer, photoURL, photoPath:path,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('KM guardado ✅'); loadMonth();
    }catch(e){ alert(e.message||e); }
  };

  function monthRange(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
  async function loadMonth(){
    const u=auth.currentUser; if(!u) return;
    const ym=new Date().toISOString().slice(0,7);
    const [s,e]=monthRange(ym);
    const snap=await db.collection(`users/${u.uid}/km`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
    const host=$('list'); host.innerHTML='';
    let totEmp=0, totPer=0, mediaL=0, cnt=0, carMax=0, costePer=0;
    for(const d of snap.docs){
      const k=d.data();
      const dt=k.date?.toDate?k.date.toDate():new Date(k.date);
      const cost = Number(k.kmPersonal||0)*Number(k.pricePerL||0);
      totEmp+=Number(k.kmBusiness||0); totPer+=Number(k.kmPersonal||0);
      if(k.pricePerL){ mediaL += Number(k.pricePerL); cnt++; }
      carMax=Math.max(carMax, Number(k.carOdometer||0)); costePer += cost;
      const div=document.createElement('div'); div.className='item';
      div.innerHTML = `<div><strong>${dt.toLocaleDateString('es-ES')}</strong> · ${k.dest||'—'}<br>
      <span class="muted">Emp ${k.kmBusiness||0} km · Pers ${k.kmPersonal||0} km · €/L ${k.pricePerL||0} · Odo ${k.carOdometer||0}</span></div>
      <div style="text-align:right">${cost.toFixed(2)} €</div>`;
      host.appendChild(div);
    }
    const avg= cnt? (mediaL/cnt):0;
    $('tot').textContent = `Empresa: ${totEmp} km · Personales: ${totPer} km · €/L medio: ${avg.toFixed(3)} · Km totales coche (máx): ${carMax} · Coste personal mes: ${costePer.toFixed(2)} €`;
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    auth.onAuthStateChanged(u=>{ if(u) loadMonth(); });
  });
})();
</script>
</body>
</html>
