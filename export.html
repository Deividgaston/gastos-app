<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gastos 2N — Exportar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { background:#0b0c0f; color:#eaeaea; }
    .card { background: linear-gradient(180deg,#121317, #0b0c0f); border:1px solid rgba(255,255,255,0.07); }
    .btn { transition: transform .06s ease; }
    .btn:active { transform: scale(.98); }
  </style>
</head>
<body class="min-h-screen text-white">
  <div class="mx-auto max-w-xl p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="btnBack" class="btn px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs">← Volver</button>
        <h1 class="text-xl md:text-2xl font-semibold">Exportar</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLogin" class="btn px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-xs hidden">Entrar Google</button>
        <button id="btnLogout" class="btn px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs hidden">Salir</button>
      </div>
    </header>
    <p id="whoami" class="text-xs text-white/60">…</p>

    <section class="card rounded-2xl p-4 space-y-4">
      <div class="grid grid-cols-2 gap-3">
        <div class="col-span-2">
          <label class="block text-xs text-white/70">Mes</label>
          <input id="fMes" type="month" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="col-span-2 flex gap-2">
          <button id="btnCSV" class="btn flex-1 bg-emerald-500 hover:bg-emerald-600 rounded-xl py-2 font-semibold">Descargar CSV</button>
          <button id="btnZIP" class="btn flex-1 bg-white/10 hover:bg-white/20 rounded-xl py-2 font-semibold">Descargar fotos (ZIP)</button>
        </div>
      </div>
      <div id="status" class="text-xs text-white/60"></div>
    </section>

    <section class="card rounded-2xl p-4">
      <h3 class="font-semibold mb-2">Registros del mes</h3>
      <div id="lista" class="space-y-2"></div>
    </section>

    <section>
      <pre id="out" class="text-[11px] text-white/60 whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref, listAll, getBlob
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app");

    const $ = (id)=>document.getElementById(id);
    const log = (o)=>{ try{$("out").textContent += (typeof o==="string"?o:JSON.stringify(o,null,2)) + "\\n";}catch{} };
    const statusEl = $("status");

    $("btnBack").onclick = ()=>{ location.href = "index.html"; };

    $("btnLogin").onclick = async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) await signInWithRedirect(auth, provider);
        else await signInWithPopup(auth, provider);
      }catch(e){ log("Login error: "+(e.code||e.message)); }
    };
    $("btnLogout").onclick = async ()=>{ await signOut(auth); };

    onAuthStateChanged(auth, (user)=>{
      if (user){
        $("whoami").textContent = "Conectado como " + (user.email||user.uid);
        $("btnLogin").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        renderMes();
        cargarMes();
      } else {
        $("whoami").textContent = "No autenticado";
        $("btnLogin").classList.remove("hidden");
        $("btnLogout").classList.add("hidden");
      }
    });

    // mes por defecto
    const now = new Date(); $("fMes").value = now.toISOString().slice(0,7);
    $("fMes").addEventListener("change", ()=>{ cargarMes(); });

    let cacheMes = []; // registros del mes
    async function cargarMes(){
      const user = auth.currentUser; if (!user) return;
      const mm = $("fMes").value; // YYYY-MM
      statusEl.textContent = "Cargando…";
      cacheMes = [];
      // Simple: traemos todo y filtramos por prefijo de fecha
      const col = collection(db, `users/${user.uid}/entries`);
      const snap = await getDocs(col);
      snap.forEach(doc=>{
        const d = doc.data();
        const iso = (d.date?.toDate ? d.date.toDate() : new Date()).toISOString().slice(0,10);
        if (iso.startsWith(mm)) cacheMes.push({id:doc.id, ...d, iso});
      });
      pintarLista();
      statusEl.textContent = `Encontrados ${cacheMes.length} registros`;
    }

    function pintarLista(){
      const cont = $("lista"); cont.innerHTML = "";
      cacheMes.sort((a,b)=> (a.iso > b.iso ? -1 : 1));
      cacheMes.forEach(d=>{
        const euros = (d.amount||0).toLocaleString("es-ES",{minimumFractionDigits:2});
        const row = document.createElement("div");
        row.className = "flex items-center justify-between border border-white/10 rounded-xl p-2 bg-white/5";
        row.innerHTML = `
          <div class="min-w-0">
            <p class="text-sm font-medium text-white truncate">${d.provider||"-"} · <span class="text-white/50">${d.category}</span></p>
            <p class="text-xs text-white/50">${d.iso} ${d.notes?("· "+d.notes):""}</p>
          </div>
          <div class="ml-3 text-right">
            <p class="text-sm font-semibold ${d.isExpense?'text-red-400':'text-emerald-400'}">${d.isExpense?'-':'+'}${euros} €</p>
            ${d.photoURL? `<a href="${d.photoURL}" target="_blank" class="text-[11px] text-indigo-300 underline">ticket</a>`: ""}
          </div>
        `;
        cont.appendChild(row);
      });
    }

    // CSV
    $("btnCSV").onclick = ()=>{
      if (!cacheMes.length){ alert("No hay datos este mes"); return; }
      const HEAD = ["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
      const cats = {
        comida: "MEALS",
        transporte: "OTHER TRANSPORTS (Taxi)",
        servicios: "VARIOUS",
        ocio: "INVITATIONS",
        gasolina: "GASOLINE",
        peajes: "TOLLS & PARKINGS",
        alojamiento: "HOTEL",
        varios: "VARIOUS"
      };
      const rows = cacheMes
        .filter(x=> x.category !== "ingreso")
        .map(x=>{
          const rec = Object.fromEntries(HEAD.map(h=>[h,""]));
          rec["DATE"] = x.iso.split("-").reverse().join("/"); // DD/MM/YYYY
          rec["CLIENT / PROVIDER"] = x.provider || "";
          rec["DESCRIPTION"] = x.notes || "";
          HEAD.forEach(h=>{ if (["TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL"].includes(h)) rec[h] = "0,00"; });
          const col = cats[x.category] || "VARIOUS";
          const amt = Number(x.amount||0);
          rec[col] = amt.toFixed(2).replace(".",",");
          rec["TOTAL"] = amt.toFixed(2).replace(".",",");
          return rec;
        });
      if (!rows.length){ alert("No hay gastos (solo ingresos) este mes"); return; }

      const esc = (v)=>{
        if (v==null) return "";
        const s = String(v);
        if (/[;"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        if (s === "CLIENT / PROVIDER") return '"CLIENT / PROVIDER"';
        return s;
      };
      const csv = [HEAD.map(esc).join(";")].concat(
        rows.map(r => HEAD.map(h=>esc(r[h])).join(";"))
      ).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const mm = $("fMes").value;
      saveAs(blob, `Informe_Gastos_${mm}.csv`);
    };

    // ZIP fotos
    $("btnZIP").onclick = async ()=>{
      try{
        const user = auth.currentUser; if (!user){ alert("Login requerido"); return; }
        const mm = $("fMes").value; // YYYY-MM
        const dir = ref(storage, `tickets/${user.uid}/${mm}`);
        statusEl.textContent = "Listando fotos…";
        const all = await listAll(dir);
        if (!all.items.length){ alert("No hay fotos para ese mes"); return; }
        const zip = new JSZip();
        let ok=0, fail=0;
        for (const item of all.items){
          try{
            const blob = await getBlob(item);
            zip.file(item.name, blob);
            ok++;
          }catch(e){
            fail++; log({fallo_zip_sdk:item.fullPath, err:e.message});
          }
        }
        statusEl.textContent = "Comprimiendo ZIP…";
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, `tickets_${mm}.zip`);
        statusEl.textContent = `ZIP listo: ${ok} ok, ${fail} fallos`;
      }catch(e){
        alert("ZIP error: " + e.message);
        log({zip_error:e.message});
      }
    };

    function renderMes(){
      // si venimos de index, no pedimos login otra vez
      const fromIndex = sessionStorage.getItem("fromIndex")==="1";
      if (fromIndex){
        sessionStorage.removeItem("fromIndex");
      }
    }
  </script>
</body>
</html>
