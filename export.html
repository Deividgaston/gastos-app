<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Exportar ¬∑ Gastos 2N</title>
  <meta name="theme-color" content="#0a84ff" />
  <style>
    :root{--bg:#f7f7fb;--card:#ffffff;--ink:#0b0b0f;--muted:#6b7280;--blue:#0a84ff;--border:#e5e7eb;--ok:#34c759;--danger:#ff3b30}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .safe{padding: max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left))}
    .topbar{position:sticky;top:0;z-index:10;background:var(--card);backdrop-filter:saturate(180%) blur(20px);
      border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
    .title{font-weight:700;font-size:18px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--ink);border-radius:14px;padding:10px 12px;font:inherit;cursor:pointer}
    .btn.primary{border:none;background:var(--blue);color:#fff;box-shadow:0 6px 16px rgba(10,132,255,.25)}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .grid{display:grid;gap:12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .list{display:grid;gap:8px}
    .item{display:flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:14px;padding:8px}
    .thumb{width:52px;height:52px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#fafafa}
    .hidden{display:none!important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="topbar safe">
    <div class="row">
      <button class="btn icon" onclick="history.back()">‚Üê Volver</button>
      <span class="title">Exportar</span>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn icon">üîê Google</button>
      <button id="btnLogout" class="btn icon hidden">Salir</button>
    </div>
  </header>

  <main class="safe" style="max-width:428px;margin:0 auto">
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label class="pill">Mes <input id="expMonth" type="month" style="border:none;margin-left:8px;outline:none"/></label>
        </div>
        <div class="row">
          <button id="btnCSV" class="btn primary icon">‚¨áÔ∏è CSV</button>
          <button id="btnPhotos" class="btn icon">üì• Descargar todas las fotos</button>
        </div>
      </div>
    </section>

    <section class="card grid">
      <b>Dashboard</b>
      <div class="row" style="justify-content:space-between">
        <div><div class="muted">Gasto total</div><div id="kTotal" style="font-weight:700;font-size:20px">‚Äî</div></div>
        <div><div class="muted">Ingresos</div><div id="kIn" style="font-weight:700;font-size:20px">‚Äî</div></div>
        <div><div class="muted">Tickets</div><div id="kCount" style="font-weight:700;font-size:20px">‚Äî</div></div>
      </div>
      <canvas id="pie" height="160"></canvas>
    </section>

    <section class="card">
      <b>Gastos del mes</b>
      <div id="list" class="list" style="margin-top:8px"></div>
      <div id="empty" class="muted">Sin datos en este mes.</div>
    </section>

    <section class="card">
      <b>Logs</b>
      <pre id="out" class="muted" style="white-space:pre-wrap;max-height:200px;overflow:auto;margin:8px 0 0 0"></pre>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $=id=>document.getElementById(id);
    const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"; };

    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

    // Auth
    const provider = new firebase.auth.GoogleAuthProvider();
    $("btnLogin").onclick = async ()=>{ try{ await auth.signInWithPopup(provider);}catch(e){alert("Login error: "+(e.message||""));}};
    $("btnLogout").onclick = async ()=>{ await auth.signOut(); };
    auth.onAuthStateChanged((u)=>{
      if(u){ $("btnLogin").classList.add("hidden"); $("btnLogout").classList.remove("hidden"); initMonth(); }
      else{ $("btnLogin").classList.remove("hidden"); $("btnLogout").classList.add("hidden"); }
    });

    function initMonth(){ if(!$("expMonth").value){ $("expMonth").value=new Date().toISOString().slice(0,7);} refresh(); }
    $("expMonth").onchange = refresh;

    function monthRange(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
    async function listEntries(ym, uid){
      const [s,e]=monthRange(ym);
      const snap=await db.collection(`users/${uid}/entries`)
        .where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    function buildCSV(entries){
      const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
      const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
      function toCSVValue(col, value){
        if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
          const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
        }
        const s=String(value||"").replace(/"/g,'""'); return `"${s}"`;
      }
      const ym=$("expMonth").value;
      const head=`,,,,,   EXPENSES REPORT,,,,,,,\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${new Date().toLocaleDateString("es-ES")}\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"})},,,,,,\n,,,,,,,,,,,,\n`;
      const h1=COLUMNS.map(h=>`"${h}"`).join(";")+"\n";
      const h2=",,PARKINGS ,,,,,TRAVELING,,,\n";
      const rows=[];
      for(const e of entries){
        if(e.category==="ingreso") continue;
        const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        rec["DATE"]=d.toLocaleDateString("es-ES");
        rec["CLIENT / PROVIDER"]=e.provider||"";
        rec["DESCRIPTION"]=e.notes||"";
        const amount=Number(e.amount||0);
        const col=MAP[e.category]||"VARIOUS"; if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
        let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0); rec["TOTAL"]=total;
        rows.push(COLUMNS.map(c=>toCSVValue(c,rec[c])).join(";"));
      }
      return head+h1+h2+rows.join("\n")+"\n";
    }

    let pie=null;
    function drawPie(stats){
      const ctx=$("pie").getContext("2d");
      const labels=Object.keys(stats.byCat);
      const data=labels.map(k=>stats.byCat[k]);
      if(pie) pie.destroy();
      pie=new Chart(ctx,{type:"doughnut",data:{labels,datasets:[{data}]},options:{plugins:{legend:{position:"bottom"}}}});
    }

    async function refresh(){
      try{
        const u=auth.currentUser; if(!u) return;
        const ym=$("expMonth").value; if(!ym) return;
        const entries=await listEntries(ym,u.uid);
        const list=$("list"); list.innerHTML="";
        $("empty").style.display = entries.length? "none":"block";

        let total=0,incomes=0,count=0;
        const byCat={};
        for(const e of entries){
          const amt=Number(e.amount||0);
          if(e.category==="ingreso") incomes+=amt; else total+=amt;
          if(e.category!=="ingreso"){ byCat[e.category]=(byCat[e.category]||0)+amt; }
          count++;
          const d=e.date?.toDate?e.date.toDate():new Date(e.date);
          const div=document.createElement("div"); div.className="item";
          const img=document.createElement("img"); img.className="thumb";
          if(e.photoURL){ img.src=e.photoURL; } else { img.style.opacity=".3"; }
          div.appendChild(img);
          const info=document.createElement("div"); info.style.flex="1";
          info.innerHTML=`<div style="font-weight:600">${e.provider||"-"} <span class="muted">¬∑ ${e.category}</span></div>
                          <div class="muted" style="font-size:12px">${d.toISOString().slice(0,10)} ¬∑ ${e.notes||""}</div>`;
          div.appendChild(info);
          const amtEl=document.createElement("div");
          amtEl.style.fontWeight="700"; amtEl.style.minWidth="82px"; amtEl.style.textAlign="right";
          amtEl.style.color = e.category==="ingreso" ? "var(--ok)" : "var(--danger)";
          amtEl.textContent = (e.category==="ingreso"?"+":"-") + (amt||0).toFixed(2) + " ‚Ç¨";
          div.appendChild(amtEl);
          list.appendChild(div);
        }
        $("kTotal").textContent = (-total).toFixed(2)+" ‚Ç¨";
        $("kIn").textContent = incomes.toFixed(2)+" ‚Ç¨";
        $("kCount").textContent = String(count);
        drawPie({byCat});
        window.__entries=entries;
      }catch(e){ console.error(e); log(e); alert("Error listando: "+(e.message||"")); }
    }

    // CSV
    $("btnCSV").onclick = ()=>{
      try{
        const entries=window.__entries||[];
        if(!entries.length) return alert("Sin datos");
        const csv=buildCSV(entries);
        const ym=$("expMonth").value; saveAs(new Blob([csv],{type:"text/csv;charset=utf-8"}), `Informe_Gastos_${ym}.csv`);
      }catch(e){ console.error(e); alert("CSV error: "+(e.message||"")); }
    };

    // Fotos (una a una, sin ZIP)
    $("btnPhotos").onclick = async ()=>{
      try{
        const u=auth.currentUser; if(!u) return alert("Haz login");
        const entries=(window.__entries||[]).filter(e=>e.photoURL||e.photoPath);
        if(!entries.length) return alert("Sin fotos");
        let i=0;
        for(const e of entries){
          try{
            let url=e.photoURL;
            if(!url && e.photoPath){ url = await firebase.storage().ref(e.photoPath).getDownloadURL(); }
            if(!url) continue;
            const a=document.createElement("a");
            a.href=url; a.download="";
            document.body.appendChild(a); a.click(); a.remove();
            i++; await new Promise(r=>setTimeout(r,300)); // evita bloqueos
          }catch(err){ log({fallo_descarga:e.photoURL||e.photoPath, err:String(err)}); }
        }
        alert(`Fotos lanzadas: ${i}`);
      }catch(e){ console.error(e); alert("Fotos error: "+(e.message||"")); }
    };

    // Init default month
    if(!$("expMonth").value){ $("expMonth").value=new Date().toISOString().slice(0,7); }
  })();
  </script>
</body>
</html>
