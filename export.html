
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Exportar ¬∑ Gastos 2N</title>
  <style>
    :root{{--bg:#f7f7fb;--card:#fff;--text:#101114;--muted:#6b7280;--blue:#0a84ff;--border:#e9e9ef;--success:#34c759;--danger:#ff3b30}}
    *{{box-sizing:border-box}} body{{margin:0;background:var(--bg);font-family:-apple-system,Inter,Segoe UI,Roboto;color:var(--text)}}
    .topbar{{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:14px 16px;background:rgba(255,255,255,.85);backdrop-filter:blur(14px);border-bottom:1px solid var(--border)}}
    .topbar a{{text-decoration:none}} .pill{{border-radius:999px;background:#eef5ff;color:#0a84ff;padding:6px 10px;font-size:12px;margin-left:auto}}
    .app{{max-width:520px;margin:0 auto;padding:14px}}
    .card{{background:#fff;border:1px solid var(--border);border-radius:20px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.04)}}
    .row{{display:flex;align-items:center;justify-content:space-between;gap:8px}}
    .grid{{display:grid;grid-template-columns:1fr 1fr;gap:10px}}
    .btn{{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600}}
    .btn.primary{{background:var(--blue);color:#fff;border:none}}
    .muted{{color:var(--muted)}}
    .list{{display:grid;gap:8px;margin-top:10px}}
    .item{{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:16px;padding:10px;background:#fff}}
    .item img{{height:44px;width:44px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}}
    canvas{{width:100%!important;height:200px!important}}
  </style>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="topbar">
    <a class="btn" href="index.html">‚Üê Volver</a>
    <strong>Exportar</strong>
    <span id="who" class="pill">No login</span>
  </header>

  <main class="app">
    <section class="card">
      <div class="grid">
        <div>
          <label class="muted">Mes</label>
          <input id="expMonth" type="month" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px"/>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button id="btnXLSX" class="btn primary">üìÑ Plantilla 2N (XLSX)</button>
          <button id="btnFotos" class="btn">üì• Descargar fotos</button>
        </div>
      </div>
      <small class="muted">La plantilla sigue el formato (cabecera + matriz) usado anteriormente.</small>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row"><strong>Dashboard</strong><small class="muted" id="sum"></small></div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row"><strong>Listado</strong><button id="refresh" class="btn">‚Üª</button></div>
      <div id="list" class="list"></div>
    </section>
  </main>

<script>
(function(){
  const config = {{apiKey:"{apiKey}",authDomain:"{authDomain}",projectId:"{projectId}",storageBucket:"{storageBucket}",messagingSenderId:"{messagingSenderId}",appId:"{appId}" }};
  firebase.initializeApp(config);
  const auth=firebase.auth(); const db=firebase.firestore(); const storage=firebase.storage();
  const $=id=>document.getElementById(id);

  const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
  const MAP={{"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"}};

  let chart;

  auth.onAuthStateChanged(user=>{
    $("who").textContent = user ? (user.email||user.uid) : "No login";
    if(user){ $("expMonth").value = new Date().toISOString().slice(0,7); loadAll(); }
  });

  function monthRange(ym){{ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }}
  async function listEntriesMonth(ym, uid){{
    const [s,e]=monthRange(ym);
    const snap=await db.collection(`users/${{uid}}/entries`).where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
    return snap.docs.map(d=>({{id:d.id, ...d.data()}}));
  }}
  async function listKmMonth(ym, uid){{
    const [s,e]=monthRange(ym);
    const snap=await db.collection(`users/${{uid}}/kms`).where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
    return snap.docs.map(d=>({{id:d.id, ...d.data()}}));
  }}

  function renderList(entries){{
    const box=$("list"); box.innerHTML="";
    for(const e of entries){{
      const d=e.date?.toDate? e.date.toDate(): new Date(e.date);
      const dateISO=d.toISOString().slice(0,10);
      const amount=Number(e.amount||0);
      const sign = e.category==='ingreso'?'+':'-';
      const color = e.category==='ingreso'?'var(--success)':'var(--danger)';
      const img = e.photoURL? `<img src="${{e.photoURL}}" alt="ticket">` : `<div style="height:44px;width:44px;border-radius:10px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center">‚Äî</div>`;
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML = `${{img}}
        <div style="flex:1">
          <div style="font-weight:600">${{e.provider||"-"}} <span class="muted">¬∑ ${{e.category}}</span></div>
          <div class="muted" style="font-size:12px">${{dateISO}} ${{e.notes?("¬∑ "+e.notes):""}}</div>
        </div>
        <div style="font-weight:700;color:${{color}}">${{sign}}${{amount.toLocaleString('es-ES',{{minimumFractionDigits:2}})}}‚Ç¨</div>`;
      box.appendChild(el);
    }}
  }}

  function renderChart(entries){{
    const byCat = {{}};
    for(const e of entries){{
      if(e.category==="ingreso") continue;
      byCat[e.category] = (byCat[e.category]||0) + Number(e.amount||0);
    }}
    const labels = Object.keys(byCat);
    const data = labels.map(k=>byCat[k]);
    if(chart) chart.destroy();
    chart = new Chart($("chart"), {{type:"bar", data:{{labels, datasets:[{{label:"Gasto por categor√≠a", data}}]}} }});
  }}

  async function buildXLSX(entries, kms, ym){{
    const rows = [];
    for(const e of entries){{
      if(e.category==="ingreso") continue;
      const col = MAP[e.category] || "VARIOUS";
      const rec = {{}};
      COLUMNS.forEach(c=>rec[c] = (["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)? "": 0));
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      rec["DATE"] = d.toLocaleDateString("es-ES");
      rec["CLIENT / PROVIDER"] = e.provider||"";
      rec["DESCRIPTION"] = e.notes||"";
      const amount = Number(e.amount||0);
      if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
      let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
      rec["TOTAL"]=total;
      rows.push(rec);
    }}
    const sheetData = [];
    const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{{month:"long",year:"numeric"}});
    const today=new Date().toLocaleDateString("es-ES");
    sheetData.push([ "", "", "", "", "", "EXPENSES REPORT" ]);
    sheetData.push([ "NOM", "", "Gaston Ortigosa", "", "", "DATE:", "", today ]);
    sheetData.push([ "PRENOM:", "David", "COST CENTER:", "7420", "", "MONTH/YEAR:", "", monthlabel ]);
    sheetData.push([]);
    sheetData.push(COLUMNS);
    sheetData.push(["", "", "PARKINGS", "", "", "", "TRAVELING"]);
    for(const r of rows){{
      sheetData.push(COLUMNS.map(c => {{
        if(c==="DATE"||c==="CLIENT / PROVIDER"||c==="DESCRIPTION") return r[c]||"";
        return Number(r[c]||0);
      }}));
    }}
    const totalKmEmpresa = kms.reduce((a,b)=>a+Number(b.km_empresa||0),0);
    const totalKmPersonal = kms.reduce((a,b)=>a+Number(b.km_personal||0),0);
    const avgPrecio = kms.length? (kms.reduce((a,b)=>a+Number(b.precio_litro||0),0)/kms.length):0;
    const eurosPersonal = totalKmPersonal * avgPrecio;
    const hojaKm = [
      ["Mes", monthlabel],
      ["Total KM empresa", totalKmEmpresa],
      ["Total KM personal", totalKmPersonal],
      ["Precio medio ‚Ç¨/L", avgPrecio],
      ["‚Ç¨ a restar por KM personales (km_personal * ‚Ç¨/L)", eurosPersonal]
    ];

    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(sheetData);
    const ws2 = XLSX.utils.aoa_to_sheet(hojaKm);
    XLSX.utils.book_append_sheet(wb, ws1, "Informe");
    XLSX.utils.book_append_sheet(wb, ws2, "KM");
    const wbout = XLSX.write(wb, {{bookType:'xlsx', type:'array'}});
    const blob = new Blob([wbout], {{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}});
    saveAs(blob, `Informe_Gastos_2N_${{ym}}.xlsx`);
  }}

  async function downloadAllPhotos(entries){{
    let count=0;
    for(const e of entries){{
      if(!e.photoURL && !e.photoPath) continue;
      try{{
        const ref = e.photoPath ? firebase.storage().ref(e.photoPath) : firebase.storage().refFromURL(e.photoURL);
        const url = await ref.getDownloadURL();
        const a=document.createElement("a"); a.href=url; a.download=""; document.body.appendChild(a); a.click(); a.remove();
        count++;
      }}catch(err){{ console.warn("Foto KO", err); }}
    }}
    alert(`Lanzadas ${{count}} descargas de fotos.`);
  }}

  async function loadAll(){{
    const user=firebase.auth().currentUser; if(!user) return;
    const ym=$("expMonth").value; if(!ym) return;
    const entries=await listEntriesMonth(ym, user.uid);
    renderList(entries);
    renderChart(entries);

    const totG = entries.filter(e=>e.category!=="ingreso").reduce((a,b)=>a+Number(b.amount||0),0);
    const totI = entries.filter(e=>e.category==="ingreso").reduce((a,b)=>a+Number(b.amount||0),0);
    $("sum").textContent = `Gastos: ‚àí${{totG.toFixed(2)}}‚Ç¨ ¬∑ Ingresos: +${{totI.toFixed(2)}}‚Ç¨ ¬∑ Tickets: ${{entries.length}}`;

    $("btnXLSX").onclick = async ()=>{{
      const kms = await listKmMonth(ym, user.uid);
      await buildXLSX(entries, kms, ym);
    }};
    $("btnFotos").onclick = ()=> downloadAllPhotos(entries);
  }}

  $("expMonth").addEventListener("change", loadAll);
  $("refresh").addEventListener("click", loadAll);
})();
</script>
</body>
</html>
