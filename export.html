
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ‚Äî Exportar</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <style>
    :root{--blue:#007aff;--border:#e5e7eb;--muted:#6b7280;--bg:#f7f7fb}
    *{box-sizing:border-box}body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:var(--bg)}
    .topbar{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff;z-index:5}
    .topbar h1{margin:0;flex:1;font-size:18px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border:none}
    .content{max-width:960px;margin:0 auto;padding:14px}
    .panel{border:1px solid var(--border);border-radius:16px;padding:12px 14px;margin-top:12px;background:#fff}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:300px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
    .field{display:flex;flex-direction:column;gap:6px}
    input,select{padding:9px 10px;border:1px solid var(--border);border-radius:10px;font:inherit}
    .hidden{display:none!important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header class="topbar">
    <h1>Exportar ‚Äî Gastos 2N</h1>
    <a class="btn" href="./index.html">‚Üê Volver</a>
    <button id="btnLogin" class="btn">üü¢ Google</button>
    <button id="btnLogout" class="btn hidden">Salir</button>
  </header>

  <main class="content">
    <div class="panel grid">
      <div class="field">
        <label>Mes y a√±o</label>
        <input id="expMonth" type="month">
      </div>
      <button id="btnCSV" class="btn">‚¨áÔ∏è Descargar CSV</button>
      <button id="btnZIP" class="btn primary">üóúÔ∏è Descargar ZIP fotos</button>
    </div>

    <div class="panel">
      <div class="muted" id="whoami">No autenticado</div>
      <pre id="out"></pre>
      <details>
        <summary>Ayuda</summary>
        <ul>
          <li>Aseg√∫rate de haber iniciado sesi√≥n con el mismo usuario que guarda los tickets.</li>
          <li>Las fotos se leen con permisos privados desde <code>tickets/&lt;uid&gt;/YYYY-MM/archivo</code>.</li>
          <li>Si aparece "permission-denied", revisa las Reglas de Storage y que sigues logueado.</li>
        </ul>
      </details>
    </div>
  </main>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; };

    // ===== Firebase modular SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
      setPersistence, browserLocalPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, getBytes
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ===== Config (tu proyecto) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app");

    await setPersistence(auth, browserLocalPersistence);

    const provider = new GoogleAuthProvider();
    $("btnLogin").onclick = async ()=>{
      try{ await signInWithPopup(auth, provider); }catch(e){ log(e); alert("Login error: "+(e.message||"")); }
    };
    $("btnLogout").onclick = async ()=>{ await signOut(auth); };

    onAuthStateChanged(auth, (user)=>{
      if(user){
        $("whoami").textContent = `Conectado como ${user.email||user.uid}`;
        $("btnLogin").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
      }else{
        $("whoami").textContent = "No autenticado";
        $("btnLogin").classList.remove("hidden");
        $("btnLogout").classList.add("hidden");
      }
    });

    // ===== Utils Export =====
    function monthRange(ym){
      const s=new Date(ym+"-01T00:00:00");
      const e=new Date(s.getFullYear(), s.getMonth()+1, 1);
      return [s,e];
    }
    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
    const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
    function toCSVValue(col, value){
      if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
        const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
      }
      const s=String(value||"").replace(/"/g,'""'); return `"${s}"`;
    }
    function buildCSV(rows, monthlabel, today){
      const head=`,,,,,   EXPENSES REPORT,,,,,,,
NOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${today}
PRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthlabel},,,,,,

`;
      const h1=COLUMNS.map(h=>`"${h}"`).join(";")+"\n";
      const h2=",,PARKINGS ,,,,,TRAVELING,,,\n";
      const data=rows.map(r=>COLUMNS.map(c=>toCSVValue(c,r[c])).join(";")).join("\n");
      return head+h1+h2+data+"\n";
    }
    function toCSVRecords(entries){
      const rows=[];
      for(const e of entries){
        if(e.category==="ingreso") continue;
        const col=MAP[e.category]||"VARIOUS";
        const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        rec["DATE"]=d.toLocaleDateString("es-ES");
        rec["CLIENT / PROVIDER"]=e.provider||"";
        rec["DESCRIPTION"]=e.notes||"";
        const amount=Number(e.amount||0);
        if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
        let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
        rec["TOTAL"]=total; rows.push(rec);
      }
      return rows;
    }

    async function listEntriesMonth(ym, uid){
      const [s,e]=monthRange(ym);
      const q=query(
        collection(db, `users/${uid}/entries`),
        where("date", ">=", s),
        where("date", "<", e),
        orderBy("date", "asc")
      );
      const snap=await getDocs(q);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    // ===== CSV =====
    $("btnCSV").addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login");
        const ym=$("expMonth").value; if(!ym) return alert("Selecciona mes");
        const entries=await listEntriesMonth(ym, user.uid);
        if(!entries.length) return alert("Sin gastos");
        const rows=toCSVRecords(entries);
        const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
        const today=new Date().toLocaleDateString("es-ES");
        const csv=buildCSV(rows, monthlabel, today);
        saveAs(new Blob([csv], {type:"text/csv;charset=utf-8"}), `Informe_Gastos_${ym}.csv`);
      }catch(e){ console.error(e); log(e); alert("CSV error: "+(e.message||"")); }
    });

    // ===== ZIP con getBytes autenticado =====
    $("expMonth").value = new Date().toISOString().slice(0,7);
    $("btnZIP").addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login");
        const ym=$("expMonth").value; if(!ym) return alert("Selecciona mes");
        const entries=await listEntriesMonth(ym, user.uid);
        const photos=entries.filter(e=>e.photoPath || e.photoURL);
        if(!photos.length) return alert("Sin fotos");

        const zip=new JSZip(); let ok=0, fail=0;
        const MAX = 12*1024*1024; // 12MB

        for(const e of photos){
          try{
            let path = e.photoPath;
            if(!path && e.photoURL){
              const u = new URL(e.photoURL);
              const i = u.pathname.indexOf('/o/');
              if(i>0){ path = decodeURIComponent(u.pathname.slice(i+3)); }
            }
            if(!path) throw new Error("Sin referencia");

            const r = sRef(storage, path);
            const bytes = await getBytes(r, MAX);
            const mime = path.toLowerCase().endsWith('.png') ? 'image/png' : 'image/jpeg';
            const blob = new Blob([bytes], {type:mime});

            const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
            const dateISO = d.toISOString().slice(0,10);
            const prov = (e.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
            const ext = (mime==='image/png')?'.png':'.jpg';
            zip.file(`${dateISO}_${prov}${ext}`, blob);
            ok++;
          }catch(err){
            fail++; log({fallo_zip_auth: e.photoURL||e.photoPath, err: err.message||String(err)});
          }
        }

        const outBlob = await zip.generateAsync({type:"blob"});
        saveAs(outBlob, `Fotos_Gastos_${ym}.zip`);
        log(`üóúÔ∏è ZIP listo: ${ok} ok, ${fail} fallos`);
      }catch(e){ console.error(e); log(e); alert("ZIP error: "+(e.message||"")); }
    });
  </script>
</body>
</html>
