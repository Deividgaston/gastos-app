<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gastos 2N ‚Äî Exportar CSV + ZIP (Auth REST)</title>
  <style>
    :root{--bg:#0b0c10;--card:#13141a;--ink:#e8e8f0;--muted:#98a2b3;--accent:#7c5cff;--border:#23242c}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:rgba(11,12,16,.75);backdrop-filter:saturate(150%) blur(6px);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;gap:8px;align-items:center}
    header h1{margin:0;font-size:16px;font-weight:600;letter-spacing:.3px}
    .content{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--border);background:#1a1b22;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input,select{background:#0f1116;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font:inherit}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:grid;gap:10px;margin-top:10px;max-height:62vh;overflow:auto}
    .item{display:flex;gap:10px;align-items:center;border:1px solid var(--border);padding:8px;border-radius:12px}
    .thumb{width:56px;height:56px;border-radius:8px;background:#0e0f14;object-fit:cover;border:1px solid #222}
    pre{white-space:pre-wrap;background:#0e0f14;border:1px dashed #2a2b36;border-radius:10px;padding:10px;max-height:220px;overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <h1>üì¶ Exportar ‚Äî Gastos 2N</h1>
    <div class="toolbar" style="margin-left:auto">
      <span id="who" class="muted">No autenticado</span>
      <button id="login" class="btn">Entrar</button>
      <button id="logout" class="btn" style="display:none">Salir</button>
    </div>
  </header>

  <main class="content">
    <div class="row">
      <section class="card">
        <div class="toolbar">
          <label>Mes: <input id="month" type="month"></label>
          <button id="load" class="btn">Cargar</button>
          <button id="csv" class="btn">‚¨áÔ∏è CSV</button>
          <button id="zip" class="btn primary">üóúÔ∏è ZIP fotos</button>
        </div>
        <div id="summary" class="muted" style="margin-top:8px">‚Äî</div>
        <div id="list" class="list"></div>
      </section>
      <aside class="card">
        <strong>Logs</strong>
        <pre id="log"></pre>
        <ul class="muted">
          <li>Se usa <code>Authorization: Bearer &lt;ID_TOKEN&gt;</code> contra el endpoint REST de Storage.</li>
          <li>Paths sin <code>%2F</code> (barras reales), p.ej. <code>tickets/&lt;uid&gt;/YYYY-MM/archivo.jpg</code></li>
          <li>Requiere sesi√≥n iniciada en este mismo dominio.</li>
        </ul>
      </aside>
    </div>
  </main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ $("log").textContent += (typeof m==="string"?m:JSON.stringify(m,null,2)) + "\\n"; };

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain: "gastos-2n.firebaseapp.com",
    projectId: "gastos-2n",
    storageBucket: "gastos-2n.firebasestorage.app",
    messagingSenderId: "55010048795",
    appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Auth UI
  const provider = new firebase.auth.GoogleAuthProvider();
  $("login").onclick = ()=> auth.signInWithPopup(provider).catch(e=>{ alert(e.message||"Error login"); log(e); });
  $("logout").onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(user=>{
    if(user){
      $("who").textContent = user.email || user.uid;
      $("login").style.display="none";
      $("logout").style.display="inline-block";
      if(!$("month").value) $("month").value=new Date().toISOString().slice(0,7);
    }else{
      $("who").textContent = "No autenticado";
      $("login").style.display="inline-block";
      $("logout").style.display="none";
    }
  });

  // Helpers
  function monthRange(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(),s.getMonth()+1,1); return [s,e]; }
  async function listEntriesMonth(ym, uid){
    const [s,e]=monthRange(ym);
    const snap=await db.collection(`users/${uid}/entries`).where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
    return snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  function renderList(entries){
    const root=$("list"); root.innerHTML="";
    for(const e of entries){
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      const li=document.createElement("div");
      li.className="item";
      const img=document.createElement("img"); img.className="thumb";
      img.src = e.photoURL || ""; // miniatura si est√° p√∫blica; si no, quedar√° vac√≠a.
      const meta=document.createElement("div");
      meta.innerHTML = `<div><strong>${(e.provider||"Ticket")}</strong> ¬∑ <span class="muted">${e.category||"varios"}</span></div>
                        <div class="muted">${d.toLocaleDateString("es-ES")} ‚Äî ${Number(e.amount||0).toFixed(2)} ‚Ç¨</div>`;
      li.appendChild(img); li.appendChild(meta);
      root.appendChild(li);
    }
  }

  function summarize(entries){
    let total=0; for(const e of entries){ if(e.category!=="ingreso") total+=Number(e.amount||0); }
    return `Gastos del mes: ${entries.length} registros ¬∑ Total ‚âà ${total.toFixed(2)} ‚Ç¨`;
  }

  // Cargar
  let cacheEntries=[];
  $("load").onclick = async ()=>{
    try{
      const user=auth.currentUser; if(!user) return alert("Inicia sesi√≥n");
      const ym=$("month").value; if(!ym) return alert("Selecciona mes");
      const entries=await listEntriesMonth(ym, user.uid);
      cacheEntries=entries;
      $("summary").textContent = summarize(entries);
      renderList(entries);
      log(`Cargados ${entries.length} registros de ${ym}`);
    }catch(e){ console.error(e); log(e); alert("Error cargando datos"); }
  };

  // CSV
  const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
  const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
  function toCSVValue(col, value){
    if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
      const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
    }
    const s=String(value||"").replace(/"/g,'""'); return `"${s}"`;
  }
  function buildCSV(entries, ym){
    const rows=[];
    for(const e of entries){
      if(e.category==="ingreso") continue;
      const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      rec["DATE"]=d.toLocaleDateString("es-ES");
      rec["CLIENT / PROVIDER"]=e.provider||"";
      rec["DESCRIPTION"]=e.notes||"";
      const col=MAP[e.category]||"VARIOUS"; const amount=Number(e.amount||0);
      if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
      let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
      rec["TOTAL"]=total; rows.push(rec);
    }
    const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
    const today=new Date().toLocaleDateString("es-ES");
    const head=`,,,,,   EXPENSES REPORT,,,,,,,\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${today}\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthlabel},,,,,,\n,,,,,,,,,,,,\n`;
    const h1=COLUMNS.map(h=>`"${h}"`).join(";")+"\n";
    const h2=",,PARKINGS ,,,,,TRAVELING,,,\n";
    const data=rows.map(r=>COLUMNS.map(c=>toCSVValue(c,r[c])).join(";")).join("\n");
    return head+h1+h2+data+"\n";
  }

  $("csv").onclick = ()=>{
    if(!cacheEntries.length) return alert("Carga primero los datos");
    const ym=$("month").value||"mes";
    const csv=buildCSV(cacheEntries, ym);
    saveAs(new Blob([csv],{type:"text/csv;charset=utf-8"}), `Informe_Gastos_${ym}.csv`);
  };

  // ===== ZIP via REST + ID token =====
  const BUCKET = "gastos-2n.firebasestorage.app";
  async function fetchBlobViaREST(path){
    // path ejemplo: tickets/<uid>/YYYY-MM/archivo.jpg  (sin %2F)
    const user=auth.currentUser;
    if(!user) throw new Error("Sin sesi√≥n");
    const idToken = await user.getIdToken(/*forceRefresh=*/false);
    const url = `https://firebasestorage.googleapis.com/v0/b/${BUCKET}/o/${encodeURIComponent(path)}?alt=media`;
    const res = await fetch(url, { headers:{ "Authorization": `Bearer ${idToken}` } });
    if(!res.ok){
      const txt=await res.text().catch(()=>res.statusText);
      throw new Error(`REST ${res.status} ${res.statusText} :: ${txt}`);
    }
    return await res.blob();
  }

  $("zip").onclick = async ()=>{
    try{
      const ym=$("month").value; if(!ym) return alert("Selecciona mes");
      if(!cacheEntries.length) return alert("Carga primero los datos");
      const photos = cacheEntries.filter(e=>e.photoPath);
      if(!photos.length) return alert("No hay fotos con path guardado");

      const zip=new JSZip(); let ok=0, fail=0;
      for(const e of photos){
        const path = e.photoPath; // ya est√° en forma tickets/<uid>/YYYY-MM/archivo
        try{
          const blob = await fetchBlobViaREST(path);
          const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
          const dateISO = d.toISOString().slice(0,10);
          const prov = (e.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          const ext = (blob.type==="image/png")?".png":".jpg";
          zip.file(`${dateISO}_${prov}${ext}`, blob);
          ok++;
        }catch(err){
          fail++; log({fallo_zip_rest:e.photoPath, err:String(err)});
        }
      }
      const outBlob = await zip.generateAsync({type:"blob"});
      saveAs(outBlob, `Fotos_Gastos_${ym}.zip`);
      log(`üóúÔ∏è ZIP: ${ok} ok, ${fail} fallos`);
    }catch(e){ console.error(e); log(e); alert("ZIP error: "+(e.message||"")); }
  };

  // Autocargar si ya hay sesi√≥n
  window.addEventListener("load", ()=>{
    if(!$("month").value) $("month").value=new Date().toISOString().slice(0,7);
  });
})();
</script>
</body>
</html>
