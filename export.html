<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Export ¬∑ Gastos 2N</title>

<link rel="stylesheet" href="assets/style.css">
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="config.js"></script>

</head>
<body>
<header class="topbar">
  <h1><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> Exportar</h1>
  <a class="badge" href="index.html">‚¨Ö Volver</a>
  <button id="btnAI" class="btn">‚öôÔ∏è IA</button>
  <div class="header-actions">
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Exportaci√≥n</h2>
      <div class="row">
        <label>Selecciona un mes</label>
        <input id="month" type="month">
        <button id="btnExcel" class="btn primary">üì• Descargar Excel 2N</button>
        <button id="btnOpenPhotos" class="btn">üìÇ Abrir todas las fotos</button>
      </div>
      <div class="small">El Excel replica tu plantilla 2N y solo totaliza lo pagado con <b>Mi dinero</b> + l√≠nea de KM personales (‚Ç¨).</div>
      <div id="currentMonthLabel" class="small" style="text-align:right;opacity:.8;margin-top:.5rem"></div>
    </div>

    <div class="card">
      <h2>Dashboard</h2>
      <div class="row">
        <div class="kpi"><b>Gastos personales del mes</b><div id="kpiGastos">0.00 ‚Ç¨</div></div>
        <div class="kpi"><b>Ingresos del mes</b><div id="kpiIngresos">0.00 ‚Ç¨</div></div>
        <div class="kpi"><b>Pagado con mi dinero</b><div id="kpiMiDinero">0.00 ‚Ç¨</div></div>
        <div class="kpi"><b>KM personales (‚Ç¨)</b><div id="kpiKm">0.00 ‚Ç¨</div></div>
      </div>
    </div>
  </div>
</main>


<script>
(function(){
  try{
    if (!firebase.apps || !firebase.apps.length) { firebase.initializeApp(window.__FBCONFIG__); }
    var auth = firebase.auth();
    if (firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    }
    if (auth.getRedirectResult) { auth.getRedirectResult().catch(()=>{}); }

    function updateUI(user){
      var who = document.getElementById('whoami');
      var btnLogin = document.getElementById('btnLogin');
      var btnLogout = document.getElementById('btnLogout');
      if(user){
        if(who) who.textContent = "Conectado como " + (user.email || user.uid);
        if(btnLogin) btnLogin.style.display = "none";
        if(btnLogout) btnLogout.style.display = "";
      }else{
        if(who) who.textContent = "No autenticado";
        if(btnLogin) btnLogin.style.display = "";
        if(btnLogout) btnLogout.style.display = "none";
      }
      try{ document.dispatchEvent(new CustomEvent('auth-changed',{detail:{user:user}})); }catch(e){}
    }
    auth.onAuthStateChanged(updateUI);

    window.__APPCTX__ = {
      auth: auth,
      db: firebase.firestore ? firebase.firestore() : null,
      storage: firebase.storage ? firebase.storage() : null
    };

    var provider = new firebase.auth.GoogleAuthProvider();
    var bL = document.getElementById('btnLogin');
    if(bL){ bL.addEventListener('click', async ()=>{
      try{ await auth.signInWithPopup(provider); }catch(err){
        if(err && (err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user')){
          await auth.signInWithRedirect(provider);
        } else { alert("Error login: "+(err.message||"")); }
      }
    });}
    var bO = document.getElementById('btnLogout');
    if(bO){ bO.addEventListener('click', ()=>auth.signOut()); }

    var bIA = document.getElementById('btnAI');
    if(bIA){ bIA.addEventListener('click', ()=>{ var m=document.getElementById('aiModal'); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }); }
    var bClose = document.getElementById('closeAI');
    if(bClose){ bClose.addEventListener('click', ()=>{ var m=document.getElementById('aiModal'); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }); }
    var bSave = document.getElementById('saveAI');
    if(bSave){ bSave.addEventListener('click', ()=>{ try{ localStorage.setItem('gkey', document.getElementById('aiKey').value.trim()); alert('Guardada ‚úÖ'); document.getElementById('closeAI').click(); }catch{} }); }
    var bClr = document.getElementById('clearAI');
    if(bClr){ bClr.addEventListener('click', ()=>{ try{ localStorage.removeItem('gkey'); document.getElementById('aiKey').value=''; alert('Borrada'); }catch{} }); }
  }catch(e){ console.error('Auth bootstrap error', e); }
})();
</script>

<script>
(function(){
  const monthInput = document.getElementById('month');
  const lab = document.getElementById('currentMonthLabel');
  monthInput.value = new Date().toISOString().slice(0,7);
  function upd(){ lab.textContent = new Date((monthInput.value||new Date().toISOString().slice(0,7))+'-01').toLocaleDateString('es-ES',{month:'long',year:'numeric'}); }
  upd();
  monthInput.addEventListener('change', ()=>{ upd(); cargar(); });

  function sumEuros(v){ return (Math.round((v||0)*100)/100).toFixed(2)+' ‚Ç¨'; }

  async function getEntries(uid, yyyyMM){
    const dbase = window.__APPCTX__ && window.__APPCTX__.db; if(!dbase) return [];
    const p = yyyyMM.split('-'); const y = parseInt(p[0],10), m = parseInt(p[1],10);
    const start = new Date(y, m-1, 1), end = new Date(y, m, 1);
    const snap = await dbase.collection('users/'+uid+'/entries').where('date','>=',start).where('date','<',end).get();
    return snap.docs.map(d=>Object.assign({id:d.id}, d.data()));
  }

  async function cargar(){
    const auth = window.__APPCTX__ && window.__APPCTX__.auth;
    const u = auth && auth.currentUser;
    const yyyyMM = monthInput.value || new Date().toISOString().slice(0,7);
    let entries = [];
    if(u) entries = await getEntries(u.uid, yyyyMM);

    let gastosMi = 0, ingresos = 0, kmEu = 0;
    for(const e of entries){
      if(e.category === 'ingreso'){ ingresos += Number(e.amount||0); continue; }
      if((e.paidWith||'') === 'personal'){ gastosMi += Number(e.amount||0); }
    }
    document.getElementById('kpiGastos').textContent = sumEuros(gastosMi);
    document.getElementById('kpiIngresos').textContent = sumEuros(ingresos);
    document.getElementById('kpiMiDinero').textContent = sumEuros(gastosMi);
    document.getElementById('kpiKm').textContent = sumEuros(kmEu);
  }
  window.cargar = cargar;
  document.addEventListener('auth-changed', ()=>cargar());
  document.addEventListener('entries-updated', ()=>cargar());
  cargar();
})();
</script>
</body>
</html>
