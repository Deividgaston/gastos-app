<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gastos 2N ‚Äî Exportar ZIP</title>
  <style>
    :root{--b:#007aff;--bd:#e5e7eb;--m:#6b7280}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:#f7f7fb}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:14px;margin-top:14px;box-shadow:0 6px 16px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--bd);background:#fff;border-radius:12px;padding:9px 14px;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--b);color:#fff;border:none}
    .muted{color:var(--m)} pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    input,select{padding:9px 10px;border:1px solid var(--bd);border-radius:10px;font:inherit}
    h1{font-size:18px;margin:0 0 8px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Firebase compat (Auth/Firestore) -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <!-- Storage MODULAR solo para getBlob autenticado -->
  <script type="module">
    import { getStorage, ref as sref, getBlob } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    window.__dlBlob = async (path) => {
      const storage = getStorage(firebase.app());
      const r = sref(storage, path);
      return await getBlob(r);
    };
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Exportar fotos del mes (ZIP)</h1>
      <div class="row">
        <button id="login" class="btn">üü¢ Entrar con Google</button>
        <button id="logout" class="btn">Salir</button>
        <span id="who" class="muted" style="margin-left:auto">No autenticado</span>
      </div>
      <div class="row" style="margin-top:10px">
        <label>Mes:</label>
        <input id="month" type="month"/>
        <button id="zip" class="btn primary">üóúÔ∏è Descargar ZIP</button>
      </div>
      <p class="muted" style="margin-top:8px">
        Esta p√°gina usa <code>getBlob()</code> del SDK de Storage para evitar CORS y tokens p√∫blicos.
      </p>
    </div>

    <div class="card">
      <strong>Logs</strong>
      <pre id="out"></pre>
    </div>
  </div>

  <script>
    // === Configura aqu√≠ tu Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    // === Inicializa compat (Auth + Firestore) ===
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ $("out").textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"; };

    // Auth
    const provider = new firebase.auth.GoogleAuthProvider();
    $("login").onclick  = async ()=>{ try{ await auth.signInWithPopup(provider);}catch(e){log(e);} };
    $("logout").onclick = async ()=>{ await auth.signOut(); };
    auth.onAuthStateChanged(u=>{
      if(u){ $("who").textContent = \`Conectado como \${u.email||u.uid}\`; }
      else { $("who").textContent = "No autenticado"; }
    });

    // Helpers
    function monthRange(ym){
      const s = new Date(ym+"-01T00:00:00");
      const e = new Date(s.getFullYear(), s.getMonth()+1, 1);
      return [s,e];
    }
    async function listEntriesMonth(ym, uid){
      const [s,e] = monthRange(ym);
      const snap = await db.collection(\`users/\${uid}/entries\`)
        .where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    function safeName(entry){
      const d = entry.date?.toDate ? entry.date.toDate() : new Date(entry.date);
      const dateISO = isNaN(d) ? new Date().toISOString().slice(0,10) : d.toISOString().slice(0,10);
      const prov = (entry.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\\s+/g,"_");
      let ext = ".jpg";
      const src = entry.photoPath||entry.photoURL||"";
      const low = src.toLowerCase();
      if(low.endsWith(".png")) ext=".png";
      else if(low.endsWith(".jpeg")) ext=".jpeg";
      else if(low.endsWith(".webp")) ext=".webp";
      else if(low.endsWith(".jpg")) ext=".jpg";
      return \`\${dateISO}_\${prov}\${ext}\`;
    }

    // Acci√≥n ZIP
    $("zip").onclick = async ()=>{
      try{
        const u = auth.currentUser; if(!u) return alert("Haz login primero");
        const ym = $("month").value; if(!ym) return alert("Selecciona un mes (YYYY-MM)");

        const entries = await listEntriesMonth(ym, u.uid);
        const withPhotos = entries.filter(e=>e.photoPath); // usamos photoPath
        if(!withPhotos.length){ return alert("No hay fotos para ese mes"); }

        const zip = new JSZip(); let ok=0, fail=0;

        for(const e of withPhotos){
          try{
            const blob = await window.__dlBlob(e.photoPath);
            zip.file(safeName(e), blob);
            ok++;
          }catch(err){
            fail++; log({ fallo_zip_getBlob: e.photoPath||e.photoURL, err: err.message||String(err) });
          }
        }

        const outBlob = await zip.generateAsync({type:"blob"});
        saveAs(outBlob, \`Fotos_Gastos_\${ym}.zip\`);
        log(\`üóúÔ∏è ZIP listo: \${ok} ok, \${fail} fallos\`);
      }catch(e){
        console.error(e); log(e); alert("Error ZIP: "+(e.message||""));
      }
    };

    // UI por defecto
    $("month").value = new Date().toISOString().slice(0,7);
    log("Listo. Inicia sesi√≥n, elige mes y pulsa ZIP.");
  </script>
</body>
</html>
