<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Export ¬∑ Gastos 2N</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="config.js"></script>

<!-- AUTH STATE BOOTSTRAP -->
<script>
(function(){
  try{
    if(!window.__FBCONFIG__) console.warn("Config faltante: __FBCONFIG__");
    if (!firebase.apps || !firebase.apps.length) { firebase.initializeApp(window.__FBCONFIG__ || window.firebaseConfig); }
    var auth = firebase.auth();
    // Persistencia local (para GH Pages)
    if (firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    }
    // Recoger resultado de redirect si lo hubo
    if (auth.getRedirectResult) { auth.getRedirectResult().catch(()=>{}); }

    function updateUI(user){
      var who = document.getElementById('whoami');
      var btnLogin = document.getElementById('btnLogin');
      var btnLogout = document.getElementById('btnLogout');
      if(user){
        if(who) who.textContent = "Conectado como " + (user.email || user.uid);
        if(btnLogin) btnLogin.style.display = "none";
        if(btnLogout) btnLogout.style.display = "";
      }else{
        if(who) who.textContent = "No autenticado";
        if(btnLogin) btnLogin.style.display = "";
        if(btnLogout) btnLogout.style.display = "none";
      }
      // Notificar a listeners opcionales de cada p√°gina
      try{ document.dispatchEvent(new CustomEvent('auth-changed',{detail:{user:user}})); }catch(e){}
    }

    auth.onAuthStateChanged(function(user){ updateUI(user); });
    // Exponer en contexto global por si otras partes lo necesitan
    window.__APPCTX__ = window.__APPCTX__ || {};
    window.__APPCTX__.auth = auth;
    window.__APPCTX__.db = firebase.firestore ? firebase.firestore() : null;
    window.__APPCTX__.storage = firebase.storage ? firebase.storage() : null;
  }catch(e){ console.error("Auth bootstrap error", e); }
})();
</script>

</head>
<body>
<header class="topbar">
  <h1 style="display:flex;gap:.5rem;align-items:center;"><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> üìÅ Exportar</h1>
  <a class="badge" href="index.html">‚Üê Volver</a>
</header>
<div class="content"><div class="small" id="currentMonthLabel" style="text-align:right;opacity:.8;margin:.3rem 0;"></div></div>
<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Exportaci√≥n</h2>
      <div class="row">
        <div class="field"><label>Selecciona un mes</label><input id="expMonth" type="month"/></div>
        <button id="btnExcel" class="btn primary">‚¨áÔ∏è Descargar Excel 2N</button>
        <button id="btnFotos" class="btn">üñºÔ∏è Abrir todas las fotos</button>
      </div>
      <div class="small">El Excel replica tu plantilla 2N y solo totaliza lo pagado con <b>Mi dinero</b> + l√≠nea de KM personales (‚Ç¨).</div>
    </div>

    <div class="card">
      <h2>Dashboard</h2>
      <div class="kpi">
        <div class="tile"><div class="small">Gastos personales del mes</div><div id="kpiGastos" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">Ingresos del mes</div><div id="kpiIngresos" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">Pagado con mi dinero</div><div id="kpiMi" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">KM personales (coste)</div><div id="kpiKm" class="v">0.00 ‚Ç¨</div></div>
      </div>
    </div>

    <div class="card">
      <h2>Plantilla 2N (vista previa)</h2>
      <div class="row" style="align-items:center">
        <button id="btnExcel2N" class="btn primary">‚¨áÔ∏è Descargar Excel 2N</button>
        <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="sheet2n" class="sheet2n">
        <div class="sheet2n-head">
          <div class="title">EXPENSES REPORT</div>
          <div class="meta">
            <div><strong>NOM:</strong> <span id="metaNom">David Gaston</span></div>
            <div><strong>PRENOM:</strong> <span id="metaPrenom"></span></div>
            <div><strong>COST CENTER:</strong> <span id="metaCC">Iberia</span></div>
            <div><strong>MONTH/YEAR:</strong> <span id="metaMonth"></span></div>
            <div><strong>DATE:</strong> <span id="metaDate"></span></div>
          </div>
          <div class="brand"><img src="assets/2n-logo-white.png" alt="2N"></div>
        </div>
        <div class="sheet2n-body">
          <table class="sheet2n-table">
            <thead>
              <tr>
                <th>DATE</th>
                <th>CLIENT / PROVIDER</th>
                <th>TOLLS &amp; PARKINGS</th>
                <th>OTHER TRANSPORTS (Taxi, Uber, etc.)</th>
                <th>TRAIN &amp; BUS</th>
                <th>FLIGHTS</th>
                <th>HOTEL</th>
                <th>INVITATIONS</th>
                <th>MEALS</th>
                <th>VARIOUS</th>
                <th>TOTAL</th>
                <th>DESCRIPTION</th>
                <th>PAID WITH</th>
              </tr>
            </thead>
            <tbody id="sheetRows"></tbody>
            <tfoot>
              <tr>
                <td colspan="10" class="r">TOTAL PERSONAL</td>
                <td id="tfPersonal" class="r">0.00</td>
                <td>‚Äî</td>
                <td>MY MONEY</td>
              </tr>
              <tr>
                <td colspan="10" class="r">KM personales (coste)</td>
                <td id="tfKm" class="r">0.00</td>
                <td>Auto-c√°lculo desde KM</td>
                <td>MY MONEY</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="small">* Totaliza √∫nicamente los gastos con <em>Mi dinero</em>. Los ingresos no cuentan como gasto.</div>
    </div>
  </div>
</main>

<script>
(function(){
  
  const $=id=>document.getElementById(id);

  /* firebaseConfig moved to config.js */
const firebaseConfig = window.__FBCONFIG__ || {
  apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
  authDomain: "gastos-2n.firebaseapp.com",
  projectId: "gastos-2n",
  storageBucket: "gastos-2n.appspot.com",
  messagingSenderId: "55010048795",
  appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
});
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const storage=firebase.storage();

  $("expMonth").value = new Date().toISOString().slice(0,7);
  document.getElementById('currentMonthLabel').textContent = new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'});
  function updateMonthLabel(){ try{ document.getElementById('currentMonthLabel').textContent = new Date(document.querySelector('input[type=month]').value+'-01').toLocaleDateString('es-ES',{month:'long',year:'numeric'});}catch{} }
  updateMonthLabel();
  auth.onAuthStateChanged(u=>{ cargar(); });

  function rangoMes(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }

  async function cargar(){
    const u=auth.currentUser;
    const ym=$("expMonth").value;
    const [s,e]=rangoMes(ym);
    let entries=[];
    try{ if(u){ const snap=await db.collection(`users/${u.uid}/entries`).where("date",">=",s).where("date","<",e).orderBy("date","asc").get(); entries = snap.docs.map(d=>({id:d.id, ...d.data()})); } }catch{}
    pintar(entries, ym, u?.uid);
  }
  $("expMonth").onchange=function(){ updateMonthLabel(); cargar(); });

  function pintar(entries, ym, uid){
    let gastos=0, ingresos=0, pagadoMio=0;
    const photos=[];

    for(const e of entries){
      const isExp = e.category!=="ingreso";
      const a=Number(e.amount||0);
      if(isExp) gastos += a; else ingresos += a;
      if(e.paidWith==="mio" && isExp) pagadoMio += a;
      if(e.photoURL) photos.push(e.photoURL);
    }

    const kmCost = Number(localStorage.getItem("km_per_cost_mes")||"0");
    $("kpiGastos").textContent = pagadoMio.toFixed(2)+" ‚Ç¨";
    $("kpiIngresos").textContent = ingresos.toFixed(2)+" ‚Ç¨";
    $("kpiMi").textContent = pagadoMio.toFixed(2)+" ‚Ç¨";
    $("kpiKm").textContent = kmCost.toFixed(2)+" ‚Ç¨";

    // Fotos
    $("btnFotos").onclick=()=>{
      if(!photos.length) return alert("Sin fotos este mes");
      photos.forEach((url,i)=> setTimeout(()=>{ window.open(url, "_blank"); }, i*200));
    });

    // Excel
    $("btnExcel").onclick=()=> descargarExcel(entries, ym, kmCost);
    const btn2 = $("btnExcel2N"); if(btn2) btn2.onclick=()=> descargarExcel(entries, ym, kmCost);

    // Render plantilla
    renderSheet(entries, ym, kmCost);
    $("btnPrint").onclick = ()=> window.print();
  }

  function xlsx_book(){ return XLSX.utils.book_new(); }

  function toTemplateSheet(entries, ym, kmCost){
    const today = new Date().toLocaleDateString("es-ES");
    const monthlabel = new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
    const head=[
      ["","","","","","EXPENSES REPORT","","","","",""],
      ["NOM","","David Gaston","","","","","","","DATE:","",today],
      ["PRENOM:","", "", "COST CENTER:","Iberia","","","MONTH/YEAR:", monthlabel,"",""],
      [""],
    ];
    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","OTHER TRANSPORTS (Taxi, Uber, etc.)","TRAIN & BUS","FLIGHTS","HOTEL","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION","PAID WITH"];
    const rows=[COLUMNS];

    let totalPersonal=0;
    for(const e of entries){
      if(e.category==="ingreso") continue;
      const date=(e.date?.toDate?e.date.toDate():new Date(e.date)).toISOString().slice(0,10);
      const rec={ "DATE":date, "CLIENT / PROVIDER": e.provider||"", "TOLLS & PARKINGS":"", "OTHER TRANSPORTS (Taxi, Uber, etc.)":"", "TRAIN & BUS":"", "FLIGHTS":"", "HOTEL":"", "INVITATIONS":"", "MEALS":"", "VARIOUS":"", "TOTAL":"", "DESCRIPTION": e.notes||"", "PAID WITH": e.paidWith==="mio"?"MY MONEY":"COMPANY" });
      const amount=Number(e.amount||0);
      const map={ comida:"MEALS", transporte:"OTHER TRANSPORTS (Taxi, Uber, etc.)", peajes:"TOLLS & PARKINGS", alojamiento:"HOTEL", varios:"VARIOUS", gasolina:"OTHER TRANSPORTS (Taxi, Uber, etc.)", servicios:"VARIOUS", ocio:"INVITATIONS" };
      const col = map[e.category] || "VARIOUS";
      rec[col] = amount;
      rec.TOTAL = amount;
      if(e.paidWith==="mio") totalPersonal += amount;
      rows.push(COLUMNS.map(k=> rec[k]));
    }
    rows.push(["", "KM personales (coste)", "", "", "", "", "", "", "", "", kmCost, "Auto-c√°lculo desde KM", "MY MONEY"]);
    rows.push(["", "TOTAL PERSONAL", "", "", "", "", "", "", "", "", totalPersonal, "", "MY MONEY"]);

    const ws = XLSX.utils.aoa_to_sheet([...head, ...rows]);
    ws["!cols"] = [12,24,14,20,14,12,12,12,10,12,10,28,12].map(w=>({wch:w}));
    return ws;
  }

  function descargarExcel(entries, ym, kmCost){
    const wb=xlsx_book();
    const ws=toTemplateSheet(entries, ym, kmCost);
    XLSX.utils.book_append_sheet(wb, ws, "EXPENSES");
    const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
    const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    saveAs(blob, `Informe_Gastos_2N_${ym}.xlsx`);
  }

  // === Render en la vista previa (tabla)
  function renderSheet(entries, ym, kmCost){
    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","OTHER TRANSPORTS (Taxi, Uber, etc.)","TRAIN & BUS","FLIGHTS","HOTEL","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION","PAID WITH"];
    const map={ comida:"MEALS", transporte:"OTHER TRANSPORTS (Taxi, Uber, etc.)", peajes:"TOLLS & PARKINGS", alojamiento:"HOTEL", varios:"VARIOUS", gasolina:"OTHER TRANSPORTS (Taxi, Uber, etc.)", servicios:"VARIOUS", ocio:"INVITATIONS" };
    const tbody=document.getElementById("sheetRows"); tbody.innerHTML="";
    let totalPersonal=0;
    for(const e of entries){
      if(e.category==="ingreso") continue;
      const date=(e.date?.toDate?e.date.toDate():new Date(e.date)).toISOString().slice(0,10);
      const rec = Object.fromEntries(COLUMNS.map(k=>[k,""]));
      rec["DATE"] = date;
      rec["CLIENT / PROVIDER"] = e.provider || "";
      const col = map[e.category] || "VARIOUS";
      const amount = Number(e.amount||0);
      rec[col] = amount.toFixed(2);
      rec["TOTAL"] = amount.toFixed(2);
      rec["DESCRIPTION"] = e.notes || "";
      rec["PAID WITH"] = e.paidWith==="mio" ? "MY MONEY" : "COMPANY";
      if(e.paidWith==="mio") totalPersonal += amount;
      const tr=document.createElement("tr");
      for(const k of COLUMNS){
        const td=document.createElement("td");
        td.textContent = rec[k];
        if(["TOLLS & PARKINGS","OTHER TRANSPORTS (Taxi, Uber, etc.)","TRAIN & BUS","FLIGHTS","HOTEL","INVITATIONS","MEALS","VARIOUS","TOTAL"].includes(k)) td.classList.add("r");
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    document.getElementById("tfPersonal").textContent = totalPersonal.toFixed(2);
    document.getElementById("tfKm").textContent = Number(kmCost||0).toFixed(2);
    // Metadatos
    document.getElementById("metaDate").textContent = new Date().toLocaleDateString("es-ES");
    document.getElementById("metaMonth").textContent = new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
  }
})();
</script>

<!-- BOOTSTRAP -->
<script>
(function(){
  // Small helper
  function $(id){ return document.getElementById(id); }

  // Ensure Firebase config exists
  try {
    if(!window.__FBCONFIG__) console.warn("Config: window.__FBCONFIG__ no definido (revisa config.js)");
    window.firebaseConfig = window.__FBCONFIG__ || window.firebaseConfig;
  } catch(e){ console.error("Config error", e); }

  // Initialize Firebase once
  try{
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(window.firebaseConfig);
    }
  }catch(e){
    console.error("Firebase init error:", e);
  }

  // Bind safe listeners
  function onClick(id, fn){
    var el = $(id);
    if(!el){ console.warn("No existe el bot√≥n", id); return; }
    el.addEventListener('click', fn, false);
  }

  // Auth/providers used across pages
  var auth = (firebase.auth ? firebase.auth() : null);
  var db   = (firebase.firestore ? firebase.firestore() : null);
  var storage = (firebase.storage ? firebase.storage() : null);
  window.__APPCTX__ = {auth:auth, db:db, storage:storage};

  // IA modal
  onClick('btnAI', function(){ var m=$('aiModal'); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } });
  onClick('closeAI', function(){ var m=$('aiModal'); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } });
  onClick('saveAI', function(){ try{ var v=$('aiKey').value.trim(); localStorage.setItem('gkey', v); alert('Guardada ‚úÖ'); var m=$('aiModal'); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }catch{} });
  onClick('clearAI', function(){ try{ localStorage.removeItem('gkey'); if($('aiKey')) $('aiKey').value=''; alert('Borrada'); }catch{} });

  // Login
  if(auth){
    var provider = new firebase.auth.GoogleAuthProvider();
    onClick('btnLogin', async function(){
      try{ await auth.signInWithPopup(provider); }
      catch(err){
        if(err && (err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user')){
          await auth.signInWithRedirect(provider);
        } else {
          alert("Error login: "+(err && err.message || ""));
          console.error(err);
        }
      }
    });
    onClick('btnLogout', function(){ auth.signOut(); });
  }

  // Review modal basic open (manual)
  onClick('manualBtn', function(){
    try{
      if($('revDate')) $('revDate').value = new Date().toISOString().slice(0,10);
      if($('revThumb')) $('revThumb').src = "";
      if($('revFileInfo')) $('revFileInfo').textContent = "";
      var m=$('reviewModal'); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
    }catch(e){ console.error(e); }
  });

  // Scanner (always opens file chooser)
  onClick('scanBtn', function(){
    try{
      var inp = document.createElement('input');
      inp.type='file'; inp.accept='image/*'; inp.capture='environment';
      inp.onchange = async function(){
        var f = inp.files && inp.files[0]; if(!f) return;
        try{
          // quick preview without downscale to minimize issues
          if($('revThumb')) $('revThumb').src = URL.createObjectURL(f);
          if($('revFileInfo')) $('revFileInfo').textContent = (f.name||'ticket')+" ¬∑ "+Math.round((f.size||0)/1024)+" KB";
          if($('revDate')) $('revDate').value = new Date().toISOString().slice(0,10);
          // store file globally for later save
          window.__lastPickedFile = f;
          var m=$('reviewModal'); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
        }catch(e){ alert('No se pudo abrir la imagen'); console.error(e); }
      };
      inp.click();
    }catch(e){ console.error(e); }
  });

  console.log("Bootstrap listo ‚úÖ");
})();
</script>

</body>
</html>
