<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gastos 2N ‚Äî Exportar</title>
  <style>
    :root{--bg:#0b0d12;--card:#121521;--ink:#e7ebf3;--muted:#8b92a7;--blue:#0a84ff;--line:#1e2230}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:-apple-system,system-ui,Segoe UI,Roboto}
    .top{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(11,13,18,.75);backdrop-filter:saturate(180%) blur(16px);z-index:10}
    .top h1{margin:0;font-size:17px;font-weight:600;letter-spacing:.2px}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--ink);border-radius:12px;padding:9px 12px;cursor:pointer}
    .btn.primary{background:var(--blue);border:none}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted);font-size:12px}
    input[type=month]{background:#0f1320;border:1px solid var(--line);border-radius:10px;padding:8px;color:var(--ink)}
    .muted{color:var(--muted)}
    canvas{max-width:100%}
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    .item{display:flex;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:12px;background:#0f1320}
    .thumb{width:54px;height:54px;border-radius:10px;object-fit:cover;background:#0b0d12;border:1px solid var(--line)}
    pre{white-space:pre-wrap;background:#0f1320;border:1px dashed #2a3046;border-radius:12px;padding:10px;color:#a9b1c9;max-height:140px;overflow:auto}
    a{color:var(--ink)}
  </style>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header class="top">
    <button class="btn" onclick="history.back()">‚Üê Volver</button>
    <h1>Exportar</h1>
    <span id="who" class="muted" style="margin-left:auto">‚Ä¶</span>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <div>
          <label>Mes</label><br>
          <input id="ym" type="month">
        </div>
        <button id="btnXLSX" class="btn primary">üìÑ Plantilla 2N (XLSX)</button>
        <button id="btnPhotos" class="btn">üñºÔ∏è Fotos (m√∫ltiples)</button>
      </div>
      <p class="muted">Descarga de fotos como m√∫ltiples archivos (sin ZIP). El Excel incluye hoja <b>GASTOS</b> y <b>KM</b> y celda con <b>Km totales coche</b>.</p>
    </section>

    <section class="card">
      <h3 style="margin:4px 0 8px">Dashboard</h3>
      <canvas id="donut"></canvas>
    </section>

    <section class="card">
      <h3 style="margin:4px 0 8px">Listado del mes</h3>
      <div id="list" class="list"></div>
    </section>

    <section class="card">
      <h3 style="margin:4px 0 8px">Logs</h3>
      <pre id="log"></pre>
      <ul class="muted" style="margin:0">
        <li>Si ves ‚Äúno permission‚Äù revisa que est√©s logueado y las reglas de Storage permitan <code>get</code> del propio UID.</li>
      </ul>
    </section>
  </main>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const log=m=>{$('log').textContent += (typeof m==='string'?m:JSON.stringify(m,null,2))+'\\n';};

  // Firebase
  const firebaseConfig={
    apiKey:"AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain:"gastos-2n.firebaseapp.com",
    projectId:"gastos-2n",
    storageBucket:"gastos-2n.firebasestorage.app",
    messagingSenderId:"55010048795",
    appId:"1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const st=firebase.storage();

  auth.onAuthStateChanged(u=>{
    $('who').textContent = u? (u.email||u.uid) : 'No autenticado';
  });

  function monthRange(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
  async function listEntries(ym, uid){
    const [s,e]=monthRange(ym);
    const q=await db.collection(`users/${uid}/entries`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
    return q.docs.map(d=>({id:d.id, ...d.data()}));
  }
  async function listKm(ym, uid){
    const [s,e]=monthRange(ym);
    const q=await db.collection(`users/${uid}/km`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
    return q.docs.map(d=>({id:d.id, ...d.data()}));
  }

  const CATS=['comida','gasolina','peajes','alojamiento','transporte','ocio','servicios','varios'];
  const CAT_LABEL={comida:'Comida',gasolina:'Gasolina',peajes:'Peajes',alojamiento:'Hotel',transporte:'Transportes',ocio:'Invitaciones',servicios:'Servicios',varios:'Varios'};

  function renderList(entries){
    const host=$('list'); host.innerHTML='';
    for(const e of entries){
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`<img class="thumb" src="${e.photoURL||''}" alt="">
        <div style="flex:1">
          <div style="font-weight:600">${e.provider||'‚Äî'} ¬∑ ${ (Number(e.amount||0)).toFixed(2)} ‚Ç¨</div>
          <div class="muted" style="font-size:12px">${d.toLocaleDateString('es-ES')} ¬∑ ${CAT_LABEL[e.category]||'Varios'}</div>
        </div>`;
      host.appendChild(el);
    }
  }

  function renderDonut(entries){
    const byCat={}; CATS.forEach(c=>byCat[c]=0);
    for(const e of entries){ if(e.category==='ingreso') continue; byCat[e.category||'varios'] += Number(e.amount||0); }
    const data=Object.values(byCat); const labels=CATS.map(c=>CAT_LABEL[c]);
    const ctx=$('donut').getContext('2d');
    if(window.__chart){window.__chart.destroy();}
    window.__chart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data}]},options:{plugins:{legend:{labels:{color:'#cdd3e4'}}}}});
  }

  // Descargar fotos (m√∫ltiples)
  $('btnPhotos').onclick=async()=>{
    try{
      const u=auth.currentUser; if(!u) return alert('Haz login');
      const ym=$('ym').value; if(!ym) return alert('Selecciona mes');
      const entries=await listEntries(ym,u.uid);
      const photos=entries.filter(e=>e.photoPath||e.photoURL);
      if(!photos.length) return alert('No hay fotos en este mes');
      let ok=0, fail=0;
      for(const e of photos){
        try{
          const ref = e.photoPath ? st.ref(e.photoPath) : st.refFromURL(e.photoURL);
          const url= await ref.getDownloadURL();
          const a=document.createElement('a'); a.href=url; a.download='';
          document.body.appendChild(a); a.click(); a.remove();
          ok++;
        }catch(err){ fail++; log({fallo_foto:e.photoPath||e.photoURL, err:err.message}); }
      }
      log(`üì∏ Descargas: ${ok} ok, ${fail} fallos`);
    }catch(e){ alert(e.message||e); }
  };

  // XLSX plantilla
  $('btnXLSX').onclick=async()=>{
    try{
      if(typeof XLSX==='undefined') throw new Error('XLSX no est√° cargado');
      const u=auth.currentUser; if(!u) return alert('Haz login');
      const ym=$('ym').value; if(!ym) return alert('Selecciona mes');

      const [entries, kms]= await Promise.all([listEntries(ym,u.uid), listKm(ym,u.uid)]);

      // Hoja GASTOS (formato 2N simplificado)
      const rows=[["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"]];
      const map={peajes:2,alojamiento:3,gasolina:4,transporte:5,ocio:6,comida:7,varios:8};
      for(const e of entries){
        if(e.category==='ingreso') continue;
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        const r=Array(rows[0].length).fill(0);
        r[0]= d.toLocaleDateString('es-ES');
        r[1]= e.provider||"";
        r[10]= e.notes||"";
        const idx= map[e.category||'varios'] ?? 8;
        const n= Number(e.amount||0);
        r[idx]= n;
        r[9]= n;
        rows.push(r);
      }
      const wsG = XLSX.utils.aoa_to_sheet(rows);

      // Hoja KM
      const kmHead=[["Fecha","Destino","Km empresa","Km personales","‚Ç¨/L","Km totales coche","Coste personal (Km pers √ó ‚Ç¨/L)"]];
      let carTotal=0;
      const kmRows=[...kmHead];
      for(const k of kms){
        const d=k.date?.toDate?k.date.toDate():new Date(k.date);
        carTotal = Math.max(carTotal, Number(k.carOdometer||0)); // od√≥metro mayor visto
        const cost = Number(k.kmPersonal||0) * Number(k.pricePerL||0);
        kmRows.push([ d.toLocaleDateString('es-ES'), k.dest||"", Number(k.kmBusiness||0), Number(k.kmPersonal||0), Number(k.pricePerL||0), Number(k.carOdometer||0), Number(cost.toFixed(2)) ]);
      }
      const wsK = XLSX.utils.aoa_to_sheet(kmRows);
      XLSX.utils.sheet_add_aoa(wsK, [["","", "", "", "", "Km totales coche (m√°x):", carTotal]], {origin:-1});

      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsG, "GASTOS");
      XLSX.utils.book_append_sheet(wb, wsK, "KM");
      const fname = `Informe_Gastos_${ym}.xlsx`;
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([wbout], {type:'application/octet-stream'}), fname);
    }catch(e){ console.error(e); alert(e.message||e); }
  };

  // cargar por defecto y pintar widgets
  window.addEventListener('DOMContentLoaded', async ()=>{
    $('ym').value = new Date().toISOString().slice(0,7);
    auth.onAuthStateChanged(async (u)=>{
      if(!u) return;
      const ym=$('ym').value;
      const entries=await listEntries(ym,u.uid);
      renderList(entries);
      renderDonut(entries);
    });
    $('ym').addEventListener('change', async ()=>{
      const u=auth.currentUser; if(!u) return;
      const entries=await listEntries($('ym').value,u.uid);
      renderList(entries);
      renderDonut(entries);
    });
  });
})();
</script>
</body>
</html>
