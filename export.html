<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Export ¬∑ Gastos 2N</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
<header class="topbar">
  <h1>üìÅ Exportar</h1>
  <a class="badge" href="index.html">‚Üê Volver</a>
</header>
<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Mes</h2>
      <div class="row">
        <div class="field"><label>Selecciona un mes</label><input id="expMonth" type="month"/></div>
        <button id="btnExcel" class="btn primary">‚¨áÔ∏è Descargar Excel 2N</button>
        <button id="btnFotos" class="btn">üñºÔ∏è Abrir todas las fotos</button>
      </div>
      <div class="small">El Excel replica tu plantilla 2N: nombre fijo "David Gaston", PRENOM vac√≠o, Cost Center "Iberia".</div>
    </div>

    <div class="card">
      <h2>Dashboard</h2>
      <div class="kpi">
        <div class="tile"><div class="small">Gastos del mes</div><div id="kpiGastos" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">Ingresos del mes</div><div id="kpiIngresos" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">Pagado con mi dinero</div><div id="kpiMi" class="v">0.00 ‚Ç¨</div></div>
        <div class="tile"><div class="small">Coste KM personales</div><div id="kpiKm" class="v">0.00 ‚Ç¨</div></div>
      </div>
    </div>

    <div class="card">
      <h2>Gastos</h2>
      <div id="lista" class="list"></div>
    </div>

    <div class="card">
      <h2>Logs</h2>
      <div id="out" class="logs mono"></div>
    </div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const log=(m)=>{ const out=$("out"); out.textContent+=(typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; };

  const firebaseConfig = {
    apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain: "gastos-2n.firebaseapp.com",
    projectId: "gastos-2n",
    storageBucket: "gastos-2n.firebasestorage.app",
    messagingSenderId: "55010048795",
    appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const storage=firebase.storage();

  $("expMonth").value = new Date().toISOString().slice(0,7);
  auth.onAuthStateChanged(u=>{ if(!u) location.href="index.html"; else cargar(); });

  function rangoMes(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }

  async function cargar(){
    const u=auth.currentUser; if(!u) return;
    const ym=$("expMonth").value;
    const [s,e]=rangoMes(ym);
    const snap=await db.collection(`users/${u.uid}/entries`).where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
    const entries=snap.docs.map(d=>({id:d.id, ...d.data()}));
    pintar(entries, ym, u.uid);
  }

  $("expMonth").onchange=cargar;

  function pintar(entries, ym, uid){
    const lista=$("lista"); lista.innerHTML="";
    let gastos=0, ingresos=0, pagadoMio=0;
    const photos=[];

    for(const e of entries){
      const dt=e.date?.toDate?e.date.toDate():new Date(e.date);
      const isExp = e.category!=="ingreso";
      if(isExp) gastos += Number(e.amount||0); else ingresos += Number(e.amount||0);
      if(e.paidWith==="mio" && isExp) pagadoMio += Number(e.amount||0);
      if(e.photoURL) photos.append?photos.append(e.photoURL):photos.push(e.photoURL);

      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`<div class="left">
        <div class="t">${e.provider||"-"} ¬∑ <span class="small">${e.category}</span> ${e.paidWith==="mio"?'<span class="badge">üí≥ Mi dinero</span>':''}</div>
        <div class="s">${dt.toISOString().slice(0,10)} ${e.notes?('¬∑ '+e.notes):''}</div>
      </div>
      <div class="right"><strong style="color:${isExp?'#ff6b6b':'#34c759'}">${isExp?'-':'+'}${Number(e.amount||0).toFixed(2)} ‚Ç¨</strong> ${e.photoURL?`<a class="badge" target="_blank" href="${e.photoURL}">ticket</a>`:''}</div>`;
      lista.appendChild(item);
    }

    const kmCost = Number(localStorage.getItem("km_per_cost_mes")||"0");
    $("kpiGastos").textContent = gastos.toFixed(2)+" ‚Ç¨";
    $("kpiIngresos").textContent = ingresos.toFixed(2)+" ‚Ç¨";
    $("kpiMi").textContent = pagadoMio.toFixed(2)+" ‚Ç¨";
    $("kpiKm").textContent = kmCost.toFixed(2)+" ‚Ç¨";

    $("btnFotos").onclick=()=>{
      if(!photos.length) return alert("Sin fotos este mes");
      photos.forEach((url,i)=> setTimeout(()=>{ window.open(url, "_blank"); }, i*200));
      log("Abriendo "+photos.length+" fotos en pesta√±as (puede bloquear el navegador).");
    };

    $("btnExcel").onclick=()=> descargarExcel(entries, ym, kmCost);
  }

  function xlsx_book(){ return XLSX.utils.book_new(); }

  function toTemplateSheet(entries, ym, kmCost){
    const today = new Date().toLocaleDateString("es-ES");
    const monthlabel = new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
    const head=[
      ["","","","","","EXPENSES REPORT","","","","",""],
      ["NOM","","David Gaston","","","","","","","DATE:","",today],
      ["PRENOM:","", "", "COST CENTER:","Iberia","","","MONTH/YEAR:", monthlabel,"",""],
      [""],
    ];

    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION","PAID WITH"];
    const rows=[COLUMNS];

    let totalMes=0;
    for(const e of entries){
      if(e.category==="ingreso") continue;
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      const rec = {
        DATE: d.toLocaleDateString("es-ES"),
        "CLIENT / PROVIDER": e.provider||"",
        "TOLLS & PARKINGS": 0, HOTEL:0, GASOLINE:0, "TICKETS TRAVELING":0, "OTHER TRANSPORTS (Taxi)":0, INVITATIONS:0, MEALS:0, VARIOUS:0,
        TOTAL: 0,
        DESCRIPTION: e.notes||"",
        "PAID WITH": e.paidWith==="mio"?"MY MONEY":"COMPANY"
      };
      const amount=Number(e.amount||0);
      const map={ comida:"MEALS", transporte:"OTHER TRANSPORTS (Taxi)", servicios:"VARIOUS", ocio:"INVITATIONS", gasolina:"GASOLINE", peajes:"TOLLS & PARKINGS", alojamiento:"HOTEL", varios:"VARIOUS" };
      const col = map[e.category] || "VARIOUS";
      rec[col] = amount;
      rec.TOTAL = amount;
      totalMes += amount;
      rows.append?rows.append(COLUMNS.map(k=> rec[k])):rows.push(COLUMNS.map(k=> rec[k]));
    }

    rows.append?rows.append(["", "KM personales (coste)", "", "", "", "", "", "", "", "", kmCost, "Auto-c√°lculo desde KM", "MY MONEY"]):rows.push(["", "KM personales (coste)", "", "", "", "", "", "", "", "", kmCost, "Auto-c√°lculo desde KM", "MY MONEY"]);

    const ws = XLSX.utils.aoa_to_sheet([...head, ...rows]);
    const widths=[12,24,14,10,12,18,20,14,12,12,10,28,12].map(w=>({"wch":w}));
    ws["!cols"] = widths;
    return ws;
  }

  function descargarExcel(entries, ym, kmCost){
    const wb=xlsx_book();
    const ws=toTemplateSheet(entries, ym, kmCost);
    XLSX.utils.book_append_sheet(wb, ws, "EXPENSES");
    const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
    const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    saveAs(blob, `Informe_Gastos_2N_${ym}.xlsx`);
  }

})();
</script>
</body>
</html>