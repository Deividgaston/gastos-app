<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N Â· Export</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- XLSX con soporte de estilos (xlsx-js-style) -->
  <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>
</head>

<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N Â· Export
  </h1>
  <a class="badge" href="index.html">ğŸ  Inicio</a>
  <a class="badge" href="kms.html">ğŸš— KM</a>
  <a class="badge active" href="export.html">ğŸ“¤ Export</a>
  <a class="badge" href="summary.html">ğŸ“„ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesiÃ³n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>


<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Exportar gastos</h2>

      <div class="row" style="flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div>
          <label>Mes</label><br>
          <select id="selMonth">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>

        <div>
          <label>AÃ±o</label><br>
          <input id="selYear" type="number" style="width:120px">
        </div>

        <div style="flex:1;min-width:200px">
          <div class="small">
            Exporta los gastos del mes seleccionando la plantilla oficial 2N.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap">
        <button id="btnExportExcel" class="btn primary">ğŸ“¥ Exportar Excel (plantilla 2N)</button>
        <button id="btnExportPhotos" class="btn">ğŸ–¼ Descargar fotos</button>
        <button id="btnExportKmPersonal" class="btn">ğŸš¶ KM personales</button>
      </div>

      <div id="exportStatus" class="small" style="margin-top:10px;min-height:2em"></div>
    </div>

    <div class="card">
      <h2>Vista previa</h2>
      <div id="previewList" class="list small"></div>
    </div>
  </div>
</main>


<!-- ============================================================= -->
<!-- ======================= FIREBASE AUTH ======================== -->
<!-- ============================================================= -->

<script>
(function(){

  if (!firebase.apps.length){
    firebase.initializeApp(window.__FBCONFIG__);
  }

  const auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  function updateUser(user){
    const who = document.getElementById('whoami');
    const btnIn = document.getElementById('btnLogin');
    const btnOut = document.getElementById('btnLogout');

    if (user){
      who.textContent = "Conectado: " + (user.email || user.uid);
      btnIn.style.display = "none";
      btnOut.style.display = "";
    } else {
      who.textContent = "No autenticado";
      btnIn.style.display = "";
      btnOut.style.display = "none";
    }

    document.dispatchEvent(new CustomEvent("auth-changed",{detail:{user}}));
  }

  auth.onAuthStateChanged(updateUser);

  document.getElementById("btnLogin").onclick = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  document.getElementById("btnLogout").onclick = ()=> auth.signOut();

  window.__APPCTX__ = {
    auth,
    db: firebase.firestore(),
    storage: firebase.storage()
  };

})();
</script>


<!-- ============================================================= -->
<!-- ======================= EXPORT LOGIC ========================= -->
<!-- ============================================================= -->

<script>
(function(){

  function $(id){ return document.getElementById(id); }

  // Inicializar mes y aÃ±o automÃ¡ticamente
  (function initMonthYear(){
    const now = new Date();
    $('selMonth').value = String(now.getMonth()+1);
    $('selYear').value  = String(now.getFullYear());
  })();


  function setStatus(msg){
    $('exportStatus').textContent = msg;
  }

  function formatISO(date){
    if (!(date instanceof Date)) date = new Date(date);
    return date.toISOString().slice(0,10);
  }

  function getRange(){
    const m = parseInt($('selMonth').value,10);
    const y = parseInt($('selYear').value,10);
    return {
      m, y,
      start: new Date(Date.UTC(y,m-1,1)),
      end:   new Date(Date.UTC(y,m,1))
    };
  }


  /* ================== LECTURA DE ENTRIES ================== */

  async function getEntries(){
    const {auth,db} = window.__APPCTX__;
    const user = auth.currentUser;

    const {start,end} = getRange();
    const entries = [];

    if (user){
      const snap = await db.collection(`users/${user.uid}/entries`)
        .orderBy("date","asc")
        .get();

      snap.forEach(doc=>{
        const e = doc.data();
        const d = e.date?.toDate?.() ?? new Date(e.date);
        if (d>=start && d<end){
          e._date = d;
          entries.push(e);
        }
      });

    } else {
      const arr = JSON.parse(localStorage.getItem("entries_local")||"[]");
      arr.forEach(e=>{
        const d = new Date(e.date);
        if (d>=start && d<end){
          e._date=d;
          entries.push(e);
        }
      });
    }

    return entries;
  }


  /* ================= VISTA PREVIA ================= */

  function renderPreview(entries){
    const cont = $('previewList');
    cont.innerHTML = "";

    if (!entries.length){
      cont.innerHTML = "<div class='small'>Sin apuntes.</div>";
      return;
    }

    entries.slice(0,10).forEach(e=>{
      const line = document.createElement("div");
      line.className="small";
      line.textContent = `${formatISO(e._date)} Â· ${e.provider||"-"} Â· ${e.amount||0}â‚¬ Â· ${e.category}`;
      cont.appendChild(line);
    });
  }


  /* ================== MAPEAR CATEGORÃAS â†’ PLANTILLA ================== */

  function mapTo2N(e){
    const cat = (e.category||"").toLowerCase();
    const amt = Number(e.amount||0);

    if (cat==="ingreso") return null;

    const cols = {
      C: 0, // peajes
      D: 0, // hotel
      E: 0, // gasolina
      F: 0, // tickets
      G: 0, // taxis
      H: 0, // invitaciones
      I: 0, // comidas
      J: 0  // varios
    };

    if (cat.includes("peaje")) cols.C = amt;
    else if (cat.includes("aloj")) cols.D = amt;
    else if (cat.includes("gasol")||cat.includes("fuel")) cols.E = amt;
    else if (cat.includes("ticket")) cols.F = amt;
    else if (cat.includes("transp")||cat.includes("taxi")) cols.G = amt;
    else if (cat.includes("invit")) cols.H = amt;
    else if (cat.includes("comid")||cat.includes("meal")) cols.I = amt;
    else cols.J = amt;

    return cols;
  }


  /* ================== IMPORTANTE: CONSERVAR ESTILOS ================== */

  function setCell(ws, addr, value){
    const old = ws[addr] || {};
    ws[addr] = {
      v: old.f ? old.v : value,
      t: old.f ? old.t : (typeof value==="number"?"n":"s"),
      f: old.f,
      z: old.z,
      s: old.s
    };
  }


  /* ================== EXPORTAR EXCEL ================== */

  async function exportExcel(){
    try{
      setStatus("Cargando datosâ€¦");
      const entries = await getEntries();
      if (!entries.length){
        setStatus("No hay apuntes.");
        return;
      }

      renderPreview(entries);

      const valid = [];
      entries.forEach(e=>{
        const m = mapTo2N(e);
        if (m) valid.push({e,m});
      });

      if (!valid.length){
        setStatus("Nada que exportar (solo ingresos).");
        return;
      }

      setStatus("Cargando plantillaâ€¦");
      const tpl = await fetch("assets/plantilla-2n.xlsx");
      if (!tpl.ok) throw new Error("No se encuentra plantilla-2n.xlsx");
      const ab = await tpl.arrayBuffer();

      const wb = XLSX.read(ab,{type:"array"});
      const ws = wb.Sheets["NDF"] || wb.Sheets[wb.SheetNames[0]];

      // Datos personales
      setCell(ws,"B2","Gaston");
      setCell(ws,"B3","David");
      setCell(ws,"D3","iberia team");

      // Fila 7 es el inicio oficial
      let row = 7;

      valid.forEach(({e,m})=>{
        setCell(ws,`A${row}`,formatISO(e._date));
        setCell(ws,`B${row}`,e.provider||"");

        setCell(ws,`C${row}`,m.C);
        setCell(ws,`D${row}`,m.D);
        setCell(ws,`E${row}`,m.E);
        setCell(ws,`F${row}`,m.F);
        setCell(ws,`G${row}`,m.G);
        setCell(ws,`H${row}`,m.H);
        setCell(ws,`I${row}`,m.I);
        setCell(ws,`J${row}`,m.J);

        // K es fÃ³rmula â†’ NO se toca
        setCell(ws,`L${row}`,e.notes||"");

        row++;
      });

      const {m,y} = getRange();
      const mm = String(m).padStart(2,"0");
      const filename = `gastos_2n_${y}-${mm}.xlsx`;

      XLSX.writeFile(wb,filename);

      setStatus("Excel exportado correctamente.");
      
    } catch(err){
      console.error(err);
      setStatus("Error: " + err.message);
    }
  }


  /* ================== EXPORTAR FOTOS ================== */

  async function exportPhotos(){
    setStatus("Descargando fotosâ€¦");

    const entries = await getEntries();
    const photos = entries.filter(e=> e.photoURL);

    if (!photos.length){
      setStatus("No hay fotos este mes.");
      return;
    }

    photos.forEach((e,i)=>{
      const a = document.createElement("a");
      a.href = e.photoURL;
      a.download = `${formatISO(e._date)}_${(e.provider||"ticket").replace(/\W+/g,"_")}.jpg`;
      document.body.appendChild(a);
      setTimeout(()=>{ a.click(); document.body.removeChild(a); }, i*300);
    });

    setStatus(`${photos.length} fotos descargadas.`);
  }


  /* ================== KM PERSONALES ================== */

  async function exportKmPersonal(){
    const {auth,db} = window.__APPCTX__;
    const user = auth.currentUser;

    const {start,end,m,y} = getRange();
    const kms=[];

    if (user){
      const snap = await db.collection(`users/${user.uid}/kms`).orderBy("date","asc").get();
      snap.forEach(doc=>{
        const e=doc.data();
        const d=e.date?.toDate?.() ?? new Date(e.date);
        if (d>=start&&d<end) kms.push({...e,_date:d});
      });
    }

    const personal = kms.filter(k =>
      (k.type||"").toLowerCase().includes("pers") ||
      (k.type||"").toLowerCase().includes("priv")
    );

    if (!personal.length){
      setStatus("No hay KM personales.");
      return;
    }

    const data=[
      ["DATE","KM","TYPE","FUEL PRICE","KM TOTAL","NOTES"]
    ];

    personal.forEach(k=>{
      data.push([
        formatISO(k._date),
        k.km||"",
        k.type||"",
        k.fuelPrice||"",
        k.totalKm||"",
        k.notes||""
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"KM personales");

    const mm = String(m).padStart(2,"0");
    XLSX.writeFile(wb,`kms_personales_${y}-${mm}.xlsx`);

    setStatus("KM personales exportados.");
  }


  /* ================== EVENTOS ================== */

  $('btnExportExcel').onclick = exportExcel;
  $('btnExportPhotos').onclick = exportPhotos;
  $('btnExportKmPersonal').onclick = exportKmPersonal;

  $('selMonth').onchange = ()=> getEntries().then(renderPreview);
  $('selYear').onchange  = ()=> getEntries().then(renderPreview);

  document.addEventListener("auth-changed",()=> getEntries().then(renderPreview));

})();
</script>

</body>
</html>
