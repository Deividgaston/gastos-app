<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ Export</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- XLSX con soporte de estilos (xlsx-js-style) -->
  <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>
</head>

<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N ¬∑ Export
  </h1>
  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge active" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Exportar gastos</h2>

      <div class="row" style="flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div>
          <label>Mes</label><br>
          <select id="selMonth">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>

        <div>
          <label>A√±o</label><br>
          <input id="selYear" type="number" style="width:120px">
        </div>

        <div style="flex:1;min-width:200px">
          <div class="small">
            Se exportan los apuntes del mes seleccionado usando la plantilla oficial de 2N.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap">
        <button id="btnExportExcel" class="btn primary">üì• Exportar Excel (plantilla 2N)</button>
        <button id="btnExportPhotos" class="btn">üñº Descargar fotos</button>
        <button id="btnExportKmPersonal" class="btn">üö∂ KM personales</button>
      </div>

      <div id="exportStatus" class="small" style="margin-top:10px;min-height:2em"></div>
    </div>

    <div class="card">
      <h2>Vista previa</h2>
      <div id="previewList" class="list small"></div>
    </div>
  </div>
</main>

<!-- ======================= FIREBASE AUTH ======================== -->
<script>
(function(){
  try{
    if (!firebase.apps.length){
      firebase.initializeApp(window.__FBCONFIG__);
    }

    const auth = firebase.auth();

    if (firebase.auth.Auth.Persistence){
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    }
    if (auth.getRedirectResult){
      auth.getRedirectResult().catch(()=>{});
    }

    function updateUser(user){
      const who   = document.getElementById('whoami');
      const btnIn = document.getElementById('btnLogin');
      const btnOut= document.getElementById('btnLogout');

      if (user){
        if (who)   who.textContent = 'Conectado: ' + (user.email || user.uid);
        if (btnIn) btnIn.style.display = 'none';
        if (btnOut)btnOut.style.display= '';
      } else {
        if (who)   who.textContent = 'No autenticado';
        if (btnIn) btnIn.style.display = '';
        if (btnOut)btnOut.style.display= 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{detail:{user}}));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth,
      db: firebase.firestore(),
      storage: firebase.storage()
    };

    const prov   = new firebase.auth.GoogleAuthProvider();
    const btnIn  = document.getElementById('btnLogin');
    const btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }

  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- ======================= EXPORT LOGIC ========================= -->
<script>
(function(){

  function $(id){ return document.getElementById(id); }

  // Inicializar mes y a√±o actuales
  (function initMonthYear(){
    const now = new Date();
    if ($('selMonth')) $('selMonth').value = String(now.getMonth()+1);
    if ($('selYear'))  $('selYear').value  = String(now.getFullYear());
  })();

  function setStatus(msg){
    const el = $('exportStatus');
    if (el) el.textContent = msg || '';
  }

  function formatISO(date){
    if (!(date instanceof Date)) date = new Date(date);
    return date.toISOString().slice(0,10);
  }

  function slugify(str){
    return (str || '')
      .toString()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/-+/g,'-')
      .replace(/^-|-$/g,'') || 'ticket';
  }

  function getRange(){
    const m = parseInt($('selMonth').value,10);
    const y = parseInt($('selYear').value,10);
    const start = new Date(Date.UTC(y, m-1, 1));
    const end   = new Date(Date.UTC(y, m,   1));
    return { m, y, start, end };
  }

  /* ============ LECTURA DE ENTRIES ============ */
  async function getEntries(){
    const ctx  = window.__APPCTX__ || {};
    const auth = ctx.auth;
    const db   = ctx.db;
    const user = auth && auth.currentUser;
    const {start,end} = getRange();
    const entries = [];

    if (user && db){
      const snap = await db.collection('users/' + user.uid + '/entries')
        .orderBy('date','asc')
        .get();

      snap.forEach(doc=>{
        const e = doc.data();
        const d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
        if (d >= start && d < end){
          e._date = d;
          entries.push(e);
        }
      });
    } else {
      const arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      arr.forEach(e=>{
        const d = new Date(e.date);
        if (d >= start && d < end){
          e._date = d;
          entries.push(e);
        }
      });
    }
    return entries;
  }

  function renderPreview(entries){
    const cont = $('previewList');
    if (!cont) return;
    cont.innerHTML = '';

    if (!entries.length){
      cont.innerHTML = "<div class='small'>Sin apuntes para este mes.</div>";
      return;
    }

    entries.slice(0,10).forEach(e=>{
      const d = e._date || new Date(e.date);
      const div = document.createElement('div');
      div.className = 'small';
      div.textContent =
        formatISO(d) + ' ¬∑ ' +
        (e.provider || '-') + ' ¬∑ ' +
        (e.amount || 0) + '‚Ç¨ ¬∑ ' +
        (e.category || '');
      cont.appendChild(div);
    });
  }

  /* ============ MAPEO CATEGOR√çAS ‚Üí COLUMNAS PLANTILLA ============ */
  function mapTo2N(e){
    const cat = (e.category || '').toLowerCase();
    const amt = Number(e.amount || 0);

    if (!amt) return null;
    if (cat === 'ingreso') return null;

    const cols = {
      C: 0, // Peajes
      D: 0, // Hotel
      E: 0, // Gasolina
      F: 0, // Tickets
      G: 0, // Transporte/otros
      H: 0, // Invitaciones
      I: 0, // Comidas
      J: 0  // Varios
    };

    if (cat.includes('peaje')) cols.C = amt;
    else if (cat.includes('aloj') || cat.includes('hotel')) cols.D = amt;
    else if (cat.includes('gasol') || cat.includes('fuel') || cat.includes('diesel')) cols.E = amt;
    else if (cat.includes('ticket')) cols.F = amt;
    else if (cat.includes('transp') || cat.includes('taxi') || cat.includes('uber') || cat.includes('cabify')) cols.G = amt;
    else if (cat.includes('invit')) cols.H = amt;
    else if (cat.includes('comida') || cat.includes('meal') || cat.includes('rest')) cols.I = amt;
    else cols.J = amt;

    return cols;
  }

  // üëâ NO tocamos estilos ni formatos, solo valores
  function setCell(ws, addr, value){
    let cell = ws[addr];
    if (!cell){
      cell = {};
      ws[addr] = cell;
    }
    const hadFormula = !!cell.f;

    if (!hadFormula){
      if (typeof value === 'number'){
        cell.t = 'n';
        cell.v = value;
      } else {
        cell.t = 's';
        cell.v = (value == null ? '' : value);
      }
    }
    // cell.s, cell.z y cell.f se dejan tal cual vengan de la plantilla
  }

  /* ============ EXPORTAR EXCEL ============ */
  async function exportExcel(){
    try{
      setStatus('Cargando apuntes‚Ä¶');
      const entries = await getEntries();
      if (!entries.length){
        setStatus('No hay apuntes para ese mes.');
        renderPreview([]);
        return;
      }

      renderPreview(entries);

      const valid = [];
      entries.forEach(e=>{
        const m = mapTo2N(e);
        if (m) valid.push({e,m});
      });

      if (!valid.length){
        setStatus('Solo hay ingresos o apuntes sin importe. Nada que exportar.');
        return;
      }

      setStatus('Cargando plantilla 2N‚Ä¶');

      const tplRes = await fetch('assets/plantilla-2n.xlsx');
      if (!tplRes.ok){
        throw new Error('No se puede cargar assets/plantilla-2n.xlsx (HTTP ' + tplRes.status + ')');
      }
      const ab = await tplRes.arrayBuffer();
      const wb = XLSX.read(ab,{type:'array'});
      const ws = wb.Sheets['NDF'] || wb.Sheets[wb.SheetNames[0]];

      // === Cabecera con tus datos ===
      setCell(ws,'B2','Gaston');      // NOM
      setCell(ws,'B3','David');       // PRENOM
      setCell(ws,'D3','iberia team'); // COST CENTER

      // IMPORTANTE:
      // Para que se mantenga TODO el formato de la tabla (bordes, rayas, etc.),
      // deja en la plantilla 2N las filas de datos (por ejemplo A7:L100) ya formateadas.
      // Aqu√≠ solo cambiamos el valor; los estilos vienen de la plantilla.

      let row = 7; // fila de inicio de datos en tu NDF
      valid.forEach(({e,m})=>{
        setCell(ws,`A${row}`,formatISO(e._date));   // DATE
        setCell(ws,`B${row}`,e.provider || '');     // CLIENT / PROVIDER

        setCell(ws,`C${row}`,m.C);
        setCell(ws,`D${row}`,m.D);
        setCell(ws,`E${row}`,m.E);
        setCell(ws,`F${row}`,m.F);
        setCell(ws,`G${row}`,m.G);
        setCell(ws,`H${row}`,m.H);
        setCell(ws,`I${row}`,m.I);
        setCell(ws,`J${row}`,m.J);
        // K = TOTAL ‚Üí tiene f√≥rmula en la plantilla, no tocamos valor
        setCell(ws,`L${row}`,e.notes || '');        // DESCRIPTION

        row++;
      });

      const {m,y} = getRange();
      const mm = String(m).padStart(2,'0');
      const filename = `gastos_2n_${y}-${mm}.xlsx`;

      XLSX.writeFile(wb, filename);
      setStatus('Excel generado correctamente a partir de la plantilla 2N (respetando todo el formato).');
    }catch(e){
      console.error(e);
      setStatus('Error al generar el Excel: ' + (e.message || e));
    }
  }

  /* ============ EXPORTAR FOTOS ============ */
  async function exportPhotos(){
    try{
      setStatus('Cargando apuntes‚Ä¶');
      const ctx  = window.__APPCTX__ || {};
      const st   = ctx.storage;
      const auth = ctx.auth;
      const user = auth && auth.currentUser;

      const entries = await getEntries();
      if (!entries.length){
        setStatus('No hay apuntes para ese mes.');
        renderPreview([]);
        return;
      }

      renderPreview(entries);

      const photos = [];
      for (let i=0; i<entries.length; i++){
        const e = entries[i];
        if (e.photoURL){
          photos.push({entry:e,url:e.photoURL});
        } else if (e.photoPath && st && user){
          try{
            const ref = st.ref(e.photoPath);
            const url = await ref.getDownloadURL();
            photos.push({entry:e,url});
          }catch(err){
            console.warn('No se pudo obtener URL de', e.photoPath, err);
          }
        }
      }

      if (!photos.length){
        setStatus('No hay fotos asociadas a los apuntes de este mes.');
        return;
      }

      setStatus('Descargando ' + photos.length + ' fotos‚Ä¶');

      photos.forEach((obj,idx)=>{
        const e   = obj.entry;
        const url = obj.url;
        const d   = e._date || new Date(e.date);
        const fecha = formatISO(d);
        const prov  = slugify(e.provider || 'ticket');
        const name  = `${fecha}_${prov}_${idx+1}.jpg`;

        setTimeout(()=>{
          const a = document.createElement('a');
          a.href = url;
          a.download = name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }, idx*350);
      });

    }catch(e){
      console.error(e);
      setStatus('Error al descargar las fotos: ' + (e.message || e));
    }
  }

  /* ============ KM PERSONALES ============ */
  async function getKmEntries(){
    const ctx  = window.__APPCTX__ || {};
    const auth = ctx.auth;
    const db   = ctx.db;
    const user = auth && auth.currentUser;
    const {start,end} = getRange();
    const kms = [];

    if (user && db){
      try{
        const snap = await db.collection('users/' + user.uid + '/kms')
          .orderBy('date','asc')
          .get();

        snap.forEach(doc=>{
          const e = doc.data();
          const d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          if (d >= start && d < end){
            e._date = d;
            kms.push(e);
          }
        });
      }catch(e){
        console.warn('Error leyendo kms de Firestore', e);
      }
    } else {
      const arr = JSON.parse(localStorage.getItem('kms_local') || '[]');
      arr.forEach(e=>{
        const d = new Date(e.date);
        if (d >= start && d < end){
          e._date = d;
          kms.push(e);
        }
      });
    }

    return kms;
  }

  function isPersonalKm(entry){
    const t = (entry.type || entry.kind || entry.category || '').toLowerCase();
    return t.includes('perso') || t.includes('priv') || t.includes('parti');
  }

  async function exportKmPersonal(){
    try{
      setStatus('Cargando KM del mes‚Ä¶');
      const kms = await getKmEntries();
      if (!kms.length){
        setStatus('No hay KM para este mes.');
        return;
      }

      const personales = kms.filter(isPersonalKm);
      if (!personales.length){
        setStatus('No hay KM personales este mes.');
        return;
      }

      const data = [];
      data.push(['DATE','KM','TYPE','FUEL PRICE','KM TOTAL','NOTES']);

      personales.forEach(e=>{
        data.push([
          formatISO(e._date),
          e.km || e.distance || '',
          e.type || e.kind || '',
          e.fuelPrice || '',
          e.totalKm || e.kmTotal || e.odo || '',
          e.notes || ''
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'KM personales');

      const {m,y} = getRange();
      const mm = String(m).padStart(2,'0');
      const filename = `kms_personales_${y}-${mm}.xlsx`;

      XLSX.writeFile(wb, filename);
      setStatus('KM personales exportados correctamente.');
    }catch(e){
      console.error(e);
      setStatus('Error al generar Excel de KM personales: ' + (e.message || e));
    }
  }

  /* ============ EVENTOS ============ */
  if ($('btnExportExcel'))      $('btnExportExcel').addEventListener('click', exportExcel);
  if ($('btnExportPhotos'))     $('btnExportPhotos').addEventListener('click', exportPhotos);
  if ($('btnExportKmPersonal')) $('btnExportKmPersonal').addEventListener('click', exportKmPersonal);

  if ($('selMonth')) $('selMonth').addEventListener('change', ()=>{ getEntries().then(renderPreview); });
  if ($('selYear'))  $('selYear').addEventListener('change',  ()=>{ getEntries().then(renderPreview); });

  document.addEventListener('auth-changed', ()=>{ getEntries().then(renderPreview); }, false);

  // Primera carga
  getEntries().then(renderPreview);

})();
</script>

</body>
</html>
