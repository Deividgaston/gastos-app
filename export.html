<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Exportar · iOS Dark</title>
<link rel="stylesheet" href="assets/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>

<body>
<header class="topbar">
  <button class="btn back" onclick="location.href='index.html'"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15 18l-6-6 6-6"/></svg> Volver</button>
  <h1>Exportar</h1>
  <span class="badge" id="whoami">No autenticado</span>
</header>
<main class="wrap">
  <div class="card">
    <div class="grid">
      <div><label>Mes</label><input id="expMonth" type="month"/></div>
      <div class="row">
        <button id="btnXLSX" class="btn primary">Plantilla 2N (XLSX)</button>
        <button id="btnPhotos" class="btn">Fotos (múltiples)</button>
      </div>
    </div>
    <div class="footer-note">Descarga de fotos en múltiples archivos (sin ZIP) usando enlaces temporales.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 class="section-title">Dashboard</h3>
    <canvas id="pie" height="240"></canvas>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 class="section-title">Listado</h3>
    <div id="list" class="list"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 class="section-title">KM personales (€/mes)</h3>
    <div id="kmEuro" class="row"><div class="small">Selecciona mes</div><div class="badge">0 €</div></div>
  </div>
</main>

<script>
window.APP = {"apiKey":"AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs","authDomain":"gastos-2n.firebaseapp.com","projectId":"gastos-2n","storageBucket":"gastos-2n.firebasestorage.app","messagingSenderId":"55010048795","appId":"1:55010048795:web:4fb48d1e0f9006ebf7b1be"};
firebase.initializeApp(APP);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const provider = new firebase.auth.GoogleAuthProvider();
function byId(id){return document.getElementById(id);}
function fmt€(n){return (Number(n)||0).toLocaleString('es-ES',{style:'currency',currency:'EUR'});}
function alertMsg(t){alert(t);}
auth.onAuthStateChanged(u=>{ const w=byId('whoami'); if(w) w.textContent = u? (u.email||u.uid) : 'No autenticado'; if(byId('btnLogin')){byId('btnLogin').style.display=u?'none':'inline-flex';} if(byId('btnLogout')){byId('btnLogout').style.display=u?'inline-flex':'none';} });
</script>

<script>
byId('expMonth').value = new Date().toISOString().slice(0,7);
const CATS = ['comida','gasolina','peajes','alojamiento','transporte','ocio','servicios','varios'];
const LABELS = {comida:'Comida', gasolina:'Gasolina', peajes:'Peajes', alojamiento:'Hotel', transporte:'Transportes', ocio:'Invitaciones', servicios:'Servicios', varios:'Varios'};

function monthRange(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
async function listEntriesMonth(ym, uid){
  const [s,e]=monthRange(ym);
  const snap=await db.collection(`users/${uid}/entries`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
  return snap.docs.map(d=>({id:d.id, ...d.data()}));
}
async function listKMsMonth(ym, uid){
  const [s,e]=monthRange(ym);
  const snap=await db.collection(`users/${uid}/kms`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
  return snap.docs.map(d=>({id:d.id, ...d.data()}));
}

async function refresh(){
  const u=auth.currentUser; if(!u) return;
  const ym = byId('expMonth').value;
  const entries = await listEntriesMonth(ym,u.uid);
  const list = byId('list'); list.innerHTML='';
  const totals = Object.fromEntries(CATS.map(c=>[c,0]));
  entries.forEach(x=>{
    if(x.category==='ingreso') return;
    const a=Number(x.amount||0);
    if(CATS.includes(x.category)) totals[x.category]+=a; else totals.varios+=a;
    const dt=x.date?.toDate?x.date.toDate():new Date(x.date);
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<img class='thumb' src='${x.photoURL||''}' onerror="this.style.display='none'"><div style='flex:1'><div><b>${dt.toLocaleDateString('es-ES')}</b> · ${x.provider||''}</div><div class='small'>${LABELS[x.category]||'Varios'} · ${fmt€(x.amount||0)}<div></div>`;
    list.appendChild(div);
  });
  const data = CATS.map(c=>totals[c]);
  const ctx = byId('pie').getContext('2d'); if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {type:'doughnut', data:{labels:CATS.map(c=>LABELS[c]), datasets:[{data:data}]} });
  const kms = await listKMsMonth(ym,u.uid);
  const euro = kms.reduce((s,x)=> s + (Number(x.kmPers||0)*(Number(x.price||0))), 0);
  byId('kmEuro').innerHTML = `<div class='small'>KM personales de ${ym}</div><div class='badge'>${fmt€(euro)}</div>`;
}
auth.onAuthStateChanged(()=>refresh());
byId('expMonth').addEventListener('change', refresh);

byId('btnPhotos').onclick = async ()=>{
  try{ const u=auth.currentUser; if(!u) return alertMsg('Haz login'); const ym=byId('expMonth').value; const entries=await listEntriesMonth(ym,u.uid); const photos=entries.filter(e=>e.photoURL||e.photoPath); if(!photos.length) return alertMsg('Sin fotos');
    for(const e of photos){ let url=e.photoURL; if(!url && e.photoPath) url=await storage.ref(e.photoPath).getDownloadURL(); if(!url) continue; const a=document.createElement('a'); a.href=url; a.download=''; document.body.appendChild(a); a.click(); a.remove(); await new Promise(r=>setTimeout(r,150)); }
  }catch(e){ alertMsg('Fotos error: '+e.message); }
};

byId('btnXLSX').onclick = async ()=>{
  try{ const u=auth.currentUser; if(!u) return alertMsg('Haz login'); const ym=byId('expMonth').value; const entries=await listEntriesMonth(ym,u.uid); if(!entries.length) return alertMsg('Sin gastos'); const rows=[['DATE','CLIENT / PROVIDER','TOLLS & PARKINGS','HOTEL','GASOLINE','TICKETS TRAVELING','OTHER TRANSPORTS (Taxi)','INVITATIONS','MEALS','VARIOUS','TOTAL','DESCRIPTION']];
    const map={comida:8, gasolina:4, peajes:2, alojamiento:3, transporte:6, ocio:7, servicios:9, varios:9};
    entries.forEach(e=>{ if(e.category==='ingreso') return; const r=['','','0','0','0','0','0','0','0','0','0','']; const dt=e.date?.toDate?e.date.toDate():new Date(e.date); r[0]=dt.toLocaleDateString('es-ES'); r[1]=e.provider||''; const col=map[e.category]||9; r[col]=String(Number(e.amount||0).toFixed(2)).replace('.',','); const total=[2,3,4,5,6,7,8,9].reduce((s,i)=>s+Number(r[i].replace(',','.')),0); r[10]=String(total.toFixed(2)).replace('.',','); r[11]=e.notes||''; rows.push(r); });
    const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Informe'); const out=XLSX.write(wb, {bookType:'xlsx', type:'array'}); saveAs(new Blob([out],{type:'application/octet-stream'}), `Informe_Gastos_${ym}.xlsx`);
  }catch(e){ alertMsg('XLSX error: '+e.message); }
};
</script>
</body></html>
