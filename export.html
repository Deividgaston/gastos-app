<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ Export</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- SheetJS para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>

  <style>
    /* Solo est√©tica espec√≠fica Export (mantiene funcionalidad) */

    .entry-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ‚úÖ FIX: alinear importe + borrar (sin tocar JS) */
    .entry-actions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      margin-left:8px;
      flex: 0 0 auto;
    }

    /* Bot√≥n borrar en m√≥vil: m√°s grande y f√°cil */
    .btnIconDel{
      min-height: 34px;
      padding: 6px 10px;
      border-radius: 14px;
      font-weight: 800;
    }

    .totals-wrap{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    /* Total protagonista */
    .pill-total{
      flex: 1 1 280px;
      justify-content: space-between;
    }

    #entriesList{
      max-height: 360px;
      overflow: auto;
    }

    @media (max-width: 600px){
      #entriesList{
        max-height: none;
      }
      .btnIconDel{
        min-height: 44px;
        font-size: 16px;
        padding: 10px 14px;
      }
    }
  </style>
</head>

<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:6px;">
    Gastos 2N ¬∑ Export
  </h1>

  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge active" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">

    <!-- FILTROS + TOTALES -->
    <div class="card">
      <h2>Exportar por mes</h2>

      <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div style="min-width:180px">
          <label>Mes</label><br>
          <input id="monthInput" type="month" style="min-width:170px">
        </div>

        <div class="small">
          Se exportan los gastos y KM del mes seleccionado.<br>
          Revisa y borra apuntes antes de exportar.
        </div>
      </div>

      <div class="totals-wrap">
        <div class="pill-total">
          üí∂ Total mes
          <span id="totGastos">0,00 ‚Ç¨</span>
        </div>

        <div class="pill">
          üßæ Pagado con mi dinero
          <span id="totPersonalPaid" style="font-weight:700;margin-left:4px">0,00 ‚Ç¨</span>
        </div>

        <div class="pill">
          üßç KM personales
          <span id="totKmPer" style="font-weight:700;margin-left:4px">0,0 km</span>
        </div>
      </div>
    </div>

    <!-- LISTADO -->
    <div class="card">
      <h2>Registros del mes</h2>
      <div id="entriesList" class="list"></div>
      <div id="exportStatus" class="small" style="margin-top:8px;min-height:1.5em;"></div>
    </div>

    <!-- ACCIONES -->
    <div class="card">
      <h2>Acciones de exportaci√≥n</h2>

      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnExcelGastos" class="btn primary">üìä Descargar Excel gastos (2N template)</button>
      </div>

      <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="btnExcelKmPersonal" class="btn">üöó Descargar Excel KM personales</button>
        <button id="btnFotosTickets" class="btn">üñº Descargar fotos tickets</button>
      </div>

      <div class="small" style="margin-top:10px">
        ‚Ä¢ El Excel de gastos usa <b>assets/plantilla-2n.xlsx</b> y rellena l√≠neas desde la fila 7.<br>
        ‚Ä¢ El Excel de KM personales incluye km, ‚Ç¨/L y coste calculado (km √ó ‚Ç¨/L √ó 6L/100km).<br>
        ‚Ä¢ Las fotos se descargan una a una (el navegador puede pedir confirmaci√≥n).
      </div>
    </div>

  </div>
</main>

<!-- FIREBASE + AUTH -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth   : auth,
      db     : firebase.firestore(),
      storage: firebase.storage()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA EXPORT -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  let currentEntries = [];
  let currentKms     = [];

  const PRENOM      = 'david';
  const NOM         = 'gaston';
  const COST_CENTER = 'iberia team';

  function setStatus(msg){
    const el = $('exportStatus');
    if (el) el.textContent = msg || '';
  }

  (function initMonth(){
    const m = $('monthInput');
    if (!m) return;
    const now = new Date();
    const iso = now.toISOString().slice(0,7); // YYYY-MM
    m.value = iso;
  })();

  function getMonthRange(ym){
    if (!ym) return null;
    const parts = ym.split('-');
    const y = parseInt(parts[0],10);
    const m = parseInt(parts[1],10)-1;
    const start = new Date(Date.UTC(y,m,1,0,0,0));
    const end   = new Date(Date.UTC(y,m+1,1,0,0,0));
    return { start, end };
  }

  async function loadDataForMonth(){
    const ctx  = window.__APPCTX__ || {};
    const auth = ctx.auth;
    const db   = ctx.db;
    const user = auth && auth.currentUser;

    const monthValue = $('monthInput').value;
    const range = getMonthRange(monthValue);
    if (!range){
      return { entries:[], kms:[] };
    }

    let entries = [];
    let kms     = [];

    // --- GASTOS ---
    if (user && db){
      const snap = await db.collection('users/'+user.uid+'/entries')
                           .where('date','>=', range.start)
                           .where('date','<',  range.end)
                           .orderBy('date','desc')
                           .get();
      snap.forEach(doc=>{
        const o = doc.data();
        o.id    = doc.id;
        o._src  = 'remote';
        o.dateJs = o.date && o.date.toDate ? o.date.toDate() : new Date(o.date);
        entries.push(o);
      });
    } else {
      const arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      entries = arr.map((e, idx)=>{
        e.dateJs = new Date(e.date);
        e._src   = 'local';
        e._localIndex = idx;
        return e;
      }).filter(e=> e.dateJs >= range.start && e.dateJs < range.end)
        .sort((a,b)=>b.dateJs - a.dateJs);
    }

    // --- KM ---
    if (user && db){
      const snapKm = await db.collection('users/'+user.uid+'/kms')
                             .where('date','>=', range.start)
                             .where('date','<',  range.end)
                             .orderBy('date','desc')
                             .get();
      snapKm.forEach(doc=>{
        const o = doc.data();
        o.id    = doc.id;
        o._src  = 'remote';
        o.dateJs = o.date && o.date.toDate ? o.date.toDate() : new Date(o.date);
        kms.push(o);
      });
    } else {
      const kArr = JSON.parse(localStorage.getItem('kms_local') || '[]');
      kms = kArr.map((e, idx)=>{
        e.dateJs = new Date(e.date);
        e._src   = 'local';
        e._localIndex = idx;
        return e;
      }).filter(e=> e.dateJs >= range.start && e.dateJs < range.end)
        .sort((a,b)=>b.dateJs - a.dateJs);
    }

    return { entries, kms };
  }

  function formatEuro(v){
    return (v || 0).toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function formatKm(v){
    return (v || 0).toFixed(1).replace('.',',') + ' km';
  }

  function renderTotals(entries, kms){
    let tot = 0;
    let totPersonal = 0;
    entries.forEach(e=>{
      const a = Number(e.amount || 0);
      tot += a;
      if ((e.paidWith || '').toLowerCase() === 'personal'){
        totPersonal += a;
      }
    });

    let kmPer = 0;
    kms.forEach(k=>{
      const km = Number(k.km || k.distance || 0) || 0;
      if ((k.type || '').toLowerCase().includes('per')){
        kmPer += km;
      }
    });

    $('totGastos').textContent       = formatEuro(tot);
    $('totPersonalPaid').textContent = formatEuro(totPersonal);
    $('totKmPer').textContent        = formatKm(kmPer);
  }

  function renderEntriesList(entries){
    currentEntries = entries || [];
    const cont = $('entriesList');
    if (!cont) return;
    cont.innerHTML = '';

    if (!entries.length){
      cont.innerHTML = '<div class="small">Sin gastos en este mes.</div>';
      return;
    }

    entries.forEach(e=>{
      const row = document.createElement('div');
      row.className = 'entry-row';

      const d = e.dateJs instanceof Date ? e.dateJs : new Date(e.dateJs || e.date);
      const fecha = d.toISOString().slice(0,10);

      const main = document.createElement('div');
      main.className = 'entry-main';

      const l1 = document.createElement('strong');
      l1.textContent = fecha + ' ¬∑ ' + (e.provider || '-');

      const meta = document.createElement('div');
      meta.className = 'entry-meta';
      const parts = [];
      if (e.category) parts.push('Cat: ' + e.category);
      if (e.paidWith) parts.push('Pago: ' + e.paidWith);
      if (e.notes) parts.push('Notas: ' + e.notes);
      meta.textContent = parts.join(' ¬∑ ');

      main.appendChild(l1);
      if (parts.length) main.appendChild(meta);

      const actions = document.createElement('div');
      actions.className = 'entry-actions';

      const amt = document.createElement('div');
      amt.className = 'entry-amount';
      amt.textContent = formatEuro(Number(e.amount || 0));

      const btnDel = document.createElement('button');
      btnDel.className = 'btn danger btnIconDel';
      btnDel.type = 'button';
      btnDel.textContent = 'üóë';
      btnDel.title = 'Eliminar';
      btnDel.addEventListener('click', function(ev){
        ev.stopPropagation();
        deleteEntry(e);
      });

      actions.appendChild(amt);
      actions.appendChild(btnDel);

      row.appendChild(main);
      row.appendChild(actions);
      cont.appendChild(row);
    });
  }

  async function deleteEntry(entry){
    if (!confirm('¬øSeguro que quieres borrar este gasto?')){
      return;
    }

    const ctx  = window.__APPCTX__ || {};
    const auth = ctx.auth;
    const db   = ctx.db;
    const user = auth && auth.currentUser;

    setStatus('Borrando apunte‚Ä¶');

    try{
      if (user && db && entry._src === 'remote' && entry.id){
        await db.collection('users/'+user.uid+'/entries').doc(entry.id).delete();
      } else {
        const arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
        if (typeof entry._localIndex === 'number'){
          if (entry._localIndex >= 0 && entry._localIndex < arr.length){
            arr.splice(entry._localIndex, 1);
          }
        } else {
          const idx = arr.findIndex(x =>
            x.date === entry.date &&
            Number(x.amount || 0) === Number(entry.amount || 0) &&
            (x.provider || '') === (entry.provider || '')
          );
          if (idx >= 0) arr.splice(idx,1);
        }
        localStorage.setItem('entries_local', JSON.stringify(arr));
      }

      setStatus('Apunte eliminado ‚úÖ');
      document.dispatchEvent(new CustomEvent('entries-updated'));
      await refreshAll();
    }catch(e){
      console.error(e);
      alert('Error al borrar el gasto: ' + (e && e.message || ''));
      setStatus('Error al borrar el gasto.');
    }
  }

  async function refreshAll(){
    setStatus('Cargando datos‚Ä¶');
    try{
      const data = await loadDataForMonth();
      currentEntries = data.entries;
      currentKms     = data.kms;
      renderTotals(data.entries, data.kms);
      renderEntriesList(data.entries);
      setStatus('');
    }catch(e){
      console.error(e);
      setStatus('Error cargando datos.');
    }
  }

  async function exportExcelGastos(){
    if (!currentEntries.length){
      alert('No hay gastos en este mes.');
      return;
    }

    try{
      setStatus('Generando Excel de gastos‚Ä¶');

      const resp = await fetch('assets/plantilla-2n.xlsx');
      if (!resp.ok){
        throw new Error('No se puede cargar "plantilla-2n.xlsx" (HTTP ' + resp.status + ')');
      }
      const data = await resp.arrayBuffer();
      const wb   = XLSX.read(data, { type:'array' });

      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      function setHeaderCell(ref, val){
        if (!ws[ref]) ws[ref] = {};
        ws[ref].v = val;
        ws[ref].t = 's';
      }

      setHeaderCell('B2', NOM);
      setHeaderCell('B3', PRENOM);
      setHeaderCell('D3', COST_CENTER);

      const startRow = 7;

      currentEntries.forEach((e, idx)=>{
        const r = startRow + idx;
        const d = e.dateJs instanceof Date ? e.dateJs : new Date(e.dateJs || e.date);
        const iso = d.toISOString().slice(0,10); // YYYY-MM-DD
        const parts = iso.split('-');
        const yyyy = parts[0], mm = parts[1], dd = parts[2];

        function setCell(col, val, typeOverride){
          const cellRef = col + String(r);
          if (!ws[cellRef]) ws[cellRef] = {};
          ws[cellRef].v = val;
          if (typeOverride){
            ws[cellRef].t = typeOverride;
          } else {
            ws[cellRef].t = (typeof val === 'number') ? 'n' : 's';
          }
        }

        const dateText = dd + '/' + mm + '/' + yyyy;
        setCell('A', dateText);

        let bVal = (e.provider || '');
        if (e.notes){
          const base = (e.provider || '').trim();
          bVal = base ? (base + ' - ' + e.notes) : e.notes;
        }
        setCell('B', bVal);

        const amount = Number(e.amount || 0);
        const cat = (e.category || '').toLowerCase();

        let colAmount = 'J';
        if (cat === 'peajes') colAmount = 'C';
        else if (cat === 'alojamiento') colAmount = 'D';
        else if (cat === 'gasolina') colAmount = 'E';
        else if (cat === 'transporte') colAmount = 'G';
        else if (cat === 'comida') colAmount = 'I';
        else colAmount = 'J';

        setCell(colAmount, amount);
        setCell('K', amount);
      });

      const month = $('monthInput').value || '';
      const filename = 'expenses-2n-' + (month || 'month') + '.xlsx'; // ENGLISH
      XLSX.writeFile(wb, filename);

      setStatus('Excel de gastos generado ‚úÖ');
    }catch(e){
      console.error(e);
      alert('Error al generar el Excel: ' + (e && e.message || ''));
      setStatus('Error al generar el Excel de gastos.');
    }
  }

  async function exportExcelKmPersonal(){
    const kmsPer = currentKms.filter(k =>
      (k.type || '').toLowerCase().includes('per')
    );
    if (!kmsPer.length){
      alert('No hay KM personales en este mes.');
      return;
    }

    try{
      setStatus('Generando Excel de KM personales‚Ä¶');

      const rows = kmsPer.map(k=>{
        const d = k.dateJs instanceof Date ? k.dateJs : new Date(k.dateJs || k.date);
        const dateISO = d.toISOString().slice(0,10);

        const km = Number(k.km || k.distance || 0) || 0;
        const fuel = (k.fuelPrice != null && k.fuelPrice !== '')
          ? Number(k.fuelPrice)
          : NaN;
        const cost = (!isNaN(fuel) && fuel > 0)
          ? km * fuel * 6 / 100
          : 0;

        return {
          Date: dateISO,
          KM: km,
          "‚Ç¨/L": (!isNaN(fuel) && fuel > 0) ? fuel : "",
          "Personal mileage cost (km√ó‚Ç¨/L√ó6/100)": cost
        };
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Personal_Mileage');

      const month = $('monthInput').value || '';
      XLSX.writeFile(wb, 'personal-mileage-' + (month || 'month') + '.xlsx'); // ENGLISH

      setStatus('Excel de KM personales generado ‚úÖ');
    }catch(e){
      console.error(e);
      alert('Error al generar el Excel de KM personales: ' + (e && e.message || ''));
      setStatus('Error al generar Excel de KM personales.');
    }
  }

  /* =================== DOWNLOAD TICKET PHOTOS (STRICT MIN FIX) =================== */
  async function exportFotosTickets(){
    const entriesWithPhoto = currentEntries.filter(e => e.photoURL);
    if (!entriesWithPhoto.length){
      alert('No hay tickets con foto en este mes.');
      return;
    }

    try{
      setStatus('Descargando fotos‚Ä¶ 0/' + entriesWithPhoto.length);

      for (let i = 0; i < entriesWithPhoto.length; i++){
        const e = entriesWithPhoto[i];
        const url = e.photoURL;
        if (!url) continue;

        const d = e.dateJs instanceof Date ? e.dateJs : new Date(e.dateJs || e.date);
        const iso = d.toISOString().slice(0,10);
        const safeProv = (e.provider || 'ticket').replace(/[^a-z0-9-_]/gi,'_').toLowerCase();
        const fname = 'ticket_' + iso + '_' + safeProv + '_' + i + '.jpg';

        const disp = 'attachment; filename="' + fname + '"';
        const sep  = url.indexOf('?') >= 0 ? '&' : '?';
        const forcedUrl = url + sep + 'response-content-disposition=' + encodeURIComponent(disp);

        const a = document.createElement('a');
        a.href = forcedUrl;
        a.download = fname;
        a.target = '_blank';                 // ‚úÖ reduce bloqueos en Chrome
        a.rel = 'noopener noreferrer';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setStatus('Descargando fotos‚Ä¶ ' + (i+1) + '/' + entriesWithPhoto.length);

        // ‚úÖ delay para evitar que Chrome lo trate como ‚Äúspam‚Äù
        await new Promise(r => setTimeout(r, 900));
      }

      setStatus('Descarga lanzada ‚úÖ (si Chrome bloquea, permite "Descargas m√∫ltiples" para este sitio).');
    }catch(e){
      console.error(e);
      alert('Error al descargar fotos: ' + (e && (e.message || e)));
      setStatus('Error al descargar fotos.');
    }
  }

  if ($('monthInput')){
    $('monthInput').addEventListener('change', refreshAll);
  }
  if ($('btnExcelGastos')){
    $('btnExcelGastos').addEventListener('click', exportExcelGastos);
  }
  if ($('btnExcelKmPersonal')){
    $('btnExcelKmPersonal').addEventListener('click', exportExcelKmPersonal);
  }
  if ($('btnFotosTickets')){
    $('btnFotosTickets').addEventListener('click', exportFotosTickets);
  }

  document.addEventListener('auth-changed', refreshAll, false);
  document.addEventListener('entries-updated', refreshAll, false);
  document.addEventListener('kms-updated', refreshAll, false);

  refreshAll();
})();
</script>

</body>
</html>
