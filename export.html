<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Exportar ¬∑ Gastos 2N</title>
  <meta name="theme-color" content="#0b0b0f">
  <style>
    :root{--bg:#0b0b0f;--card:#12121a;--card2:#161622;--muted:#a1a1b2;--text:#f5f6fb;--blue:#0a84ff;--border:#232333;--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,#0b0b0f,#0e0e14);color:var(--text)}
    .topbar{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:12px 14px;background:rgba(10,10,14,.6);backdrop-filter:saturate(160%) blur(14px);border-bottom:1px solid var(--border)}
    .btn{border:none;border-radius:14px;padding:10px 14px;background:var(--card2);color:var(--text);display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border)}
    .btn.pri{background:linear-gradient(135deg,#0a84ff,#6a5cff);border:none}
    .grid{max-width:980px;margin:0 auto;padding:14px;display:grid;gap:12px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:820px){ .cards{grid-template-columns:repeat(4,1fr)} }
    canvas{max-height:220px!important}
    .out{white-space:pre-wrap;color:#c7c7d1;font-size:12px;max-height:200px;overflow:auto;background:#0f0f16;border:1px dashed var(--border);padding:10px;border-radius:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="topbar">
    <button class="btn" onclick="location.href='index.html'">‚¨ÖÔ∏è Volver</button>
    <div style="flex:1"></div>
    <span id="whoami" class="small muted">No autenticado</span>
  </div>

  <main class="grid">
    <section class="panel" style="display:grid;gap:10px;grid-template-columns:1fr auto">
      <div class="small muted">Exporta el mes a la plantilla oficial 2N (XLSX). El dashboard se ha compactado para escritorio.</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="expMonth" type="month" style="background:#0f0f16;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px">
        <button id="btnExcel" class="btn pri">‚¨áÔ∏è Plantilla 2N (Excel)</button>
        <button id="btnFotos" class="btn">üñºÔ∏è Descargar fotos</button>
      </div>
    </section>

    <section class="panel">
      <div class="cards">
        <div><canvas id="chartCat"></canvas></div>
        <div><canvas id="chartDaily"></canvas></div>
        <div><canvas id="chartInc"></canvas></div>
        <div><canvas id="chartNet"></canvas></div>
      </div>
    </section>

    <section class="panel">
      <strong>Listado</strong>
      <div id="list" class="small"></div>
    </section>

    <section class="panel">
      <strong>Logs</strong>
      <div id="out" class="out"></div>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $=id=>document.getElementById(id);
    const log = (m)=>{ const o=$('out'); o.textContent += (typeof m==='string'?m:JSON.stringify(m,null,2))+'\\n'; o.scrollTop=o.scrollHeight; };

    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();
    const storage=firebase.storage();

    auth.onAuthStateChanged(async (user)=>{
      $('whoami').textContent = user? (user.email||user.uid) : 'No autenticado';
      if(user && !$('expMonth').value) $('expMonth').value = new Date().toISOString().slice(0,7);
      if(user && $('expMonth').value) await refresh();
    });

    $('expMonth').onchange = refresh;
    $('btnExcel').onclick = exportExcel;
    $('btnFotos').onclick = descargarFotosMes;

    function rangeMonth(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
    async function listEntries(ym, uid){
      const [s,e]=rangeMonth(ym);
      const q = await db.collection(`users/${uid}/entries`).where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
      return q.docs.map(d=>({id:d.id,...d.data()}));
    }

    const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];

    function toCSVRecord(e){
      const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
      const d=e.date?.toDate?e.date.toDate():new Date(e.date);
      rec["DATE"]=d.toLocaleDateString("es-ES");
      rec["CLIENT / PROVIDER"]=e.provider||"";
      rec["DESCRIPTION"]=e.notes||"";
      const col = MAP[e.category]||"VARIOUS";
      const amount=Number(e.amount||0);
      if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
      let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
      rec["TOTAL"]=total;
      return rec;
    }

    let entriesCache=[];

    async function refresh(){
      try{
        const user=auth.currentUser; if(!user) return;
        const ym=$('expMonth').value; if(!ym) return;
        const entries=await listEntries(ym,user.uid);
        entriesCache=entries;
        renderList(entries);
        renderCharts(entries);
      }catch(e){ log(e); }
    }

    function renderList(entries){
      const host=$('list'); host.innerHTML='';
      for(const e of entries){
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        const amount = Number(e.amount||0);
        const sign = (e.category==='ingreso')?'+':'-';
        const line = document.createElement('div');
        line.style.display='grid'; line.style.gridTemplateColumns='1fr auto'; line.style.alignItems='center';
        line.style.borderTop='1px solid #232333'; line.style.padding='6px 0';
        line.innerHTML = `<div>
            <div><strong>${e.provider||'-'}</strong> <span class="muted">¬∑ ${e.category}</span></div>
            <div class="muted small">${d.toISOString().slice(0,10)}${e.notes? ' ¬∑ '+e.notes : ''}</div>
          </div>
          <div style="text-align:right">${sign}${amount.toLocaleString('es-ES',{minimumFractionDigits:2})} ‚Ç¨</div>`;
        host.appendChild(line);
      }
    }

    function renderCharts(entries){
      const byCat={}; const byDay={}; let inc=0, exp=0;
      for(const e of entries){
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        const day=d.toISOString().slice(0,10);
        const v=Number(e.amount||0);
        if(e.category==='ingreso'){ inc+=v; } else { exp+=v; byCat[e.category]=(byCat[e.category]||0)+v; }
        byDay[day]=(byDay[day]||0)+(e.category==='ingreso'?-v:v);
      }
      const net = inc - exp;

      const ctx1=document.getElementById('chartCat').getContext('2d');
      const ctx2=document.getElementById('chartDaily').getContext('2d');
      const ctx3=document.getElementById('chartInc').getContext('2d');
      const ctx4=document.getElementById('chartNet').getContext('2d');

      const labelsCat=Object.keys(byCat); const dataCat=Object.values(byCat);
      const labelsDay=Object.keys(byDay).sort(); const dataDay=labelsDay.map(k=>byDay[k]);

      if(window._c1) window._c1.destroy(); if(window._c2) window._c2.destroy(); if(window._c3) window._c3.destroy(); if(window._c4) window._c4.destroy();
      window._c1=new Chart(ctx1,{type:'doughnut',data:{labels:labelsCat,datasets:[{data:dataCat}]},options:{plugins:{legend:{display:false}}}});
      window._c2=new Chart(ctx2,{type:'line',data:{labels:labelsDay,datasets:[{data:dataDay}]},options:{plugins:{legend:{display:false}}}});
      window._c3=new Chart(ctx3,{type:'bar',data:{labels:['Ingresos','Gastos'],datasets:[{data:[inc,exp]}]},options:{plugins:{legend:{display:false}}}});
      window._c4=new Chart(ctx4,{type:'bar',data:{labels:['Neto'],datasets:[{data:[net]}]},options:{plugins:{legend:{display:false}}}});
    }

    async function exportExcel(){
      try{
        const user=auth.currentUser; if(!user) return alert('Haz login');
        const ym=$('expMonth').value; if(!ym) return alert('Selecciona un mes');
        const entries = entriesCache.length? entriesCache : await listEntries(ym,user.uid);
        if(!entries.length) return alert('Sin datos');
        const monthlabel=new Date(ym+'-01').toLocaleDateString('es-ES',{month:'long',year:'numeric'});
        const today=new Date().toLocaleDateString('es-ES');
        const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
        const header=[["","","","","","EXPENSES REPORT","","","","",""],["NOM","","Gaston Ortigosa","","","","","DATE:","",today,""],["PRENOM:","David","COST CENTER:","7420","","","MONTH/YEAR:",monthlabel,"","",""],[""],COLUMNS];
        const toRec=(e)=>{
          const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
          const d=e.date?.toDate?e.date.toDate():new Date(e.date);
          rec["DATE"]=d.toLocaleDateString("es-ES");
          rec["CLIENT / PROVIDER"]=e.provider||"";
          rec["DESCRIPTION"]=e.notes||"";
          const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
          const col = MAP[e.category]||"VARIOUS";
          const amount=Number(e.amount||0);
          if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
          let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
          rec["TOTAL"]=total; return COLUMNS.map(c=>rec[c]);
        };
        const rows = entries.map(toRec);
        const ws = XLSX.utils.aoa_to_sheet(header.concat(rows));
        ws['!cols']=[{wch:12},{wch:26},{wch:14},{wch:10},{wch:10},{wch:16},{wch:22},{wch:12},{wch:10},{wch:10},{wch:10},{wch:30}];

        // KM sheet
        const kmsSnap = await db.collection(`users/${user.uid}/kms`).where('ym','==',ym).orderBy('date','asc').get();
        const kms = kmsSnap.docs.map(d=>d.data());
        let personalCost=0;
        const kmsRows = [["DATE","DESTINATION","KM_EMP","KM_PERS","PRICE/L","PERS. COST (‚Ç¨)"]];
        for(const k of kms){
          const d=k.date?.toDate?k.date.toDate():new Date(k.date);
          const cost = Number(k.km_pers||0) * Number(k.price_per_liter||0);
          personalCost += cost;
          kmsRows.push([d.toISOString().slice(0,10), k.destination||"", Number(k.km_emp||0), Number(k.km_pers||0), Number(k.price_per_liter||0), cost]);
        }
        const ws2 = XLSX.utils.aoa_to_sheet([["KM PERSONAL ‚Äì LIQUIDACI√ìN"],["Mes",ym],["Total a descontar (‚Ç¨)", personalCost],[""], ...kmsRows]);
        ws2['!cols'] = [{wch:12},{wch:24},{wch:10},{wch:10},{wch:10},{wch:14}];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
        XLSX.utils.book_append_sheet(wb, ws2, 'KM personales');
        const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        saveAs(new Blob([out], {type:'application/octet-stream'}), `Informe_Gastos_${ym}.xlsx`);
      }catch(e){ log(e); alert('Excel error: '+(e.message||'')); }
    }

    async function descargarFotosMes(){
      try{
        const user=auth.currentUser; if(!user) return alert('Haz login');
        const ym=$('expMonth').value; if(!ym) return alert('Selecciona un mes');
        const entries = entriesCache.length? entriesCache : await listEntries(ym,user.uid);
        const photos = entries.filter(e=>e.photoURL);
        if(!photos.length) return alert('Sin fotos en este mes');
        for(const e of photos){
          const a=document.createElement('a'); a.href=e.photoURL; a.download='';
          document.body.appendChild(a); a.click(); a.remove();
          await new Promise(r=>setTimeout(r,150));
        }
      }catch(e){ log(e); alert('Descarga fotos: '+(e.message||'')); }
    }

  })();
  </script>
</body>
</html>