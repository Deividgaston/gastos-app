<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ‚Äî Exportar</title>
  <style>
    :root{--ink:#0b0b0f;--muted:#6b7280;--b:#e5e7eb;--brand:#007aff}
    *{box-sizing:border-box}body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:#f7f7fb;color:var(--ink)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);padding:10px 14px;display:flex;gap:8px;align-items:center;z-index:5}
    header h1{font-size:18px;margin:0;flex:1}
    .btn{border:1px solid var(--b);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    main{max-width:960px;margin:0 auto;padding:14px}
    .panel{background:#fff;border:1px solid var(--b);border-radius:16px;padding:12px 14px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .hidden{display:none!important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <h1>Gastos 2N ‚Äî Exportar</h1>
    <span id="who" class="muted">Comprobando sesi√≥n‚Ä¶</span>
    <button id="login" class="btn">Entrar</button>
    <button id="logout" class="btn hidden">Salir</button>
  </header>
  <main>
    <div class="panel grid">
      <div>
        <label class="muted">Mes</label><br/>
        <input id="month" type="month"/>
      </div>
      <div style="display:flex;gap:8px;align-items:end;justify-content:flex-start">
        <button id="btnCSV" class="btn">‚¨áÔ∏è CSV</button>
        <button id="btnZIP" class="btn primary">üóúÔ∏è Descargar ZIP (fotos)</button>
      </div>
    </div>
    <div class="panel">
      <strong>Logs</strong>
      <pre id="out"></pre>
      <p class="muted">Si ves <code>storage/unauthorized</code>, revisa las reglas de Storage y que est√©s autenticado.</p>
    </div>
  </main>
  <script>
    (function(){
      const $=id=>document.getElementById(id);
      const log=(m)=>{$("out").textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"};

      // === Firebase ===
      const firebaseConfig = {
        apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
        authDomain: "gastos-2n.firebaseapp.com",
        projectId: "gastos-2n",
        storageBucket: "gastos-2n.firebasestorage.app",
        messagingSenderId: "55010048795",
        appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
      };
      firebase.initializeApp(firebaseConfig);
      const auth=firebase.auth(); const db=firebase.firestore(); const storage=firebase.storage();
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

      const provider=new firebase.auth.GoogleAuthProvider();
      $("login").onclick=()=>auth.signInWithPopup(provider).catch(e=>alert(e.message));
      $("logout").onclick=()=>auth.signOut();

      auth.onAuthStateChanged((u)=>{
        if(u){
          $("who").textContent = "Conectado como " + (u.email||u.uid);
          $("login").classList.add("hidden"); $("logout").classList.remove("hidden");
          if(!$("month").value) $("month").value=new Date().toISOString().slice(0,7);
        }else{
          $("who").textContent = "No autenticado";
          $("login").classList.remove("hidden"); $("logout").classList.add("hidden");
        }
      });

      function monthRange(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
      async function listEntriesMonth(ym, uid){
        const [s,e]=monthRange(ym);
        const snap=await db.collection("users/"+uid+"/entries").where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
        return snap.docs.map(d=>({id:d.id, ...d.data()}));
      }

      // Try to derive a storage path from a downloadURL
      function pathFromDownloadURL(url){
        try{
          const u=new URL(url);
          // expect .../o/<encodedPath>?alt=media&token=...
          const m = u.pathname.match(/\/o\/(.+)$/);
          if(!m) return null;
          const enc = m[1].split("?")[0];
          return decodeURIComponent(enc);
        }catch(_){ return null; }
      }

      async function getBlobForEntry(e){
        // Prefer server path stored in DB
        if(e.photoPath){
          const ref = storage.ref(e.photoPath);
          // Use getBlob to avoid size caps and keep mime
          return ref.getBlob();
        }
        if(e.photoURL){
          // Derive a path and access via SDK (auth)
          const p = pathFromDownloadURL(e.photoURL);
          if(p){
            const ref = storage.ref(p);
            return ref.getBlob();
          }
        }
        throw new Error("Sin foto");
      }

      $("btnZIP").onclick = async () => {
        try{
          const u=auth.currentUser; if(!u) return alert("Haz login primero");
          const ym=$("month").value; if(!ym) return alert("Selecciona mes");
          const entries=await listEntriesMonth(ym,u.uid);
          const photos=entries.filter(x=>x.photoPath||x.photoURL);
          if(!photos.length) return alert("Sin fotos ese mes");

          const zip = new JSZip(); let ok=0, fail=0;
          for(const e of photos){
            try{
              const blob = await getBlobForEntry(e);
              const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
              const dateISO = d.toISOString().slice(0,10);
              const prov = (e.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
              const ext = blob.type==="image/png" ? ".png" : ".jpg";
              zip.file(`${dateISO}_${prov}${ext}`, blob);
              ok++;
            }catch(err){
              fail++; log({fallo_zip_getBlob: e.photoURL||e.photoPath, err: (err && err.message) || String(err)});
            }
          }
          const out = await zip.generateAsync({type:"blob"});
          saveAs(out, `Fotos_Gastos_${ym}.zip`);
          log(`üóúÔ∏è ZIP listo: ${ok} ok, ${fail} fallos`);
        }catch(e){ console.error(e); log(e); alert("ZIP error: " + (e.message||"")); }
      };

      // Minimal CSV as well
      const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
      const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
      function toCSVValue(col, value){
        if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
          const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
        }
        const s=String(value||"").replace(/"/g,'""'); return `"${s}"`;
      }
      function buildCSV(rows, monthlabel, today){
        const head=`,,,,,   EXPENSES REPORT,,,,,,,\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${today}\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthlabel},,,,,,\n,,,,,,,,,,,,\n`;
        const h1=COLUMNS.map(h=>`"${h}"`).join(";")+"\\n";
        const h2=",,PARKINGS ,,,,,TRAVELING,,,\\n";
        const data=rows.map(r=>COLUMNS.map(c=>toCSVValue(c,r[c])).join(";")).join("\\n");
        return head+h1+h2+data+"\\n";
      }
      function toCSVRecords(entries){
        const rows=[];
        for(const e of entries){
          if(e.category==="ingreso") continue;
          const col=MAP[e.category]||"VARIOUS";
          const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
          const d=e.date?.toDate?e.date.toDate():new Date(e.date);
          rec["DATE"]=d.toLocaleDateString("es-ES");
          rec["CLIENT / PROVIDER"]=e.provider||"";
          rec["DESCRIPTION"]=e.notes||"";
          const amount=Number(e.amount||0);
          if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
          let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
          rec["TOTAL"]=total; rows.push(rec);
        }
        return rows;
      }
      $("btnCSV").onclick = async ()=>{
        try{
          const u=auth.currentUser; if(!u) return alert("Haz login primero");
          const ym=$("month").value; if(!ym) return alert("Selecciona mes");
          const entries=await listEntriesMonth(ym,u.uid);
          if(!entries.length) return alert("Sin gastos");
          const rows=toCSVRecords(entries);
          const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
          const today=new Date().toLocaleDateString("es-ES");
          const csv=buildCSV(rows, monthlabel, today);
          saveAs(new Blob([csv],{type:"text/csv;charset=utf-8"}),`Informe_Gastos_${ym}.csv`);
        }catch(e){ console.error(e); log(e); alert("CSV error: "+(e.message||"")); }
      };
    })();
  </script>
</body>
</html>