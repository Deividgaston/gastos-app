<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ Export</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- XLSX para generar/modificar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>
</head>
<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N ¬∑ Export
  </h1>

  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge active" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Exportar gastos</h2>
      <div class="row" style="flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div>
          <label for="selMonth">Mes</label><br>
          <select id="selMonth">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <div>
          <label for="selYear">A√±o</label><br>
          <input id="selYear" type="number" style="width:110px">
        </div>
        <div style="flex:1;min-width:220px">
          <div class="small">
            Se exportan los apuntes del mes seleccionado, leyendo de Firestore si hay login
            o de localStorage si no.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap">
        <button id="btnExportExcel" class="btn primary">üì• Descargar Excel (plantilla 2N)</button>
        <button id="btnExportPhotos" class="btn">üñº Descargar fotos del mes</button>
        <button id="btnExportKmPersonal" class="btn">üö∂‚Äç‚ôÇÔ∏è Descargar KM personales</button>
      </div>

      <div id="exportStatus" class="small" style="margin-top:10px;min-height:1.5em"></div>
    </div>

    <div class="card">
      <h2>Vista previa r√°pida</h2>
      <div id="previewList" class="list small"></div>
    </div>
  </div>
</main>

<!-- FIREBASE + AUTH GOOGLE -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth   : auth,
      db     : firebase.firestore(),
      storage: firebase.storage()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA EXPORT -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  /* Inicializar mes/a√±o por defecto */
  (function initMonthYear(){
    var now  = new Date();
    var m    = now.getMonth() + 1;
    var y    = now.getFullYear();
    if ($('selMonth')) $('selMonth').value = String(m);
    if ($('selYear'))  $('selYear').value  = String(y);
  })();

  function setStatus(msg){
    var el = $('exportStatus');
    if (el) el.textContent = msg || '';
  }

  function formatDateISO(d){
    if (!(d instanceof Date)) d = new Date(d);
    return d.toISOString().slice(0,10);
  }

  function slugify(str){
    return (str || '')
      .toString()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/-+/g,'-')
      .replace(/^-|-$/g,'') || 'ticket';
  }

  function getMonthRange(){
    var m = parseInt($('selMonth').value,10);
    var y = parseInt($('selYear').value,10);
    if (!m || !y) throw new Error('Mes o a√±o no v√°lidos');
    var start = new Date(Date.UTC(y, m-1, 1, 0,0,0));
    var end   = new Date(Date.UTC(y, m,   1, 0,0,0));
    return { m, y, start, end };
  }

  /* ==== GASTOS (entries) ==== */

  async function getMonthEntries(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    var range = getMonthRange();
    var start = range.start;
    var end   = range.end;

    var entries = [];

    if (user && db){
      // Leemos todo ordenado y filtramos en cliente para evitar problemas de √≠ndices
      var snap = await db.collection('users/' + user.uid + '/entries')
        .orderBy('date','asc')
        .get();

      snap.forEach(function(doc){
        var e = doc.data();
        var d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
        if (d >= start && d < end){
          e._id   = doc.id;
          e._date = d;
          entries.push(e);
        }
      });
    } else {
      var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      arr.forEach(function(e){
        var d = new Date(e.date);
        if (d >= start && d < end){
          e._date = d;
          entries.push(e);
        }
      });
    }

    return { entries, range };
  }

  function renderPreview(entries, range){
    var cont = $('previewList');
    if (!cont) return;
    cont.innerHTML = '';

    if (!entries.length){
      cont.innerHTML = '<div class="small">Sin apuntes para este mes.</div>';
      return;
    }

    var title = document.createElement('div');
    title.className = 'small';
    title.style.fontWeight = 'bold';
    title.textContent = 'Mostrando hasta 10 primeros apuntes del mes (gastos):';
    cont.appendChild(title);

    entries.slice(0,10).forEach(function(e){
      var d = e._date || new Date(e.date);
      var div = document.createElement('div');
      div.className = 'small';
      div.textContent =
        formatDateISO(d) + ' ¬∑ ' +
        (e.provider || '-') + ' ¬∑ ' +
        (e.amount || 0) + '‚Ç¨ ¬∑ ' +
        (e.category || '');
      cont.appendChild(div);
    });
  }

  /* Mapear categor√≠a interna -> columnas plantilla 2N */
  function mapTo2NCols(e){
    var cat       = (e.category || '').toString().toLowerCase();
    var importe   = (typeof e.amount === 'number') ? e.amount : Number(e.amount || 0);
    if (!importe) importe = 0;

    // Omitimos ingresos en la plantilla de gastos
    if (cat === 'ingreso') return null;

    var cols = {
      tolls   : 0, // C
      hotel   : 0, // D
      gas     : 0, // E
      tickets : 0, // F
      other   : 0, // G
      invit   : 0, // H
      meals   : 0, // I
      varios  : 0  // J
    };

    if      (cat === 'peajes')      cols.tolls  = importe;
    else if (cat === 'gasolina')    cols.gas    = importe;
    else if (cat === 'alojamiento') cols.hotel  = importe;
    else if (cat === 'transporte')  cols.other  = importe;
    else if (cat === 'comida')      cols.meals  = importe;
    else if (cat === 'ocio')        cols.varios = importe;
    else if (cat === 'servicios')   cols.varios = importe;
    else                            cols.varios = importe; // 'varios' y cualquier otro

    return cols;
  }

  function setCell(ws, addr, value){
    var cell = ws[addr];
    if (!cell) {
      cell = ws[addr] = {};
    }
    cell.v = value;
    if (typeof value === 'number') {
      cell.t = 'n';
    } else if (value == null || value === '') {
      cell.t = 's';
      cell.v = '';
    } else {
      cell.t = 's';
    }
  }

  async function handleExportExcel(){
    try{
      setStatus('Cargando apuntes del mes‚Ä¶');
      var res = await getMonthEntries();
      var entries = res.entries;
      var range   = res.range;

      if (!entries.length){
        setStatus('No hay apuntes para ese mes.');
        renderPreview([], range);
        return;
      }

      renderPreview(entries, range);

      // Filtramos entradas v√°lidas (no ingresos)
      var validEntries = [];
      entries.forEach(function(e){
        var mapped = mapTo2NCols(e);
        if (mapped) {
          validEntries.push({ entry: e, cols: mapped });
        }
      });

      if (!validEntries.length){
        setStatus('Solo hay ingresos o apuntes sin importe, nada que exportar en plantilla 2N.');
        return;
      }

      setStatus('Cargando plantilla 2N‚Ä¶');

      // üëá Usamos la plantilla que has subido a assets
      var tplRes = await fetch('assets/plantilla-2n.xlsx');
      if (!tplRes.ok){
        throw new Error('No se puede cargar "assets/plantilla-2n.xlsx" (HTTP ' + tplRes.status + ')');
      }
      var ab    = await tplRes.arrayBuffer();
      var wb    = XLSX.read(ab, { type:'array' });
      var ws    = wb.Sheets['NDF'] || wb.Sheets[wb.SheetNames[0]];

      // Rellenar cabecera con tus datos
      // Ajusta estas celdas si en tu plantilla real est√°n en otra posici√≥n
      setCell(ws, 'B2', 'Gaston');      // NOM (apellido)
      setCell(ws, 'B3', 'David');       // PRENOM
      setCell(ws, 'D3', 'iberia team'); // COST CENTER

      // Los datos empiezan en la fila 7 en la plantilla (ajusta si tu plantilla usa otra)
      var startRow = 7;

      validEntries.forEach(function(obj, idx){
        var e    = obj.entry;
        var cols = obj.cols;
        var row  = startRow + idx;

        var d = e._date || new Date(e.date);
        var fecha     = formatDateISO(d);
        var proveedor = e.provider || '';
        var notas     = e.notes || '';

        // A: DATE
        setCell(ws, 'A' + row, fecha);
        // B: CLIENT / PROVIDER
        setCell(ws, 'B' + row, proveedor);

        // C..J: importes seg√∫n categor√≠a
        setCell(ws, 'C' + row, cols.tolls);
        setCell(ws, 'D' + row, cols.hotel);
        setCell(ws, 'E' + row, cols.gas);
        setCell(ws, 'F' + row, cols.tickets);
        setCell(ws, 'G' + row, cols.other);
        setCell(ws, 'H' + row, cols.invit);
        setCell(ws, 'I' + row, cols.meals);
        setCell(ws, 'J' + row, cols.varios);

        // K (TOTAL) se deja la f√≥rmula original de la plantilla (=SUM(Crow:Jrow))
        // L: DESCRIPTION
        setCell(ws, 'L' + row, notas);
      });

      // Guardar el Excel manteniendo todos los estilos/f√≥rmulas de la plantilla
      var mm = String(range.m).padStart(2,'0');
      var filename = 'gastos_2n_' + range.y + '-' + mm + '.xlsx';

      XLSX.writeFile(wb, filename);
      setStatus('Excel generado a partir de la plantilla 2N: ' + filename);
    }catch(e){
      console.error(e);
      setStatus('Error al generar el Excel: ' + (e.message || e));
    }
  }

  /* ==== FOTOS ==== */

  async function handleExportPhotos(){
    try{
      setStatus('Cargando apuntes del mes‚Ä¶');
      var ctx  = window.__APPCTX__ || {};
      var st   = ctx.storage;
      var auth = ctx.auth;
      var user = auth && auth.currentUser;

      var res = await getMonthEntries();
      var entries = res.entries;
      var range   = res.range;

      if (!entries.length){
        setStatus('No hay apuntes para ese mes.');
        renderPreview([], range);
        return;
      }

      renderPreview(entries, range);

      var photos = [];
      for (var i=0; i<entries.length; i++){
        var e = entries[i];
        if (e.photoURL){
          photos.push({ entry: e, url: e.photoURL });
        } else if (e.photoPath && st && user){
          try{
            var ref = st.ref(e.photoPath);
            var url = await ref.getDownloadURL();
            photos.push({ entry: e, url: url });
          }catch(err){
            console.warn('No se pudo obtener URL de', e.photoPath, err);
          }
        }
      }

      if (!photos.length){
        setStatus('No hay fotos asociadas a los apuntes de este mes.');
        return;
      }

      setStatus('Descargando ' + photos.length + ' fotos‚Ä¶ (el navegador puede mostrar varias descargas seguidas)');

      photos.forEach(function(obj, idx){
        var e = obj.entry;
        var url = obj.url;
        var d = e._date || new Date(e.date);
        var fecha = formatDateISO(d);
        var prov  = slugify(e.provider || 'ticket');
        var name  = fecha + '_' + prov + '_' + String(idx+1) + '.jpg';

        setTimeout(function(){
          var a = document.createElement('a');
          a.href = url;
          a.download = name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }, idx * 350);
      });
    }catch(e){
      console.error(e);
      setStatus('Error al descargar las fotos: ' + (e.message || e));
    }
  }

  /* ==== KM PERSONALES ==== */

  async function getMonthKmEntries(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    var range = getMonthRange();
    var start = range.start;
    var end   = range.end;

    var kms = [];

    if (user && db){
      try{
        var snap = await db.collection('users/' + user.uid + '/kms')
          .orderBy('date','asc')
          .get();

        snap.forEach(function(doc){
          var e = doc.data();
          var d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          if (d >= start && d < end){
            e._id   = doc.id;
            e._date = d;
            kms.push(e);
          }
        });
      }catch(e){
        console.warn('Error leyendo kms de Firestore', e);
      }
    } else {
      var arr = JSON.parse(localStorage.getItem('kms_local') || '[]');
      arr.forEach(function(e){
        var d = new Date(e.date);
        if (d >= start && d < end){
          e._date = d;
          kms.push(e);
        }
      });
    }

    return { kms, range };
  }

  function isPersonalKm(entry){
    var type = (entry.type || entry.kind || entry.category || '').toString().toLowerCase();
    return (
      type.includes('perso') ||
      type.includes('parti') ||
      type.includes('priv')
    );
  }

  async function handleExportKmPersonal(){
    try{
      setStatus('Cargando KM del mes‚Ä¶');
      var res = await getMonthKmEntries();
      var kms = res.kms;
      var range = res.range;

      if (!kms.length){
        setStatus('No hay registros de KM para este mes.');
        return;
      }

      var personales = kms.filter(isPersonalKm);
      if (!personales.length){
        setStatus('No hay KM personales en este mes.');
        return;
      }

      var data = [];
      // Cabecera propia para KM personales
      data.push(['DATE', 'KM', 'TYPE', 'FUEL PRICE', 'KM TOTAL', 'NOTES']);

      personales.forEach(function(e){
        var d = e._date || new Date(e.date);
        var fecha = formatDateISO(d);
        var km    = (typeof e.km === 'number') ? e.km : Number(e.km || e.distance || 0);
        var type  = e.type || e.kind || '';
        var fuel  = (typeof e.fuelPrice === 'number') ? e.fuelPrice : Number(e.fuelPrice || 0);
        var totalKm = (typeof e.totalKm === 'number') ? e.totalKm : Number(e.totalKm || e.odo || e.kmTotal || 0);
        var notes = e.notes || '';

        data.push([fecha, km, type, fuel, totalKm, notes]);
      });

      var ws = XLSX.utils.aoa_to_sheet(data);
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'KM personales');

      var mm = String(range.m).padStart(2,'0');
      var filename = 'kms_personales_' + range.y + '-' + mm + '.xlsx';

      XLSX.writeFile(wb, filename);
      setStatus('Excel KM personales generado: ' + filename);
    }catch(e){
      console.error(e);
      setStatus('Error al generar Excel de KM personales: ' + (e.message || e));
    }
  }

  /* Listeners */
  if ($('btnExportExcel')){
    $('btnExportExcel').addEventListener('click', handleExportExcel);
  }
  if ($('btnExportPhotos')){
    $('btnExportPhotos').addEventListener('click', handleExportPhotos);
  }
  if ($('btnExportKmPersonal')){
    $('btnExportKmPersonal').addEventListener('click', handleExportKmPersonal);
  }

  // Recargar vista previa cuando cambie mes/a√±o o usuario
  function refreshPreview(){
    getMonthEntries()
      .then(function(res){
        renderPreview(res.entries, res.range);
        if (!res.entries.length){
          setStatus('Sin apuntes para ese mes.');
        } else {
          setStatus('');
        }
      })
      .catch(function(e){
        console.error(e);
        setStatus('Error cargando apuntes: ' + (e.message || e));
      });
  }

  if ($('selMonth')) $('selMonth').addEventListener('change', refreshPreview);
  if ($('selYear'))  $('selYear').addEventListener('change', refreshPreview);

  document.addEventListener('auth-changed', function(){ refreshPreview(); }, false);

  // Primera carga
  refreshPreview();
})();
</script>

</body>
</html>
