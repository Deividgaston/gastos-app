<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N - AI Scan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body { background:#f9fbfc; } </style>
</head>

<body class="min-h-screen">
<div class="max-w-xl mx-auto p-4 space-y-4">

<header class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">Gastos 2N</h1>
  <button id="btnSettings" class="px-3 py-2 rounded bg-gray-200 text-sm">‚öôÔ∏è Ajustes</button>
</header>

<p id="whoami" class="text-sm text-gray-600">No autenticado</p>

<div id="modalSettings" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
  <div class="bg-white p-4 rounded-xl w-80 space-y-3">
    <h2 class="text-lg font-bold">Ajustes</h2>
    <label class="text-sm font-medium">Gemini API Key</label>
    <input id="apiKeyInput" type="password" class="w-full border rounded px-3 py-2" placeholder="Pegue aqu√≠ su API Key" />
    <button id="saveApiKey" class="w-full py-2 bg-indigo-600 text-white rounded">Guardar</button>
    <button id="closeSettings" class="w-full py-2 bg-gray-300 rounded">Cerrar</button>
  </div>
</div>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <h2 class="font-semibold">Nuevo gasto</h2>

  <input id="fFecha" type="date" class="w-full border rounded px-3 py-2" />
  <input id="fProveedor" placeholder="Proveedor / Local" class="w-full border rounded px-3 py-2"/>
  <input id="fCantidad" type="number" step="0.01" placeholder="Importe (‚Ç¨)" class="w-full border rounded px-3 py-2"/>
  <textarea id="fNota" rows="2" class="w-full border rounded px-3 py-2" placeholder="Notas"></textarea>

  <input id="fFile" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
  <img id="preview" class="mt-2 max-h-40 hidden rounded border" />

  <button id="scanAI" class="w-full py-2 bg-purple-600 text-white font-semibold rounded">üì∏ Escanear ticket con IA</button>
  <button id="btnGuardar" class="w-full py-2 bg-green-600 text-white font-semibold rounded">üíæ Guardar gasto</button>
</section>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <div class="flex justify-between">
    <h2 class="font-semibold">√öltimos gastos</h2>
    <button id="btnRefrescar" class="px-2 py-1 rounded border text-sm">‚Üª</button>
  </div>
  <div id="lista" class="space-y-2"></div>
</section>

<pre id="out" class="text-xs text-gray-600 whitespace-pre-wrap"></pre>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, Timestamp, query, limit, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const config = {
  apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
  authDomain: "gastos-2n.firebaseapp.com",
  projectId: "gastos-2n",
  storageBucket: "gastos-2n.firebasestorage.app",
  messagingSenderId: "55010048795",
  appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
};

const app = initializeApp(config);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app");

const whoami = document.getElementById("whoami");
const fFecha = document.getElementById("fFecha");
const fProveedor = document.getElementById("fProveedor");
const fCantidad = document.getElementById("fCantidad");
const fNota = document.getElementById("fNota");
const fFile = document.getElementById("fFile");
const preview = document.getElementById("preview");
const out = document.getElementById("out");

document.getElementById("btnSettings").onclick=()=>modalSettings.classList.remove("hidden");
document.getElementById("closeSettings").onclick=()=>modalSettings.classList.add("hidden");
document.getElementById("saveApiKey").onclick=()=>{
  const key=document.getElementById("apiKeyInput").value.trim();
  if(!key)return alert("Introduce clave");
  localStorage.setItem("geminiKey",key);
  alert("‚úÖ API Key guardada");
  modalSettings.classList.add("hidden");
};

fFecha.value=new Date().toISOString().slice(0,10);

fFile.addEventListener("change",e=>{
  const f=e.target.files?.[0];
  if(!f)return preview.classList.add("hidden");
  preview.src=URL.createObjectURL(f);
  preview.classList.remove("hidden");
});

onAuthStateChanged(auth, user=>{
  if(user){
    whoami.textContent="Sesi√≥n: "+user.email;
    cargarUltimos();
  } else {
    const provider=new GoogleAuthProvider();
    signInWithPopup(auth,provider).catch(()=>{});
  }
});

document.getElementById("btnGuardar").onclick=async()=>{
  const user=auth.currentUser;
  if(!user)return alert("Login...");

  const fecha=fFecha.value;
  const proveedor=fProveedor.value;
  const nota=fNota.value;
  const cantidad=parseFloat(fCantidad.value);
  if(!proveedor||!cantidad)return alert("Completa proveedor e importe");

  let photoURL="";
  const file=fFile.files?.[0];
  if(file){
    const fname=fecha+"_"+proveedor.replace(/\W+/g,"_")+"_"+Date.now()+".jpg";
    const r=ref(storage,`tickets/${user.uid}/${fname}`);
    await uploadBytes(r,file);
    photoURL=await getDownloadURL(r);
  }

  await addDoc(collection(db,`users/${user.uid}/entries`),{
    date:Timestamp.fromDate(new Date(fecha)),
    provider:proveedor,
    notes:nota,
    amount:cantidad,
    isExpense:true,
    photoURL,
    createdAt:Timestamp.now()
  });

  alert("‚úÖ Guardado");
  fProveedor.value=""; fNota.value=""; fCantidad.value=""; fFile.value=""; preview.classList.add("hidden");
  cargarUltimos();
};

async function cargarUltimos(){
  const user=auth.currentUser; if(!user)return;
  const qSnap=await getDocs(query(collection(db,`users/${user.uid}/entries`),orderBy("createdAt","desc"),limit(10)));
  const list=document.getElementById("lista");
  list.innerHTML="";
  qSnap.forEach(doc=>{
    const d=doc.data();
    const dstr=d.date.toDate().toISOString().slice(0,10);
    list.innerHTML+=`
      <div class="flex justify-between border p-2 rounded">
        <div><b>${d.provider}</b><br><small>${dstr}</small></div>
        <div>${d.amount} ‚Ç¨<br>${d.photoURL?`<a href="${d.photoURL}" target="_blank">ticket</a>`:""}</div>
      </div>`;
  });
}
document.getElementById("btnRefrescar").onclick=cargarUltimos;

document.getElementById("scanAI").onclick=async()=>{
  const key=localStorage.getItem("geminiKey");
  if(!key)return alert("Guarda tu API Key");

  const file=fFile.files[0];
  if(!file)return alert("Sube ticket primero");

  const buf=await file.arrayBuffer();
  const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));
  const prompt="Extrae proveedor e importe del ticket.";

  const body={
    contents:[{
      role:"user",
      parts:[
        {text:prompt},
        {inline_data:{mime_type:"image/jpeg",data:b64}}
      ]
    }]
  };

  const res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  const data=await res.json();
  out.textContent=JSON.stringify(data,null,2);

  try{
    const txt=data.candidates[0].content.parts[0].text;
    const prov=txt.match(/Proveedor:? (.*)/i)?.[1];
    const amt=txt.match(/Importe:? ([0-9.,]+)/i)?.[1];
    if(prov)fProveedor.value=prov;
    if(amt)fCantidad.value=amt.replace(",",".");
  }catch{}
};
</script>
</body>
</html>