<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Gastos 2N â€” iOS</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
  <script src="assets/app.js"></script>
</head>
<body>
  <header class="topbar">
    <h1>Gastos 2N</h1>
    <button id="btnAI" class="btn">IA</button>
    <button id="btnLogin" class="btn">Google</button>
    <button id="btnLogout" class="btn hidden">Salir</button>
  </header>
  <main class="content">
    <div class="panel actions">
      <button id="scanBtn" class="btn primary">ðŸ“· Escanear</button>
      <button id="addBtn" class="btn">âž• Ingreso manual</button>
      <a class="btn" href="kms.html">ðŸš— KM</a>
      <a class="btn" href="export.html">ðŸ“¦ Exportar</a>
      <a class="btn" href="summary.html">ðŸ“Š Summary</a>
      <span class="badge" style="margin-left:auto">Usuario: <span id="whoami">...</span></span>
    </div>

    <div class="panel"><strong>Logs</strong><pre id="log" class="small"></pre></div>
  </main>

  <!-- Modal IA -->
  <div id="aiModal" class="modal">
    <div class="sheet">
      <header><strong>Configurar IA</strong><button class="btn" id="aiClose">Cerrar</button></header>
      <div class="body" style="grid-template-columns:1fr">
        <div class="field"><label>API Key Gemini</label><input id="aiKey" type="password" placeholder="AIza..."/></div>
      </div>
      <footer>
        <button class="btn" id="aiClear">Borrar</button>
        <button class="btn primary" id="aiSave">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal Review -->
  <div id="revModal" class="modal">
    <div class="sheet">
      <header><strong>Revisar y guardar</strong><button class="btn" id="revClose">Cerrar</button></header>
      <div class="body">
        <div class="field"><label>Fecha</label><input id="revDate" type="date"/></div>
        <div class="field"><label>Importe (â‚¬)</label><input id="revAmount" type="number" min="0.01" step="0.01"/></div>
        <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" type="text"/></div>
        <div class="field"><label>CategorÃ­a</label>
          <select id="revCategory">
            <option value="varios">Varios</option><option value="comida">Comida</option>
            <option value="gasolina">Gasolina</option><option value="peajes">Peajes</option>
            <option value="alojamiento">Hotel</option><option value="transporte">Transportes</option>
            <option value="ocio">Invitaciones</option><option value="servicios">Servicios</option>
            <option value="ingreso">Ingreso</option>
          </select>
        </div>
        <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" rows="2"></textarea></div>
        <div class="preview"><img id="revThumb" style="height:72px"><div id="revInfo" class="small"></div></div>
        <div class="field" style="grid-column:1/3"><label>Foto (opcional)</label><input id="revFile" type="file" accept="image/*"></div>
      </div>
      <footer>
        <button class="btn" id="revCancel">Cancelar</button>
        <button class="btn primary" id="revSave">Guardar</button>
      </footer>
    </div>
  </div>

  <script>
  (function(){
    const log = (m)=>{ const el=$id('log'); el.textContent += (typeof m==='string'?m:JSON.stringify(m))+"\n"; }
    const { auth, db, st } = App;
    AfterRedirect();
    requireAuth(()=>{});

    // Login/Logout
    $id('btnLogin').onclick = ()=> SignIn().catch(e=>alert("Login: "+(e.message||e)));
    auth.onAuthStateChanged(u=>{
      $id('btnLogin').classList.toggle('hidden', !!u);
      $id('btnLogout').classList.toggle('hidden', !u);
    });
    $id('btnLogout').onclick = ()=> auth.signOut();

    // AI modal
    const aiM = $id('aiModal');
    $id('btnAI').onclick=()=>{ aiM.classList.add('open'); $id('aiKey').value=localStorage.getItem('gkey')||''; };
    $id('aiClose').onclick=()=> aiM.classList.remove('open');
    $id('aiSave').onclick=()=>{ const v=$id('aiKey').value.trim(); if(!v) return alert('Pega tu API Key'); localStorage.setItem('gkey', v); aiM.classList.remove('open'); };
    $id('aiClear').onclick=()=>{ localStorage.removeItem('gkey'); $id('aiKey').value=''; };

    // Review modal shared
    const revM=$id('revModal');
    const state={{ file:null }};
    function openReview(data, file) {{
      revM.classList.add('open');
      const dIso=(data.date||new Date()).toString().slice(0,10);
      $id('revDate').value = (data.dateISO||new Date().toISOString().slice(0,10));
      $id('revAmount').value = data.amount||'';
      $id('revProvider').value = data.provider||'';
      $id('revCategory').value = data.category||'varios';
      $id('revNotes').value = data.notes||'';
      state.file = file||null;
      $id('revThumb').src = file ? URL.createObjectURL(file) : '';
      $id('revInfo').textContent = file ? (file.name + ' Â· ' + Math.round(file.size/1024)+' KB') : '';
    }}
    function closeReview(){ revM.classList.remove('open'); }
    $id('revClose').onclick=closeReview; $id('revCancel').onclick=closeReview;

    // Save
    $id('revSave').onclick = async () => {{
      try{{
        const user=auth.currentUser; if(!user) return alert('Login primero');
        const dateISO=$id('revDate').value||new Date().toISOString().slice(0,10);
        const amount=Number($id('revAmount').value||0);
        const provider=$id('revProvider').value.trim();
        const category=$id('revCategory').value;
        const notes=$id('revNotes').value.trim();
        if(!provider) return alert('Proveedor obligatorio');
        if(!amount || amount<=0) return alert('Importe > 0');
        const yyyyMM=dateISO.slice(0,7);
        let photoURL="", photoPath="";
        const file = $id('revFile').files[0] || state.file;
        if(file){{
          const safeProv=(provider||'ticket').replace(/[^a-zA-Z0-9-_ ]/g,'').slice(0,40).replace(/\s+/g,'_');
          const ext=(file.name.split('.').pop()||'jpg').toLowerCase();
          const filename=`${{dateISO}}_${{safeProv}}_${{Date.now()}}.${{ext}}`;
          photoPath = `tickets/${{user.uid}}/${{yyyyMM}}/${{filename}}`;
          await App.st.ref(photoPath).put(file);
          photoURL = await App.st.ref(photoPath).getDownloadURL();
        }}
        await db.collection(`users/${{user.uid}}/entries`).add({{
          date: new Date(dateISO), category, provider, notes, amount,
          photoURL, photoPath, isExpense: category!=='ingreso',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }});
        alert('Guardado âœ…'); closeReview();
      }}catch(e){ alert('Error guardando: '+(e.message||e)); console.error(e); }
    }};

    // Escanear -> usa input de archivo + IA (sÃ³lo estructura bÃ¡sica; OCR real ya lo tenÃ­as)
    const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment';
    function b64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]); r.onerror=rej; r.readAsDataURL(file); }); }
    async function callGemini(base64,mime){{
      const key=(localStorage.getItem('gkey')||'').trim();
      if(!key) throw new Error('Falta API Key (botÃ³n IA)');
      const prompt=`Devuelve SOLO JSON {{\"date\":\"YYYY-MM-DD\",\"provider\":\"Nombre\",\"amount\":0}}`;
      const body={{ contents:[{{role:'user',parts:[{{text:prompt}},{{inlineData:{{mimeType:mime||'image/jpeg',data:base64}}}}]}}] }};
      const url=`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${{encodeURIComponent(key)}}`;
      const r=await fetch(url,{{method:'POST',headers:{{'Content-Type':'application/json'}},body:JSON.stringify(body)}});
      const js=await r.json(); const text=js?.candidates?.[0]?.content?.parts?.[0]?.text||'{{}}';
      try{{ return JSON.parse(text.replace(/```json|```/g,'')); }}catch{{ return {{date:new Date().toISOString().slice(0,10), provider:'Ticket', amount:0}}; }}
    }}
    $id('scanBtn').onclick = async ()=>{{
      try{{
        const u=auth.currentUser; if(!u) return alert('Login primero');
        input.onchange=async()=>{{
          const f=input.files[0]; if(!f) return;
          const base64=await b64(f);
          const res=await callGemini(base64,f.type);
          openReview({{ dateISO:res.date, amount:res.amount, provider:res.provider, category:'varios', notes:'' }}, f);
        }}
        input.click();
      }}catch(e){{ alert('Escanear: '+(e.message||e)); }}
    }};

    // Ingreso manual
    $id('addBtn').onclick = ()=> openReview({{ dateISO:new Date().toISOString().slice(0,10), amount:'', provider:'', category:'ingreso', notes:'' }}, null);
  })();
  </script>
</body>
</html>
