<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gastos 2N</title>
  <meta name="theme-color" content="#0a84ff" />
  <style>
    :root{--bg:#f7f7fb;--card:#ffffff;--ink:#0b0b0f;--muted:#6b7280;--blue:#0a84ff;--border:#e5e7eb;--ok:#34c759;--danger:#ff3b30}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .safe{padding: max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left))}
    .topbar{position:sticky;top:0;z-index:10;background:var(--card);backdrop-filter:saturate(180%) blur(20px);
      border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
    .title{font-weight:700;font-size:18px;letter-spacing:.2px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--ink);border-radius:14px;padding:10px 12px;font:inherit;cursor:pointer}
    .btn.primary{border:none;background:var(--blue);color:#fff;box-shadow:0 6px 16px rgba(10,132,255,.25)}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .btn.ghost{border:1px dashed var(--border);background:transparent}
    .chip{font-size:12px;color:#fff;background:#111;border-radius:999px;padding:6px 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:12px}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .footer{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:10px 14px;display:flex;gap:10px}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;padding:0;background:rgba(0,0,0,.35)}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:560px;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;
      box-shadow:0 -8px 40px rgba(0,0,0,.25);border:1px solid var(--border)}
    .sheet header,.sheet footer{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sheet footer{border-top:1px solid var(--border);border-bottom:none}
    .sheet .body{padding:12px 14px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{padding:10px;border:1px solid var(--border);border-radius:12px;font:inherit;background:#fff}
    .preview{grid-column:1/3;display:flex;gap:10px;align-items:center;border:1px solid var(--border);padding:8px;border-radius:12px}
    .preview img{height:72px;width:auto;border-radius:10px}
    .link{color:var(--blue);text-decoration:none}
  </style>
</head>
<body>
  <header class="topbar safe">
    <div class="row">
      <span class="title">Gastos 2N</span>
      <span id="whoami" class="chip hidden"></span>
    </div>
    <div class="row">
      <button id="btnAI" class="btn icon" title="Guardar API Key de Gemini">‚öôÔ∏è IA</button>
      <button id="btnLogin" class="btn icon">üîê Google</button>
      <button id="btnLogout" class="btn icon hidden">Salir</button>
    </div>
  </header>

  <main class="safe grid" style="max-width:428px;margin:0 auto">
    <section class="card grid">
      <div class="actions">
        <button id="btnScan" class="btn primary icon">üì∏ Escanear ticket</button>
        <button id="btnIngreso" class="btn icon">‚ûï Ingreso manual</button>
      </div>
      <div class="actions">
        <a class="btn icon" id="goExport">üìÅ Exportar</a>
        <a class="btn icon" id="goKM">üöó Gastos de KM</a>
      </div>
      <small class="muted">Optimizado para iPhone 16 Pro Max (tambi√©n funciona en escritorio).</small>
    </section>

    <section class="card">
      <b>Registro r√°pido</b>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <span class="muted">Los tickets se guardan con foto y OCR.</span>
        <a href="#" id="lastMonth" class="link muted">Ver √∫ltimo mes ‚Üí</a>
      </div>
    </section>

    <section class="card">
      <b>Logs</b>
      <pre id="out" class="muted" style="white-space:pre-wrap;max-height:200px;overflow:auto;margin:8px 0 0 0"></pre>
    </section>
  </main>

  <!-- Review / Guardar -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Revisar y guardar</strong>
        <button class="btn" id="closeReview">Cerrar</button>
      </header>
      <div class="body">
        <div class="field"><label>Fecha</label><input id="revDate" type="date"/></div>
        <div class="field"><label>Importe (‚Ç¨)</label><input id="revAmount" type="number" min="0.01" step="0.01"/></div>
        <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" type="text"/></div>
        <div class="field"><label>Categor√≠a</label><select id="revCategory">
          <option value="varios" selected>Varios</option>
          <option value="comida">Comida</option>
          <option value="gasolina">Gasolina</option>
          <option value="peajes">Peajes</option>
          <option value="alojamiento">Hotel</option>
          <option value="transporte">Transportes</option>
          <option value="ocio">Invitaciones</option>
          <option value="servicios">Servicios</option>
          <option value="ingreso">Ingreso</option>
        </select></div>
        <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" rows="2" placeholder="Opcional"></textarea></div>
        <div class="preview"><img id="revThumb"><div id="revFileInfo" class="muted" style="font-size:12px"></div></div>
      </div>
      <footer>
        <button class="btn" id="cancelReview">Cancelar</button>
        <button class="btn primary" id="saveReview">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- IA Key -->
  <div id="aiModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header><strong>Configurar IA</strong><button class="btn" id="closeAI">Cerrar</button></header>
      <div class="body" style="grid-template-columns:1fr">
        <div class="field">
          <label>API Key de Google AI (Gemini)</label>
          <input id="aiKey" type="password" placeholder="AIza..." />
          <small class="muted">Se guarda localmente en este navegador.</small>
        </div>
      </div>
      <footer>
        <button class="btn" id="clearAI">Borrar</button>
        <button class="btn primary" id="saveAI">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"; };

    // Firebase (tu proyecto: gastos-2n)
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

    // ===== Navegaci√≥n =====
    $("goExport").href = "./export.html";
    $("goKM").href = "./km.html"; // (placeholder si luego la creamos)

    // ===== IA modal =====
    (function(){
      const aiModal=$("aiModal");
      const open=()=>{ aiModal.classList.add("open"); $("aiKey").value=localStorage.getItem("gkey")||""; };
      const close=()=> aiModal.classList.remove("open");
      $("btnAI").onclick=open; $("closeAI").onclick=close;
      $("saveAI").onclick=()=>{ const v=$("aiKey").value.trim(); if(!v) return alert("Pega tu API Key"); localStorage.setItem("gkey",v); alert("Guardada ‚úÖ"); close(); };
      $("clearAI").onclick=()=>{ localStorage.removeItem("gkey"); $("aiKey").value=""; alert("Borrada"); };
      window.__ai={open,close};
    })();

    // ===== Auth Google =====
    const provider = new firebase.auth.GoogleAuthProvider();
    $("btnLogin").onclick = async ()=>{
      try{ await auth.signInWithPopup(provider); }catch(e){ console.error(e); alert("Login error: "+(e.message||"")); }
    };
    $("btnLogout").onclick = async ()=>{ await auth.signOut(); };

    auth.onAuthStateChanged((user)=>{
      if(user){
        $("whoami").textContent = user.email||user.uid;
        $("whoami").classList.remove("hidden");
        $("btnLogin").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
      }else{
        $("whoami").classList.add("hidden");
        $("btnLogin").classList.remove("hidden");
        $("btnLogout").classList.add("hidden");
      }
    });

    // ===== OCR helpers =====
    let current = { file:null, base64:"", mime:"image/jpeg", isManual:false };
    function ensureCameraInput(){
      const el=document.createElement("input");
      el.type="file"; el.accept="image/*"; el.capture="environment"; el.style.display="none";
      document.body.appendChild(el); return el;
    }
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{ const rd=new FileReader(); rd.onload=()=>resolve(String(rd.result).split(",")[1]||""); rd.onerror=()=>reject(new Error("No se pudo leer")); rd.readAsDataURL(file); });
    }
    async function downscale(file, max=2048, q=0.9){
      const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
      const scale=Math.min(1,max/Math.max(img.width,img.height));
      const w=Math.round(img.width*scale),h=Math.round(img.height*scale);
      const cv=document.createElement("canvas"); cv.width=w; cv.height=h; cv.getContext("2d").drawImage(img,0,0,w,h);
      const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",q)); URL.revokeObjectURL(img.src);
      return new File([blob], (file.name||"ticket")+".jpg", {type:"image/jpeg"});
    }
    function safeParseJSON(text){
      let s=(text||"").trim(); if(s.startsWith("```")) s=s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
      const a=s.indexOf("{"), b=s.lastIndexOf("}"); if(a!==-1 && b!==-1) s=s.slice(a,b+1);
      return JSON.parse(s);
    }
    function fallbackParse(text){
      const t=(text||"").replace(/\s+/g," ").trim();
      let amount=0; const m=t.match(/(\d+[.,]\d{2})\s*(‚Ç¨|eur)?/i); if(m) amount=Number(m[1].replace(",", "."));
      let dateISO=new Date().toISOString().slice(0,10);
      const d1=t.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/); const d2=t.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
      if(d2) dateISO=`${d2[1]}-${d2[2]}-${d2[3]}`; else if(d1) dateISO=`${d1[3]}-${d1[2]}-${d1[1]}`;
      let provider="Ticket"; const prov=t.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][A-Za-z√Å√â√ç√ì√ö√ë0-9&\-. ]{2,40}/); if(prov) provider=prov[0].trim();
      return { date:dateISO, provider, amount };
    }
    async function callGemini(base64, mime){
      const key=(localStorage.getItem("gkey")||"").trim();
      if(!key){ window.__ai.open(); throw new Error("Falta API Key de Gemini"); }
      const prompt='Devuelve solo JSON: {"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00} (total final, punto decimal).';
      const body={ contents:[{ role:"user", parts:[{text:prompt},{inlineData:{mimeType:mime||"image/jpeg",data:base64}}]}] };
      const models=["gemini-2.5-flash","gemini-2.0-flash"];
      for(const model of models){
        const url=`https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
        const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        const txt=await res.text(); let js=null; try{js=JSON.parse(txt)}catch{}
        if(res.status===429){ await new Promise(r=>setTimeout(r,700)); continue; }
        if(!res.ok){ log({fallo_modelo:model,status:res.status,body:js||txt}); continue; }
        const text=js?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        try{ return safeParseJSON(text); }catch{ return fallbackParse(text); }
      }
      throw new Error("No fue posible extraer datos");
    }

    // ===== Review Modal =====
    const review = { file:null, dateISO:"", amount:0, provider:"", category:"varios", notes:"" };
    function openReview(){
      $("reviewModal").classList.add("open");
      $("revDate").value = review.dateISO || new Date().toISOString().slice(0,10);
      $("revAmount").value = review.amount || "";
      $("revProvider").value = review.provider || "";
      $("revCategory").value = review.category;
      $("revNotes").value = review.notes || "";
      $("revThumb").src = review.file ? URL.createObjectURL(review.file) : "";
      $("revFileInfo").textContent = review.file ? `${review.file.name||"captura"} ¬∑ ${Math.round(review.file.size/1024)} KB` : "Sin imagen";
    }
    function closeReview(){ $("reviewModal").classList.remove("open"); }
    $("closeReview").onclick=closeReview; $("cancelReview").onclick=closeReview;

    $("saveReview").onclick = async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login primero");
        const dateISO=$("revDate").value||new Date().toISOString().slice(0,10);
        const amount=Number($("revAmount").value||0);
        const provider=$("revProvider").value.trim()||"Ticket";
        const category=$("revCategory").value;
        const notes=$("revNotes").value.trim();
        if(!amount || amount<=0) return alert("Importe > 0");

        const yyyyMM=dateISO.slice(0,7);
        let photoURL="", photoPath="";
        if(current.file){
          const safeProv=provider.replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          const ext=(current.file.name.split(".").pop()||"jpg").toLowerCase();
          const filename=`${dateISO}_${safeProv}_${Date.now()}.${ext}`;
          photoPath=`tickets/${user.uid}/${yyyyMM}/${filename}`;
          await storage.ref(photoPath).put(current.file);
          photoURL = await storage.ref(photoPath).getDownloadURL();
        }

        await db.collection(`users/${user.uid}/entries`).add({
          date:new Date(dateISO),
          category, provider, notes, amount,
          photoURL, photoPath,
          isExpense: category!=="ingreso",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Guardado ‚úÖ");
        closeReview();
        current={file:null,base64:"",mime:"image/jpeg",isManual:false};
      }catch(e){ console.error(e); alert("Error guardando: "+(e.message||"")); }
    };

    // ===== Bot√≥n ESCANEAR =====
    $("btnScan").onclick = async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login primero");
        const picker=ensureCameraInput();
        const file=await new Promise((resolve,reject)=>{
          const fn=()=>{ picker.removeEventListener("change",fn); if(picker.files&&picker.files[0]) resolve(picker.files[0]); else reject(new Error("Sin imagen")); };
          picker.addEventListener("change",fn,{once:true}); picker.click();
        });
        const small=await downscale(file,2048,0.9);
        const b64=await fileToBase64(small);
        const res=await callGemini(b64, small.type);
        const d=/^\d{4}-\d{2}-\d{2}$/.test(res.date||"") ? new Date(res.date+"T00:00:00") : new Date();
        current={ file:small, base64:b64, mime:small.type, isManual:false };
        review.dateISO=d.toISOString().slice(0,10);
        review.amount=Number(res.amount||0)||0;
        review.provider=(res.provider||"").toString().slice(0,80)||"Ticket";
        review.category="varios"; review.notes="";
        openReview();
      }catch(e){ console.error(e); alert("OCR error: "+(e.message||"")); }
    };

    // ===== Ingreso manual (sin foto) =====
    $("btnIngreso").onclick = ()=>{
      current={file:null,base64:"",mime:"image/jpeg",isManual:true};
      review.dateISO=new Date().toISOString().slice(0,10);
      review.amount=0; review.provider="Ingreso"; review.category="ingreso"; review.notes="";
      openReview();
    };

    // Acceso r√°pido √∫ltimo mes
    $("lastMonth").onclick=(ev)=>{ ev.preventDefault(); location.href="./export.html"; };
  })();
  </script>
</body>
</html>
