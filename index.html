<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gastos 2N Â· App</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="config.js"></script>
</head>
<body>
<header class="topbar">
  <h1 style="display:flex;gap:.5rem;align-items:center;"><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> Gastos 2N</h1>
  <a class="badge" href="kms.html" title="Gastos de KM">ğŸš— KM</a>
  <a class="badge" href="export.html" title="Exportar">ğŸ“ Export</a>
  <a class="badge" href="summary.html" title="Sumario">ğŸ“Š Sumary</a>
  <button id="btnAI" class="btn ghost" title="Gemini API">âš™ï¸ IA</button>
  <button id="btnLogin" class="btn success">Iniciar sesiÃ³n</button>
  <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Acciones rÃ¡pidas</h2>
      <div class="row">
        <button id="scanBtn" class="btn primary">ğŸ“¸ Escanear ticket</button>
        <button id="manualBtn" class="btn">â• Ingreso manual</button>
        <span id="whoami" class="badge">No autenticado</span>
      </div>
      <div class="small">Consejo: si no hay permisos de escritura, los apuntes se guardan en este navegador y se sincronizan mÃ¡s tarde.</div>
    </div>

    <div class="card">
      <h2>Notas</h2>
      <div class="small">Ãšltimos apuntes</div>
      <div id="lista" class="list"></div>
      <pre id="out" class="small"></pre>
    </div>
  </div>
</main>

<!-- Modal review -->
<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Revisar y guardar</strong><button class="btn" id="closeReview">Cerrar</button></header>
    <div class="body">
      <div class="field"><label>Fecha</label><input id="revDate" type="date"/></div>
      <div class="field"><label>Importe (â‚¬)</label><input id="revAmount" type="number" min="0.01" step="0.01"/></div>
      <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" type="text"/></div>
      <div class="field"><label>CategorÃ­a</label><select id="revCategory">
        <option value="varios" selected>Varios</option>
        <option value="comida">Comida</option>
        <option value="gasolina">Gasolina</option>
        <option value="peajes">Peajes</option>
        <option value="alojamiento">Hotel</option>
        <option value="transporte">Transportes</option>
        <option value="ocio">Invitaciones</option>
        <option value="servicios">Servicios</option>
        <option value="ingreso">Ingreso</option>
      </select></div>
      <div class="field"><label>Pagado con</label><select id="revPaidWith">
        <option value="empresa">Tarjeta empresa</option>
        <option value="mio">Mi dinero</option>
      </select></div>
      <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" rows="2"></textarea></div>
      <div class="row"><button id="btnPick" class="btn">ğŸ“ Adjuntar foto</button><button id="btnCam" class="btn">ğŸ“· Tomar foto</button></div>
      <div class="preview"><img id="revThumb" style="height:72px;border-radius:8px"><div id="revFileInfo" class="small"></div></div>
    </div>
    <footer><div class="left"><span class="small">Se guardarÃ¡ en tu espacio y en el mes correspondiente.</span></div><div class="right"><button class="btn primary" id="saveReview">Guardar</button></div></footer>
  </div>
</div>

<!-- Modal IA -->
<div id="aiModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Configurar IA</strong><button class="btn" id="closeAI">Cerrar</button></header>
    <div class="body" style="grid-template-columns:1fr">
      <div class="field"><label>API Key de Google AI (Gemini)</label><input id="aiKey" type="text" placeholder="AIza..."/><div class="small">Se guarda en este navegador (localStorage).</div></div>
    </div>
    <footer><button class="btn" id="clearAI">Borrar</button><button class="btn primary" id="saveAI">Guardar</button></footer>
  </div>
</div>

<script>
(function(){
  
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const out=$("out"); if(out) out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; });

  // Firebase
  /* firebaseConfig moved to config.js */
const firebaseConfig = window.__FBCONFIG__ || {
  apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
  authDomain: "gastos-2n.firebaseapp.com",
  projectId: "gastos-2n",
  storageBucket: "gastos-2n.appspot.com",
  messagingSenderId: "55010048795",
  appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
});
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Modal helpers
  const openModal = (id)=>{ $(id).classList.add("open"); $(id).setAttribute("aria-hidden","false"); });
  const closeModal = (id)=>{ $(id).classList.remove("open"); $(id).setAttribute("aria-hidden","true"); });

  // IA modal
  var _btnAI=document.getElementById('btnAI'); if(_btnAI){ _btnAI.addEventListener('click', openModal("aiModal");
  var _closeAI=document.getElementById('closeAI'); if(_closeAI){ _closeAI.addEventListener('click', closeModal("aiModal");
  var _saveAI=document.getElementById('saveAI'); if(_saveAI){ _saveAI.addEventListener('click',{ const v=$("aiKey").value.trim(); localStorage.setItem("gkey", v); alert("Guardada âœ…"); closeModal("aiModal"); };
  var _clearAI=document.getElementById('clearAI'); if(_clearAI){ _clearAI.addEventListener('click',{ localStorage.removeItem("gkey"); $("aiKey").value=""; alert("Borrada"); };

  // Login
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.getRedirectResult().catch(()=>{});
  $('btnLogin').onclick = async () => { 
    try{ await auth.signInWithPopup(provider); }
    catch(err){ if(err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user'){ await auth.signInWithRedirect(provider); } else { alert("Error login: "+(err.message||"")); } }
  };
  $('btnLogout').onclick = async () => { await auth.signOut(); };

  auth.onAuthStateChanged((user)=>{
    if(user){
      $("whoami").textContent = `Conectado como ${user.email||user.uid}`;
      $("btnLogin").style.display="none"; $("btnLogout").style.display="";
      cargarUltimos();
    }else{
      $("whoami").textContent = "No autenticado";
      $("btnLogin").style.display=""; $("btnLogout").style.display="none";
      $("lista").innerHTML="";
    }
  });

  // ======= Review flow =======
  let review = { file:null, dateISO:"", amount:0, provider:"", category:"varios", notes:"", paidWith:"empresa" };

  function ensureCameraInput(){ const x=document.createElement("input"); x.type="file"; x.accept="image/*"; x.capture="environment"; x.style.display="none"; document.body.appendChild(x); return x; }
  function fileToBase64(file){ return new Promise((resolve,reject)=>{ const rd=new FileReader(); rd.onload=()=>resolve(String(rd.result).split(",")[1]||""); rd.onerror=()=>reject(new Error("No se pudo leer imagen")); rd.readAsDataURL(file); }); }
  async function downscaleImage(file, max=2048, q=0.9){
    const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
    const scale=Math.min(1,max/Math.max(img.width,img.height));
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    const cv=document.createElement("canvas"); cv.width=w; cv.height=h; cv.getContext("2d").drawImage(img,0,0,w,h);
    const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",q)); URL.revokeObjectURL(img.src);
    return new File([blob], (file.name||"ticket")+".jpg", {type:"image/jpeg"});
  }

  $("manualBtn").onclick = ()=>{ review={ file:null, dateISO:new Date().toISOString().slice(0,10), amount:0, provider:"", category:"varios", notes:"", paidWith:"empresa" }; $("revThumb").src=""; $("revFileInfo").textContent=""; $("revDate").value = new Date().toISOString().slice(0,10); openModal("reviewModal"); };
  // Escanear ticket -> abrir selector/cÃ¡mara y precargar imagen. Si hay API key, intentarÃ¡ OCR (opcional)
  
  $("scanBtn").onclick = ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.capture = "environment";
    inp.onchange = async ()=>{
      if(!inp.files||!inp.files[0]) return;
      try{
        const downs = await downscaleImage(inp.files[0]);
        review.file = downs;
        $("revThumb").src = URL.createObjectURL(downs);
        $("revFileInfo").textContent = downs.name + " Â· " + Math.round(downs.size/1024) + " KB";
        $("revDate").value = new Date().toISOString().slice(0,10);
        openModal("reviewModal");
      }catch(e){ alert("No se pudo abrir la imagen"); }
    };
    inp.click();
  };
    inp.click();
  };

  $("btnPick").onclick=()=>{ const inp=document.createElement("input"); inp.type="file"; inp.accept="image/*"; inp.onchange=async()=>{ if(!inp.files||!inp.files[0]) return; const downs=await downscaleImage(inp.files[0]); review.file=downs; $("revThumb").src=URL.createObjectURL(downs); $("revFileInfo").textContent = downs.name+" Â· "+Math.round(downs.size/1024)+" KB"; }; inp.click(); };
  $("btnCam").onclick = ()=>{ const inp=ensureCameraInput(); inp.onchange=async()=>{ if(!inp.files||!inp.files[0]) return; const downs=await downscaleImage(inp.files[0]); review.file=downs; $("revThumb").src=URL.createObjectURL(downs); $("revFileInfo").textContent = downs.name+" Â· "+Math.round(downs.size/1024)+" KB"; inp.remove(); }; inp.click(); };
  $("closeReview").onclick = ()=> closeModal("reviewModal");
  $("saveReview").onclick = async ()=>{
    const user=auth.currentUser;
    const dateISO = $("revDate").value;
    const amount = Number($("revAmount").value||0);
    const provider = $("revProvider").value.trim();
    const category = $("revCategory").value;
    const paidWith = $("revPaidWith").value;
    const notes = $("revNotes").value;

    try{
      let photoURL=null, photoPath=null;
      if(review.file && user){
        const yyyyMM = dateISO.slice(0,7);
        const safeProv = provider.replace(/[^a-z0-9-_]/gi,"_").toLowerCase()||"ticket";
        const filename=`${dateISO}_${safeProv}_${Date.now()}.jpg`;
        photoPath=`tickets/${user.uid}/${yyyyMM}/${filename}`;
        await firebase.storage().ref(photoPath).put(review.file);
        photoURL=await firebase.storage().ref(photoPath).getDownloadURL();
      }
      if(user){
        await firebase.firestore().collection(`users/${user.uid}/entries`).add({
          date:new Date(dateISO), category, provider, notes, amount, paidWith,
          photoURL, photoPath,
          isExpense: category!=="ingreso",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        throw new Error("local");
      }
      alert("Guardado âœ…"); closeModal("reviewModal"); cargarUltimos();
    }catch(e){
      try{
        const b64 = review.file ? await fileToBase64(review.file) : null;
        const loc = JSON.parse(localStorage.getItem("entries_local")||"[]");
        loc.push({date:dateISO, category, provider, notes, amount, paidWith, photoData:b64, isExpense: category!=="ingreso"});
        localStorage.setItem("entries_local", JSON.stringify(loc));
        alert("Guardado en local (sin permisos).");
        closeModal("reviewModal"); cargarUltimos();
      }catch(err){ alert("Error guardando: "+(e.message||"")); }
    }
  };

  async function cargarUltimos(){
    const user=auth.currentUser;
    const lista=$("lista"); lista.innerHTML="";
    let docs=[];
    try{
      if(user){
        const snap=await db.collection(`users/${user.uid}/entries`).orderBy("date","desc").limit(20).get();
        docs = snap.docs.map(d=>d.data());
      }
    }catch{}
    const local=JSON.parse(localStorage.getItem("entries_local")||"[]");
    docs = [...local.map(d=>({...d, local:true})), ...docs];

    docs.forEach(d=>{
      const dt=d.date?.toDate?d.date.toDate():new Date(d.date);
      const el=document.createElement("div"); el.className="item";
      el.innerHTML=`<div class="left">
        <div class="t">${d.provider||"-"} Â· <span class="small">${d.category}</span> ${d.paidWith==="mio"?'<span class="badge">ğŸ’³ Mi dinero</span>':''}</div>
        <div class="s">${dt.toISOString().slice(0,10)} ${d.notes?('Â· '+d.notes):''}</div>
      </div>
      <div class="right"><strong style="color:${d.isExpense?'#ff6b6b':'#3ee890'}">${(d.isExpense?'-':'+')}${Number(d.amount||0).toFixed(2)}â‚¬</strong> ${d.photoURL?`<a href="${d.photoURL}" target="_blank" class="badge">ticket</a>`:''}</div>`;
      lista.appendChild(el);
    });
  }

})();</script>
</body>
</html>
