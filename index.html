<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gastos 2N ‚Äî Inicio</title>
<style>
:root{
  --bg:#0b0f14;
  --card:#11161c;
  --muted:#97a3b6;
  --accent:#0a84ff;
  --border:#1b2530;
  --ok:#30d158;
  --warn:#ffd60a;
  --bad:#ff453a;
  --txt:#e6edf6;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--txt)}
a{color:var(--accent);text-decoration:none}
.btn{border:1px solid var(--border);background:linear-gradient(180deg,#17202a,#11161c);
  color:var(--txt);padding:10px 14px;border-radius:14px;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
.btn:active{transform:scale(.98)}
.btn.primary{background:linear-gradient(180deg,#0a84ff,#0066cc);border:none;color:#fff}
.btn.ghost{background:transparent}
.btn.warn{background:linear-gradient(180deg,#ffd60a,#bda107);border:none;color:#1a1a1a}
.btn.ok{background:linear-gradient(180deg,#30d158,#248a3d);border:none;color:#061307}
.badge{padding:4px 8px;border-radius:999px;background:#0f1520;border:1px solid var(--border);color:var(--muted);font-size:12px}
.topbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:12px 14px;background:rgba(11,15,20,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.topbar h1{margin:0;font-size:18px;letter-spacing:.3px}
.container{max-width:920px;margin:0 auto;padding:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:1fr 1fr 1fr}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;background:#0e141b;border:1px solid var(--border);border-radius:12px;color:var(--txt);padding:10px;font:inherit}
label{font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.muted{color:var(--muted)}
.hidden{display:none!important}
.list{display:grid;gap:10px}
.item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);background:#0e141b;border-radius:14px;padding:10px}
.item .left{min-width:0}
.item .left p{margin:0}
.item small{color:var(--muted)}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi .k{background:#0e141b;border:1px solid var(--border);border-radius:16px;padding:12px}
.kpi .v{font-weight:700;font-size:18px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
.modal.open{display:flex}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:20px;max-width:520px;width:100%;overflow:hidden}
.sheet header,.sheet footer{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
.sheet footer{border-top:1px solid var(--border);border-bottom:none}
.sheet .body{padding:14px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
.preview{grid-column:1/3;display:flex;gap:10px;align-items:center;border:1px dashed var(--border);padding:10px;border-radius:12px}
</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
  authDomain: "gastos-2n.firebaseapp.com",
  projectId: "gastos-2n",
  storageBucket: "gastos-2n.firebasestorage.app",
  messagingSenderId: "55010048795",
  appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
</script>

</head>
<body>

<header class="topbar">
  <h1>Gastos 2N</h1>
  <span id="whoami" class="badge">No autenticado</span>
  <span style="flex:1"></span>
  <a class="btn ghost" href="./index.html">üè† Inicio</a>
  <a class="btn ghost" href="./export.html">üìÅ Export</a>
  <a class="btn ghost" href="./kms.html">üõ£Ô∏è KMs</a>
  <a class="btn ghost" href="./summary.html">üìä Summary</a>
  <button id="btnLogin" class="btn">üîê Google</button>
  <button id="btnLogout" class="btn hidden">Salir</button>
</header>
<script>
  const who = ()=>document.getElementById('whoami');
  auth.onAuthStateChanged(u=>{
    if(u){ who().textContent = u.email||u.uid;
      document.getElementById('btnLogin').classList.add('hidden');
      document.getElementById('btnLogout').classList.remove('hidden');
    }else{
      who().textContent = 'No autenticado';
      document.getElementById('btnLogin').classList.remove('hidden');
      document.getElementById('btnLogout').classList.add('hidden');
    }
  });
  document.getElementById('btnLogin').onclick = async ()=>{
    try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ alert(e.message||'Login error'); }
  };
  document.getElementById('btnLogout').onclick = ()=>auth.signOut();
</script>

<main class="container grid">
  <section class="card">
    <div class="row">
      <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
      <button id="addManual" class="btn">‚ûï Ingreso manual</button>
      <button id="goExport" class="btn">üìÅ Exportar</button>
      <button id="goKms" class="btn">üõ£Ô∏è Gastos KM</button>
      <button id="goSummary" class="btn">üìä Summary</button>
      <button id="btnAI" class="btn ghost">‚öôÔ∏è IA</button>
    </div>
    <div class="kpi" style="margin-top:12px">
      <div class="k"><div class="muted">Gasto mes</div><div id="k1" class="v">0 ‚Ç¨</div></div>
      <div class="k"><div class="muted">Ingresos mes</div><div id="k2" class="v">0 ‚Ç¨</div></div>
      <div class="k"><div class="muted">Neto</div><div id="k3" class="v">0 ‚Ç¨</div></div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <strong>√öltimos movimientos</strong>
      <span id="monthLabel" class="badge"></span>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <strong>Logs</strong>
    <pre id="out" class="mono" style="max-height:240px;overflow:auto"></pre>
  </section>
</main>

<div id="review" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Revisar y guardar</strong><button class="btn ghost" id="closeReview">Cerrar</button></header>
    <div class="body">
      <div class="field"><label>Fecha</label><input id="revDate" class="input" type="date"/></div>
      <div class="field"><label>Importe (‚Ç¨)</label><input id="revAmount" class="input" type="number" min="0.01" step="0.01"/></div>
      <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" class="input" type="text"/></div>
      <div class="field"><label>Categor√≠a</label><select id="revCategory" class="input">
        <option value="varios" selected>Varios</option>
        <option value="comida">Comida</option>
        <option value="gasolina">Gasolina</option>
        <option value="peajes">Peajes</option>
        <option value="alojamiento">Hotel</option>
        <option value="transporte">Transportes</option>
        <option value="ocio">Invitaciones</option>
        <option value="servicios">Servicios</option>
        <option value="ingreso">Ingreso</option>
      </select></div>
      <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" class="input" rows="2"></textarea></div>
      <div class="preview"><img id="revThumb" style="height:72px;width:auto;border-radius:8px"><div id="revInfo" class="muted" style="font-size:12px"></div></div>
    </div>
    <footer><button class="btn" id="cancelReview">Cancelar</button><button class="btn primary" id="saveReview">Guardar</button></footer>
  </div>
</div>

<div id="aiModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Configurar IA</strong><button class="btn ghost" id="closeAI">Cerrar</button></header>
    <div class="body" style="grid-template-columns:1fr">
      <div class="field">
        <label>API Key de Google AI (Gemini)</label>
        <input id="aiKey" class="input" type="password" placeholder="AIza..." />
        <small class="muted">Se guarda en este navegador.</small>
      </div>
    </div>
    <footer><button class="btn" id="clearAI">Borrar</button><button class="btn primary" id="saveAI">Guardar</button></footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const $ = id=>document.getElementById(id);
function log(m){ const out=$('out'); out.textContent += (typeof m==='string'?m:JSON.stringify(m,null,2)) + "\\n"; }

(function(){
  const aiModal = $("aiModal");
  $("btnAI").onclick = ()=>{ aiModal.classList.add("open"); $("aiKey").value=localStorage.getItem("gkey")||""; };
  $("closeAI").onclick = ()=> aiModal.classList.remove("open");
  $("saveAI").onclick = ()=>{ const v=$("aiKey").value.trim(); if(!v) return alert("Pega tu API Key"); localStorage.setItem("gkey",v); alert("Guardada"); aiModal.classList.remove("open"); };
  $("clearAI").onclick = ()=>{ localStorage.removeItem("gkey"); $("aiKey").value=""; alert("Borrada"); };
})();

const review={file:null,dateISO:"",amount:0,provider:"",category:"varios",notes:""};
function openReview(){
  $("review").classList.add("open");
  $("revDate").value = review.dateISO || new Date().toISOString().slice(0,10);
  $("revAmount").value = review.amount || "";
  $("revProvider").value = review.provider || "";
  $("revCategory").value = review.category;
  $("revNotes").value = review.notes || "";
  $("revThumb").src = review.file ? URL.createObjectURL(review.file) : "";
  $("revInfo").textContent = review.file ? (review.file.name||"captura")+" ¬∑ "+Math.round(review.file.size/1024)+" KB" : "";
}
function closeReview(){ $("review").classList.remove("open"); }
$("closeReview").onclick = closeReview; $("cancelReview").onclick = closeReview;

$("goExport").onclick = ()=> location.href="./export.html";
$("goKms").onclick = ()=> location.href="./kms.html";
$("goSummary").onclick = ()=> location.href="./summary.html";

let hiddenInput;
function ensureCameraInput(){
  if(hiddenInput) return hiddenInput;
  hiddenInput=document.createElement('input');
  hiddenInput.type='file'; hiddenInput.accept='image/*'; hiddenInput.capture='environment';
  hiddenInput.style.display='none'; document.body.appendChild(hiddenInput);
  return hiddenInput;
}
function fileToBase64(file){
  return new Promise((resolve,reject)=>{ const rd=new FileReader(); rd.onload=()=>resolve(String(rd.result).split(',')[1]||''); rd.onerror=()=>reject(new Error('No se pudo leer')); rd.readAsDataURL(file); });
}
async function downscaleImage(file,max=2048,q=.9){
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
  const sc=Math.min(1,max/Math.max(img.width,img.height)); const w=Math.round(img.width*sc), h=Math.round(img.height*sc);
  const cv=document.createElement('canvas'); cv.width=w; cv.height=h; cv.getContext('2d').drawImage(img,0,0,w,h);
  const blob=await new Promise(r=>cv.toBlob(r,'image/jpeg',q)); URL.revokeObjectURL(img.src);
  return new File([blob], (file.name||'ticket')+'.jpg', {type:'image/jpeg'});
}
function safeParseJSON(text){
  let s=(text||'').trim(); if(s.startsWith('```')) s=s.replace(/^```(?:json)?/i,'').replace(/```$/i,'').trim();
  const a=s.indexOf('{'), b=s.lastIndexOf('}'); if(a!=-1 && b!=-1) s=s.slice(a,b+1);
  return JSON.parse(s);
}
function fallbackParse(text){
  const t=(text||'').replace(/\\s+/g,' ').trim();
  let amount=0; const m=t.match(/(\\d+[.,]\\d{2})\\s*(‚Ç¨|eur)?/i); if(m) amount=Number(m[1].replace(',','.'));
  let dateISO=new Date().toISOString().slice(0,10);
  const d1=t.match(/(\\d{2})[\\/\\-](\\d{2})[\\/\\-](\\d{4})/); const d2=t.match(/(\\d{4})[\\/\\-](\\d{2})[\\/\\-](\\d{2})/);
  if(d2) dateISO=`${d2[1]}-${d2[2]}-${d2[3]}`; else if(d1) dateISO=`${d1[3]}-${d1[2]}-${d1[1]}`;
  let provider='Ticket'; const prov=t.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][A-Za-z√Å√â√ç√ì√ö√ë0-9&\\-. ]{2,40}/); if(prov) provider=prov[0].trim();
  return { date:dateISO, provider, amount };
}
async function callGemini(base64,mime){
  const key=(localStorage.getItem('gkey')||'').trim();
  if(!key){ document.getElementById('aiModal').classList.add('open'); throw new Error('Falta API Key'); }
  const prompt=`Devuelve solo un JSON v√°lido: {"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00}`;
  const body={ contents:[{ role:'user', parts:[{text:prompt},{inlineData:{mimeType:mime||'image/jpeg',data:base64}}] }] };
  const models=['gemini-2.5-flash','gemini-2.0-flash'];
  for(const model of models){
    const url=`https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const txt=await res.text(); let js=null; try{js=JSON.parse(txt)}catch{}
    if(res.status===429){ await new Promise(r=>setTimeout(r,800)); continue; }
    if(!res.ok){ log({fallo_modelo:model,status:res.status,body:js||txt}); continue; }
    const text=js?.candidates?.[0]?.content?.parts?.[0]?.text||'';
    try{ return safeParseJSON(text); }catch{ return fallbackParse(text); }
  }
  throw new Error('No fue posible extraer datos');
}

function monthRange(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
async function refreshList(){
  const u=auth.currentUser; if(!u) return;
  const ym=new Date().toISOString().slice(0,7); document.getElementById('monthLabel').textContent=ym;
  const ref=db.collection(`users/${u.uid}/entries`).orderBy('createdAt','desc').limit(20);
  const snap=await ref.get(); const list=$('list'); list.innerHTML='';
  let sumE=0, sumI=0;
  snap.forEach(doc=>{
    const d=doc.data(); const dt=d.date?.toDate?d.date.toDate():new Date(d.date);
    const isExp = d.category!=='ingreso'; const amt=Number(d.amount||0);
    if(isExp) sumE+=amt; else sumI+=amt;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`
      <div class="left">
        <p><strong>${d.provider||'-'}</strong> <small class="muted">¬∑ ${d.category}</small></p>
        <small>${dt.toISOString().slice(0,10)} ‚Äî ${d.notes||''}</small>
      </div>
      <div class="right">
        <strong style="color:${isExp?'#ff453a':'#30d158'}">${isExp?'-':''}${amt.toFixed(2)} ‚Ç¨</strong>
      </div>`;
    list.appendChild(div);
  });
  document.getElementById('k1').textContent = (sumE).toFixed(2)+' ‚Ç¨';
  document.getElementById('k2').textContent = (sumI).toFixed(2)+' ‚Ç¨';
  document.getElementById('k3').textContent = (sumI-sumE).toFixed(2)+' ‚Ç¨';
}
auth.onAuthStateChanged(u=>{ if(u) refreshList(); });

document.getElementById('scanBtn').onclick = async ()=>{
  try{
    const u=auth.currentUser; if(!u) return alert('Haz login');
    const input=ensureCameraInput();
    const file=await new Promise((resolve,reject)=>{
      const fn=()=>{ input.removeEventListener('change',fn); if(input.files&&input.files[0]) resolve(input.files[0]); else reject(new Error('Sin imagen')); };
      input.addEventListener('change',fn,{once:true}); input.click();
    });
    const compact=await downscaleImage(file,2048,.9);
    const b64=await fileToBase64(compact);
    const res=await callGemini(b64, compact.type);
    review.file=compact; review.dateISO=(/\d{4}-\d{2}-\d{2}/.test(res.date||''))?res.date:new Date().toISOString().slice(0,10);
    review.amount=Number(res.amount||0)||0; review.provider=(res.provider||'Ticket').toString().slice(0,80);
    review.category='varios'; review.notes='';
    openReview();
  }catch(e){ console.error(e); log(e.message||e); alert('OCR error: '+(e.message||'')); }
};

document.getElementById('addManual').onclick = ()=>{
  review.file=null; review.dateISO=new Date().toISOString().slice(0,10);
  review.amount=0; review.provider='Ingreso'; review.category='ingreso'; review.notes='';
  openReview();
};

document.getElementById('saveReview').onclick = async ()=>{
  try{
    const u=auth.currentUser; if(!u) return alert('Haz login');
    const dateISO=document.getElementById('revDate').value||new Date().toISOString().slice(0,10);
    const amount=Number(document.getElementById('revAmount').value||0);
    const provider=document.getElementById('revProvider').value.trim();
    const category=document.getElementById('revCategory').value;
    const notes=document.getElementById('revNotes').value.trim();
    if(!provider) return alert('Proveedor obligatorio');
    if(!amount || amount<=0) return alert('Importe > 0');
    const yyyyMM=dateISO.slice(0,7);
    let photoURL='', photoPath='';
    if(review.file){
      const safeProv=(provider||'ticket').replace(/[^a-zA-Z0-9-_ ]/g,'').slice(0,40).replace(/\s+/g,'_');
      const ext=(review.file.name.split('.').pop()||'jpg').toLowerCase();
      const filename=`${dateISO}_${safeProv}_${Date.now()}.${ext}`;
      photoPath=`tickets/${u.uid}/${yyyyMM}/${filename}`;
      await storage.ref(photoPath).put(review.file);
      photoURL=await storage.ref(photoPath).getDownloadURL();
    }
    await db.collection(`users/${u.uid}/entries`).add({
      date:new Date(dateISO),
      category, provider, notes, amount,
      photoURL, photoPath,
      isExpense:category!=='ingreso',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Guardado ‚úÖ'); closeReview(); refreshList();
  }catch(e){ console.error(e); log(e); alert('Error guardando: '+(e.message||'')); }
};
</script>
</body>
</html>
