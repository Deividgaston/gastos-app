<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gastos 2N ¬∑ App</title>

<link rel="stylesheet" href="assets/style.css">
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="config.js"></script>

</head>
<body>
<header class="topbar">
  <h1><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> Gastos 2N</h1>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Sumary</a>
  <button id="btnAI" class="btn" title="Gemini API">‚öôÔ∏è IA</button>
  <div class="header-actions">
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Acciones r√°pidas</h2>
      <div class="row">
        <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
        <button id="manualBtn" class="btn">Ôºã Ingreso manual</button>
        <span id="whoami" class="badge">No autenticado</span>
      </div>
      <div class="small">Consejo: si no hay permisos de escritura, los apuntes se guardan en este navegador y se sincronizan m√°s tarde.</div>
    </div>

    <div class="card">
      <h2>Notas</h2>
      <div id="lista" class="list"></div>
      <pre id="out" class="small"></pre>
    </div>
  </div>
</main>

<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Revisar y guardar</h3>
      <button id="closeReview" class="btn">Cerrar</button>
    </div>
    <div class="row">
      <div>
        <label>Fecha</label><br>
        <input id="revDate" type="date">
      </div>
      <div>
        <label>Importe (‚Ç¨)</label><br>
        <input id="revAmount" type="number" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label>Proveedor</label><br>
        <input id="revProvider" placeholder="Proveedor">
      </div>
      <div>
        <label>Categor√≠a</label><br>
        <select id="revCategory">
          <option value="comida">Comida</option>
          <option value="peajes">Peajes</option>
          <option value="gasolina">Gasolina</option>
          <option value="transporte">Transporte</option>
          <option value="alojamiento">Alojamiento</option>
          <option value="ocio">Ocio</option>
          <option value="servicios">Servicios</option>
          <option value="varios" selected>Varios</option>
          <option value="ingreso">Ingreso</option>
        </select>
      </div>
      <div>
        <label>Pagado con</label><br>
        <select id="revPaidWith">
          <option value="empresa" selected>Tarjeta empresa</option>
          <option value="personal">Mi dinero</option>
        </select>
      </div>
    </div>
    <div class="row">
      <textarea id="revNotes" rows="3" style="flex:1" placeholder="Notas"></textarea>
      <img id="revThumb" class="thumb" alt="preview"/>
    </div>
    <div class="small" id="revFileInfo"></div>
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="btnPick" class="btn">üìé Adjuntar foto</button>
        <button id="btnCam" class="btn">üì∑ Tomar foto</button>
      </div>
      <button id="saveReview" class="btn primary">Guardar</button>
    </div>
    <div class="small">Se guardar√° en tu espacio y en el mes correspondiente.</div>
  </div>
</div>

<div id="aiModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>API Key de Gemini</h3>
      <button id="closeAI" class="btn">Cerrar</button>
    </div>
    <input id="aiKey" placeholder="AIzaSy..." style="width:100%" />
    <div class="row" style="justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="clearAI" class="btn">Borrar</button>
      <button id="saveAI" class="btn primary">Guardar</button>
    </div>
  </div>
</div>

<script>
(function(){
  try{
    if (!firebase.apps || !firebase.apps.length) { firebase.initializeApp(window.__FBCONFIG__); }
    var auth = firebase.auth();
    if (firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    }
    if (auth.getRedirectResult) { auth.getRedirectResult().catch(()=>{}); }

    function updateUI(user){
      var who = document.getElementById('whoami');
      var btnLogin = document.getElementById('btnLogin');
      var btnLogout = document.getElementById('btnLogout');
      if(user){
        if(who) who.textContent = "Conectado como " + (user.email || user.uid);
        if(btnLogin) btnLogin.style.display = "none";
        if(btnLogout) btnLogout.style.display = "";
      }else{
        if(who) who.textContent = "No autenticado";
        if(btnLogin) btnLogin.style.display = "";
        if(btnLogout) btnLogout.style.display = "none";
      }
      try{ document.dispatchEvent(new CustomEvent('auth-changed',{detail:{user:user}})); }catch(e){}
    }
    auth.onAuthStateChanged(updateUI);

    window.__APPCTX__ = {
      auth: auth,
      db: firebase.firestore ? firebase.firestore() : null,
      storage: firebase.storage ? firebase.storage() : null
    };

    var provider = new firebase.auth.GoogleAuthProvider();
    var bL = document.getElementById('btnLogin');
    if(bL){ bL.addEventListener('click', async ()=>{
      try{ await auth.signInWithPopup(provider); }catch(err){
        if(err && (err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user')){
          await auth.signInWithRedirect(provider);
        } else { alert("Error login: "+(err.message||"")); }
      }
    });}
    var bO = document.getElementById('btnLogout');
    if(bO){ bO.addEventListener('click', ()=>auth.signOut()); }

    var bIA = document.getElementById('btnAI');
    if(bIA){ bIA.addEventListener('click', ()=>{ var m=document.getElementById('aiModal'); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }); }
    var bClose = document.getElementById('closeAI');
    if(bClose){ bClose.addEventListener('click', ()=>{ var m=document.getElementById('aiModal'); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }); }
    var bSave = document.getElementById('saveAI');
    if(bSave){ bSave.addEventListener('click', ()=>{ try{ localStorage.setItem('gkey', document.getElementById('aiKey').value.trim()); alert('Guardada ‚úÖ'); document.getElementById('closeAI').click(); }catch{} }); }
    var bClr = document.getElementById('clearAI');
    if(bClr){ bClr.addEventListener('click', ()=>{ try{ localStorage.removeItem('gkey'); document.getElementById('aiKey').value=''; alert('Borrada'); }catch{} }); }
  }catch(e){ console.error('Auth bootstrap error', e); }
})();
</script>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function openModal(id){ var m=$(id); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }
  function closeModal(id){ var m=$(id); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }

  async function downscaleImage(file, max=2048, q=0.9){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, max / Math.max(img.width, img.height));
        const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
        const cv = document.createElement('canvas'); cv.width=w; cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        cv.toBlob((blob)=>{ resolve(new File([blob], (file.name||'ticket')+'.jpg', {type:'image/jpeg'})); }, 'image/jpeg', q);
      };
      img.onerror = reject; img.src = URL.createObjectURL(file);
    });
  }

  function attachPick(fromCamera){
    const inp=document.createElement('input');
    inp.type='file'; inp.accept='image/*'; if(fromCamera) inp.capture='environment';
    inp.onchange = async ()=>{
      const f = inp.files && inp.files[0]; if(!f) return;
      const downs = await downscaleImage(f);
      window.__lastPickedFile = downs;
      $('revThumb').src = URL.createObjectURL(downs);
      $('revFileInfo').textContent = downs.name+' ¬∑ '+Math.round(downs.size/1024)+' KB';
      $('revDate').value = new Date().toISOString().slice(0,10);
      openModal('reviewModal');
      setTimeout(tryOCR, 150);
    };
    inp.click();
  }

  const btnPick = $('btnPick'); if(btnPick) btnPick.addEventListener('click', ()=>attachPick(false));
  const btnCam  = $('btnCam');  if(btnCam)  btnCam.addEventListener('click',  ()=>attachPick(true));
  const scanBtn = $('scanBtn'); if(scanBtn) scanBtn.addEventListener('click', ()=>attachPick(true));
  const closeBtn= $('closeReview'); if(closeBtn) closeBtn.addEventListener('click', ()=>closeModal('reviewModal'));

  async function tryOCR(){
    try{
      const key = localStorage.getItem('gkey'); if(!key) return;
      const file = window.__lastPickedFile; if(!file) return;
      const ab = await file.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(ab)));
      const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key='+encodeURIComponent(key),{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          contents:[{role:'user', parts:[
            {text:'Extrae proveedor, fecha (YYYY-MM-DD), categor√≠a (comida, peajes, gasolina, transporte, alojamiento, ocio, servicios, varios o ingreso) e importe total EUR. Responde JSON con provider,date,category,amount.'},
            {inline_data:{mime_type:'image/jpeg', data:b64}}
          ]}]
        })
      });
      const data = await resp.json();
      const text = data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text || '';
      const m = text && text.match(/\{[\s\S]*\}/);
      if(!m) return;
      const j = JSON.parse(m[0]);
      if(j.provider) $('revProvider').value = j.provider;
      if(j.date) $('revDate').value = j.date;
      if(j.amount) $('revAmount').value = Number(j.amount||0);
      if(j.category){
        let c = String(j.category).toLowerCase();
        if(!/comida|peajes|gasolina|transporte|alojamiento|ocio|servicios|varios|ingreso/.test(c)) c='varios';
        $('revCategory').value = c;
      }
    }catch(e){ console.warn('OCR no aplicado', e); }
  }

  const saveBtn = $('saveReview');
  if(saveBtn){
    saveBtn.addEventListener('click', async ()=>{
      const ctx = window.__APPCTX__ || {};
      const auth = ctx.auth, db = ctx.db, storage = ctx.storage;
      const user = auth && auth.currentUser;
      const dateISO = $('revDate').value || new Date().toISOString().slice(0,10);
      const amount  = Number($('revAmount').value || 0);
      const provider= $('revProvider').value.trim() || '';
      const category= $('revCategory').value || 'varios';
      const paidWith= $('revPaidWith').value || 'empresa';
      const notes   = $('revNotes').value || '';
      const file    = window.__lastPickedFile || null;

      try{
        let photoURL=null, photoPath=null;
        if(file && user && storage){
          const yyyyMM = dateISO.slice(0,7);
          const safeProv = (provider||'ticket').replace(/[^a-z0-9-_]/gi,'_').toLowerCase();
          const filename = dateISO+'_'+safeProv+'_'+Date.now()+'.jpg';
          photoPath = 'tickets/'+user.uid+'/'+yyyyMM+'/'+filename;
          await storage.ref(photoPath).put(file);
          photoURL = await storage.ref(photoPath).getDownloadURL();
        }

        if(user && db){
          await db.collection('users/'+user.uid+'/entries').add({
            date:new Date(dateISO), category, provider, notes, amount, paidWith,
            photoURL, photoPath,
            isExpense: category!=='ingreso',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Guardado ‚úÖ');
        }else{
          const arr = JSON.parse(localStorage.getItem('entries_local')||'[]');
          arr.push({date:dateISO, category, provider, notes, amount, paidWith, isExpense: category!=='ingreso'});
          localStorage.setItem('entries_local', JSON.stringify(arr));
          alert('Guardado en local (sin login).');
        }
        closeModal('reviewModal');
        document.dispatchEvent(new CustomEvent('entries-updated'));
      }catch(e){
        alert('Error guardando: '+(e && e.message || ''));
        console.error(e);
      }
    });
  }
})();
</script>
</body>
</html>
