
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Gastos 2N</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <style>
    :root{
      --bg:#0b0c0f; --card:#12141a; --muted:#8a8f98; --text:#eef2f7;
      --blue:#0a84ff; --green:#30d158; --red:#ff453a; --sep:rgba(255,255,255,.06);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto}
    .safe{padding-top:constant(safe-area-inset-top);padding-top:env(safe-area-inset-top)}
    .shell{max-width:428px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
    header.top{position:sticky;top:0;z-index:5;backdrop-filter:saturate(180%) blur(18px);background:rgba(11,12,15,.6);border-bottom:1px solid var(--sep)}
    .top-inner{display:flex;gap:10px;align-items:center;padding:14px 16px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .spacer{flex:1}
    .iconbtn{background:linear-gradient(180deg,#1a1d24,#12141a);border:1px solid var(--sep);border-radius:14px;padding:10px;display:inline-flex;align-items:center;gap:8px;color:var(--text);box-shadow:var(--shadow);cursor:pointer}
    .iconbtn.primary{background:linear-gradient(180deg,#0f6bd8,#0a58b5);border-color:rgba(255,255,255,.15)}
    .iconbtn.green{background:linear-gradient(180deg,#2fbf66,#27a95a)}
    .grid{display:grid;gap:12px;padding:16px}
    .card{background:linear-gradient(180deg,#181b23,#12141a);border:1px solid var(--sep);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;gap:12px}
    .title{font-size:15px;font-weight:600}
    .muted{color:var(--muted)}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--sep);font-size:12px;color:var(--muted)}
    .bigbtn{display:flex;gap:12px;align-items:center;justify-content:center;padding:14px;border-radius:18px;border:1px solid var(--sep);background:linear-gradient(180deg,#191d25,#141720);box-shadow:var(--shadow);cursor:pointer}
    .bigbtn .emoji{font-size:22px}
    .cta{background:linear-gradient(180deg,#0a84ff,#0063e5);color:white;border:0}
    .hidden{display:none!important}
    .list{display:grid;gap:8px}
    .log{background:#0f1116;border:1px solid var(--sep);border-radius:16px;padding:10px;white-space:pre-wrap;max-height:200px;overflow:auto;color:#b7c4d6}
    a{color:#a3c8ff;text-decoration:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js" type="module"></script>

</head>
<body class="safe">
  <div class="shell">
    <header class="top">
      <div class="top-inner">
        <h1>Gastos 2N</h1>
        <span class="chip" id="whoami">Invitado</span>
        <div class="spacer"></div>
        <button id="btnAI" class="iconbtn" title="API Key IA">‚öôÔ∏è</button>
        <button id="btnLogin" class="iconbtn primary" title="Entrar Google">‚ûï</button>
        <button id="btnLogout" class="iconbtn hidden" title="Salir">‚Ü©Ô∏é</button>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">Capturar ticket</div>
            <div class="muted">Usa la c√°mara del iPhone para OCR</div>
          </div>
          <button id="scanBtn" class="bigbtn cta"><span class="emoji">üì∏</span> Escanear</button>
        </div>
      </section>

      <section class="grid" style="grid-template-columns:1fr 1fr">
        <a class="bigbtn" href="export-dashboard.html"><span class="emoji">üìä</span> Exportar</a>
        <a class="bigbtn" href="kms.html"><span class="emoji">üöó</span> Gastos KM</a>
      </section>

      <section class="card">
        <div class="title">Actividad</div>
        <div class="log" id="out"></div>
      </section>
    </main>
  </div>

  <dialog id="aiDlg" style="max-width:420px;background:#12141a;color:#eef2f7;border:1px solid var(--sep);border-radius:18px">
    <form method="dialog" style="padding:16px;display:grid;gap:12px">
      <h3 style="margin:0">Configurar IA</h3>
      <label>API Key Gemini
        <input id="aiKey" type="password" placeholder="AIza..." style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--sep);background:#0f1116;color:#fff">
      </label>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="aiClear" class="iconbtn">Borrar</button>
        <button id="aiSave" class="iconbtn primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


const firebaseConfig = {
  apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
  authDomain: "gastos-2n.firebaseapp.com",
  projectId: "gastos-2n",
  storageBucket: "gastos-2n.firebasestorage.app",
  messagingSenderId: "55010048795",
  appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const stg  = getStorage(app, "gs://gastos-2n.firebasestorage.app");

    const $ = id=>document.getElementById(id);
    const log = m=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; out.scrollTop=out.scrollHeight; };

    const dlg = $("aiDlg");
    $("btnAI").onclick = ()=>{ $("aiKey").value=localStorage.getItem("gkey")||""; dlg.showModal(); };
    $("aiClear").onclick = (e)=>{ e.preventDefault(); localStorage.removeItem("gkey"); $("aiKey").value=""; };
    $("aiSave").onclick = (e)=>{ e.preventDefault(); const v=$("aiKey").value.trim(); if(!v) return; localStorage.setItem("gkey", v); dlg.close(); };

    const provider = new GoogleAuthProvider();
    $("btnLogin").onclick = async ()=>{ try{ await signInWithPopup(auth, provider); }catch(e){ log(e); alert(e.message||"Login error"); } };
    $("btnLogout").onclick = async ()=>{ await signOut(auth); };
    onAuthStateChanged(auth, (user)=>{
      if(user){ $("whoami").textContent = user.email||user.uid; $("btnLogin").classList.add("hidden"); $("btnLogout").classList.remove("hidden"); }
      else { $("whoami").textContent = "Invitado"; $("btnLogin").classList.remove("hidden"); $("btnLogout").classList.add("hidden"); }
    });

    function ensureInput(){
      const i=document.createElement("input");
      i.type="file"; i.accept="image/*"; i.capture="environment"; i.style.display="none"; document.body.appendChild(i);
      return i;
    }
    function downscale(file, max=2048, q=0.9){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>{
          const s = Math.min(1, max/Math.max(img.width,img.height));
          const w = Math.round(img.width*s), h = Math.round(img.height*s);
          const c = document.createElement("canvas"); c.width=w; c.height=h; c.getContext("2d").drawImage(img,0,0,w,h);
          c.toBlob(b=>resolve(new File([b], (file.name||"ticket")+".jpg", {type:"image/jpeg"})), "image/jpeg", q);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }
    function toBase64(file){
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(",")[1]||""); r.onerror=rej; r.readAsDataURL(file); });
    }
    function safeParse(text){
      try{ let t=(text||"").trim(); if(t.startsWith("```")) t=t.replace(/^```(?:json)?/i,"").replace(/```$/,"").trim(); const a=t.indexOf("{"), b=t.lastIndexOf("}"); if(a>-1&&b>-1) t=t.slice(a,b+1); return JSON.parse(t); }catch{}
      return null;
    }
    async function callGemini(b64){
      const key=(localStorage.getItem("gkey")||"").trim(); if(!key) throw new Error("Falta API Key (pulsa ‚öôÔ∏è)");
      const body = { contents:[{ role:"user", parts:[
        {text:`Devuelve solo JSON v√°lido: {\"date\":\"YYYY-MM-DD\",\"provider\":\"Nombre\",\"amount\":0.00}`},
        {inlineData:{mimeType:"image/jpeg", data:b64}}
      ] }]};
      const models = ["gemini-2.5-flash","gemini-2.0-flash"];
      for(const m of models){
        const url=`https://generativelanguage.googleapis.com/v1/models/${m}:generateContent?key=${encodeURIComponent(key)}`;
        const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
        const txt = await r.text(); let js=null; try{ js=JSON.parse(txt) }catch{}
        if(!r.ok){ log({modelo:m,status:r.status,body:js||txt}); if(r.status===429) await new Promise(X=>setTimeout(X,800)); continue; }
        const text = js?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        const parsed = safeParse(text);
        if(parsed) return parsed;
      }
      throw new Error("OCR sin respuesta v√°lida");
    }

    async function saveEntry(file, data){
      const user=auth.currentUser; if(!user) throw new Error("Login requerido");
      const dateISO = /^\d{4}-\d{2}-\d{2}$/.test(data.date||"") ? data.date : new Date().toISOString().slice(0,10);
      const yyyyMM = dateISO.slice(0,7);
      const prov = (data.provider||"Ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
      const name = `${dateISO}_${prov}_${Date.now()}.jpg`;
      const path = `tickets/${user.uid}/${yyyyMM}/${name}`;
      const r = ref(stg, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      await addDoc(collection(db, `users/${user.uid}/entries`), {
        date: new Date(dateISO),
        category: "varios",
        provider: data.provider||"Ticket",
        notes: "",
        amount: Number(data.amount||0)||0,
        isExpense: true,
        photoURL: url,
        photoPath: path,
        createdAt: serverTimestamp()
      });
      log("‚úÖ Guardado");
    }

    document.getElementById("scanBtn").onclick = async ()=>{
      try{
        const u=auth.currentUser; if(!u) return alert("Haz login con Google");
        const inp=ensureInput();
        const file = await new Promise((resolve,reject)=>{ const once=()=>{ inp.removeEventListener("change", once); if(inp.files&&inp.files[0]) resolve(inp.files[0]); else reject(new Error("Sin imagen")); }; inp.addEventListener("change", once, {once:true}); inp.click(); });
        const compact = await downscale(file, 2048, .9);
        log(`üì∑ ${compact.name} (${Math.round(compact.size/1024)} KB)`);
        const b64 = await toBase64(compact);
        const data = await callGemini(b64);
        await saveEntry(compact, data);
        alert("Ticket guardado ‚úÖ");
      }catch(e){ console.error(e); log(e); alert(e.message||"Error"); }
    };
  </script>
</body>
</html>
