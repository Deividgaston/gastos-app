<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ¬∑ Registrar</title>
  <meta name="theme-color" content="#111827">
  <style>
    :root{
      --bg:#0b0c10; --panel:#151824; --muted:#7b7f8c; --brand:#0a84ff; --ok:#34c759; --danger:#ff3b30; --border:#232635;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:var(--bg);color:#e5e7eb;}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,12,16,.8);backdrop-filter:saturate(180%) blur(10px);z-index:10}
    .top h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--border);background:#0f1220;color:#e5e7eb;border-radius:12px;padding:9px 12px;font:inherit;cursor:pointer}
    .btn.primary{background:var(--brand);border:none;color:#fff}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .input,select,textarea{background:#0f1220;border:1px solid var(--border);border-radius:12px;padding:10px;color:#e5e7eb;font:inherit}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .preview{display:flex;gap:10px;align-items:center;border:1px dashed var(--border);border-radius:12px;padding:8px;background:#0f1220}
    .chip{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;justify-content:flex-end}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:#0f1220;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:#cbd5e1}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);padding:16px;z-index:50}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:560px;background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden}
    .sheet header,.sheet footer{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sheet footer{border-bottom:none;border-top:1px solid var(--border)}
    .sheet .body{padding:14px;display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .space{height:6px}
    a.link{color:#9ecbff;text-decoration:none}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Firebase compat SDKs (muy estables en GH Pages) -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="top">
    <h1>Gastos 2N</h1>
    <span class="pill" id="userPill">No autenticado</span>
    <div style="margin-left:auto" class="row">
      <button id="btnAI" class="btn">‚öôÔ∏è IA</button>
      <button id="btnExport" class="btn">üìÅ Exportar</button>
      <button id="btnLogin" class="btn primary">Entrar con Google</button>
      <button id="btnLogout" class="btn ghost" style="display:none">Salir</button>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="row">
        <button id="scanBtn" class="btn primary">üì∑ Escanear ticket</button>
        <span class="chip">Usa IA para extraer <span class="kbd">fecha</span>, <span class="kbd">proveedor</span> e <span class="kbd">importe</span>.</span>
      </div>
      <div class="space"></div>
      <div class="grid">
        <div class="field">
          <label>Fecha</label>
          <input id="fDate" type="date" class="input">
        </div>
        <div class="field">
          <label>Importe (‚Ç¨)</label>
          <input id="fAmount" type="number" class="input" min="0.01" step="0.01" placeholder="0,00">
        </div>
        <div class="field">
          <label>Proveedor</label>
          <input id="fProvider" class="input" placeholder="Ej: Repsol, Restaurante X">
        </div>
        <div class="field">
          <label>Categor√≠a</label>
          <select id="fCategory" class="input">
            <option value="varios" selected>Varios</option>
            <option value="comida">Comida</option>
            <option value="gasolina">Gasolina</option>
            <option value="peajes">Peajes</option>
            <option value="alojamiento">Hotel</option>
            <option value="transporte">Transportes</option>
            <option value="ocio">Invitaciones</option>
            <option value="servicios">Servicios</option>
            <option value="ingreso">Ingreso</option>
          </select>
        </div>
        <div class="field" style="grid-column:1/3">
          <label>Notas</label>
          <textarea id="fNotes" rows="2" class="input" placeholder="Opcional"></textarea>
        </div>
        <div class="preview" style="grid-column:1/3">
          <img id="thumb" alt="" style="height:78px;border-radius:10px;display:none">
          <div class="chip" id="fileInfo">Sin imagen</div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="saveBtn" class="btn">üíæ Guardar</button>
      </div>
    </div>

    <div class="panel">
      <strong>Logs</strong>
      <pre id="out" style="white-space:pre-wrap;background:#0f1220;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:260px;overflow:auto"></pre>
    </div>
  </div>

  <!-- Modal IA -->
  <div id="aiModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Configurar IA (Gemini)</strong>
        <button class="btn" id="closeAI">Cerrar</button>
      </header>
      <div class="body" style="grid-template-columns:1fr">
        <div class="field">
          <label>API Key de Google AI</label>
          <input id="aiKey" class="input" type="password" placeholder="AIza...">
          <small class="muted">Se guarda solo en este navegador (localStorage).</small>
        </div>
      </div>
      <footer>
        <button id="clearAI" class="btn">Borrar</button>
        <button id="saveAI" class="btn primary">Guardar</button>
      </footer>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"; out.scrollTop=out.scrollHeight; };

  // ==== Firebase config (gastos-2n) ====
  const firebaseConfig = {
    apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain: "gastos-2n.firebaseapp.com",
    projectId: "gastos-2n",
    storageBucket: "gastos-2n.firebasestorage.app",
    messagingSenderId: "55010048795",
    appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ==== UI helpers ====
  function setUser(u){
    if(u){
      $("userPill").textContent = `Conectado como ${u.email||u.uid}`;
      $("btnLogin").style.display="none";
      $("btnLogout").style.display="inline-flex";
    }else{
      $("userPill").textContent = "No autenticado";
      $("btnLogin").style.display="inline-flex";
      $("btnLogout").style.display="none";
    }
  }

  // ==== Auth ====
  const provider = new firebase.auth.GoogleAuthProvider();
  $("btnLogin").onclick = async ()=>{
    try{ await auth.signInWithPopup(provider); }catch(e){ alert(e.message||"Error login"); log(e); }
  };
  $("btnLogout").onclick = async ()=>{ await auth.signOut(); };
  auth.onAuthStateChanged(setUser);

  // ==== AI Key modal ====
  const aiModal = $("aiModal");
  $("btnAI").onclick = ()=>{ aiModal.classList.add("open"); $("aiKey").value=localStorage.getItem("gkey")||""; };
  $("closeAI").onclick = ()=> aiModal.classList.remove("open");
  $("saveAI").onclick = ()=>{ const v=$("aiKey").value.trim(); if(!v) return alert("Pega tu API key"); localStorage.setItem("gkey",v); aiModal.classList.remove("open"); alert("Guardada ‚úÖ"); };
  $("clearAI").onclick = ()=>{ localStorage.removeItem("gkey"); $("aiKey").value=""; };

  // ==== Export ===
  $("btnExport").onclick = ()=>{ window.location.href = "./export.html"; };

  // ==== Capture helpers ====
  let currentFile = null;
  function ensureFileInput(){
    let el = document.createElement("input");
    el.type="file"; el.accept="image/*"; el.capture="environment"; el.style.display="none";
    document.body.appendChild(el);
    return el;
  }
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const rd=new FileReader();
      rd.onload=()=>resolve(String(rd.result).split(",")[1]||"");
      rd.onerror=()=>reject(new Error("No se pudo leer imagen"));
      rd.readAsDataURL(file);
    });
  }
  async function downscale(file, max=2048, q=.9){
    const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
    const scale=Math.min(1, max/Math.max(img.width,img.height));
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    const cv=document.createElement("canvas"); cv.width=w; cv.height=h; cv.getContext("2d").drawImage(img,0,0,w,h);
    const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",q));
    URL.revokeObjectURL(img.src);
    return new File([blob], (file.name||"ticket")+".jpg", {type:"image/jpeg"});
  }
  function safeParseJSON(text){
    let s=(text||"").trim();
    if(s.startsWith("```")) s=s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
    const a=s.indexOf("{"), b=s.lastIndexOf("}"); if(a!==-1 && b!==-1) s=s.slice(a,b+1);
    return JSON.parse(s);
  }
  function fallbackParse(text){
    const t=(text||"").replace(/\s+/g," ").trim();
    let amount=0; const m=t.match(/(\d+[.,]\d{2})\s*(‚Ç¨|eur)?/i); if(m) amount=Number(m[1].replace(",", "."));
    let dateISO=new Date().toISOString().slice(0,10);
    const d1=t.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/); const d2=t.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
    if(d2) dateISO=`${d2[1]}-${d2[2]}-${d2[3]}`; else if(d1) dateISO=`${d1[3]}-${d1[2]}-${d1[1]}`;
    let provider="Ticket"; const prov=t.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][A-Za-z√Å√â√ç√ì√ö√ë0-9&\-. ]{2,40}/); if(prov) provider=prov[0].trim();
    return { date:dateISO, provider, amount };
  }
  async function callGemini(base64, mime){
    const key=(localStorage.getItem("gkey")||"").trim();
    if(!key) throw new Error("Falta API Key (pulsa ‚öôÔ∏è IA)");
    const prompt=`Devuelve solo un JSON v√°lido con:
{"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00}`;
    const body={contents:[{role:"user",parts:[{text:prompt},{inlineData:{mimeType:mime||"image/jpeg",data:base64}}]}]};
    const models=["gemini-2.5-flash","gemini-2.0-flash"];
    for(const m of models){
      const url=`https://generativelanguage.googleapis.com/v1/models/${m}:generateContent?key=${encodeURIComponent(key)}`;
      const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      const txt=await res.text(); let js=null; try{js=JSON.parse(txt)}catch{}
      if(res.status===429){ await new Promise(r=>setTimeout(r,800)); continue; }
      if(!res.ok){ log({fallo_modelo:m,status:res.status,body:js||txt}); continue; }
      const text=js?.candidates?.[0]?.content?.parts?.[0]?.text||"";
      try{ return safeParseJSON(text); }catch{ return fallbackParse(text); }
    }
    throw new Error("No fue posible extraer datos");
  }

  // ==== Scan ====
  $("scanBtn").onclick = async ()=>{
    try{
      const u=auth.currentUser; if(!u) return alert("Haz login primero");
      const input=ensureFileInput();
      const file=await new Promise((resolve,reject)=>{
        const fn=()=>{ input.removeEventListener("change",fn); if(input.files&&input.files[0]) resolve(input.files[0]); else reject(new Error("Sin imagen")); };
        input.addEventListener("change",fn,{once:true}); input.click();
      });
      log(`üì∑ ${file.name||"captura"} (${Math.round(file.size/1024)} KB)`);
      const compact=await downscale(file,2048,.9); currentFile=compact;
      $("thumb").src = URL.createObjectURL(compact); $("thumb").style.display="block";
      $("fileInfo").textContent = `${compact.name} ¬∑ ${Math.round(compact.size/1024)} KB`;

      const b64=await fileToBase64(compact);
      const out=await callGemini(b64, compact.type);
      // rellenar
      const d = /^\d{4}-\d{2}-\d{2}$/.test(out.date||"") ? new Date(out.date+"T00:00:00") : new Date();
      $("fDate").value = d.toISOString().slice(0,10);
      $("fAmount").value = (Number(out.amount||0)||0).toFixed(2);
      $("fProvider").value = (out.provider||"Ticket").toString().slice(0,80);
    }catch(e){ console.error(e); log(e); alert("No se pudo interpretar la respuesta de la IA. Revisa el ticket o edita manualmente."); }
  };

  // ==== Save ====
  $("saveBtn").onclick = async ()=>{
    try{
      const u=auth.currentUser; if(!u) return alert("Haz login primero");
      const dateISO=$("fDate").value||new Date().toISOString().slice(0,10);
      const amount=Number($("fAmount").value||0);
      const provider=($("fProvider").value||"").trim();
      const category=$("fCategory").value;
      const notes=($("fNotes").value||"").trim();
      if(!provider) return alert("Proveedor obligatorio");
      if(!amount || amount<=0) return alert("Importe > 0");

      let photoURL="", photoPath="";
      if(currentFile){
        const yyyyMM = dateISO.slice(0,7);
        const safeProv=(provider||"ticket").replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
        const ext = (currentFile.name.split(".").pop()||"jpg").toLowerCase();
        const filename = `${dateISO}_${safeProv}_${Date.now()}.${ext}`;
        photoPath = `tickets/${u.uid}/${yyyyMM}/${filename}`;
        await storage.ref(photoPath).put(currentFile);
        photoURL = await storage.ref(photoPath).getDownloadURL();
      }

      await db.collection(`users/${u.uid}/entries`).add({
        date:new Date(dateISO),
        category, provider, notes, amount,
        photoURL, photoPath,
        isExpense: category!=="ingreso",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Gasto guardado ‚úÖ");
      currentFile=null; $("thumb").style.display="none"; $("fileInfo").textContent="Sin imagen";
      $("fAmount").value=""; $("fProvider").value=""; $("fNotes").value="";
    }catch(e){ console.error(e); log(e); alert("Error guardando: "+(e.message||"")); }
  };

})();</script>
</body>
</html>
