<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ‚Ä¢ Escaneo IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f6f8fb; }
    .btn { @apply px-3 py-2 rounded font-medium; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-extrabold leading-tight">Gesti√≥n de Registros</h1>
        <p id="whoami" class="text-xs text-gray-500 mt-1">No autenticado</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLogin" class="btn bg-indigo-600 text-white hidden">Entrar con Google</button>
        <button id="btnLogout" class="btn border hidden">Salir</button>
        <button id="btnSettings" class="btn border">‚öôÔ∏è Ajustes</button>
      </div>
    </header>

    <!-- Resumen -->
    <section class="grid grid-cols-3 gap-3">
      <div class="bg-white rounded-xl p-3 border">
        <p class="text-xs text-gray-500">Total Gastos</p>
        <p id="totGastos" class="text-lg font-extrabold text-red-600">-‚Ç¨0,00</p>
      </div>
      <div class="bg-white rounded-xl p-3 border">
        <p class="text-xs text-gray-500">Total Ingresos</p>
        <p id="totIngresos" class="text-lg font-extrabold text-green-600">+‚Ç¨0,00</p>
      </div>
      <div class="bg-white rounded-xl p-3 border">
        <p class="text-xs text-gray-500">Balance</p>
        <p id="totBalance" class="text-lg font-extrabold text-emerald-700">‚Ç¨0,00</p>
      </div>
    </section>

    <!-- Formulario -->
    <section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Nuevo registro</h2>
        <span id="statusMsg" class="text-xs text-gray-400"></span>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium">Fecha</label>
          <input id="fFecha" type="date" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs font-medium">Categor√≠a</label>
          <select id="fCategoria" class="w-full border rounded px-3 py-2">
            <option value="comida">Comida/Mercado</option>
            <option value="transporte">Otros Transportes</option>
            <option value="servicios">Servicios/Varios</option>
            <option value="ocio">Ocio/Invitaciones</option>
            <option value="gasolina">Gasolina</option>
            <option value="peajes">Peajes/Parking</option>
            <option value="alojamiento">Alojamiento/Hotel</option>
            <option value="varios">Varios</option>
            <option value="ingreso">Ingreso</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium">Proveedor / Local</label>
        <input id="fProveedor" placeholder="Ej: Repsol, Restaurante X" class="w-full border rounded px-3 py-2"/>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium">Importe (‚Ç¨)</label>
          <input id="fCantidad" type="number" step="0.01" min="0.01" placeholder="0,00" class="w-full border rounded px-3 py-2"/>
        </div>
        <div>
          <label class="block text-xs font-medium">Notas</label>
          <input id="fNota" placeholder="Opcional" class="w-full border rounded px-3 py-2"/>
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium">Foto del ticket</label>
        <input id="fFile" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
        <img id="preview" class="mt-2 max-h-44 hidden rounded border" />
      </div>

      <div class="flex gap-3">
        <button id="scanAI" class="flex-1 btn bg-purple-600 text-white">üì∏ Escanear ticket con IA</button>
        <button id="btnGuardar" class="flex-1 btn bg-green-600 text-white">üíæ Guardar gasto</button>
      </div>
    </section>

    <!-- √öltimos -->
    <section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">√öltimos 5 Registros</h2>
        <button id="btnRefrescar" class="btn border text-sm">‚Üª</button>
      </div>
      <div id="lista" class="space-y-2 text-sm"></div>
    </section>

    <!-- Console -->
    <section>
      <h3 class="text-xs font-semibold text-gray-500 mb-1">Salida / Depuraci√≥n</h3>
      <pre id="out" class="text-[11px] bg-white border rounded-xl p-3 overflow-x-auto whitespace-pre-wrap"></pre>
    </section>
  </div>

  <!-- Modal Ajustes -->
  <div id="modalSettings" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Ajustes</h2>
        <button id="closeSettings" class="btn border">‚úñ</button>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium">üîë Gemini API Key</label>
        <input id="apiKeyInput" type="password" class="w-full border rounded px-3 py-2" placeholder="Pega aqu√≠ tu API Key (AIza...)" />
        <div class="flex gap-2">
          <button id="saveApiKey" class="btn bg-indigo-600 text-white flex-1">Guardar clave</button>
          <button id="clearApiKey" class="btn border flex-1">Borrar</button>
        </div>
        <p class="text-xs text-gray-500">Se guarda en este navegador (localStorage). No se sube a Firebase.</p>
      </div>

      <hr class="my-2"/>

      <div class="space-y-2">
        <label class="text-sm font-medium">üë§ Sesi√≥n</label>
        <div class="flex gap-2">
          <button id="loginSettings" class="btn border flex-1">Entrar con Google</button>
          <button id="logoutSettings" class="btn border flex-1">Salir</button>
        </div>
        <p id="sessionInfo" class="text-xs text-gray-500"></p>
      </div>
    </div>
  </div>

  <!-- App Script -->
  <script type="module">
    // ===== Firebase (CDN) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, Timestamp, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === TU CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app"); // <- bucket que me diste

    // ===== Helpers UI =====
    const $ = (id) => document.getElementById(id);
    const out = $("out");
    const log = (msg,obj) => {
      const line = (new Date()).toLocaleTimeString()+" ‚Äî "+msg+(obj?(" "+JSON.stringify(obj,null,2)):"");
      out.textContent = (out.textContent + "\\n" + line).slice(-4000);
    };

    // Set defaults
    $("fFecha").value = new Date().toISOString().slice(0,10);
    $("fCategoria").value = "comida";

    // Preview imagen
    $("fFile").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f){ $("preview").classList.add("hidden"); return; }
      $("preview").src = URL.createObjectURL(f);
      $("preview").classList.remove("hidden");
    });

    // ===== Ajustes modal =====
    const modal = $("modalSettings");
    $("btnSettings").onclick = ()=> modal.classList.remove("hidden");
    $("closeSettings").onclick = ()=> modal.classList.add("hidden");
    $("saveApiKey").onclick = ()=> {
      const key = $("apiKeyInput").value.trim();
      if(!key) return alert("Introduce una API Key v√°lida (empieza por AIza...)");
      localStorage.setItem("geminiKey", key);
      alert("‚úÖ Clave guardada en este navegador");
      modal.classList.add("hidden");
    };
    $("clearApiKey").onclick = ()=> {
      localStorage.removeItem("geminiKey");
      $("apiKeyInput").value = "";
      alert("üßπ Clave eliminada de este navegador");
    };

    // ===== Login visible en header y en Ajustes =====
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");
    const loginSettings = $("loginSettings");
    const logoutSettings = $("logoutSettings");
    const whoami = $("whoami");
    const sessionInfo = $("sessionInfo");

    function updateAuthButtons(user){
      const logged = !!user;
      btnLogin.classList.toggle("hidden", logged);
      btnLogout.classList.toggle("hidden", !logged);
      loginSettings.classList.toggle("hidden", logged);
      logoutSettings.classList.toggle("hidden", !logged);
      whoami.textContent = logged ? `Conectado: ${user.email || user.uid}` : "No autenticado";
      sessionInfo.textContent = logged ? `UID: ${user.uid}` : "Sin sesi√≥n";
    }

    async function doLogin(){
      try{
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await signInWithPopup(auth, provider);
      }catch(e){ alert("Error al iniciar sesi√≥n: "+(e.message||e)); log("login error", e); }
    }
    async function doLogout(){
      try{ await signOut(auth); }catch(e){ log("logout error", e); }
    }

    btnLogin.onclick = doLogin;
    loginSettings.onclick = doLogin;
    btnLogout.onclick = doLogout;
    logoutSettings.onclick = doLogout;

    onAuthStateChanged(auth, (user)=>{
      updateAuthButtons(user);
      if(user){ cargarUltimos(); calcularTotales(); }
      else { $("lista").innerHTML=""; $("totGastos").textContent="-‚Ç¨0,00"; $("totIngresos").textContent="+‚Ç¨0,00"; $("totBalance").textContent="‚Ç¨0,00"; }
    });

    // ===== Guardar registro =====
    $("btnGuardar").onclick = async ()=> {
      const user = auth.currentUser;
      if(!user){ alert("Inicia sesi√≥n con Google primero."); return; }

      const fecha = $("fFecha").value || new Date().toISOString().slice(0,10);
      const categoria = $("fCategoria").value;
      const proveedor = $("fProveedor").value.trim();
      const nota = $("fNota").value.trim();
      const cantidad = parseFloat(($("fCantidad").value || "0").replace(",", "."));

      if(!proveedor || !cantidad || cantidad<=0){
        alert("Completa proveedor e importe (> 0).");
        return;
      }

      $("statusMsg").textContent = "Guardando...";

      // Subir foto si hay
      let photoURL = "";
      const f = $("fFile").files?.[0];
      if(f){
        const y = fecha.slice(0,7); // YYYY-MM
        const safe = proveedor.replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
        const ext = (f.name.split('.').pop()||"jpg").toLowerCase();
        const fileName = `${fecha}_${safe}_${Date.now()}.${ext}`;
        const rr = ref(storage, `tickets/${user.uid}/${y}/${fileName}`);
        await uploadBytes(rr, f);
        photoURL = await getDownloadURL(rr);
      }

      await addDoc(collection(db, `users/${user.uid}/entries`), {
        date: Timestamp.fromDate(new Date(fecha)),
        category: categoria,
        provider: proveedor,
        notes: nota,
        amount: cantidad,
        isExpense: categoria!=="ingreso",
        photoURL,
        createdAt: Timestamp.now()
      });

      $("statusMsg").textContent = "‚úÖ Guardado";
      $("fProveedor").value = ""; $("fNota").value=""; $("fCantidad").value=""; $("fFile").value=""; $("preview").classList.add("hidden");
      cargarUltimos(); calcularTotales();
      setTimeout(()=>$("statusMsg").textContent="",1500);
    };

    // ===== Listado √∫ltimos =====
    $("btnRefrescar").onclick = ()=> { cargarUltimos(); calcularTotales(); };

    async function cargarUltimos(){
      const user = auth.currentUser; if(!user) return;
      const refCol = collection(db, `users/${user.uid}/entries`);
      const q = query(refCol, orderBy("createdAt","desc"), limit(5));
      const snap = await getDocs(q);
      const c = [];
      snap.forEach(d=> c.push({id:d.id, ...d.data()}));
      const html = c.map(d=>{
        const fecha = d.date?.toDate ? d.date.toDate().toISOString().slice(0,10) : "";
        const euros = (d.amount||0).toLocaleString("es-ES",{minimumFractionDigits:2});
        return `<div class="flex items-center justify-between border rounded p-2">
          <div class="min-w-0">
            <p class="text-sm font-medium truncate">${d.provider||"-"} ¬∑ <span class="text-gray-500">${d.category}</span></p>
            <p class="text-xs text-gray-500">${fecha}${d.notes?(" ¬∑ "+d.notes):""}</p>
          </div>
          <div class="text-right ml-2">
            <p class="text-sm font-semibold ${d.isExpense?'text-red-600':'text-green-600'}">${d.isExpense?'-':'+'}${euros} ‚Ç¨</p>
            ${d.photoURL?`<a class="text-xs underline text-indigo-600" href="${d.photoURL}" target="_blank">ticket</a>`:""}
          </div>
        </div>`;
      }).join("");
      $("lista").innerHTML = html || `<p class="text-center text-gray-400 text-sm">¬°A√∫n no hay registros!</p>`;
    }

    async function calcularTotales(){
      const user = auth.currentUser; if(!user) return;
      // sumar (r√°pido: pedimos √∫ltimos 100; para informes mensuales haremos query por mes)
      const refCol = collection(db, `users/${user.uid}/entries`);
      const q = query(refCol, orderBy("createdAt","desc"), limit(100));
      const snap = await getDocs(q);
      let gastos=0, ingresos=0;
      snap.forEach(d=>{
        const x=d.data();
        if(x.category==="ingreso") ingresos += (x.amount||0); else gastos += (x.amount||0);
      });
      $("totGastos").textContent = "-‚Ç¨"+gastos.toLocaleString("es-ES",{minimumFractionDigits:2});
      $("totIngresos").textContent = "+‚Ç¨"+ingresos.toLocaleString("es-ES",{minimumFractionDigits:2});
      $("totBalance").textContent = "‚Ç¨"+(ingresos-gastos).toLocaleString("es-ES",{minimumFractionDigits:2});
    }

    // ===== Escaneo con Gemini (v1 + modelo -latest) =====
    $("scanAI").onclick = async () => {
      const apiKey = localStorage.getItem("geminiKey");
      if(!apiKey){ alert("Ve a ‚öôÔ∏è Ajustes y pega tu API Key de Gemini."); return; }
      const file = $("fFile").files?.[0];
      if(!file){ alert("Selecciona una foto del ticket primero."); return; }

      const buf = await file.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      const mime = file.type || "image/jpeg";

      const prompt = `Extrae la siguiente informaci√≥n del ticket y responde SOLO en este formato exacto (sin texto adicional):
Proveedor: <nombre>
Importe: <n√∫mero con punto decimal>
Fecha: <YYYY-MM-DD>`;

      const body = {
        contents: [{
          role: "user",
          parts: [
            { text: prompt },
            { inline_data: { mime_type: mime, data: b64 } }
          ]
        }]
      };

      const url = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key="+encodeURIComponent(apiKey);
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const data = await res.json();
      log("Gemini respuesta", data);

      if(data.error){
        alert("Error IA: "+(data.error.message || data.error.status));
        return;
      }

      try{
        const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        const prov = /Proveedor:\s*(.*)/i.exec(txt)?.[1]?.trim();
        const imp = /Importe:\s*([0-9]+[.,]?[0-9]*)/.exec(txt)?.[1]?.trim();
        const fec = /Fecha:\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/.exec(txt)?.[1]?.trim();
        if(prov) $("fProveedor").value = prov;
        if(imp) $("fCantidad").value = imp.replace(",", ".");
        if(fec) $("fFecha").value = fec;
        if(!prov && !imp) alert("No se pudieron extraer campos. Prueba con otra foto o ajusta la iluminaci√≥n.");
      }catch(e){
        alert("No pude interpretar la salida de la IA.");
      }
    };
  </script>
</body>
</html>
