<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gastos 2N Â· iOS dark</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
<header class="topbar">
  <h1 style="display:flex;gap:.5rem;align-items:center;"><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> Gastos 2N</h1>
  <a class="badge" href="kms.html" title="Gastos de KM">ğŸš— KM</a>
  <a class="badge" href="export.html" title="Exportar">ğŸ“ Export</a>
  <a class="badge" href="summary.html" title="Sumario">ğŸ“Š Sumary</a>
  <button id="btnAI" class="btn ghost" title="Gemini API">âš™ï¸ IA</button>
  <button id="btnLogin" class="btn success">Iniciar sesiÃ³n</button>
  <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Acciones rÃ¡pidas</h2>
      <div class="row">
        <button id="scanBtn" class="btn primary">ğŸ“¸ Escanear ticket</button>
        <button id="manualBtn" class="btn">â• Ingreso manual</button>
        <span id="whoami" class="badge">No autenticado</span>
      </div>
    </div>
    <div class="card">
      <h2>Notas</h2>
      <div class="small">Tema oscuro estilo iOS, OCR con Gemini, y guardado en Firebase (Firestore + Storage).</div>
    </div>
    <div class="card">
      <h2>Ãšltimos movimientos</h2>
      <div id="lista" class="list"></div>
    </div>
    <div class="card">
      <h2>Logs</h2>
      <div id="out" class="logs mono"></div>
    </div>
  </div>
</main>

<!-- Modal revisiÃ³n / guardar -->
<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Revisar y guardar</strong><button class="btn" id="closeReview">Cerrar</button></header>
    <div class="body">
      <div class="field"><label>Fecha</label><input id="revDate" type="date"/></div>
      <div class="field"><label>Importe (â‚¬)</label><input id="revAmount" type="number" min="0.01" step="0.01"/></div>
      <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" type="text"/></div>
      <div class="field"><label>CategorÃ­a</label><select id="revCategory">
        <option value="varios" selected>Varios</option>
        <option value="comida">Comida</option>
        <option value="gasolina">Gasolina</option>
        <option value="peajes">Peajes</option>
        <option value="alojamiento">Hotel</option>
        <option value="transporte">Transportes</option>
        <option value="ocio">Invitaciones</option>
        <option value="servicios">Servicios</option>
        <option value="ingreso">Ingreso</option>
      </select></div>
      <div class="field"><label>Pagado con</label><select id="revPaidWith">
        <option value="empresa">Tarjeta empresa</option>
        <option value="mio">Mi dinero</option>
      </select></div>
      <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" rows="2"></textarea></div>
      <div class="row"><button id="btnPick" class="btn">ğŸ“ Adjuntar foto</button><button id="btnCam" class="btn">ğŸ“· Tomar foto</button></div><div class="preview"><img id="revThumb" style="height:72px;width:auto;border-radius:8px"><div id="revFileInfo" class="small"></div></div>
    </div>
    <footer><div class="left"><span class="small">Se guardarÃ¡ en tu Firestore</span></div><div class="right"><button class="btn" id="cancelReview">Cancelar</button><button class="btn primary" id="saveReview">Guardar</button></div></footer>
  </div>
</div>

<!-- Modal IA -->
<div id="aiModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <header><strong>Configurar IA</strong><button class="btn" id="closeAI">Cerrar</button></header>
    <div class="body" style="grid-template-columns:1fr">
      <div class="field"><label>API Key de Google AI (Gemini)</label><input id="aiKey" type="password" placeholder="AIza..." /><div class="small">Se guarda en este navegador (localStorage).</div></div>
    </div>
    <footer><button class="btn" id="clearAI">Borrar</button><button class="btn primary" id="saveAI">Guardar</button></footer>
  </div>
</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; };

  // ======= CONFIG FIREBASE (tu proyecto) =======
  const firebaseConfig = {
    apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain: "gastos-2n.firebaseapp.com",
    projectId: "gastos-2n",
    storageBucket: "gastos-2n.firebasestorage.app",
    messagingSenderId: "55010048795",
    appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ======= IA config modal =======
  const aiModal = $("aiModal");
  const openAIModal=()=>{ aiModal.classList.add("open"); $("aiKey").value = localStorage.getItem("gkey")||""; };
  const closeAIModal=()=> aiModal.classList.remove("open");
  $("btnAI").onclick=openAIModal; $("closeAI").onclick=closeAIModal;
  $("saveAI").onclick=()=>{ const v=$("aiKey").value.trim(); if(!v){alert("Pega tu API Key");return;} localStorage.setItem("gkey",v); alert("Guardada âœ…"); closeAIModal(); };
  $("clearAI").onclick=()=>{ localStorage.removeItem("gkey"); $("aiKey").value=""; alert("Borrada"); };

  // ======= Login =======
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.getRedirectResult().catch(e=>{ console.warn('Redirect login error', e); });
  $('btnLogin').onclick = async () => {
    if(location.protocol==='file:'){ alert('Para iniciar sesiÃ³n con Google, abre la app con un servidor local (http://localhost).'); return; }
    try{ try{ await auth.signInWithPopup(provider); }
    catch(err){ if(err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user'){ await auth.signInWithRedirect(provider); } else { throw err; } } }
    catch(e){ console.error(e); log("âŒ Login: "+(e.code||e.message)); alert("Error login: "+(e.message||"")); }
  };
  $('btnLogout').onclick = async () => { await auth.signOut(); };

  if(location.protocol==='file:'){
    alert('âš ï¸ EstÃ¡s abriendo la app como archivo (file://). El login de Google no funciona asÃ­. Usa un servidor local (http://localhost).');
  }
  auth.onAuthStateChanged((user)=>{
    if(user){
      $("whoami").textContent = `Conectado como ${user.email||user.uid}`;
      $("btnLogin").style.display="none"; $("btnLogout").style.display="";
      cargarUltimos();
    }else{
      $("whoami").textContent = "No autenticado";
      $("btnLogin").style.display=""; $("btnLogout").style.display="none";
      $("lista").innerHTML="";
    }
  });

  
  // ======= Botones de foto =======
  $("btnPick").onclick=()=>{
    const inp=document.createElement("input"); inp.type="file"; inp.accept="image/*";
    inp.onchange=async()=>{
      if(!inp.files||!inp.files[0]) return;
      const downs=await downscaleImage(inp.files[0], 2048, 0.9);
      review.file=downs;
      $("revThumb").src=URL.createObjectURL(downs);
      $("revFileInfo").textContent = downs.name+" Â· "+Math.round(downs.size/1024)+" KB";
    };
    inp.click();
  };
  $("btnCam").onclick=()=>{ 
    const inp=ensureCameraInput();
    inp.onchange=async()=>{
      if(!inp.files||!inp.files[0]) return;
      const downs=await downscaleImage(inp.files[0], 2048, 0.9);
      review.file=downs;
      $("revThumb").src=URL.createObjectURL(downs);
      $("revFileInfo").textContent = downs.name+" Â· "+Math.round(downs.size/1024)+" KB";
      inp.remove();
    };
    inp.click();
  };
// ======= OCR helpers =======
  let review = { file:null, dateISO:"", amount:0, provider:"", category:"varios", notes:"", paidWith:"empresa" };
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{ const rd=new FileReader(); rd.onload=()=>resolve(String(rd.result).split(",")[1]||""); rd.onerror=()=>reject(new Error("No se pudo leer imagen")); rd.readAsDataURL(file); });
  }
  async function downscaleImage(file, max=2048, q=0.9){
    const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
    const scale=Math.min(1,max/Math.max(img.width,img.height));
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    const cv=document.createElement("canvas"); cv.width=w; cv.height=h; cv.getContext("2d").drawImage(img,0,0,w,h);
    const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",q)); URL.revokeObjectURL(img.src);
    return new File([blob], (file.name||"ticket")+".jpg", {type:"image/jpeg"});
  }
  function safeParseJSON(text){
    let s=(text||"").trim(); if(s.startsWith("```")) s=s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
    const a=s.indexOf("{"), b=s.lastIndexOf("}"); if(a!==-1 && b!==-1) s=s.slice(a,b+1);
    return JSON.parse(s);
  }
  function fallbackParse(text){
    const t=(text||"").replace(/\s+/g," ").trim();
    let amount=0; const m=t.match(/(\d+[.,]\d{2})\s*(â‚¬|eur)?/i); if(m) amount=Number(m[1].replace(",", "."));
    let dateISO=new Date().toISOString().slice(0,10);
    const d1=t.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/); const d2=t.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
    if(d2) dateISO=`${d2[1]}-${d2[2]}-${d2[3]}`; else if(d1) dateISO=`${d1[3]}-${d1[2]}-${d1[1]}`;
    let provider="Ticket"; const prov=t.match(/^[A-ZÃÃ‰ÃÃ“ÃšÃ‘0-9][A-Za-zÃÃ‰ÃÃ“ÃšÃ‘0-9&\-. ]{2,40}/); if(prov) provider=prov[0].trim();
    return { date:dateISO, provider, amount };
  }
  async function callGemini(base64, mime){
    const key=(localStorage.getItem("gkey")||"").trim();
    if(!key){ (function(){document.getElementById('aiModal').classList.add('open')})(); throw new Error("Falta API Key"); }
    const prompt=`Devuelve solo un JSON vÃ¡lido exacto:
{"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00}`;
    const body={ contents:[{ role:"user", parts:[{text:prompt},{inlineData:{mimeType:mime||"image/jpeg",data:base64}}]}] };
    const models=["gemini-2.5-flash","gemini-2.0-flash"];
    for(const m of models){
      const url=`https://generativelanguage.googleapis.com/v1/models/${m}:generateContent?key=${encodeURIComponent(key)}`;
      const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      const txt=await res.text(); let js=null; try{js=JSON.parse(txt)}catch{}
      if(res.status===429){ await new Promise(r=>setTimeout(r,700)); continue; }
      if(!res.ok){ log({fallo_modelo:m,status:res.status,body:js||txt}); continue; }
      const text=js?.candidates?.[0]?.content?.parts?.[0]?.text||"";
      try{ return safeParseJSON(text); }catch{ return fallbackParse(text); }
    }
    throw new Error("No fue posible extraer datos");
  }

  function openReview(){
    $("reviewModal").classList.add("open");
    $("revDate").value=review.dateISO||new Date().toISOString().slice(0,10);
    $("revAmount").value=review.amount||"";
    $("revProvider").value=review.provider||"";
    $("revCategory").value=review.category;
    $("revPaidWith").value=review.paidWith||"empresa";
    $("revNotes").value=review.notes||"";
    $("revThumb").src= review.file? URL.createObjectURL(review.file):"";
    $("revFileInfo").textContent= review.file? `${review.file.name||"captura"} Â· ${Math.round(review.file.size/1024)} KB`:"";
  }
  function closeReview(){ $("reviewModal").classList.remove("open"); }
  $("closeReview").onclick=closeReview; $("cancelReview").onclick=closeReview;

  $("saveReview").onclick=async ()=>{
    try{
      const user=auth.currentUser; if(!user) return alert("Haz login primero");
      const dateISO=$("revDate").value||new Date().toISOString().slice(0,10);
      const amount=Number($("revAmount").value||0);
      const provider=$("revProvider").value.trim();
      const category=$("revCategory").value;
      const paidWith=$("revPaidWith").value;
      const notes=$("revNotes").value.trim();
      if(!provider) return alert("Proveedor obligatorio");
      if(!amount||amount<=0) return alert("Importe > 0");
      const yyyyMM=dateISO.slice(0,7);
      let photoURL="", path="";
      if(review.file){
        const safeProv=(provider||"ticket").replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
        const ext=(review.file.name.split(".").pop()||"jpg").toLowerCase();
        const filename=`${dateISO}_${safeProv}_${Date.now()}.${ext}`;
        path=`tickets/${user.uid}/${yyyyMM}/${filename}`;
        await firebase.storage().ref(path).put(review.file);
        photoURL=await firebase.storage().ref(path).getDownloadURL();
      }
      await firebase.firestore().collection(`users/${user.uid}/entries`).add({
        date:new Date(dateISO),
        category, provider, notes, amount, paidWith,
        photoURL, photoPath:path,
        isExpense: category!=="ingreso",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Guardado âœ…"); closeReview(); cargarUltimos();
    }catch(e){ console.error(e);
      try{
        const b64 = review.file ? await fileToBase64(review.file) : null;
        const loc = JSON.parse(localStorage.getItem("entries_local")||"[]");
        loc.push({date:dateISO, category, provider, notes, amount, paidWith, photoData:b64, isExpense: category!=="ingreso"});
        localStorage.setItem("entries_local", JSON.stringify(loc));
        alert("Guardado en local (sin permisos). Se sincronizarÃ¡ mÃ¡s tarde.");
        closeReview(); cargarUltimos();
      }catch(err){ alert("Error guardando: "+(e.message||"")); }
    }og(e); alert("Error guardando: "+(e.message||"")); }
  };

  // Ingreso manual
  $("manualBtn").onclick=()=>{
    review={ file:null, dateISO:new Date().toISOString().slice(0,10), amount:0, provider:"", category:"varios", notes:"", paidWith:"empresa" };
    $("revThumb").src=""; $("revFileInfo").textContent="";
    openReview();
  };

  // Escanear (cÃ¡mara)
  function ensureCameraInput(){
    const x=document.createElement("input");
    x.type="file"; x.accept="image/*"; x.capture="environment";
    x.style.display="none"; document.body.appendChild(x); return x;
  }
  $("scanBtn").onclick=async ()=>{
    try{
      const user=auth.currentUser; if(!user) return alert("Haz login primero");
      const input=ensureCameraInput();
      const file=await new Promise((resolve,reject)=>{
        const fn=()=>{ input.removeEventListener("change",fn); if(input.files&&input.files[0]) resolve(input.files[0]); else reject(new Error("Sin imagen")); };
        input.addEventListener("change",fn,{once:true}); input.click();
      });
      log(`ğŸ“· ${file.name||"captura"} (${Math.round(file.size/1024)} KB)`);
      const compact=await (async function(f){const img=await new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=URL.createObjectURL(f)});const scale=Math.min(1,2048/Math.max(img.width,img.height));const w=Math.round(img.width*scale),h=Math.round(img.height*scale);const cv=document.createElement("canvas");cv.width=w;cv.height=h;cv.getContext("2d").drawImage(img,0,0,w,h);const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",.9));URL.revokeObjectURL(img.src);return new File([blob],(f.name||"ticket")+".jpg",{type:"image/jpeg"})})(file);
      const b64=await (new Promise((resolve,reject)=>{const rd=new FileReader();rd.onload=()=>resolve(String(rd.result).split(",")[1]||"");rd.onerror=()=>reject(new Error("No se pudo leer imagen"));rd.readAsDataURL(compact)}));
      const res=await callGemini(b64, compact.type);
      const d=/^\d{4}-\d{2}-\d{2}$/.test(res.date||"") ? new Date(res.date+"T00:00:00") : new Date();
      review={ file:compact, dateISO:d.toISOString().slice(0,10), amount:Number(res.amount||0)||0, provider:(res.provider||"Ticket").toString().slice(0,80), category:"varios", notes:"", paidWith:"empresa" };
      openReview();
    }catch(e){ console.error(e);
      try{
        const b64 = review.file ? await fileToBase64(review.file) : null;
        const loc = JSON.parse(localStorage.getItem("entries_local")||"[]");
        loc.push({date:dateISO, category, provider, notes, amount, paidWith, photoData:b64, isExpense: category!=="ingreso"});
        localStorage.setItem("entries_local", JSON.stringify(loc));
        alert("Guardado en local (sin permisos). Se sincronizarÃ¡ mÃ¡s tarde.");
        closeReview(); cargarUltimos();
      }catch(err){ alert("Error guardando: "+(e.message||"")); }
    }og(e); alert("OCR error: "+(e.message||"")); }
  };

  // Listado Ãºltimos
  async function cargarUltimos(){
    const user=auth.currentUser; if(!user) return;
    const snap=await firebase.firestore().collection(`users/${user.uid}/entries`).orderBy("createdAt","desc").limit(10).get();
    const lista=document.getElementById("lista"); lista.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data(); const dt=d.date?.toDate?d.date.toDate():new Date(d.date);
      const li=document.createElement("div"); li.className="item";
      li.innerHTML=`<div class="left">
        <div class="t">${d.provider||"-"} Â· <span class="small">${d.category}</span> ${d.paidWith==="mio"?'<span class="badge">ğŸ’³ Mi dinero</span>':''}</div>
        <div class="s">${dt.toISOString().slice(0,10)} ${d.notes?('Â· '+d.notes):''}</div>
      </div>
      <div class="right"><strong style="color:${d.isExpense?'#ff6b6b':'#34c759'}">${d.isExpense?'-':'+'}${Number(d.amount||0).toFixed(2)} â‚¬</strong> ${d.photoURL?`<a href="${d.photoURL}" target="_blank" class="badge">ticket</a>`:''}</div>`;
      lista.appendChild(li);
    });
  }

})();
</script>
</body>
</html>