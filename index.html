<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ‚Äî OCR + CSV + ZIP</title>
  <style>
    :root{--blue:#007aff;--border:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:#f7f7fb}
    .topbar{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff;z-index:5}
    .topbar h1{margin:0;flex:1;font-size:18px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border:none}
    .content{max-width:960px;margin:0 auto;padding:14px}
    .panel{border:1px solid var(--border);border-radius:16px;padding:12px 14px;margin-top:12px;background:#fff}
    .muted{color:var(--muted)} pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{background:#fff;border-radius:18px;max-width:520px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)}
    .sheet header,.sheet footer{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
    .sheet footer{border-top:1px solid var(--border);border-bottom:none}
    .sheet .body{padding:12px 14px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .field{display:flex;flex-direction:column;gap:6px} .field input,.field select,.field textarea{padding:9px 10px;border:1px solid var(--border);border-radius:10px;font:inherit}
    .preview{grid-column:1/3;display:flex;gap:10px;align-items:center;border:1px solid var(--border);padding:8px;border-radius:12px}
    .export-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hidden{display:none!important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header class="topbar">
    <h1>Gastos 2N</h1>
    <button id="btnAI" class="btn" title="Guardar API Key de Gemini">‚öôÔ∏è IA / API Key</button>
    <button id="btnLogin" class="btn" title="Google Sign-In">üü¢ Entrar con Google</button>
    <button id="btnLogout" class="btn hidden" title="Cerrar Sesi√≥n">Salir</button>
  </header>

  <main class="content">
    <div class="panel" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
      <button id="expBtn" class="btn">üìÅ Exportar mes</button>
      <span class="muted" id="whoami" style="margin-left:auto">No autenticado</span>
    </div>

    <div id="exportPanel" class="panel" style="display:none">
      <div class="export-grid">
        <div class="field"><label>Mes</label><input id="expMonth" type="month"/></div>
        <div class="field" style="align-items:flex-start;gap:8px">
          <button id="btnCSV" class="btn primary">‚¨áÔ∏è CSV</button>
          <button id="btnZIP" class="btn">üóúÔ∏è ZIP fotos</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">Las fotos se descargan de <code>tickets/&lt;uid&gt;/YYYY-MM/archivo</code> usando el SDK (reglas privadas).</p>
    </div>

    <div class="panel">
      <strong>Logs</strong>
      <pre id="out"></pre>
      <details>
        <summary>¬øProblemas con el login?</summary>
        <ul>
          <li>Authentication ‚Üí Proveedor <b>Google</b>: Activado.</li>
          <li>Dominios autorizados: <code>deividgaston.github.io</code>.</li>
          <li>Recarga con <code>?noCache=1</code>.</li>
        </ul>
      </details>
    </div>
  </main>

  <!-- Modal revisi√≥n -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Revisar y guardar</strong>
        <button class="btn" id="closeReview">Cerrar</button>
      </header>
      <div class="body">
        <div class="field"><label>Fecha</label><input id="revDate" type="date"/></div>
        <div class="field"><label>Importe (‚Ç¨)</label><input id="revAmount" type="number" min="0.01" step="0.01"/></div>
        <div class="field" style="grid-column:1/2"><label>Proveedor</label><input id="revProvider" type="text"/></div>
        <div class="field"><label>Categor√≠a</label><select id="revCategory">
          <option value="varios" selected>Varios</option>
          <option value="comida">Comida</option>
          <option value="gasolina">Gasolina</option>
          <option value="peajes">Peajes</option>
          <option value="alojamiento">Hotel</option>
          <option value="transporte">Transportes</option>
          <option value="ocio">Invitaciones</option>
          <option value="servicios">Servicios</option>
          <option value="ingreso">Ingreso</option>
        </select></div>
        <div class="field" style="grid-column:1/3"><label>Notas</label><textarea id="revNotes" rows="2"></textarea></div>
        <div class="preview"><img id="revThumb" style="height:72px;width:auto;border-radius:8px"><div id="revFileInfo" class="muted" style="font-size:12px"></div></div>
      </div>
      <footer>
        <button class="btn" id="cancelReview">Cancelar</button>
        <button class="btn primary" id="saveReview">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal IA -->
  <div id="aiModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Configurar IA</strong>
        <button class="btn" id="closeAI">Cerrar</button>
      </header>
      <div class="body" style="grid-template-columns:1fr">
        <div class="field">
          <label>API Key de Google AI (Gemini)</label>
          <input id="aiKey" type="password" placeholder="AIza..." />
          <small class="muted">Se guarda en este navegador (localStorage).</small>
        </div>
      </div>
      <footer>
        <button class="btn" id="clearAI">Borrar</button>
        <button class="btn primary" id="saveAI">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- JS m√≠nimo para bot√≥n de API Key -->
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const aiModal = $("aiModal");
      const openAIModal = ()=>{ aiModal.classList.add("open"); $("aiKey").value = localStorage.getItem("gkey")||""; };
      const closeAIModal = ()=> aiModal.classList.remove("open");
      $("btnAI").addEventListener("click", openAIModal);
      $("closeAI").addEventListener("click", closeAIModal);
      $("saveAI").addEventListener("click", ()=>{ const v=$("aiKey").value.trim(); if(!v){alert("Pega tu API Key");return;} localStorage.setItem("gkey", v); alert("Guardada ‚úÖ"); closeAIModal(); });
      $("clearAI").addEventListener("click", ()=>{ localStorage.removeItem("gkey"); $("aiKey").value=""; alert("Borrada"); });
      window.__ui = { openAIModal, closeAIModal };
    })();
  </script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- Capa modular SOLO para ZIP (getBlob autenticado, sin CORS) -->
  <script type="module">
    import { getStorage as getStorageMod, ref as sref, getBlob } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    const app = firebase.app();                          // usa el mismo app de compat
    const storageMod = getStorageMod(app);
    // expone helper global seguro para ZIP
    window.__getBlobAuth = async (pathOrUrl) => {
      const r = sref(storageMod, pathOrUrl);            // acepta path, gs:// o https://
      const blob = await getBlob(r);                    // descarga autenticado
      return { blob, name: r.name };
    };
  </script>

  <!-- App principal -->
  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const out=$("out"); out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\\n"; };

    // ======= CONFIG FIREBASE =======
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ======= GOOGLE AUTH =======
    const provider = new firebase.auth.GoogleAuthProvider();
    $('btnLogin').onclick = async () => {
      try { await auth.signInWithPopup(provider); }
      catch (e) { console.error(e); log("‚ùå Login: " + (e.code||e.message)); alert("Error login: " + (e.message||"")); }
    };
    $('btnLogout').onclick = async () => { await auth.signOut(); };
    auth.onAuthStateChanged((user)=>{
      if (user) {
        $("whoami").textContent = `Conectado como ${user.email||user.uid}`;
        $("btnLogin").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        $("expMonth").value = new Date().toISOString().slice(0,7);
      } else {
        $("whoami").textContent = "No autenticado";
        $("btnLogin").classList.remove("hidden");
        $("btnLogout").classList.add("hidden");
      }
    });

    // ======= C√°mara / captura =======
    let hiddenInput;
    function ensureCameraInput(){
      if(hiddenInput) return hiddenInput;
      hiddenInput = document.createElement("input");
      hiddenInput.type="file"; hiddenInput.accept="image/*"; hiddenInput.capture="environment";
      hiddenInput.style.display="none"; document.body.appendChild(hiddenInput);
      return hiddenInput;
    }
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{ const rd=new FileReader(); rd.onload=()=>resolve(String(rd.result).split(",")[1]||""); rd.onerror=()=>reject(new Error("No se pudo leer imagen")); rd.readAsDataURL(file); });
    }
    async function downscaleImage(file, max=2048, q=0.9){
      const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
      const scale=Math.min(1,max/Math.max(img.width,img.height));
      const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
      const cv=document.createElement("canvas"); cv.width=w; cv.height=h; cv.getContext("2d").drawImage(img,0,0,w,h);
      const blob=await new Promise(r=>cv.toBlob(r,"image/jpeg",q)); URL.revokeObjectURL(img.src);
      return new File([blob], (file.name||"ticket")+".jpg", {type:"image/jpeg"});
    }
    function safeParseJSON(text){
      let s=(text||"").trim(); if(s.startsWith("```")) s=s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
      const a=s.indexOf("{"), b=s.lastIndexOf("}"); if(a!==-1 && b!==-1) s=s.slice(a,b+1);
      return JSON.parse(s);
    }
    function fallbackParse(text){
      const t=(text||"").replace(/\s+/g," ").trim();
      let amount=0; const m=t.match(/(\d+[.,]\d{2})\s*(‚Ç¨|eur)?/i); if(m) amount=Number(m[1].replace(",", "."));
      let dateISO=new Date().toISOString().slice(0,10);
      const d1=t.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/); const d2=t.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
      if(d2) dateISO=`${d2[1]}-${d2[2]}-${d2[3]}`; else if(d1) dateISO=`${d1[3]}-${d1[2]}-${d1[1]}`;
      let provider="Ticket"; const prov=t.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][A-Za-z√Å√â√ç√ì√ö√ë0-9&\-. ]{2,40}/); if(prov) provider=prov[0].trim();
      return { date:dateISO, provider, amount };
    }
    async function callGemini(base64, mime){
      const key=(localStorage.getItem("gkey")||"").trim();
      if(!key){ window.__ui.openAIModal(); throw new Error("Falta API Key"); }
      const prompt = `Devuelve *solo* un JSON v√°lido con la estructura exacta:
{"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00}
Reglas: solo JSON, punto decimal, total final.`;
      const body = { contents:[{ role:"user", parts:[{text:prompt},{ inlineData:{ mimeType:mime||"image/jpeg", data:base64 }}]}] };
      const models = ["gemini-2.5-flash","gemini-2.0-flash"];
      for (const model of models){
        const url=`https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
        const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        const txt=await res.text(); let js=null; try{js=JSON.parse(txt)}catch{}
        if(res.status===429){ await new Promise(r=>setTimeout(r,800)); continue; }
        if(!res.ok){ log({fallo_modelo:model,status:res.status,body:js||txt}); continue; }
        const text=js?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        try{ return safeParseJSON(text); }catch{ return fallbackParse(text); }
      }
      throw new Error("No fue posible extraer datos");
    }

    // ======= Modal de revisi√≥n / guardado =======
    const review = { file:null, dateISO:"", amount:0, provider:"", category:"varios", notes:"" };
    function openReview(){
      $("reviewModal").classList.add("open");
      $("revDate").value=review.dateISO||new Date().toISOString().slice(0,10);
      $("revAmount").value=review.amount||"";
      $("revProvider").value=review.provider||"";
      $("revCategory").value=review.category;
      $("revNotes").value=review.notes||"";
      $("revThumb").src= review.file? URL.createObjectURL(review.file):"";
      $("revFileInfo").textContent= review.file? `${review.file.name||"captura"} ¬∑ ${Math.round(review.file.size/1024)} KB`:"";
    }
    function closeReview(){ $("reviewModal").classList.remove("open"); }
    $("closeReview").addEventListener("click", closeReview);
    $("cancelReview").addEventListener("click", closeReview);

    $("saveReview").addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login primero");
        const dateISO=$("revDate").value||new Date().toISOString().slice(0,10);
        const amount=Number($("revAmount").value||0);
        const provider=$("revProvider").value.trim();
        const category=$("revCategory").value;
        const notes=$("revNotes").value.trim();
        if(!provider) return alert("Proveedor obligatorio");
        if(!amount || amount<=0) return alert("Importe > 0");
        const yyyyMM=dateISO.slice(0,7);
        let photoURL="", path="";
        if(review.file){
          const safeProv=(provider||"ticket").replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          const ext=(review.file.name.split(".").pop()||"jpg").toLowerCase();
          const filename=`${dateISO}_${safeProv}_${Date.now()}.${ext}`;
          path=`tickets/${user.uid}/${yyyyMM}/${filename}`;
          await storage.ref(path).put(review.file);
          photoURL = await storage.ref(path).getDownloadURL();
        }
        await db.collection(`users/${user.uid}/entries`).add({
          date:new Date(dateISO),
          category, provider, notes, amount,
          photoURL, photoPath:path,
          isExpense:category!=="ingreso",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Gasto guardado ‚úÖ"); closeReview();
      }catch(e){ console.error(e); log(e); alert("Error guardando: "+(e.message||"")); }
    });

    // ======= Bot√≥n ESCANEAR =======
    $('scanBtn').addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login primero");
        const input=ensureCameraInput();
        const file=await new Promise((resolve,reject)=>{
          const fn=()=>{ input.removeEventListener("change", fn);
            if(input.files&&input.files[0]) resolve(input.files[0]);
            else reject(new Error("Sin imagen"));
          };
          input.addEventListener("change", fn, {once:true}); input.click();
        });
        log(`üì∑ ${file.name||"captura"} (${Math.round(file.size/1024)} KB)`);
        const compact=await downscaleImage(file,2048,0.9);
        const b64=await fileToBase64(compact);
        const res=await callGemini(b64, compact.type);
        const d=/^\d{4}-\d{2}-\d{2}$/.test(res.date||"") ? new Date(res.date+"T00:00:00") : new Date();
        review.file=compact;
        review.dateISO=d.toISOString().slice(0,10);
        review.amount=Number(res.amount||0)||0;
        review.provider=(res.provider||"").toString().slice(0,80)||"Ticket";
        review.category="varios"; review.notes="";
        openReview();
      }catch(e){ console.error(e); log(e); alert("OCR error: "+(e.message||"")); }
    });

    // ======= Exportar =======
    $('expBtn').addEventListener("click", ()=>{
      const p=$("exportPanel"); p.style.display=(p.style.display==="none")?"block":"none";
      if(!$("expMonth").value) $("expMonth").value=new Date().toISOString().slice(0,7);
    });

    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
    const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
    function toCSVValue(col, value){
      if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
        const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
      }
      const s=String(value||"").replace(/"/g,'""'); return `"${s}"`;
    }
    function buildCSV(rows, monthlabel, today){
      const head=`,,,,,   EXPENSES REPORT,,,,,,,\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${today}\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthlabel},,,,,,\n,,,,,,,,,,,,\n`;
      const h1=COLUMNS.map(h=>`"${h}"`).join(";")+"\n";
      const h2=",,PARKINGS ,,,,,TRAVELING,,,\n";
      const data=rows.map(r=>COLUMNS.map(c=>toCSVValue(c,r[c])).join(";")).join("\n");
      return head+h1+h2+data+"\n";
    }
    function monthRange(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
    async function listEntriesMonth(ym, uid){
      const [s,e]=monthRange(ym);
      const snap=await db.collection(`users/${uid}/entries`)
        .where("date",">=",s).where("date","<",e).orderBy("date","asc").get();
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    function toCSVRecords(entries){
      const rows=[];
      for(const e of entries){
        if(e.category==="ingreso") continue;
        const col=MAP[e.category]||"VARIOUS";
        const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        rec["DATE"]=d.toLocaleDateString("es-ES");
        rec["CLIENT / PROVIDER"]=e.provider||"";
        rec["DESCRIPTION"]=e.notes||"";
        const amount=Number(e.amount||0);
        if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
        let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
        rec["TOTAL"]=total; rows.push(rec);
      }
      return rows;
    }

    // CSV
    $('btnCSV').addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login");
        const ym=$("expMonth").value; if(!ym) return alert("Selecciona un mes");
        const entries=await listEntriesMonth(ym,user.uid);
        if(!entries.length) return alert("Sin gastos");
        const rows=toCSVRecords(entries);
        const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
        const today=new Date().toLocaleDateString("es-ES");
        const csv=buildCSV(rows, monthlabel, today);
        saveAs(new Blob([csv], {type:"text/csv;charset=utf-8"}), `Informe_Gastos_${ym}.csv`);
      }catch(e){ console.error(e); log(e); alert("CSV error: "+(e.message||"")); }
    });

    // ======= ZIP usando getBlob (modular, autenticado, sin CORS) =======
    $('btnZIP').addEventListener("click", async ()=>{
      try{
        const user=auth.currentUser; if(!user) return alert("Haz login");
        const ym=$("expMonth").value; if(!ym) return alert("Selecciona un mes");
        const entries=await listEntriesMonth(ym,user.uid);
        const photos=entries.filter(e=>e.photoPath || e.photoURL);
        if(!photos.length) return alert("Sin fotos");

        const zip=new JSZip(); let ok=0, fail=0;

        function filenameFrom(src, entry){
          const d = entry.date?.toDate ? entry.date.toDate() : new Date(entry.date);
          const dateISO = isNaN(d) ? new Date().toISOString().slice(0,10) : d.toISOString().slice(0,10);
          const prov = (entry.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          let ext = ".jpg";
          const lower = (src||"").toLowerCase();
          if(lower.endsWith(".png")) ext=".png";
          else if(lower.endsWith(".jpeg")) ext=".jpeg";
          else if(lower.endsWith(".webp")) ext=".webp";
          else if(lower.endsWith(".jpg")) ext=".jpg";
          return `${dateISO}_${prov}${ext}`;
        }

        for(const e of photos){
          try{
            const src = e.photoPath ? e.photoPath : e.photoURL; // ambos v√°lidos
            const { blob } = await window.__getBlobAuth(src);   // üîí descarga autenticada
            const name = filenameFrom(src, e);
            zip.file(name, blob);
            ok++;
          }catch(err){
            fail++; const msg = { fallo_zip_getBlob: (e.photoPath||e.photoURL), err: err.message || String(err) };
            console.log(msg); $("out").textContent += JSON.stringify(msg) + "\n";
          }
        }

        const outBlob = await zip.generateAsync({ type:"blob" });
        saveAs(outBlob, `Fotos_Gastos_${ym}.zip`);
        $("out").textContent += `üóúÔ∏è ZIP listo: ${ok} ok, ${fail} fallos\n`;
      }catch(e){
        console.error(e); $("out").textContent += (e.message||String(e)) + "\n";
        alert("ZIP error: " + (e.message||""));
      }
    });

  })();
  </script>
</body>
</html>
