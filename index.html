<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gastos 2N â€” Captura</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b0c0f; color:#0a0a0a; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
    .card { background: linear-gradient(180deg,#121317, #0b0c0f); border:1px solid rgba(255,255,255,0.07); }
    .btn { transition: transform .06s ease; }
    .btn:active { transform: scale(.98); }
  </style>
</head>
<body class="min-h-screen text-white">
  <div class="mx-auto max-w-xl p-4 space-y-4">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-white/10 grid place-items-center">ðŸ’³</div>
        <h1 class="text-xl md:text-2xl font-semibold">Gastos 2N</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnIA" class="btn px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs">API Key IA</button>
        <button id="btnLogin" class="btn px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-xs">Entrar Google</button>
        <button id="btnLogout" class="btn px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs hidden">Salir</button>
      </div>
    </header>

    <p id="whoami" class="text-xs text-white/60">No autenticado</p>

    <!-- Tarjeta captura -->
    <section class="card rounded-2xl p-4 space-y-4 shadow-2xl">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Nuevo gasto</h2>
        <button id="btnExport" class="btn px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-xs">Exportar â†’</button>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="col-span-1">
          <label class="block text-xs text-white/70">Fecha</label>
          <input id="fFecha" type="date" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="col-span-1">
          <label class="block text-xs text-white/70">CategorÃ­a</label>
          <select id="fCategoria" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="comida">Comida/Mercado</option>
            <option value="transporte">Otros Transportes</option>
            <option value="servicios">Servicios/Varios</option>
            <option value="ocio">Ocio/Invitaciones</option>
            <option value="gasolina">Gasolina</option>
            <option value="peajes">Peajes/Parking</option>
            <option value="alojamiento">Alojamiento/Hotel</option>
            <option value="varios">Varios</option>
            <option value="ingreso">Ingreso</option>
          </select>
        </div>
        <div class="col-span-2">
          <label class="block text-xs text-white/70">Proveedor / Local</label>
          <input id="fProveedor" type="text" placeholder="Ej: Repsol, Restaurante X" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="col-span-2">
          <label class="block text-xs text-white/70">Notas</label>
          <textarea id="fNota" rows="2" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Opcional"></textarea>
        </div>
        <div>
          <label class="block text-xs text-white/70">Importe (â‚¬)</label>
          <input id="fCantidad" type="number" min="0.01" step="0.01" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-white/70">Ticket</label>
          <div class="flex gap-2">
            <label class="btn bg-indigo-500 hover:bg-indigo-600 rounded-xl px-3 py-2 text-xs cursor-pointer">
              <input id="fFile" type="file" accept="image/*" capture="environment" class="hidden" />
              Abrir cÃ¡mara
            </label>
            <button id="btnScan" class="btn bg-white/10 hover:bg-white/20 rounded-xl px-3 py-2 text-xs">OCR IA</button>
          </div>
          <img id="preview" class="mt-1 max-h-44 hidden rounded-xl border border-white/10" />
        </div>
      </div>

      <button id="btnGuardar" class="btn w-full bg-emerald-500 hover:bg-emerald-600 rounded-2xl py-3 font-semibold">Guardar gasto</button>
    </section>

    <!-- Ãšltimos -->
    <section class="card rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Ãšltimos gastos</h2>
        <button id="btnRefrescar" class="btn px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-xs">Refrescar</button>
      </div>
      <div id="lista" class="space-y-2"></div>
    </section>

    <section>
      <pre id="out" class="text-[11px] text-white/60 whitespace-pre-wrap"></pre>
    </section>
  </div>

  <!-- Modal API Key -->
  <dialog id="dlgKey" class="rounded-2xl p-0 w-[95%] max-w-md bg-[#0f1115] border border-white/10">
    <form method="dialog" class="p-4 space-y-3">
      <h3 class="text-lg font-semibold">Configurar API Key de Google AI</h3>
      <p class="text-sm text-white/60">Se guarda localmente en este dispositivo (localStorage).</p>
      <input id="apiKeyInput" type="password" placeholder="AIza..." class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
      <div class="flex justify-end gap-2 pt-2">
        <button class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs">Cancelar</button>
        <button id="btnSaveKey" type="button" class="px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-xs">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    // --- Firebase CDN v11 ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, Timestamp,
      query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Config Firebase (tu proyecto) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app");

    // --- UI helpers ---
    const $ = (id)=>document.getElementById(id);
    const log = (o)=>{ try{$("out").textContent += (typeof o==="string"?o:JSON.stringify(o,null,2)) + "\\n";}catch{} };
    $("fFecha").value = new Date().toISOString().slice(0,10);

    // login / logout
    $("btnLogin").onclick = async () => {
      try{
        const provider = new GoogleAuthProvider();
        if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
          await signInWithRedirect(auth, provider);
        } else {
          await signInWithPopup(auth, provider);
        }
      }catch(e){ log("Login error: "+(e.code||e.message)); }
    };
    $("btnLogout").onclick = async()=>{ await signOut(auth); };

    onAuthStateChanged(auth, (user)=>{
      if (user){
        $("whoami").textContent = "Conectado como " + (user.email || user.uid);
        $("btnLogin").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        cargarUltimos();
      } else {
        $("whoami").textContent = "No autenticado";
        $("btnLogin").classList.remove("hidden");
        $("btnLogout").classList.add("hidden");
        $("lista").innerHTML = "";
      }
    });

    // export nav
    $("btnExport").onclick = ()=>{
      sessionStorage.setItem("fromIndex","1");
      location.href = "export.html";
    };

    // preview
    const fileInput = $("fFile");
    const preview = $("preview");
    fileInput.addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if (!f){ preview.classList.add("hidden"); return; }
      const url = URL.createObjectURL(f);
      preview.src = url; preview.classList.remove("hidden");
    });

    // --- OCR (Gemini) ---
    const MODEL = "gemini-2.0-flash"; // v1
    function getApiKey(){ return localStorage.getItem("GAI_API_KEY") || ""; }

    function parseGeminiJson(text){
      if (!text) throw new Error("Respuesta IA vacÃ­a");
      let clean = text.trim().replace(/^```json\\s*/i,"").replace(/^```\\s*/i,"").replace(/\\s*```$/i,"").trim();
      if (!clean.startsWith("{")){
        const m = clean.match(/\\{[\\s\\S]*\\}/);
        if (m) clean = m[0];
      }
      try {
        const obj = JSON.parse(clean);
        if (typeof obj.amount === "string") obj.amount = parseFloat(obj.amount.replace(",","."));
        return {
          date: obj.date || new Date().toISOString().slice(0,10),
          provider: obj.provider || "Datos no encontrados",
          amount: Number.isFinite(obj.amount)? obj.amount : 0
        };
      } catch(e){
        log({json_parse_error:e.message, text});
        return { date:new Date().toISOString().slice(0,10), provider:"Datos no encontrados", amount:0 };
      }
    }

    async function fileToResizedBase64(file, maxSize=1600){
      const img = await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=URL.createObjectURL(file); });
      const scale = Math.min(1, maxSize/Math.max(img.width, img.height));
      const canvas = document.createElement("canvas");
      canvas.width = Math.max(1, Math.round(img.width*scale));
      canvas.height = Math.max(1, Math.round(img.height*scale));
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
      return dataUrl.split(",")[1]; // base64 sin prefijo
    }

    async function callGeminiOCR(file){
      const apiKey = getApiKey();
      if (!apiKey){ throw new Error("Configura primero la API Key de IA"); }
      const base64 = await fileToResizedBase64(file);
      const prompt = `Extrae esta informaciÃ³n del ticket y devuelve SOLO JSON plano (sin \\\`\\\`\\\`):
{
  "date": "YYYY-MM-DD",
  "provider": "Nombre del local",
  "amount": 0.00
}
Si falta algo, usa date="${new Date().toISOString().slice(0,10)}", provider="Datos no encontrados", amount=0.00`;

      const url = `https://generativelanguage.googleapis.com/v1/models/${MODEL}:generateContent?key=${encodeURIComponent(apiKey)}`;
      const body = {
        contents:[{
          role:"user",
          parts:[
            {text: prompt},
            {inlineData:{mimeType:"image/jpeg", data: base64}}
          ]
        }],
        // sin responseMimeType en v1
      };

      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok){
        const err = await res.json().catch(()=>({}));
        throw new Error((err?.error?.message)||(`HTTP ${res.status}`));
      }
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      return parseGeminiJson(text);
    }

    $("btnScan").onclick = async ()=>{
      try{
        const f = fileInput.files?.[0];
        if (!f) { alert("Adjunta primero una foto del ticket"); return; }
        log("ðŸ“· Analizandoâ€¦");
        const out = await callGeminiOCR(f);
        $("fFecha").value = out.date;
        $("fProveedor").value = out.provider;
        $("fCantidad").value = out.amount?.toString().replace(",",".") || "";
        log({IA: out});
      }catch(e){
        alert("OCR: " + e.message);
        log({ocr_error: e.message});
      }
    };

    // Guardar gasto
    $("btnGuardar").onclick = async ()=>{
      try{
        const user = auth.currentUser;
        if (!user){ alert("Haz login primero"); return; }
        const fecha = $("fFecha").value || new Date().toISOString().slice(0,10);
        const y = fecha.slice(0,7);
        const categoria = $("fCategoria").value;
        const proveedor = $("fProveedor").value.trim();
        const nota = $("fNota").value.trim();
        const cantidad = parseFloat(($("fCantidad").value||"").replace(",","."));
        if (!proveedor || !cantidad || cantidad<=0){ alert("Proveedor e importe > 0"); return; }

        // foto opcional
        let photoURL = "";
        const f = fileInput.files?.[0];
        if (f){
          const safeProv = proveedor.replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          const ext = (f.name.split(".").pop()||"jpg").toLowerCase();
          const filename = `${fecha}_${safeProv}_${Date.now()}.${ext}`;
          const path = `tickets/${user.uid}/${y}/${filename}`;
          const r = ref(storage, path);
          await uploadBytes(r, f);
          photoURL = await getDownloadURL(r);
          log({photoURL});
        }

        await addDoc(collection(db, `users/${user.uid}/entries`), {
          date: Timestamp.fromDate(new Date(fecha)),
          category: categoria,
          provider: proveedor,
          notes: nota,
          amount: cantidad,
          photoURL,
          createdAt: Timestamp.now(),
          isExpense: categoria !== "ingreso"
        });

        alert("âœ… Gasto guardado");
        // reset mÃ­nimos
        $("fProveedor").value = "";
        $("fNota").value = "";
        $("fCantidad").value = "";
        fileInput.value = ""; preview.classList.add("hidden");
        cargarUltimos();
      }catch(e){
        alert("Error al guardar: " + (e.code||e.message));
        log({save_error: e.code||e.message});
      }
    };

    async function cargarUltimos(){
      const user = auth.currentUser; if (!user) return;
      const qRef = query(collection(db, `users/${user.uid}/entries`), orderBy("createdAt", "desc"), limit(10));
      const snap = await getDocs(qRef);
      const cont = $("lista"); cont.innerHTML = "";
      snap.forEach(doc=>{
        const d = doc.data();
        const fecha = d.date?.toDate ? d.date.toDate() : new Date();
        const euros = (d.amount||0).toLocaleString("es-ES", { minimumFractionDigits:2 });
        const row = document.createElement("div");
        row.className = "flex items-center justify-between border border-white/10 rounded-xl p-2 bg-white/5";
        row.innerHTML = `
          <div class="min-w-0">
            <p class="text-sm font-medium text-white truncate">${d.provider||"-"} Â· <span class="text-white/50">${d.category}</span></p>
            <p class="text-xs text-white/50">${fecha.toISOString().slice(0,10)} ${d.notes?("Â· "+d.notes):""}</p>
          </div>
          <div class="ml-3 text-right">
            <p class="text-sm font-semibold ${d.isExpense?'text-red-400':'text-emerald-400'}">${d.isExpense?'-':'+'}${euros} â‚¬</p>
            ${d.photoURL? `<a href="${d.photoURL}" target="_blank" class="text-[11px] text-indigo-300 underline">ticket</a>`: ""}
          </div>
        `;
        cont.appendChild(row);
      });
    }

    // API key modal
    const dlg = $("dlgKey");
    $("btnIA").onclick = ()=>{
      $("apiKeyInput").value = getApiKey();
      dlg.showModal();
    };
    $("btnSaveKey").onclick = ()=>{
      const v = $("apiKeyInput").value.trim();
      if (v) localStorage.setItem("GAI_API_KEY", v);
      dlg.close();
      alert("âœ… API Key guardada en este dispositivo");
    };
  </script>
</body>
</html>
