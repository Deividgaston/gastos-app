<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f7f7fb; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Gastos 2N</h1>
      <div class="flex items-center gap-2">
        <button id="btnLogin" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm">Entrar con Google</button>
        <button id="btnLogout" class="px-3 py-2 rounded border text-sm">Salir</button>
      </div>
    </header>
    <p id="whoami" class="text-sm text-gray-600">No autenticado</p>

    <!-- Formulario gasto -->
    <section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
      <h2 class="font-semibold">Nuevo gasto</h2>
      <div>
        <label class="block text-sm font-medium">Fecha</label>
        <input id="fFecha" type="date" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium">CategorÃ­a</label>
        <select id="fCategoria" class="w-full border rounded px-3 py-2">
          <option value="comida">Comida/Mercado</option>
          <option value="transporte">Otros Transportes</option>
          <option value="servicios">Servicios/Varios</option>
          <option value="ocio">Ocio/Invitaciones</option>
          <option value="gasolina">Gasolina</option>
          <option value="peajes">Peajes/Parking</option>
          <option value="alojamiento">Alojamiento/Hotel</option>
          <option value="varios">Varios</option>
          <option value="ingreso">Ingreso</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">Proveedor / Local</label>
        <input id="fProveedor" type="text" placeholder="Ej: Repsol, Restaurante X" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium">Notas</label>
        <textarea id="fNota" rows="2" class="w-full border rounded px-3 py-2" placeholder="Opcional"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium">Importe (â‚¬)</label>
        <input id="fCantidad" type="number" min="0.01" step="0.01" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium">Foto del ticket (opcional)</label>
        <input id="fFile" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
        <img id="preview" class="mt-2 max-h-40 hidden rounded border" />
      </div>
      <button id="btnGuardar" class="w-full py-3 rounded bg-green-600 text-white font-semibold">Guardar gasto</button>
      <p class="text-xs text-gray-500">Las fotos se guardan en <code>tickets/&lt;uid&gt;/YYYY-MM/archivo</code>.</p>
    </section>

    <!-- Ãšltimos movimientos -->
    <section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Ãšltimos gastos</h2>
        <button id="btnRefrescar" class="text-sm px-3 py-1 rounded border">Refrescar</button>
      </div>
      <div id="lista" class="space-y-2"></div>
    </section>

    <section>
      <pre id="out" class="text-xs text-gray-600 whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script type="module">
    // --- Firebase imports (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, Timestamp, query, orderBy, limit, getDocs 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytes, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Config Firebase (tuya) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app", // correcto en tu proyecto
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };

    // --- Inicializar Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app"); // forzamos bucket

    // --- Helpers UI ---
    const log = (msg) => { document.getElementById('out').textContent += msg + "\n"; };
    const whoami = document.getElementById('whoami');

    // Fecha por defecto hoy
    document.getElementById('fFecha').value = new Date().toISOString().slice(0,10);

    // Preview imagen
    const fileInput = document.getElementById('fFile');
    const preview = document.getElementById('preview');
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) { preview.classList.add('hidden'); return; }
      const url = URL.createObjectURL(f);
      preview.src = url; preview.classList.remove('hidden');
    });

    // Login/Logout
    document.getElementById('btnLogin').onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(auth, provider);
      } catch (e) {
        log("âŒ Login error: " + (e.code || e.message)); console.error(e);
      }
    };
    document.getElementById('btnLogout').onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        whoami.textContent = `Conectado como ${user.email || user.uid}`;
        cargarUltimos();
      } else {
        whoami.textContent = "No autenticado";
        document.getElementById('lista').innerHTML = "";
      }
    });

    // Guardar gasto (con foto opcional)
    document.getElementById('btnGuardar').onclick = async () => {
      try {
        const user = auth.currentUser;
        if (!user) { alert("Haz login primero"); return; }

        const fecha = document.getElementById('fFecha').value || new Date().toISOString().slice(0,10);
        const categoria = document.getElementById('fCategoria').value;
        const proveedor = document.getElementById('fProveedor').value.trim();
        const nota = document.getElementById('fNota').value.trim();
        const cantidad = parseFloat(document.getElementById('fCantidad').value);
        if (!proveedor || !cantidad || cantidad <= 0) { alert("Proveedor e importe > 0"); return; }

        // 1) Subir foto si existe
        let photoURL = "";
        const f = fileInput.files?.[0];
        if (f) {
          const y = fecha.slice(0,7); // YYYY-MM
          const safeProv = proveedor.replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\s+/g,"_");
          const ext = (f.name.split('.').pop()||'jpg').toLowerCase();
          const filename = `${fecha}_${safeProv}_${Date.now()}.${ext}`;
          const path = `tickets/${user.uid}/${y}/${filename}`;
          const r = ref(storage, path);
          await uploadBytes(r, f);
          photoURL = await getDownloadURL(r);
          log("ðŸ“¸ Foto subida: " + path);
        }

        // 2) Guardar documento en Firestore
        const refCol = collection(db, `users/${user.uid}/entries`);
        await addDoc(refCol, {
          date: Timestamp.fromDate(new Date(fecha)),
          category: categoria,
          provider: proveedor,
          notes: nota,
          amount: cantidad,
          photoURL,
          createdAt: Timestamp.now(),
          isExpense: categoria !== 'ingreso'
        });

        log("âœ… Gasto guardado");
        alert("Gasto guardado correctamente");
        // reset
        document.getElementById('fProveedor').value = "";
        document.getElementById('fNota').value = "";
        document.getElementById('fCantidad').value = "";
        fileInput.value = ""; preview.classList.add('hidden');
        cargarUltimos();
      } catch (e) {
        console.error(e);
        alert("Error al guardar: " + (e.code || e.message));
        log("âŒ Error al guardar: " + (e.code || e.message));
      }
    };

    // Listar Ãºltimos 10
    async function cargarUltimos() {
      const user = auth.currentUser; if (!user) return;
      const refCol = collection(db, `users/${user.uid}/entries`);
      const q = query(refCol, orderBy('createdAt','desc'), limit(10));
      const snap = await getDocs(q);
      const lista = document.getElementById('lista');
      lista.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const fecha = d.date?.toDate ? d.date.toDate() : new Date();
        const euros = (d.amount||0).toLocaleString('es-ES', { minimumFractionDigits: 2 });
        const li = document.createElement('div');
        li.className = "flex items-center justify-between border rounded p-2";
        li.innerHTML = `
          <div class="min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate">${d.provider||'-'} Â· <span class="text-gray-500">${d.category}</span></p>
            <p class="text-xs text-gray-500">${fecha.toISOString().slice(0,10)} ${d.notes?('Â· '+d.notes):''}</p>
          </div>
          <div class="ml-3 text-right">
            <p class="text-sm font-semibold ${d.isExpense? 'text-red-600':'text-green-600'}">${d.isExpense?'-':'+'}${euros} â‚¬</p>
            ${d.photoURL? `<a href="${d.photoURL}" target="_blank" class="text-xs text-indigo-600 underline">ticket</a>`: ''}
          </div>`;
        lista.appendChild(li);
      });
    }

    document.getElementById('btnRefrescar').onclick = cargarUltimos;
  </script>
</body>
</html>
