<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N</title>
  <style>
    :root{--blue:#007aff;--bg:#fff;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Inter",system-ui,Segoe UI,Roboto}
    .topbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff}
    .topbar svg{height:28px} .topbar h1{font-size:18px;margin:0;font-weight:700;flex:1}
    .btn{border:none;padding:10px 14px;border-radius:12px;background:#f2f2f7;cursor:pointer} .btn.primary{background:var(--blue);color:#fff}
    .btn.small{padding:8px 10px;font-size:13px} .btn.outline{background:#fff;border:1px solid var(--border)}
    .content{max-width:980px;margin:0 auto;padding:16px}
    .metric-card{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
    .metric{border:1px solid var(--border);border-radius:16px;padding:14px 16px}
    .metric h2{margin:0 0 4px 0;font-size:22px} .metric p{margin:0;color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .panel{border:1px solid var(--border);border-radius:16px;padding:14px 16px;margin-top:12px}
    .muted{color:var(--muted)} pre.log{white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:240px;overflow:auto}

    /* Modal revisi√≥n */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{background:#fff;border-radius:18px;max-width:560px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden}
    .sheet header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sheet h3{margin:0;font-size:16px}
    .sheet .body{padding:14px 16px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#374151}
    .field input,.field select,.field textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
    .field textarea{grid-column:1/3;min-height:72px;resize:vertical}
    .preview{grid-column:1/3;border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;gap:12px;align-items:center}
    .preview img{height:72px;width:auto;border-radius:8px}
    .sheet footer{padding:14px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}

    /* Export */
    .export-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .export-grid .field{height:100%}
  </style>
  <!-- Librer√≠as para ZIP y descarga de ficheros -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header class="topbar">
    <!-- Inline simple 2N-like logo -->
    <svg viewBox="0 0 120 40" aria-hidden="true"><rect x="0" y="0" width="120" height="40" rx="8" fill="#111827"></rect><text x="60" y="26" text-anchor="middle" fill="#fff" font-family="system-ui,Segoe UI,Roboto" font-weight="700" font-size="20">2N</text></svg>
    <h1>Gastos 2N</h1>
    <div class="stack">
      <button id="btnLogin" class="btn small">Entrar</button>
      <button id="btnLogout" class="btn small outline">Salir</button>
    </div>
  </header>

  <main class="content">
    <!-- Dashboard -->
    <section class="metric-card">
      <div class="metric">
        <h2 id="totalMes">0,00 ‚Ç¨</h2>
        <p>Total del mes</p>
      </div>
      <div class="metric">
        <h2 id="numTickets">0</h2>
        <p>Tickets del mes</p>
      </div>
      <div class="metric">
        <h2 id="ultimoModelo">‚Äî</h2>
        <p>Modelo OCR activo</p>
      </div>
    </section>

    <div class="tabs">
      <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
      <button id="demoBtn" class="btn">‚ûï Demo</button>
      <button id="expBtn"  class="btn outline">üìÅ Exportar mes</button>
    </div>

    <!-- Export panel -->
    <section id="exportPanel" class="panel" style="display:none">
      <h3 style="margin:0 0 12px 0">Exportaci√≥n mensual</h3>
      <div class="export-grid">
        <div class="field">
          <label for="expMonth">Mes a exportar</label>
          <input type="month" id="expMonth" />
        </div>
        <div class="field" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <button id="btnCSV" class="btn primary">‚¨áÔ∏è CSV plantilla 2N</button>
          <button id="btnZIP" class="btn">üóúÔ∏è ZIP fotos del mes</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">El CSV usa separador <b>;</b> y coma decimal. El ZIP incluye todas las fotos de tickets del mes.</p>
    </section>

    <section class="panel">
      <h3 style="margin:0 0 6px 0">Estado</h3>
      <p id="whoami" class="muted">No autenticado</p>
      <pre id="out" class="log"></pre>
    </section>
  </main>

  <!-- Modal de revisi√≥n -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
      <header>
        <h3 id="reviewTitle">Revisar y guardar</h3>
        <button id="btnCloseModal" class="btn small outline">Cerrar</button>
      </header>
      <div class="body">
        <div class="field">
          <label for="revDate">Fecha</label>
          <input type="date" id="revDate" />
        </div>
        <div class="field">
          <label for="revAmount">Importe (‚Ç¨)</label>
          <input type="number" id="revAmount" min="0.01" step="0.01" />
        </div>
        <div class="field" style="grid-column:1/3">
          <label for="revProvider">Proveedor / Concepto</label>
          <input type="text" id="revProvider" placeholder="Ej: Repsol, Restaurante X" />
        </div>
        <div class="field">
          <label for="revCategory">Categor√≠a</label>
          <select id="revCategory">
            <option value="comida">Comida/Mercado</option>
            <option value="transporte">Otros Transportes</option>
            <option value="servicios">Servicios/Varios</option>
            <option value="ocio">Ocio/Invitaciones</option>
            <option value="gasolina">Gasolina</option>
            <option value="peajes">Peajes/Parking</option>
            <option value="alojamiento">Alojamiento/Hotel</option>
            <option value="varios" selected>Varios</option>
            <option value="ingreso">Ingreso</option>
          </select>
        </div>
        <div class="field" style="grid-column:1/3">
          <label for="revNotes">Notas</label>
          <textarea id="revNotes" placeholder="Opcional"></textarea>
        </div>
        <div class="preview">
          <img id="revThumb" alt="ticket" />
          <div>
            <div style="font-size:12px;color:#6b7280">Vista previa del ticket</div>
            <div id="revFileInfo" style="font-size:12px"></div>
          </div>
        </div>
      </div>
      <footer>
        <button id="btnCancel" class="btn">Cancelar</button>
        <button id="btnSave" class="btn primary">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- ================= SCRIPTS (M√ìDULOS) ================= -->
  <script type="module">
    // --------- Firebase (CDN m√≥dulos) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, getBlob, getBytes
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --------- Helpers UI ----------
    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const out = $("out"); if(!out) return; out.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2)) + "\\n"; };
    const setTotalMes = (n)=>{ $("totalMes").textContent = new Intl.NumberFormat("es-ES",{minimumFractionDigits:2}).format(n) + " ‚Ç¨"; };
    const setNumTickets = (n)=>{ $("numTickets").textContent = n; };
    const setOCRModel = (name)=>{ $("ultimoModelo").textContent = name || "‚Äî"; };

    // --------- Config Firebase (tu proyecto) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://gastos-2n.firebasestorage.app");

    // --------- Auth UI ----------
    $("btnLogin").onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await signInWithPopup(auth, provider);
      } catch(e){ log("‚ùå Login: "+(e.code||e.message)); alert("Error login: "+(e.code||e.message)); }
    };
    $("btnLogout").onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      $("whoami").textContent = user ? `Conectado como ${user.email||user.uid}` : "No autenticado";
      if (user) {
        const now = new Date();
        $("expMonth").value = now.toISOString().slice(0,7);
        await refrescarDashboard();
      }
    });

    // --------- Guardar gasto + subir foto ----------
    async function saveExpense({ date, category, provider, notes, amount, file }) {
      const user = auth.currentUser; if(!user) throw new Error("No autenticado");

      let photoURL = "";
      let storagePath = "";
      if (file) {
        const yyyyMM = (date ? new Date(date) : new Date()).toISOString().slice(0,7);
        const safeProv = (provider||"ticket").replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\\s+/g,"_");
        const ext = (file.name?.split(".").pop()||"jpg").toLowerCase();
        const filename = `${(date?new Date(date):new Date()).toISOString().slice(0,10)}_${safeProv}_${Date.now()}.${ext}`;
        const path = `tickets/${user.uid}/${yyyyMM}/${filename}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        photoURL = await getDownloadURL(r);
        storagePath = path; // guardamos la ruta interna
      }

      const col = collection(db, `users/${user.uid}/entries`);
      await addDoc(col, {
        date: date ? new Date(date) : new Date(),
        category: category || "varios",
        provider: provider || "",
        notes: notes || "",
        amount: Number(amount || 0),
        photoURL,
        photoPath: storagePath, // <<< NUEVO
        isExpense: (category || "varios") !== "ingreso",
        createdAt: serverTimestamp()
      });

      return { ok:true, photoURL, photoPath: storagePath };
    }

    // --------- Dashboard (mes actual) ----------
    async function refrescarDashboard(){
      const user = auth.currentUser; if(!user) return;
      const now = new Date();
      const y = now.getFullYear(); const m = String(now.getMonth()+1).padStart(2,"0");
      const monthStart = new Date(`${y}-${m}-01T00:00:00`);
      const nextMonth = new Date(`${m==="12" ? y+1 : y}-${m==="12" ? "01" : String(Number(m)+1).padStart(2,"0")}-01T00:00:00`);

      const col = collection(db, `users/${user.uid}/entries`);
      const q = query(col, orderBy("date","desc"));
      const snap = await getDocs(q);

      let total = 0, count = 0;
      snap.forEach(doc=>{
        const d = doc.data();
        if(!d.isExpense) return;
        const dt = d.date?.toDate ? d.date.toDate() : new Date(d.date);
        if (dt >= monthStart && dt < nextMonth) {
          total += Number(d.amount||0);
          count ++;
        }
      });
      setTotalMes(total);
      setNumTickets(count);
    }

    // ===================== OCR + Revisi√≥n =====================
    function getApiKey(){
      let k = localStorage.getItem("gkey");
      if(!k){
        k = prompt("Pega tu API Key de Google AI (Gemini):");
        if (k && k.trim()){ localStorage.setItem("gkey", k.trim()); alert("API Key guardada ‚úÖ"); }
        else throw new Error("No hay API Key");
      }
      return k.trim();
    }
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const rd = new FileReader();
        rd.onerror = ()=>reject(new Error("No se pudo leer la imagen"));
        rd.onload = ()=> resolve(String(rd.result).split(",")[1] || "");
        rd.readAsDataURL(file);
      });
    }
    function safeParseJSON(text){
      if(!text) throw new Error("Salida vac√≠a de la IA");
      let cleaned = text.trim();
      if(cleaned.startsWith("```")){
        cleaned = cleaned.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
      }
      const a = cleaned.indexOf("{"); const b = cleaned.lastIndexOf("}");
      if (a!==-1 && b!==-1 && b>a) cleaned = cleaned.slice(a,b+1);
      return JSON.parse(cleaned);
    }
    function normalizeAmount(val){
      if(val==null) return 0;
      let s = String(val).trim().replace(/[‚Ç¨$]/g,"").replace(/\\s/g,"").replace(",",".");
      s = s.replace(/[^\\d.\\-]/g,"");
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }
    function normalizeDate(val){
      if(!val) return new Date();
      if(/^\\d{4}-\\d{2}-\\d{2}$/.test(val)){
        const d = new Date(val+"T00:00:00"); if(!isNaN(d)) return d;
      }
      const d2 = new Date(val); return isNaN(d2) ? new Date() : d2;
    }

    async function callGeminiVision(base64, mime){
      const key = getApiKey();

      const prompt = `
Extrae JSON del ticket con esta estructura exacta:
{
  "date": "YYYY-MM-DD",
  "provider": "Nombre del local o concepto",
  "amount": 0.00
}
Reglas:
- No a√±adas texto fuera del JSON.
- Usa punto como decimal.
- Si falta un dato, d√©jalo vac√≠o ("") o 0.00.
`;

      const body = {
        contents: [{
          role: "user",
          parts: [
            { text: prompt },
            { inlineData: { mimeType: mime || "image/jpeg", data: base64 } }
          ]
        }]
      };

      const models = ["gemini-1.5-flash","gemini-1.5-pro","gemini-2.0-flash"];
      let lastErr;
      for (const model of models){
        const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
        try{
          log({ probando_modelo:model, endpoint:url });
          const res = await fetch(url, {
            method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
          });
          const raw = await res.text();
          let json = null; try { json = JSON.parse(raw); } catch {}
          if (!res.ok){
            lastErr = new Error(json?.error?.message || `HTTP ${res.status}`);
            log({ fallo_modelo:model, status:res.status, body: json || raw });
            continue;
          }
          const text = json?.candidates?.[0]?.content?.parts?.[0]?.text ?? json?.text ?? raw;
          const parsed = safeParseJSON(text);
          setOCRModel(model);
          log({ modelo_ok:model });
          return parsed;
        }catch(e){
          lastErr = e; log({ excepcion_modelo:model, error:e.message||String(e) });
        }
      }
      throw lastErr || new Error("No hay modelos disponibles para tu API key.");
    }

    // C√°mara (modo A: foto)
    let hiddenInput;
    function ensureCameraInput(){
      if(hiddenInput) return hiddenInput;
      hiddenInput = document.createElement("input");
      hiddenInput.type = "file";
      hiddenInput.accept = "image/*";
      hiddenInput.capture = "environment"; // c√°mara trasera en m√≥vil
      hiddenInput.style.display = "none";
      document.body.appendChild(hiddenInput);
      return hiddenInput;
    }

    // ------- Estado temporal para revisi√≥n -------
    const reviewState = { file:null, provider:"", amount:0, dateISO:"", category:"varios", notes:"" };

    function openReviewModal(){
      $("reviewModal").classList.add("open");
      $("revDate").value = reviewState.dateISO || new Date().toISOString().slice(0,10);
      $("revAmount").value = reviewState.amount ? String(reviewState.amount) : "";
      $("revProvider").value = reviewState.provider || "";
      $("revCategory").value = reviewState.category || "varios";
      $("revNotes").value = reviewState.notes || "";
      $("revThumb").src = reviewState.file ? URL.createObjectURL(reviewState.file) : "";
      $("revFileInfo").textContent = reviewState.file ? `${reviewState.file.name || "captura"} ¬∑ ${Math.round(reviewState.file.size/1024)} KB` : "";
    }
    function closeReviewModal(){
      $("reviewModal").classList.remove("open");
      try { if ($("revThumb").src.startsWith("blob:")) URL.revokeObjectURL($("revThumb").src); } catch {}
    }

    $("btnCloseModal").addEventListener("click", closeReviewModal);
    $("btnCancel").addEventListener("click", closeReviewModal);

    $("btnSave").addEventListener("click", async ()=>{
      try{
        const user = auth.currentUser; if(!user) return alert("Haz login primero");
        const dateISO = $("revDate").value || new Date().toISOString().slice(0,10);
        const amount = Number($("revAmount").value || 0);
        const provider = $("revProvider").value.trim();
        const category = $("revCategory").value;
        const notes = $("revNotes").value.trim();

        if (!provider) return alert("Proveedor es obligatorio");
        if (!amount || amount <= 0) return alert("Importe debe ser mayor a 0");

        const resp = await saveExpense({
          date: dateISO,
          category,
          provider,
          notes,
          amount,
          file: reviewState.file
        });

        log("‚úÖ Gasto guardado con foto");
        if (resp?.photoURL) log({ photoURL: resp.photoURL });
        alert("Gasto guardado ‚úÖ");
        closeReviewModal();
        await refrescarDashboard();
      }catch(e){
        console.error(e);
        log({ error: e.message || String(e), details: e.responseJSON || "" });
        alert("‚ùå Error al guardar: " + (e.message || "desconocido"));
      }
    });

    async function handleScan(){
      try{
        const user = auth.currentUser; if(!user) return alert("Haz login primero");
        const input = ensureCameraInput();
        const file = await new Promise((resolve,reject)=>{
          const onChange = ()=>{
            input.removeEventListener("change", onChange);
            if (input.files && input.files[0]) resolve(input.files[0]);
            else reject(new Error("No se seleccion√≥ imagen"));
          };
          input.addEventListener("change", onChange, { once:true });
          input.click();
        });

        log(`üì∑ Imagen: ${file.name||"captura"} (${Math.round(file.size/1024)} KB)`);
        const b64 = await fileToBase64(file);

        const result = await callGeminiVision(b64, file.type);
        log({ IA: result });

        const dateObj = normalizeDate(result?.date);
        reviewState.file = file;
        reviewState.provider = (result?.provider || "").toString().trim().slice(0,80) || "Ticket";
        reviewState.amount = normalizeAmount(result?.amount);
        reviewState.dateISO = dateObj.toISOString().slice(0,10);
        reviewState.category = "varios";
        reviewState.notes = "";

        openReviewModal();
      }catch(e){
        console.error(e);
        log({ error: e.message || String(e), details: e.responseJSON || "" });
        alert("‚ùå Error en escaneo: " + (e.message || "desconocido"));
      }
    }
    $("scanBtn").addEventListener("click", handleScan);

    // Bot√≥n demo -> crea un gasto de 1‚Ç¨ sin foto (para probar conexi√≥n)
    $("demoBtn").addEventListener("click", async ()=>{
      try{
        const user = auth.currentUser; if(!user) return alert("Haz login primero");
        await saveExpense({
          date: new Date().toISOString().slice(0,10),
          category: "varios",
          provider: "Demo",
          notes: "Gasto de prueba",
          amount: 1,
          file: null
        });
        log("‚úÖ Gasto demo guardado");
        await refrescarDashboard();
      }catch(e){ log(e); alert("Error demo: "+(e.code||e.message)); }
    });

    // ===================== EXPORTACI√ìN =====================
    const COLUMNS = [
      "DATE",
      "CLIENT / PROVIDER",
      "TOLLS & PARKINGS",
      "HOTEL",
      "GASOLINE",
      "TICKETS TRAVELING",
      "OTHER TRANSPORTS (Taxi)",
      "INVITATIONS",
      "MEALS",
      "VARIOUS",
      "TOTAL",
      "DESCRIPTION"
    ];
    const CATEGORY_MAP = {
      "comida": "MEALS",
      "transporte": "OTHER TRANSPORTS (Taxi)",
      "servicios": "VARIOUS",
      "ocio": "INVITATIONS",
      "gasolina": "GASOLINE",
      "peajes": "TOLLS & PARKINGS",
      "alojamiento": "HOTEL",
      "varios": "VARIOUS"
    };

    function toCSVValue(col, value){
      if (col !== "DATE" && col !== "CLIENT / PROVIDER" && col !== "DESCRIPTION") {
        if (typeof value === "number") {
          return value.toFixed(2).replace(".", ",");
        }
        const n = Number(value||0);
        return isFinite(n) ? n.toFixed(2).replace(".", ",") : "0,00";
      } else {
        if (value == null) value = "";
        const s = String(value).replace(/"/g,'""');
        return `"${s}"`;
      }
    }

    function buildCSV(rows, monthlabel, todaylabel){
      const templateHeader =
        `,,,,,   EXPENSES REPORT,,,,,,,\\n` +
        `NOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${todaylabel}\\n` +
        `PRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthlabel},,,,,,\\n` +
        `,,,,,,,,,,,,\\n`;

      const headerRow = COLUMNS.map(h=>`"${h}"`).join(";") + "\\n";
      const headerRow2 = `,,PARKINGS ,,,,,TRAVELING,,,\\n`;
      const dataRows = rows.map(rec => COLUMNS.map(c => toCSVValue(c, rec[c])).join(";")).join("\\n");
      return templateHeader + headerRow + headerRow2 + dataRows + "\\n";
    }

    function monthRange(ym){
      const start = new Date(ym + "-01T00:00:00");
      const y = start.getFullYear();
      const m = start.getMonth();
      const end = new Date(y, m+1, 1, 0,0,0);
      return [start, end];
    }

    async function getEntriesForMonth(ym){
      const user = auth.currentUser; if(!user) throw new Error("No autenticado");
      const [start, end] = monthRange(ym);
      const col = collection(db, `users/${user.uid}/entries`);
      const q = query(col, where("date", ">=", start), where("date", "<", end), orderBy("date","asc"));
      const snap = await getDocs(q);
      const list = [];
      snap.forEach(doc=>{
        const d = doc.data();
        const dateObj = d.date?.toDate ? d.date.toDate() : new Date(d.date);
        list.push({ ...d, date: dateObj });
      });
      return list;
    }

    function toCSVRecords(entries){
      const rows = [];
      for (const e of entries){
        if (e.category === "ingreso") continue;
        const colName = CATEGORY_MAP[e.category] || "VARIOUS";
        const rec = {};
        COLUMNS.forEach(c => rec[c] = (["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c) ? "" : 0.00));

        rec["DATE"] = e.date.toLocaleDateString("es-ES");
        rec["CLIENT / PROVIDER"] = e.provider || "";
        rec["DESCRIPTION"] = e.notes || "";

        const amount = Number(e.amount||0);
        if (COLUMNS.includes(colName)) rec[colName] = amount; else rec["VARIOUS"] = amount;

        let total = 0;
        for (let i=2;i<=9;i++) total += Number(rec[COLUMNS[i]]||0);
        rec["TOTAL"] = total;

        rows.push(rec);
      }
      return rows;
    }

    $("expBtn").addEventListener("click", ()=>{
      const p = $("exportPanel");
      p.style.display = (p.style.display==="none") ? "block" : "none";
    });

    $("btnCSV").addEventListener("click", async ()=>{
      try{
        const ym = $("expMonth").value;
        if(!ym) return alert("Selecciona un mes (YYYY-MM)");
        const entries = await getEntriesForMonth(ym);
        if (entries.length === 0) return alert("No hay gastos en ese mes");

        const rows = toCSVRecords(entries);
        const monthlabel = new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
        const todaylabel = new Date().toLocaleDateString("es-ES");

        const csv = buildCSV(rows, monthlabel, todaylabel);
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        saveAs(blob, `Informe_Gastos_${ym}.csv`);
        log(`üìÑ CSV generado (${rows.length} filas)`);
      }catch(e){
        console.error(e);
        alert("Error generando CSV: " + (e.message||""));
      }
    });

    $("btnZIP").addEventListener("click", async ()=>{
      try{
        const ym = $("expMonth").value;
        if(!ym) return alert("Selecciona un mes (YYYY-MM)");
        const entries = await getEntriesForMonth(ym);
        const photos = entries.filter(e => e.photoURL);
        if (photos.length === 0) return alert("No hay fotos en ese mes");

        const zip = new JSZip();
        let ok = 0, fail = 0;

        const urlToPath = (url) => {
          try {
            const afterO = url.split("/o/")[1];
            if (!afterO) return "";
            const encodedPath = afterO.split("?")[0];
            return decodeURIComponent(encodedPath);
          } catch { return ""; }
        };

        for (const e of photos){
          try{
            const path = e.photoPath || urlToPath(e.photoURL);
            if (!path) throw new Error("Sin ruta de Storage");

            const r = ref(storage, path);
            let blob;
            try {
              blob = await getBlob(r);
            } catch {
              const bytes = await getBytes(r);
              blob = new Blob([bytes]);
            }

            const d = e.date instanceof Date ? e.date : new Date(e.date);
            const dateISO = d.toISOString().slice(0,10);
            const prov = (e.provider||"ticket").toString().replace(/[^a-zA-Z0-9-_ ]/g,"").slice(0,40).replace(/\\s+/g,"_");
            const guessedExt = (blob.type && blob.type.includes("/")) ? blob.type.split("/")[1] : "jpg";
            const name = `${dateISO}_${prov}.${guessedExt}`;

            zip.file(name, blob);
            ok++;
          }catch(err){
            fail++; 
            log({ fallo_descarga_foto_sdk: e.photoURL || e.photoPath, err: err.message||String(err) });
          }
        }

        const out = await zip.generateAsync({type:"blob"});
        saveAs(out, `Fotos_Gastos_${ym}.zip`);
        log(`üóúÔ∏è ZIP listo: ${ok} fotos OK, ${fail} fallos`);
      }catch(e){
        console.error(e);
        alert("Error creando ZIP: " + (e.message||""));
      }
    });

  </script>
</body>
</html>
