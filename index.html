<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ App</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- Config Firebase (usa window.__FBCONFIG__ desde config.js) -->
  <script src="config.js"></script>
</head>
<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N
  </h1>

  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <button id="btnConfigOCR" class="btn">‚öôÔ∏è Config OCR</button>
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Acciones r√°pidas</h2>
      <div class="row">
        <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
        <button id="manualBtn" class="btn">Ôºã Ingreso manual</button>
      </div>
      <div class="small">
        Si no hay login, los apuntes se guardan localmente en este navegador.
      </div>
    </div>

    <div class="card">
      <h2>Notas recientes</h2>
      <div id="lista" class="list"></div>
    </div>
  </div>
</main>

<!-- MODAL REVISI√ìN / GUARDADO -->
<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:16px">Revisar y guardar</h2>
      <button id="closeReview" class="btn">Cerrar</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Fecha</label><br>
        <input id="revDate" type="date">
      </div>
      <div>
        <label>Importe (‚Ç¨)</label><br>
        <input id="revAmount" type="number" step="0.01">
      </div>
    </div>

    <div class="row">
      <div style="flex:1;min-width:150px">
        <label>Proveedor</label><br>
        <input id="revProvider">
      </div>
      <div>
        <label>Categor√≠a</label><br>
        <select id="revCategory">
          <option value="comida">Comida</option>
          <option value="peajes">Peajes</option>
          <option value="gasolina">Gasolina</option>
          <option value="transporte">Transporte</option>
          <option value="alojamiento">Alojamiento</option>
          <option value="ocio">Ocio</option>
          <option value="servicios">Servicios</option>
          <option value="varios" selected>Varios</option>
          <option value="ingreso">Ingreso</option>
        </select>
      </div>
      <div>
        <label>Pagado con</label><br>
        <select id="revPaidWith">
          <option value="empresa" selected>Tarjeta empresa</option>
          <option value="personal">Mi dinero</option>
        </select>
      </div>
    </div>

    <div class="row">
      <textarea id="revNotes" rows="3" placeholder="Notas"></textarea>
      <img id="revThumb" class="thumb" alt="preview">
    </div>

    <div id="revFileInfo" class="small"></div>

    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div class="row">
        <button id="btnPick" class="btn">üìé Adjuntar foto</button>
        <button id="btnCam" class="btn">üì∑ Tomar foto</button>
      </div>
      <button id="saveReview" class="btn primary">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIG OCR -->
<div id="ocrModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:16px">Configurar OCR (Gemini)</h2>
      <button id="closeOCR" class="btn">Cerrar</button>
    </div>

    <div style="margin-top:10px">
      <label>API Key de Gemini</label><br>
      <input id="ocrKeyInput" type="text" style="width:100%">
      <div class="small" style="margin-top:6px">
        Se guarda solo en este dispositivo (localStorage).<br>
        Puedes conseguir tu API Key en <b>aistudio.google.com</b>.
      </div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button id="btnTestKey" class="btn">Probar clave</button>
      <div class="row">
        <button id="btnSaveKey" class="btn primary">Guardar clave</button>
        <button id="btnClearKey" class="btn danger">Borrar clave</button>
      </div>
    </div>

    <div id="ocrStatus" class="small" style="margin-top:8px"></div>
  </div>
</div>

<!-- FIREBASE + AUTH GOOGLE -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth   : auth,
      db     : firebase.firestore(),
      storage: firebase.storage()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA OCR + GUARDADO + LISTA -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  /* MODALES */
  function openModal(){
    var m = $('reviewModal');
    if (!m) return;
    m.classList.add('open');
    m.setAttribute('aria-hidden','false');
  }

  function closeModal(){
    var m = $('reviewModal');
    if (!m) return;
    m.classList.remove('open');
    m.setAttribute('aria-hidden','true');
  }

  function openOCRModal(){
    var m = $('ocrModal');
    if (!m) return;
    var key = localStorage.getItem('gkey') || '';
    $('ocrKeyInput').value = key;
    $('ocrStatus').textContent = key ? 'Clave cargada en este dispositivo.' : 'No hay clave guardada todav√≠a.';
    m.classList.add('open');
    m.setAttribute('aria-hidden','false');
  }

  function closeOCRModal(){
    var m = $('ocrModal');
    if (!m) return;
    m.classList.remove('open');
    m.setAttribute('aria-hidden','true');
  }

  if ($('btnConfigOCR')) $('btnConfigOCR').addEventListener('click', openOCRModal);
  if ($('closeOCR'))     $('closeOCR').addEventListener('click', closeOCRModal);

  if ($('btnSaveKey')){
    $('btnSaveKey').addEventListener('click', function(){
      var v = $('ocrKeyInput').value.trim();
      if (!v){
        alert('Introduce una clave v√°lida.');
        return;
      }
      localStorage.setItem('gkey', v);
      $('ocrStatus').textContent = 'Clave guardada correctamente.';
    });
  }

  if ($('btnClearKey')){
    $('btnClearKey').addEventListener('click', function(){
      localStorage.removeItem('gkey');
      $('ocrKeyInput').value = '';
      $('ocrStatus').textContent = 'Clave borrada. El OCR no funcionar√° hasta que configures una nueva.';
    });
  }

  if ($('btnTestKey')){
    $('btnTestKey').addEventListener('click', async function(){
      var key = $('ocrKeyInput').value.trim();
      if (!key){
        alert('Introduce una clave para probar.');
        return;
      }
      $('ocrStatus').textContent = 'Probando clave‚Ä¶';
      try{
        var body = {
          contents: [{
            role: 'user',
            parts:[{ text: 'Hola, responde con un OK.' }]
          }]
        };
        var res = await fetch(
          'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key='+
          encodeURIComponent(key),
          {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
          }
        );
        if (!res.ok){
          $('ocrStatus').textContent = 'Error al probar la clave: HTTP '+res.status;
          return;
        }
        $('ocrStatus').textContent = 'Clave v√°lida ‚úÖ';
      }catch(e){
        $('ocrStatus').textContent = 'Error al probar la clave: '+(e.message||e);
      }
    });
  }

  /* INGRESO MANUAL */
  var manualBtn = $('manualBtn');
  if (manualBtn){
    manualBtn.addEventListener('click', function(){
      $('revDate').value      = new Date().toISOString().slice(0,10);
      $('revAmount').value    = '';
      $('revProvider').value  = '';
      $('revCategory').value  = 'varios';
      $('revPaidWith').value  = 'empresa';
      $('revNotes').value     = '';
      $('revThumb').src       = '';
      $('revFileInfo').textContent = '';
      window.__lastFile = null;
      openModal();
    });
  }

  /* PICK FILE / C√ÅMARA -> abre modal y lanza OCR auto */
  function pickFile(fromCamera){
    var inp = document.createElement('input');
    inp.type   = 'file';
    inp.accept = 'image/*';
    if (fromCamera) inp.capture = 'environment';

    inp.onchange = function(){
      var f = inp.files && inp.files[0];
      if (!f) return;
      window.__lastFile = f;

      // Vista previa
      $('revThumb').src = URL.createObjectURL(f);
      $('revFileInfo').textContent =
        (f.name || 'ticket') + ' ¬∑ ' + Math.round((f.size || 0)/1024) + ' KB';

      // Fecha por defecto: hoy
      $('revDate').value = new Date().toISOString().slice(0,10);

      // Abrimos modal y lanzamos OCR
      openModal();
      $('revFileInfo').textContent += ' ¬∑ Analizando ticket‚Ä¶';
      setTimeout(runOCR, 200);
    };

    inp.click();
  }

  if ($('scanBtn')) $('scanBtn').addEventListener('click', function(){ pickFile(true); });
  if ($('btnPick')) $('btnPick').addEventListener('click', function(){ pickFile(false); });
  if ($('btnCam'))  $('btnCam').addEventListener('click',  function(){ pickFile(true);  });
  if ($('closeReview')) $('closeReview').addEventListener('click', closeModal);

  /* HELPERS IA (tomados del index que te funcionaba) */

  function fileToBase64(file){
    return new Promise(function(resolve, reject){
      var reader = new FileReader();
      reader.onload = function(e){
        var dataUrl = e.target.result;          // data:image/...;base64,AAAA
        var base64  = dataUrl.split(',')[1] || '';
        resolve(base64);
      };
      reader.onerror = function(err){ reject(err); };
      reader.readAsDataURL(file);
    });
  }

  function safeParseJSON(text){
    var s = (text || '').trim();
    if (s.startsWith('```')) {
      s = s.replace(/^```(?:json)?/i,'').replace(/```$/i,'').trim();
    }
    var a = s.indexOf('{');
    var b = s.lastIndexOf('}');
    if (a !== -1 && b !== -1) {
      s = s.slice(a, b+1);
    }
    return JSON.parse(s);
  }

  function fallbackParse(text){
    var t = (text || '').replace(/\s+/g,' ').trim();
    var amount = 0;
    var m = t.match(/(\d+[.,]\d{2})\s*(‚Ç¨|eur)?/i);
    if (m) amount = Number(m[1].replace(',', '.'));

    var dateISO = new Date().toISOString().slice(0,10);
    var d1 = t.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
    var d2 = t.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
    if (d2) {
      dateISO = d2[1] + '-' + d2[2] + '-' + d2[3];
    } else if (d1) {
      dateISO = d1[3] + '-' + d1[2] + '-' + d1[1];
    }

    var provider = 'Ticket';
    var prov = t.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][A-Za-z√Å√â√ç√ì√ö√ë0-9&\-. ]{2,40}/);
    if (prov) provider = prov[0].trim();

    return { date: dateISO, provider: provider, amount: amount };
  }

  async function ensureKey(){
    var key = (localStorage.getItem('gkey') || '').trim();
    if (!key){
      openOCRModal();
      throw new Error('No hay API Key configurada');
    }
    return key;
  }

  /* OCR CON GEMINI (misma l√≥gica que el index bueno) */
  async function runOCR(){
    try{
      var key  = await ensureKey();
      var file = window.__lastFile;
      if (!key || !file) return;

      if ($('revFileInfo')) {
        $('revFileInfo').textContent =
          (file.name || 'ticket') + ' ¬∑ ' + Math.round((file.size || 0)/1024) +
          ' KB ¬∑ Analizando con OCR‚Ä¶';
      }

      var b64 = await fileToBase64(file);

      var prompt = 'Devuelve solo un JSON v√°lido con:\n' +
        '{"date":"YYYY-MM-DD","provider":"Nombre","amount":0.00}';

      var body = {
        contents: [{
          role : 'user',
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType: file.type || 'image/jpeg',
                data    : b64
              }
            }
          ]
        }]
      };

      var url = 'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=' +
                encodeURIComponent(key);

      var res  = await fetch(url, {
        method :'POST',
        headers:{ 'Content-Type':'application/json' },
        body   : JSON.stringify(body)
      });

      var rawText = await res.text();
      var data = null;
      try{ data = JSON.parse(rawText); }catch(e){}

      if (!res.ok){
        console.error('HTTP error OCR', res.status, data || rawText);
        if ($('revFileInfo')){
          $('revFileInfo').textContent =
            'Error OCR (HTTP ' + res.status + '). Revisa la API Key o los l√≠mites de uso.';
        }
        return;
      }

      var text = '';
      try{
        var parts =
          data &&
          data.candidates &&
          data.candidates[0] &&
          data.candidates[0].content &&
          data.candidates[0].content.parts;

        if (Array.isArray(parts)){
          for (var i=0; i<parts.length; i++){
            if (parts[i].text){
              text += parts[i].text + '\n';
            }
          }
        }
      }catch(e){
        console.warn('Error leyendo respuesta de Gemini', e);
      }

      if (!text){
        console.warn('Respuesta OCR sin texto √∫til', data || rawText);
        if ($('revFileInfo')){
          $('revFileInfo').textContent =
            'No se ha podido leer el ticket. Prueba con una foto m√°s clara o revisa la clave.';
        }
        return;
      }

      console.log('OCR RAW TEXT:', text);

      var parsed;
      try{
        parsed = safeParseJSON(text);
      }catch(e){
        parsed = fallbackParse(text);
      }

      var dateStr = parsed.date || new Date().toISOString().slice(0,10);
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
        dateStr = new Date().toISOString().slice(0,10);
      }
      $('revDate').value     = dateStr;
      $('revProvider').value = (parsed.provider || 'Ticket').toString().slice(0,80);
      if (parsed.amount != null){
        $('revAmount').value = Number(parsed.amount || 0);
      }

      if ($('revFileInfo')){
        $('revFileInfo').textContent =
          (file.name || 'ticket') + ' ¬∑ ' + Math.round((file.size || 0)/1024) +
          ' KB ¬∑ OCR completado ‚úÖ';
      }
    }catch(e){
      console.warn('OCR error', e);
      if ($('revFileInfo')){
        $('revFileInfo').textContent =
          'Error ejecutando OCR: ' + (e.message || e);
      }
    }
  }

  async function saveEntry(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var st   = ctx.storage;

    var user = auth && auth.currentUser;

    var dateISO  = $('revDate').value || new Date().toISOString().slice(0,10);
    var amount   = Number($('revAmount').value || 0);
    var provider = $('revProvider').value.trim();
    var category = $('revCategory').value;
    var paidWith = $('revPaidWith').value;
    var notes    = $('revNotes').value;
    var file     = window.__lastFile || null;

    try{
      var photoURL  = null;
      var photoPath = null;

      if (file && user && st){
        var yyyyMM   = dateISO.slice(0,7);
        var safeProv = (provider || 'ticket').replace(/[^a-z0-9-_]/gi,'_').toLowerCase();
        var name     = dateISO + '_' + safeProv + '_' + Date.now() + '.jpg';
        photoPath    = 'tickets/' + user.uid + '/' + yyyyMM + '/' + name;

        var ref = st.ref(photoPath);
        await ref.put(file);
        photoURL = await ref.getDownloadURL();
      }

      if (user && db){
        await db.collection('users/' + user.uid + '/entries').add({
          date     : new Date(dateISO),
          amount   : amount,
          provider : provider,
          category : category,
          paidWith : paidWith,
          notes    : notes,
          photoURL : photoURL,
          photoPath: photoPath,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Guardado ‚úÖ');
      } else {
        var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
        arr.push({
          date    : dateISO,
          amount  : amount,
          provider: provider,
          category: category,
          paidWith: paidWith,
          notes   : notes
        });
        localStorage.setItem('entries_local', JSON.stringify(arr));
        alert('Guardado en local ‚úÖ (sin login)');
      }

      closeModal();
      document.dispatchEvent(new CustomEvent('entries-updated'));
      renderList();
    }catch(e){
      alert('Error guardando: ' + (e && e.message || ''));
      console.error(e);
    }
  }

  if ($('saveReview')) $('saveReview').addEventListener('click', saveEntry);

  /* LISTA √öLTIMOS APUNTES */
  function renderList(){
    var cont = $('lista');
    if (!cont) return;
    cont.innerHTML = '';

    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    if (user && db){
      db.collection('users/' + user.uid + '/entries')
        .orderBy('date','desc')
        .limit(5)
        .get()
        .then(function(snap){
          if (snap.empty){
            cont.innerHTML = '<div class="small">Sin apuntes a√∫n.</div>';
            return;
          }
          snap.forEach(function(doc){
            var e = doc.data();
            var d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
            var div = document.createElement('div');
            div.className = 'small';
            div.textContent =
              d.toISOString().slice(0,10) + ' ¬∑ ' +
              (e.provider || '-') + ' ¬∑ ' +
              (e.amount || 0) + '‚Ç¨';
            cont.appendChild(div);
          });
        });
    } else {
      var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      if (!arr.length){
        cont.innerHTML = '<div class="small">Sin apuntes a√∫n.</div>';
        return;
      }
      arr.slice(-5).reverse().forEach(function(e){
        var div = document.createElement('div');
        div.className = 'small';
        div.textContent =
          e.date + ' ¬∑ ' + (e.provider || '-') + ' ¬∑ ' + (e.amount || 0) + '‚Ç¨';
        cont.appendChild(div);
      });
    }
  }

  document.addEventListener('auth-changed',     renderList, false);
  document.addEventListener('entries-updated',  renderList, false);
  renderList();
})();
</script>

</body>
</html>
