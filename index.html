<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ App</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>

  <style>
    /* Solo mejoras visuales locales (sin tocar l√≥gica) */

    /* Lista de notas en cards (mejor en m√≥vil) */
    #lista .note-item{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(208, 213, 229, 0.9);
      background: var(--bg-card-soft);
    }

    /* Barra de acciones r√°pida: dos botones grandes, especialmente en m√≥vil */
    .quick-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .quick-actions .btn{
      flex: 1 1 220px;
    }

    /* Thumbnail del modal */
    #revThumb{
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #fff;
    }

    /* En m√≥vil: botones a√∫n m√°s grandes y layout del modal m√°s c√≥modo */
    @media (max-width: 600px){
      .quick-actions .btn{
        flex: 1 1 100%;
      }
      #revThumb{
        width: 84px;
        height: 84px;
      }
    }
  </style>
</head>

<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:6px;">
    Gastos 2N
  </h1>

  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <button id="btnConfigOCR" class="btn">‚öôÔ∏è Config OCR</button>
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Acciones r√°pidas</h2>

      <div class="quick-actions">
        <button id="scanBtn" class="btn primary">üì∏ Escanear ticket</button>
        <button id="manualBtn" class="btn">Ôºã Ingreso manual</button>
      </div>

      <div class="small" style="margin-top:8px">
        Si no hay login, los apuntes se guardan localmente en este navegador.
      </div>
    </div>

    <div class="card">
      <h2>Notas recientes</h2>
      <div id="lista" class="list"></div>
    </div>
  </div>
</main>

<!-- MODAL REVISI√ìN / GUARDADO -->
<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:16px">Revisar y guardar</h2>
      <button id="closeReview" class="btn">Cerrar</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:160px">
        <label>Fecha</label><br>
        <input id="revDate" type="date">
      </div>
      <div style="flex:1;min-width:140px">
        <label>Importe (‚Ç¨)</label><br>
        <input id="revAmount" type="number" step="0.01">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1;min-width:160px">
        <label>Proveedor</label><br>
        <input id="revProvider">
      </div>
      <div style="flex:1;min-width:150px">
        <label>Categor√≠a</label><br>
        <select id="revCategory">
          <option value="comida">Comida</option>
          <option value="peajes">Peajes</option>
          <option value="gasolina">Gasolina</option>
          <option value="transporte">Transporte</option>
          <option value="alojamiento">Alojamiento</option>
          <option value="ocio">Ocio</option>
          <option value="servicios">Servicios</option>
          <option value="varios" selected>Varios</option>
          <option value="ingreso">Ingreso</option>
        </select>
      </div>
      <div style="flex:1;min-width:150px">
        <label>Pagado con</label><br>
        <select id="revPaidWith">
          <option value="empresa" selected>Tarjeta empresa</option>
          <option value="personal">Mi dinero</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px;align-items:flex-start">
      <textarea id="revNotes" rows="3" placeholder="Notas" style="flex:1;min-width:200px"></textarea>
      <img id="revThumb" class="thumb" alt="preview">
    </div>

    <div id="revFileInfo" class="small" style="margin-top:6px"></div>

    <div class="row" style="justify-content:space-between;margin-top:12px;flex-wrap:wrap">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnPick" class="btn">üìé Adjuntar foto</button>
        <button id="btnCam" class="btn">üì∑ Tomar foto</button>
      </div>
      <button id="saveReview" class="btn primary">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIG OCR -->
<div id="ocrModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:16px">Configurar OCR (Gemini)</h2>
      <button id="closeOCR" class="btn">Cerrar</button>
    </div>

    <div style="margin-top:10px">
      <label>API Key de Gemini</label><br>
      <input id="ocrKeyInput" type="text" style="width:100%">
      <div class="small" style="margin-top:6px">
        Se guarda solo en este dispositivo (localStorage).<br>
        Puedes conseguir tu API Key en <b>aistudio.google.com</b>.
      </div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:12px;flex-wrap:wrap">
      <button id="btnTestKey" class="btn">Probar clave</button>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnSaveKey" class="btn primary">Guardar clave</button>
        <button id="btnClearKey" class="btn danger">Borrar clave</button>
      </div>
    </div>

    <div id="ocrStatus" class="small" style="margin-top:8px"></div>
  </div>
</div>

<!-- FIREBASE + AUTH GOOGLE -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth   : auth,
      db     : firebase.firestore(),
      storage: firebase.storage()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA OCR + GUARDADO + LISTA -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  // Cargar key si ya estaba guardada
  window.__GKEY__ = window.__GKEY__ || localStorage.getItem('gkey') || null;

  /* ========= MODALES ========= */

  function openModal(){
    var m = $('reviewModal');
    if (!m) return;
    m.classList.add('open');
    m.setAttribute('aria-hidden','false');
  }

  function closeModal(){
    var m = $('reviewModal');
    if (!m) return;
    m.classList.remove('open');
    m.setAttribute('aria-hidden','true');
  }

  function openOCRModal(){
    var m = $('ocrModal');
    if (!m) return;
    var key = window.__GKEY__ || localStorage.getItem('gkey') || '';
    $('ocrKeyInput').value = key;
    $('ocrStatus').textContent = key
      ? 'Clave cargada en este dispositivo.'
      : 'No hay clave guardada todav√≠a.';
    m.classList.add('open');
    m.setAttribute('aria-hidden','false');
  }

  function closeOCRModal(){
    var m = $('ocrModal');
    if (!m) return;
    m.classList.remove('open');
    m.setAttribute('aria-hidden','true');
  }

  if ($('btnConfigOCR')) $('btnConfigOCR').addEventListener('click', openOCRModal);
  if ($('closeOCR'))     $('closeOCR').addEventListener('click', closeOCRModal);

  /* ========= GESTI√ìN API KEY ========= */

  if ($('btnSaveKey')){
    $('btnSaveKey').addEventListener('click', function(){
      var v = $('ocrKeyInput').value.trim();
      if (!v){
        alert('Introduce una clave v√°lida.');
        return;
      }
      window.__GKEY__ = v;
      localStorage.setItem('gkey', v);
      $('ocrStatus').textContent = 'Clave guardada correctamente. ‚úÖ';
    });
  }

  if ($('btnClearKey')){
    $('btnClearKey').addEventListener('click', function(){
      window.__GKEY__ = null;
      localStorage.removeItem('gkey');
      $('ocrKeyInput').value = '';
      $('ocrStatus').textContent = 'Clave borrada. El OCR no funcionar√° hasta que configures una nueva.';
    });
  }

  if ($('btnTestKey')){
    $('btnTestKey').addEventListener('click', async function(){
      var key = $('ocrKeyInput').value.trim();
      if (!key){
        alert('Introduce una clave para probar.');
        return;
      }
      $('ocrStatus').textContent = 'Probando clave‚Ä¶';
      try{
        var body = {
          contents: [{
            role: 'user',
            parts:[{ text: 'Hola' }]
          }]
        };
        var res = await fetch(
          'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key='+encodeURIComponent(key),
          {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
          }
        );
        if (!res.ok){
          $('ocrStatus').textContent = 'Error al probar la clave: HTTP '+res.status;
          return;
        }
        window.__GKEY__ = key;
        localStorage.setItem('gkey', key);
        $('ocrStatus').textContent = 'Clave v√°lida y guardada ‚úÖ';
      }catch(e){
        $('ocrStatus').textContent = 'Error al probar la clave: '+(e.message||e);
      }
    });
  }

  /* ========= INGRESO MANUAL ========= */

  var manualBtn = $('manualBtn');
  if (manualBtn){
    manualBtn.addEventListener('click', function(){
      $('revDate').value      = new Date().toISOString().slice(0,10);
      $('revAmount').value    = '';
      $('revProvider').value  = '';
      $('revCategory').value  = 'varios';
      $('revPaidWith').value  = 'empresa';
      $('revNotes').value     = '';
      $('revThumb').src       = '';
      $('revFileInfo').textContent = '';
      window.__lastFile = null;
      openModal();
    });
  }

  /* ========= PICK FILE / C√ÅMARA (OCR AUTO) ========= */

  function pickFile(fromCamera){
    var inp = document.createElement('input');
    inp.type   = 'file';
    inp.accept = 'image/*';
    if (fromCamera) inp.capture = 'environment';

    inp.onchange = function(){
      var f = inp.files && inp.files[0];
      if (!f) return;
      window.__lastFile = f;
      $('revThumb').src = URL.createObjectURL(f);
      $('revFileInfo').textContent =
        (f.name || 'ticket') + ' ¬∑ ' + Math.round((f.size || 0)/1024) + ' KB';
      $('revDate').value = new Date().toISOString().slice(0,10);
      openModal();
      // OCR autom√°tico
      setTimeout(runOCR, 150);
    };

    inp.click();
  }

  if ($('scanBtn')) $('scanBtn').addEventListener('click', function(){ pickFile(true); });
  if ($('btnPick')) $('btnPick').addEventListener('click', function(){ pickFile(false); });
  if ($('btnCam'))  $('btnCam').addEventListener('click',  function(){ pickFile(true);  });
  if ($('closeReview')) $('closeReview').addEventListener('click', closeModal);

  /* ========= PARSER OCR ========= */

  function normalizarCategoria(raw){
    if (!raw) return null;
    var c = String(raw).trim().toLowerCase();
    if (c.includes('ingres')) return 'ingreso';
    if (c.includes('comida') || c.includes('rest') || c.includes('food')) return 'comida';
    if (c.includes('peaje') || c.includes('toll')) return 'peajes';
    if (c.includes('gas') || c.includes('fuel') || c.includes('diesel')) return 'gasolina';
    if (c.includes('hotel') || c.includes('aloj')) return 'alojamiento';
    if (c.includes('ocio') || c.includes('entertain')) return 'ocio';
    if (c.includes('serv')) return 'servicios';
    if (c.includes('transp') || c.includes('taxi') || c.includes('uber') || c.includes('cabify')) return 'transporte';
    return 'varios';
  }

  function parseOcrText(text){
    var out = { provider:null, date:null, amount:null, category:null };

    var jsonMatch = text && text.match && text.match(/\{[\s\S]*\}/);
    if (jsonMatch){
      try{
        var obj = JSON.parse(jsonMatch[0]);
        out.provider = obj.provider || obj.proveedor || null;
        out.date     = obj.date     || obj.fecha     || null;
        out.amount   = obj.amount   || obj.importe   || null;
        out.category = obj.category || obj.categoria || null;
      }catch(e){}
    }

    if (!out.provider){
      var mProv = text.match(/(?:provider|proveedor)\s*[:=]\s*"?([^\n"]+)/i);
      if (!mProv) mProv = text.match(/^[A-Z√Å√â√ç√ì√ö√ë0-9][^\n]{3,30}$/m);
      if (mProv) out.provider = (mProv[1] ? mProv[1] : mProv[0]).trim();
    }

    if (!out.date){
      var mISO = text.match(/(\d{4}-\d{2}-\d{2})/);
      if (mISO){
        out.date = mISO[1];
      } else {
        var mEU = text.match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
        if (mEU){
          var d = mEU[1].padStart(2,'0');
          var m = mEU[2].padStart(2,'0');
          var y = mEU[3];
          if (y.length === 2) y = '20'+y;
          out.date = y+'-'+m+'-'+d;
        }
      }
    }

    if (out.amount == null){
      var allNums = text.match(/(\d+[.,]\d{2})\s*‚Ç¨?/g);
      if (allNums && allNums.length){
        var last = allNums[allNums.length-1];
        last = last.replace(/[‚Ç¨\s]/g,'').replace(',','.');
        var val = parseFloat(last);
        if (!isNaN(val)) out.amount = val;
      }
    }

    if (!out.category){
      var mCat = text.match(/(?:category|categor[i√≠]a)\s*[:=]\s*"?([a-zA-Z√°√©√≠√≥√∫√±]+)/i);
      if (mCat) out.category = mCat[1];
    }

    if (out.category){
      out.category = normalizarCategoria(out.category);
    }

    return out;
  }

  /* ========= UTILIDAD: ArrayBuffer ‚Üí base64 (sin reventar la pila) ========= */

  function arrayBufferToBase64(ab){
    var bytes = new Uint8Array(ab);
    var len   = bytes.length;
    var chunk = 0x8000; // 32KB por trozo
    var binary = '';

    for (var i = 0; i < len; i += chunk){
      var sub = bytes.subarray(i, i + chunk);
      binary += String.fromCharCode.apply(null, sub);
    }
    return btoa(binary);
  }

  /* ========= KEY PARA OCR ========= */

  async function ensureKey(){
    var key = window.__GKEY__;
    if (!key){
      key = localStorage.getItem('gkey');
      if (key){
        window.__GKEY__ = key;
      }
    }
    if (!key){
      openOCRModal();
      throw new Error('No hay API Key configurada');
    }
    return key;
  }

  /* ========= OCR PRINCIPAL ========= */

  async function runOCR(){
    try{
      var key  = await ensureKey();
      var file = window.__lastFile;
      if (!key || !file) return;

      var ab  = await file.arrayBuffer();
      var b64 = arrayBufferToBase64(ab);

      var body = {
        contents: [{
          role : 'user',
          parts: [
            { text: 'Extrae proveedor, fecha (YYYY-MM-DD), categor√≠a (comida, peajes, gasolina, transporte, alojamiento, ocio, servicios, varios o ingreso) e importe total EUR. Devuelve JSON con provider,date,category,amount.' },
            { inlineData: { mimeType:'image/jpeg', data:b64 } }
          ]
        }]
      };

      var res  = await fetch(
        'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key='+encodeURIComponent(key),
        {
          method :'POST',
          headers:{ 'Content-Type':'application/json' },
          body   : JSON.stringify(body)
        }
      );

      if (!res.ok){
        console.warn('OCR HTTP error', res.status);
        return;
      }

      var data = await res.json();
      var text =
        data &&
        data.candidates &&
        data.candidates[0] &&
        data.candidates[0].content &&
        data.candidates[0].content.parts &&
        data.candidates[0].content.parts[0].text
          ? data.candidates[0].content.parts[0].text
          : "";

      var parsed = parseOcrText(text);

      if (parsed.provider) $('revProvider').value = parsed.provider;
      if (parsed.date)     $('revDate').value     = parsed.date;
      if (parsed.amount != null)
        $('revAmount').value = Number(parsed.amount || 0);
      if (parsed.category){
        $('revCategory').value = parsed.category;
      }
    }catch(e){
      console.warn('OCR error', e);
    }
  }

  /* ========= GUARDAR ENTRADA ========= */

  async function saveEntry(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var st   = ctx.storage;

    var user = auth && auth.currentUser;

    var dateISO  = $('revDate').value || new Date().toISOString().slice(0,10);
    var amount   = Number($('revAmount').value || 0);
    var provider = $('revProvider').value.trim();
    var category = $('revCategory').value;
    var paidWith = $('revPaidWith').value;
    var notes    = $('revNotes').value;
    var file     = window.__lastFile || null;

    try{
      var photoURL  = null;
      var photoPath = null;

      if (file && user && st){
        var yyyyMM   = dateISO.slice(0,7);
        var safeProv = (provider || 'ticket').replace(/[^a-z0-9-_]/gi,'_').toLowerCase();
        var name     = dateISO + '_' + safeProv + '_' + Date.now() + '.jpg';
        photoPath    = 'tickets/' + user.uid + '/' + yyyyMM + '/' + name;

        var ref = st.ref(photoPath);
        await ref.put(file);
        photoURL = await ref.getDownloadURL();
      }

      if (user && db){
        await db.collection('users/' + user.uid + '/entries').add({
          date     : new Date(dateISO),
          amount   : amount,
          provider : provider,
          category : category,
          paidWith : paidWith,
          notes    : notes,
          photoURL : photoURL,
          photoPath: photoPath,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Guardado ‚úÖ');
      } else {
        var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
        arr.push({
          date    : dateISO,
          amount  : amount,
          provider: provider,
          category: category,
          paidWith: paidWith,
          notes   : notes
        });
        localStorage.setItem('entries_local', JSON.stringify(arr));
        alert('Guardado en local ‚úÖ (sin login)');
      }

      closeModal();
      document.dispatchEvent(new CustomEvent('entries-updated'));
      renderList();
    }catch(e){
      alert('Error guardando: ' + (e && e.message || ''));
      console.error(e);
    }
  }

  if ($('saveReview')) $('saveReview').addEventListener('click', saveEntry);

  /* ========= LISTA √öLTIMOS APUNTES ========= */

  function renderList(){
    var cont = $('lista');
    if (!cont) return;
    cont.innerHTML = '';

    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    if (user && db){
      db.collection('users/' + user.uid + '/entries')
        .orderBy('date','desc')
        .limit(5)
        .get()
        .then(function(snap){
          if (snap.empty){
            cont.innerHTML = '<div class="small note-item">Sin apuntes a√∫n.</div>';
            return;
          }
          snap.forEach(function(doc){
            var e = doc.data();
            var d = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
            var div = document.createElement('div');
            div.className = 'small note-item';
            div.textContent =
              d.toISOString().slice(0,10) + ' ¬∑ ' +
              (e.provider || '-') + ' ¬∑ ' +
              (e.amount || 0) + '‚Ç¨';
            cont.appendChild(div);
          });
        });
    } else {
      var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      if (!arr.length){
        cont.innerHTML = '<div class="small note-item">Sin apuntes a√∫n.</div>';
        return;
      }
      arr.slice(-5).reverse().forEach(function(e){
        var div = document.createElement('div');
        div.className = 'small note-item';
        div.textContent =
          e.date + ' ¬∑ ' + (e.provider || '-') + ' ¬∑ ' + (e.amount || 0) + '‚Ç¨';
        cont.appendChild(div);
      });
    }
  }

  document.addEventListener('auth-changed',    renderList, false);
  document.addEventListener('entries-updated', renderList, false);
  renderList();
})();
</script>

</body>
</html>
