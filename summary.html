<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sumary Â· Gastos 2N</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
<header class="topbar">
  <h1 style="display:flex;gap:.5rem;align-items:center;"><img src="assets/2n-logo-black.png" alt="2N" style="height:20px"> ğŸ“Š Sumario</h1>
  <a class="badge" href="index.html">â† Volver</a>
</header>
<main class="content">
  <div id="sumPanel" class="card">
    <h2>Resumen mensual</h2>
    <div class="row">
      <div class="field"><label>Mes</label><input id="sumMonth" type="month"/></div>
      <button id="btnPDF" class="btn primary">ğŸ§¾ PDF</button>
      <button id="btnFotos" class="btn">ğŸ–¼ï¸ Abrir fotos</button>
    </div>
    <hr class="sep"/>
    <div class="kpi">
      <div class="tile"><div class="small">Gasto total</div><div id="sGasto" class="v">0.00 â‚¬</div></div>
      <div class="tile"><div class="small">Ingresos</div><div id="sIng" class="v">0.00 â‚¬</div></div>
      <div class="tile"><div class="small">Pagado con mi dinero</div><div id="sMi" class="v">0.00 â‚¬</div></div>
      <div class="tile"><div class="small">KM personales (coste)</div><div id="sKm" class="v">0.00 â‚¬</div></div>
    </div>
    <hr class="sep"/>
    <div class="row">
      <div class="badge">ğŸ”¢ LiquidaciÃ³n neta = Gastos - Ingresos - KM personales</div>
    </div>
    <h3 style="margin-top:10px">LiquidaciÃ³n neta</h3>
    <div class="tile" style="padding:18px;font-size:22px" id="liq">0.00 â‚¬</div>
  </div>

  <div class="card">
    <h2>Logs</h2>
    <div id="out" class="logs mono"></div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const log=(m)=>{ const out=$("out"); out.textContent+=(typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; };

  const firebaseConfig = {
    apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
    authDomain: "gastos-2n.firebaseapp.com",
    projectId: "gastos-2n",
    storageBucket: "gastos-2n.firebasestorage.app",
    messagingSenderId: "55010048795",
    appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore(); let lastFotos=[];

  $("sumMonth").value=new Date().toISOString().slice(0,7);
  auth.onAuthStateChanged(u=>{ if(!u) location.href="index.html"; else cargar(); });
  $("sumMonth").onchange=cargar;

  function rangoMes(ym){ const s=new Date(ym+"-01T00:00:00"); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }

  async function cargar(){
    const u=auth.currentUser; if(!u) return;
    const ym=$("sumMonth").value; const [s,e]=rangoMes(ym);

    const ents=(await db.collection(`users/${u.uid}/entries`).where("date",">=",s).where("date","<",e).get()).docs.map(d=>d.data());
    const kms=(await db.collection(`users/${u.uid}/kms`).where("date",">=",s).where("date","<",e).get()).docs.map(d=>d.data());

    let gasto=0, ingreso=0, mi=0; const fotos=[];
    ents.forEach(e=>{
      const isExp=e.category!=="ingreso"; const a=Number(e.amount||0);
      if(isExp) gasto+=a; else ingreso+=a;
      if(isExp && e.paidWith==="mio") mi+=a;
      if(e.photoURL) fotos.push(e.photoURL); lastFotos=fotos;
    });
    let kmCost=0; kms.forEach(k=>{ kmCost += Number(k.kmPer||0)*Number(k.precio||0); });
    $("sGasto").textContent=gasto.toFixed(2)+" â‚¬";
    $("sIng").textContent=ingreso.toFixed(2)+" â‚¬";
    $("sMi").textContent=mi.toFixed(2)+" â‚¬";
    $("sKm").textContent=kmCost.toFixed(2)+" â‚¬";
    const liq = gasto - ingreso - kmCost;
    $("liq").textContent = liq.toFixed(2)+" â‚¬";

    $("btnFotos").onclick=()=>{
      if(!fotos.length) return alert("Sin fotos");
      fotos.forEach((url,i)=> setTimeout(()=> window.open(url,"_blank"), i*200));
    };

    $("btnPDF").onclick=async ()=>{
      const el=document.getElementById("sumPanel");
      const canvas=await html2canvas(el,{scale:2,backgroundColor:"#111217"});
      const img=canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf=new jsPDF({unit:"pt",format:"a4"});
      const pageW=595.28;
      const imgW=pageW-60, imgH=imgW*(canvas.height/canvas.width);
      pdf.addImage(img,"PNG",30,30,imgW,imgH);
      pdf.save(`Sumario_${ym}.pdf`);
    };
    
    $("btnPhotos").onclick=async()=>{
      const fotos = lastFotos||[]; if(!fotos.length) return alert("No hay fotos este mes");
      const zip=new JSZip();
      let i=1;
      for(const url of fotos){
        const res=await fetch(url); const blob=await res.blob();
        zip.file(`ticket_${String(i).padStart(2,'0')}.jpg`, blob);
        i++;
      }
      const out=await zip.generateAsync({type:"blob"});
      saveAs(out, `Tickets_${$("sumMonth").value}.zip`);
    };

  }
})();
</script>
</body>
</html>