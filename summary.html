<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ Summary</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>

  <style>
    /* Solo est√©tica espec√≠fica Summary (Lightning + m√≥vil) */

    .layout-summary{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .layout-summary .list-panel{
      flex: 1 1 520px;
      min-width: 260px;
      max-height: 440px;
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(208, 213, 229, 0.9);
      background: var(--bg-card-soft);
      padding: 10px;
    }

    .layout-summary .preview-panel{
      flex: 0 1 360px;
      min-width: 240px;
      border-radius: 14px;
      border: 1px solid rgba(208, 213, 229, 0.9);
      background: var(--bg-card-soft);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
    }

    .entry-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      border: 1px solid rgba(208, 213, 229, 0.6);
      background: rgba(255,255,255,0.55);
      transition: box-shadow .15s ease, transform .05s ease;
      margin-bottom:8px;
    }
    .entry-row:hover{
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.10);
    }
    .entry-row:active{
      transform: translateY(1px);
    }
    .entry-row.active{
      outline: 2px solid rgba(1,118,211,0.35);
      border-color: rgba(1,118,211,0.35);
      background: rgba(1,118,211,0.08);
    }

    .entry-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .entry-main span:first-child{
      font-weight: 750;
      font-size: 13px;
      color: var(--text-main);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 100%;
    }
    .entry-main span:last-child{
      font-size: 12px;
      color: var(--text-muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .entry-amount{
      font-weight: 800;
      font-size: 13px;
      white-space:nowrap;
      margin-left:6px;
    }

    .preview-img{
      width:100%;
      max-height: 320px;
      border-radius: 14px;
      object-fit: contain;
      border: 1px solid rgba(208, 213, 229, 0.8);
      background: #fff;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius:999px;
      font-size: 12px;
      border: 1px solid rgba(208, 213, 229, 0.9);
      background: rgba(255,255,255,0.6);
      gap:6px;
      font-weight: 650;
    }

    .big-total-card{
      flex: 1 1 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(208, 213, 229, 0.9);
      background: rgba(255,255,255,0.6);
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 13px;
    }

    .big-total-header{
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:2px;
    }

    .big-total-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .big-total-row span.label{
      color: var(--text-muted);
      font-weight: 650;
    }
    .big-total-row span.value{
      font-weight: 850;
      white-space: nowrap;
    }

    @media (max-width: 700px){
      .layout-summary .list-panel{
        max-height:none;
      }
      .layout-summary .preview-panel{
        flex: 1 1 100%;
      }
      .preview-img{
        max-height: 360px;
      }
      #btnPdf{
        width:100%;
      }
    }
  </style>
</head>

<body>
<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:6px;">
    Gastos 2N ¬∑ Summary
  </h1>

  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge active" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">

  <div class="card">
    <h2>Resumen mensual</h2>

    <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
      <div style="min-width:180px">
        <label>Mes</label><br>
        <input id="monthInput" type="month" style="min-width:170px">
      </div>

      <div class="small">
        Se muestran gastos y KM del mes seleccionado.<br>
        Inicia sesi√≥n para ver los datos sincronizados.
      </div>

      <div style="flex:1"></div>
      <button id="btnPdf" class="btn primary">üìÑ Descargar PDF</button>
    </div>

    <!-- Totales econ√≥micos -->
    <div class="row" style="margin-top:12px;gap:12px;flex-wrap:wrap">
      <div class="big-total-card">
        <div class="big-total-header">üí∂ Resumen econ√≥mico del mes</div>

        <div class="big-total-row">
          <span class="label">Total gastos</span>
          <span class="value" id="totGastos">0,00 ‚Ç¨</span>
        </div>

        <div class="big-total-row">
          <span class="label">Pagado con mi dinero</span>
          <span class="value" id="totPersonalPaid">0,00 ‚Ç¨</span>
        </div>

        <div class="big-total-row">
          <span class="label">Coste KM personales</span>
          <span class="value" id="totKmPerCost">0,00 ‚Ç¨</span>
        </div>

        <div class="big-total-row">
          <span class="label">Lo que me debe la empresa</span>
          <span class="value" id="totOwed">0,00 ‚Ç¨</span>
        </div>
      </div>
    </div>

    <!-- KM pills -->
    <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
      <div class="pill">üè¢ KM empresa: <span id="totKmEmp" style="font-weight:900;margin-left:4px">0,0 km</span></div>
      <div class="pill">üßç KM personales: <span id="totKmPer" style="font-weight:900;margin-left:4px">0,0 km</span></div>
    </div>
  </div>

  <div class="card">
    <h2>Detalle gastos + tickets</h2>

    <div class="layout-summary">
      <div class="list-panel" id="listPanel"></div>

      <div class="preview-panel">
        <div style="font-size:12px;font-weight:800;width:100%;">Vista previa ticket</div>
        <img id="ticketPreview" class="preview-img" alt="Ticket">
        <div id="previewMeta" class="small" style="width:100%;white-space:pre-wrap;"></div>
      </div>
    </div>
  </div>

</main>

<!-- FIREBASE + AUTH -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth   : auth,
      db     : firebase.firestore(),
      storage: firebase.storage()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA SUMMARY -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  // Mes actual por defecto
  (function initMonth(){
    var m = $('monthInput');
    if (!m) return;
    var now = new Date();
    var iso = now.toISOString().slice(0,7); // YYYY-MM
    m.value = iso;
  })();

  function getMonthRange(ym){
    if (!ym) return null;
    var parts = ym.split('-');
    var y = parseInt(parts[0],10);
    var m = parseInt(parts[1],10)-1;
    var start = new Date(Date.UTC(y,m,1,0,0,0));
    var end   = new Date(Date.UTC(y,m+1,1,0,0,0));
    return { start, end };
  }

  async function loadEntriesAndKms(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    var monthValue = $('monthInput').value;
    var range = getMonthRange(monthValue);

    var entries = [];
    var kms     = [];

    // --- GASTOS ---
    if (user && db && range){
      var snap = await db.collection('users/'+user.uid+'/entries')
                         .where('date','>=', range.start)
                         .where('date','<',  range.end)
                         .orderBy('date','desc')
                         .get();
      snap.forEach(function(doc){
        var o = doc.data();
        o.id  = doc.id;
        o.dateJs = o.date && o.date.toDate ? o.date.toDate() : new Date(o.date);
        entries.push(o);
      });
    } else {
      var arr = JSON.parse(localStorage.getItem('entries_local') || '[]');
      entries = arr.filter(function(e){
        var d = new Date(e.date);
        return d >= range.start && d < range.end;
      }).map(function(e){
        e.dateJs = new Date(e.date);
        return e;
      }).sort(function(a,b){ return b.dateJs - a.dateJs; });
    }

    // --- KM ---
    if (user && db && range){
      var snapKm = await db.collection('users/'+user.uid+'/kms')
                           .where('date','>=', range.start)
                           .where('date','<',  range.end)
                           .orderBy('date','desc')
                           .get();
      snapKm.forEach(function(doc){
        var o = doc.data();
        o.id  = doc.id;
        o.dateJs = o.date && o.date.toDate ? o.date.toDate() : new Date(o.date);
        kms.push(o);
      });
    } else {
      var kArr = JSON.parse(localStorage.getItem('kms_local') || '[]');
      kms = kArr.filter(function(e){
        var d = new Date(e.date);
        return d >= range.start && d < range.end;
      }).map(function(e){
        e.dateJs = new Date(e.date);
        return e;
      }).sort(function(a,b){ return b.dateJs - a.dateJs; });
    }

    return { entries, kms };
  }

  function formatEuro(v){
    return (v || 0).toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function formatKm(v){
    return (v || 0).toFixed(1).replace('.',',') + ' km';
  }

  function renderSummaryTotals(entries, kms){
    var totG = 0;
    var totPersonalPaid = 0;

    entries.forEach(function(e){
      var amount = Number(e.amount || 0);
      totG += amount;
      if ((e.paidWith || '').toLowerCase() === 'personal'){
        totPersonalPaid += amount;
      }
    });

    var kmEmp = 0;
    var kmPer = 0;
    var costPer = 0;

    kms.forEach(function(k){
      var km = Number(k.km || k.distance || 0) || 0;
      var fuel = (k.fuelPrice != null && k.fuelPrice !== '')
        ? Number(k.fuelPrice)
        : NaN;

      if ((k.type || '').toLowerCase().includes('per')){
        kmPer += km;
        if (!isNaN(fuel) && fuel > 0){
          costPer += km * fuel * 6 / 100;
        }
      } else {
        kmEmp += km;
      }
    });

    var owed = totPersonalPaid - costPer;

    $('totGastos').textContent       = formatEuro(totG);
    $('totPersonalPaid').textContent = formatEuro(totPersonalPaid);
    $('totKmEmp').textContent        = formatKm(kmEmp);
    $('totKmPer').textContent        = formatKm(kmPer);
    $('totKmPerCost').textContent    = formatEuro(costPer);
    $('totOwed').textContent         = formatEuro(owed);
  }

  var currentEntries = [];
  var currentKms     = [];
  var currentSelectedIdx = -1;

  function renderList(entries){
    currentEntries = entries || [];
    var panel = $('listPanel');
    if (!panel) return;
    panel.innerHTML = '';

    if (!entries.length){
      panel.innerHTML = '<div class="small">Sin apuntes en este mes.</div>';
      $('ticketPreview').src = '';
      $('previewMeta').textContent = 'Selecciona un apunte para ver la foto del ticket.';
      return;
    }

    entries.forEach(function(e, idx){
      var row = document.createElement('div');
      row.className = 'entry-row';
      row.dataset.idx = idx;

      var fecha = e.dateJs instanceof Date
        ? e.dateJs.toISOString().slice(0,10)
        : (e.date || '');

      var main = document.createElement('div');
      main.className = 'entry-main';

      var s1 = document.createElement('span');
      s1.textContent = (e.provider || '-');

      var s2 = document.createElement('span');
      s2.textContent =
        fecha + ' ¬∑ ' +
        (e.category || '-') + ' ¬∑ ' +
        (e.paidWith || '');

      main.appendChild(s1);
      main.appendChild(s2);

      var amt = document.createElement('div');
      amt.className = 'entry-amount';
      amt.textContent = formatEuro(Number(e.amount||0));

      row.appendChild(main);
      row.appendChild(amt);

      row.addEventListener('click', function(){
        selectEntry(idx);
      });

      panel.appendChild(row);
    });

    selectEntry(0);
  }

  function selectEntry(idx){
    currentSelectedIdx = idx;
    var panel = $('listPanel');
    if (!panel) return;

    Array.prototype.forEach.call(
      panel.querySelectorAll('.entry-row'),
      function(n){ n.classList.remove('active'); }
    );

    var sel = panel.querySelector('.entry-row[data-idx="'+idx+'"]');
    if (sel) sel.classList.add('active');

    var e = currentEntries[idx];
    if (!e){
      $('ticketPreview').src = '';
      $('previewMeta').textContent = '';
      return;
    }

    var img = $('ticketPreview');
    img.src = e.photoURL ? e.photoURL : '';

    var fecha = e.dateJs instanceof Date
      ? e.dateJs.toISOString().slice(0,10)
      : (e.date || '');

    var meta =
      fecha + ' ¬∑ ' + (e.provider||'-') +
      ' ¬∑ ' + formatEuro(Number(e.amount||0)) +
      '\nCategory: ' + (e.category||'-') +
      ' ¬∑ Paid with: ' + (e.paidWith || '-') +
      (e.notes ? '\nNotes: ' + e.notes : '');

    $('previewMeta').textContent = meta;
  }

  async function refreshAll(){
    try{
      var d = await loadEntriesAndKms();
      currentEntries = d.entries;
      currentKms     = d.kms;
      renderSummaryTotals(d.entries, d.kms);
      renderList(d.entries);
    }catch(e){
      console.error(e);
      alert('Error cargando datos del resumen: ' + (e && e.message || ''));
    }
  }

  // -------- PDF (ENGLISH) --------
  async function buildPdf(){
    var month = $('monthInput').value || '';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text('2N Expenses - Monthly Summary', 14, 16);
    doc.setFontSize(11);
    doc.text('Month: ' + (month || 'N/A'), 14, 24);

    var totG = 0;
    var totPersonalPaid = 0;

    currentEntries.forEach(function(e){
      var amount = Number(e.amount || 0);
      totG += amount;
      if ((e.paidWith || '').toLowerCase() === 'personal'){
        totPersonalPaid += amount;
      }
    });

    var kmEmp = 0, kmPer = 0, costPer = 0;
    currentKms.forEach(function(k){
      var km = Number(k.km || k.distance || 0) || 0;
      var fuel = (k.fuelPrice != null && k.fuelPrice !== '')
        ? Number(k.fuelPrice)
        : NaN;

      if ((k.type || '').toLowerCase().includes('per')){
        kmPer += km;
        if (!isNaN(fuel) && fuel > 0){
          costPer += km * fuel * 6 / 100;
        }
      } else {
        kmEmp += km;
      }
    });

    var owed = totPersonalPaid - costPer;

    // Summary boxes
    doc.setDrawColor(200);
    doc.setLineWidth(0.3);

    // Expenses box
    doc.roundedRect(12, 30, 90, 32, 3, 3);
    doc.setFontSize(11);
    doc.text('Expenses summary', 16, 36);
    doc.setFontSize(10);
    doc.text('Total expenses: ' + formatEuro(totG), 16, 44);
    doc.text('Paid with my money: ' + formatEuro(totPersonalPaid), 16, 50);
    doc.text('Company owes me: ' + formatEuro(owed), 16, 56);

    // Mileage box
    doc.roundedRect(110, 30, 88, 32, 3, 3);
    doc.setFontSize(11);
    doc.text('Mileage summary', 114, 36);
    doc.setFontSize(10);
    doc.text('Company mileage: ' + formatKm(kmEmp), 114, 44);
    doc.text('Personal mileage: ' + formatKm(kmPer), 114, 50);
    doc.text('Personal mileage cost (km √ó ‚Ç¨/L √ó 6L/100km): ' + formatEuro(costPer), 114, 56);

    // Expenses table
    var rows = currentEntries.map(function(e){
      var d = e.dateJs instanceof Date ? e.dateJs.toISOString().slice(0,10) : (e.date || '');
      return [
        d,
        e.provider || '',
        e.category || '',
        (e.paidWith || ''),
        (e.notes || '').slice(0,40),
        (Number(e.amount||0)).toFixed(2)
      ];
    });

    doc.autoTable({
      startY: 66,
      head: [['Date','Provider','Category','Paid with','Notes','Amount']],
      body: rows,
      styles:{ fontSize:8 },
      headStyles:{ fillColor:[0,0,0] }
    });

    // Mileage table
    var finalY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY : 66;

    var rowsKm = currentKms.map(function(k){
      var d = k.dateJs instanceof Date ? k.dateJs.toISOString().slice(0,10) : (k.date || '');
      var km = Number(k.km || k.distance || 0) || 0;
      var fuel = (k.fuelPrice != null && k.fuelPrice !== '')
        ? Number(k.fuelPrice)
        : NaN;

      var type = (k.type || '').toLowerCase().includes('per') ? 'Personal' : 'Company';
      var costPers = 0;
      if (type === 'Personal' && !isNaN(fuel) && fuel > 0){
        costPers = km * fuel * 6 / 100;
      }
      var notesKm = (k.notes || '').toString();

      return [
        d,
        type,
        km.toFixed(1),
        (!isNaN(fuel) && fuel > 0) ? fuel.toFixed(2) : '',
        costPers ? costPers.toFixed(2) : '',
        notesKm.slice(0,60)
      ];
    });

    doc.autoTable({
      startY: finalY + 6,
      head: [['Date','Type','KM','‚Ç¨/L','Personal cost','Notes']],
      body: rowsKm,
      styles:{ fontSize:8 },
      headStyles:{ fillColor:[30,30,30] }
    });

    // ENGLISH filename
    doc.save('monthly-summary-2n-' + (month || 'month') + '.pdf');
  }

  if ($('monthInput')){
    $('monthInput').addEventListener('change', refreshAll);
  }
  if ($('btnPdf')){
    $('btnPdf').addEventListener('click', buildPdf);
  }

  document.addEventListener('auth-changed', refreshAll, false);
  document.addEventListener('entries-updated', refreshAll, false);
  document.addEventListener('kms-updated', refreshAll, false);

  refreshAll();
})();
</script>

</body>
</html>
