<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ Summary</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script src="config.js"></script>
</head>

<body>

<!-- ===================================================== -->
<!-- ==================   HEADER  ========================= -->
<!-- ===================================================== -->

<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N ¬∑ Summary
  </h1>

  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge active" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<!-- ===================================================== -->
<!-- ==================  MAIN CONTENT  ==================== -->
<!-- ===================================================== -->

<main class="content">
  <div class="grid">
    <div class="card">
      <h2>Resumen mensual</h2>

      <div class="row" style="flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div>
          <label>Mes</label><br>
          <select id="selMonth">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>

        <div>
          <label>A√±o</label><br>
          <input id="selYear" type="number" style="width:120px">
        </div>

        <div style="flex:1;min-width:200px">
          <div class="small">
            Consulta los gastos del mes y genera el PDF oficial.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap">
        <button id="btnRefresh" class="btn">üîÑ Actualizar vista</button>
        <button id="btnPdf" class="btn primary">üìÑ Generar PDF</button>
      </div>

      <div id="summaryStatus" class="small" style="margin-top:10px;min-height:2em"></div>
    </div>

    <!-- =============================================== -->
    <!--               LISTA + VISTA FOTO                -->
    <!-- =============================================== -->

    <div class="card">
      <h2>Vista previa gastos</h2>

      <div class="row" style="align-items:flex-start;gap:12px">
        <div id="previewExpenses"
             class="list small"
             style="flex:2;max-height:260px;overflow:auto;">
        </div>

        <div style="flex:1;min-width:130px;">
          <div class="small">Vista previa ticket</div>
          <div style="
            margin-top:6px;
            border:1px solid #ddd;
            border-radius:8px;
            padding:4px;
            min-height:80px;
            display:flex;
            align-items:center;
            justify-content:center;">
            <img id="previewPhoto"
                 src=""
                 alt="Vista previa ticket"
                 style="max-width:100%;max-height:220px;border-radius:6px;display:none;">
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================== -->

    <div class="card">
      <h2>Vista previa KM</h2>
      <div id="previewKms" class="list small"></div>
    </div>

    <div class="card">
      <h2>Totales r√°pidos</h2>
      <div id="previewTotals" class="small"></div>
    </div>

  </div>
</main>

<!-- ===================================================== -->
<!-- ==================  FIREBASE AUTH  =================== -->
<!-- ===================================================== -->

<script>
(function(){
  if (!firebase.apps.length){
    firebase.initializeApp(window.__FBCONFIG__);
  }

  const auth = firebase.auth();

  auth.onAuthStateChanged(function(user){
    const who = document.getElementById('whoami');
    const inBtn = document.getElementById('btnLogin');
    const outBtn= document.getElementById('btnLogout');

    if (user){
      who.textContent = "Conectado: " + (user.email || user.uid);
      inBtn.style.display = "none";
      outBtn.style.display = "";
    } else {
      who.textContent = "No autenticado";
      inBtn.style.display = "";
      outBtn.style.display = "none";
    }

    document.dispatchEvent(new CustomEvent("auth-changed",{detail:{user}}));
  });

  document.getElementById("btnLogin").onclick = ()=>{
    const prov = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(prov).catch(()=>auth.signInWithRedirect(prov));
  };

  document.getElementById("btnLogout").onclick = ()=>auth.signOut();

  window.__APPCTX__ = {
    auth,
    db: firebase.firestore(),
    storage: firebase.storage()
  };
})();
</script>

<!-- ===================================================== -->
<!-- ==================  SUMMARY LOGIC  =================== -->
<!-- ===================================================== -->

<script>
(function(){

/* ------------------------------------------------------ */
/* UTILIDADES */
/* ------------------------------------------------------ */

function $(id){ return document.getElementById(id); }

let __currentEntries = [];

function formatISO(d){
  if (!(d instanceof Date)) d = new Date(d);
  return d.toISOString().slice(0,10);
}

function getRange(){
  const m = parseInt($("selMonth").value,10);
  const y = parseInt($("selYear").value,10);
  return {
    m, y,
    start: new Date(Date.UTC(y,m-1,1)),
    end:   new Date(Date.UTC(y,m,1))
  };
}

function setStatus(msg){
  $("summaryStatus").textContent = msg;
}

/* ------------------------------------------------------ */
/* CARGA DE GASTOS */
/* ------------------------------------------------------ */

async function getEntries(){
  const ctx = window.__APPCTX__;
  const db = ctx.db;
  const auth = ctx.auth;
  const user = auth.currentUser;

  const {start,end} = getRange();
  const list = [];

  if (user){
    const snap = await db.collection("users/"+user.uid+"/entries")
                         .orderBy("date","asc").get();
    snap.forEach(doc=>{
      const o = doc.data();
      const d = o.date?.toDate() || new Date(o.date);
      if (d>=start && d<end){
        o._date = d;
        list.push(o);
      }
    });
  } else {
    const local = JSON.parse(localStorage.getItem("entries_local")||"[]");
    local.forEach(o=>{
      const d = new Date(o.date);
      if (d>=start && d<end){
        o._date = d;
        list.push(o);
      }
    });
  }

  return list;
}

/* ------------------------------------------------------ */
/* CARGA DE KM */
/* ------------------------------------------------------ */

async function getKmEntries(){
  const ctx = window.__APPCTX__;
  const db = ctx.db;
  const auth = ctx.auth;
  const user = auth.currentUser;

  const {start,end} = getRange();
  const list = [];

  if (user){
    const snap = await db.collection("users/"+user.uid+"/kms")
                         .orderBy("date","asc").get();
    snap.forEach(doc=>{
      const o = doc.data();
      const d = o.date?.toDate() || new Date(o.date);
      if (d>=start && d<end){
        o._date = d;
        list.push(o);
      }
    });
  } else {
    const local = JSON.parse(localStorage.getItem("kms_local")||"[]");
    local.forEach(o=>{
      const d = new Date(o.date);
      if (d>=start && d<end){
        o._date = d;
        list.push(o);
      }
    });
  }

  return list;
}

/* ------------------------------------------------------ */
/* VISTA PREVIA GASTOS */
/* ------------------------------------------------------ */

function showPhoto(entry){
  const img = $("previewPhoto");
  if (entry && entry.photoURL){
    img.src = entry.photoURL;
    img.style.display = "block";
  } else {
    img.src = "";
    img.style.display = "none";
  }
}

function renderExpensesPreview(entries){
  const cont = $("previewExpenses");
  cont.innerHTML = "";
  __currentEntries = entries;

  if (!entries.length){
    cont.innerHTML = "<div class='small'>Sin gastos.</div>";
    showPhoto(null);
    return;
  }

  entries.forEach((e,i)=>{
    const div = document.createElement("div");
    div.className = "small";
    div.style.padding = "4px 6px";
    div.style.cursor = "pointer";
    div.style.borderRadius = "4px";

    div.textContent =
      formatISO(e._date)+" ¬∑ "+
      (e.provider||"-")+" ¬∑ "+
      (e.amount||0)+"‚Ç¨ ¬∑ "+(e.category||"");

    div.onclick = ()=>{
      [...cont.children].forEach(n=>n.style.background="transparent");
      div.style.background="rgba(0,0,0,0.05)";
      showPhoto(e);
    };

    cont.appendChild(div);
  });

  const first = entries.find(e=>e.photoURL) || entries[0];
  showPhoto(first);
  if (cont.firstChild) cont.firstChild.style.background="rgba(0,0,0,0.05)";
}

/* ------------------------------------------------------ */
/* VISTA PREVIA KM */
/* ------------------------------------------------------ */

function renderKmPreview(kms){
  const cont = $("previewKms");
  cont.innerHTML = "";

  if (!kms.length){
    cont.innerHTML = "<div class='small'>Sin KM.</div>";
    return;
  }

  kms.forEach(k=>{
    const div = document.createElement("div");
    div.className = "small";
    div.textContent =
      formatISO(k._date)+" ¬∑ "+
      (k.km||k.distance||0)+" km ¬∑ "+
      ((k.type||"").toLowerCase().includes("per") ? "üßç Personal" : "üöó Empresa");
    cont.appendChild(div);
  });
}

/* ------------------------------------------------------ */
/* TOTALES */
/* ------------------------------------------------------ */

function computeTotals(entries,kms){
  let total = 0, empresa = 0, personal = 0;
  const categorias = {};

  entries.forEach(e=>{
    const a = Number(e.amount||0);
    total += a;
    if (e.paidWith==="personal") personal+=a;
    else empresa+=a;

    const cat = (e.category||"varios").toLowerCase();
    categorias[cat] = (categorias[cat]||0)+a;
  });

  let totalKm=0, kmE=0, kmP=0;
  kms.forEach(k=>{
    const d = Number(k.km||k.distance||0);
    totalKm += d;
    if ((k.type||"").toLowerCase().includes("per")) kmP+=d;
    else kmE+=d;
  });

  return {total,empresa,personal,categorias,totalKm,kmE,kmP};
}

function renderTotals(t){
  const cont = $("previewTotals");
  cont.innerHTML = `
    <b>Total:</b> ${t.total.toFixed(2)} ‚Ç¨<br>
    <b>Empresa:</b> ${t.empresa.toFixed(2)} ‚Ç¨<br>
    <b>Personal:</b> ${t.personal.toFixed(2)} ‚Ç¨<br><br>
    <b>KM totales:</b> ${t.totalKm.toFixed(2)} km<br>
    <b>KM empresa:</b> ${t.kmE.toFixed(2)} km<br>
    <b>KM personales:</b> ${t.kmP.toFixed(2)} km<br>
  `;
}

/* ------------------------------------------------------ */
/* PDF LOGO */
/* ------------------------------------------------------ */

let __logo = null;

async function loadLogo(){
  if (__logo) return __logo;
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement("canvas");
      c.width=img.width;
      c.height=img.height;
      c.getContext("2d").drawImage(img,0,0);
      __logo = c.toDataURL("image/png");
      res(__logo);
    };
    img.src="assets/2n-logo-black.png";
  });
}

/* ------------------------------------------------------ */
/* GENERAR PDF (CUADRADO NEGRO ELIMINADO) */
/* ------------------------------------------------------ */

async function generatePdf(){
  const entries = await getEntries();
  const kms = await getKmEntries();
  const totals = computeTotals(entries,kms);

  const {m,y} = getRange();
  const mm = String(m).padStart(2,"0");

  const {jsPDF} = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  const logo = await loadLogo();

  /* ---- LOGO 2N EN LA CABECERA ---- */
  if (logo){
    doc.addImage(logo,"PNG",150,10,40,12);
  }

  /* ---- CABECERA DEL INFORME ---- */
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("Informe de gastos - 2N",14,20);

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);
  doc.text("Empleado: David Gaston",14,28);
  doc.text("Cost center: Iberia Team",14,34);
  doc.text(`Periodo: ${mm}/${y}`,14,40);

  /* ========================================================= */
  /*   BLOQUES DE RESUMEN + LOGO GRANDE A LA DERECHA           */
  /* ========================================================= */

  doc.setFillColor(245,245,245);
  doc.roundedRect(14,48,90,30,3,3,"FD");

  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("Resumen de gastos",18,56);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Total: ${totals.total.toFixed(2)} ‚Ç¨`,18,64);
  doc.text(`Empresa: ${totals.empresa.toFixed(2)} ‚Ç¨`,18,70);
  doc.text(`Personal: ${totals.personal.toFixed(2)} ‚Ç¨`,18,76);

  /* ---- LOGO GRANDE A LA DERECHA ---- */
  if (logo){
    doc.addImage(logo,"PNG",115,48,70,30);   
  }

  /* ========================================================= */

  doc.setFillColor(245,245,245);
  doc.roundedRect(14,84,90,28,3,3,"FD");

  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("Resumen de kil√≥metros",18,92);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Total:  ${totals.totalKm.toFixed(2)} km`,18,100);
  doc.text(`Empresa:  ${totals.kmE.toFixed(2)} km`,18,106);
  doc.text(`Personal: ${totals.kmP.toFixed(2)} km`,18,112);

  /* ---- SIN CUADRADO NEGRO ---- */

  /* ========================================================= */
  /*    DETALLE GASTOS / KM (SIN CABECERA NEGRA)               */
  /* ========================================================= */

  const catRows = Object.keys(totals.categorias)
                        .sort()
                        .map(k=>[k,totals.categorias[k].toFixed(2)+" ‚Ç¨"]);

  if (catRows.length){
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Desglose por categor√≠a",14,125);

    doc.autoTable({
      startY:129,
      head:[["Categor√≠a","Importe"]],
      body:catRows,
      theme:"striped",
      styles:{fontSize:9}
    });
  }

  /* ---- Tabla gastos ---- */
  const gastosBody = entries.map(e=>[
    formatISO(e._date),
    e.provider||"",
    e.category||"",
    Number(e.amount||0).toFixed(2)+" ‚Ç¨",
    (e.paidWith==="personal"?"Personal":"Empresa"),
    e.notes||""
  ]);

  if (gastosBody.length){
    doc.addPage();
    if (logo) doc.addImage(logo,"PNG",150,10,40,12);
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("Detalle de gastos",14,20);

    doc.autoTable({
      startY:26,
      head:[["Fecha","Proveedor","Categor√≠a","Importe","Pago","Notas"]],
      body:gastosBody,
      theme:"striped",
      styles:{fontSize:8,cellWidth:"wrap"}
    });
  }

  /* ---- Tabla KM ---- */
  const kmsBody = kms.map(k=>[
    formatISO(k._date),
    Number(k.km||k.distance||0).toFixed(2),
    ((k.type||"").toLowerCase().includes("per")?"Personal":"Empresa"),
    k.fuelPrice||"",
    k.totalKm||"",
    k.notes||""
  ]);

  if (kmsBody.length){
    doc.addPage();
    if (logo) doc.addImage(logo,"PNG",150,10,40,12);
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("Detalle de kil√≥metros",14,20);

    doc.autoTable({
      startY:26,
      head:[["Fecha","KM","Tipo","Precio combustible","KM total","Notas"]],
      body:kmsBody,
      theme:"striped",
      styles:{fontSize:8,cellWidth:"wrap"}
    });
  }

  doc.save(`informe_gastos_2n_${y}-${mm}.pdf`);
}

/* ------------------------------------------------------ */
/* REFRESH */
/* ------------------------------------------------------ */

async function refreshAll(){
  setStatus("Cargando...");
  const entries = await getEntries();
  const kms = await getKmEntries();
  const totals = computeTotals(entries,kms);

  renderExpensesPreview(entries);
  renderKmPreview(kms);
  renderTotals(totals);

  setStatus("");
}

/* ------------------------------------------------------ */
/* EVENTOS */
/* ------------------------------------------------------ */

document.getElementById("btnRefresh").onclick = refreshAll;
document.getElementById("btnPdf").onclick = generatePdf;

document.addEventListener("auth-changed",refreshAll);
document.getElementById("selMonth").onchange = refreshAll;
document.getElementById("selYear").onchange = refreshAll;

refreshAll();

})();
</script>

</body>
</html>
