<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#f7f7fb;}button:disabled{opacity:.5}</style>
</head>
<body class="min-h-screen">
<div class="max-w-xl mx-auto p-4 space-y-4">
<header class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">Gastos 2N</h1>
  <div class="flex items-center gap-2">
    <button id="btnLogin" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm">Google</button>
    <button id="btnLogout" class="px-3 py-2 rounded border text-sm">Salir</button>
  </div>
</header>
<p id="whoami" class="text-sm text-gray-600">No autenticado</p>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <h2 class="font-semibold">Nuevo gasto</h2>
  <div><label class="text-sm font-medium">Fecha<input id="fFecha" type="date" class="w-full border rounded px-3 py-2"/></label></div>
  <div><label class="text-sm font-medium">CategorÃ­a<select id="fCategoria" class="w-full border rounded px-3 py-2">
    <option value="comida">Comida/Mercado</option>
    <option value="transporte">Otros Transportes</option>
    <option value="servicios">Servicios/Varios</option>
    <option value="ocio">Ocio/Invitaciones</option>
    <option value="gasolina">Gasolina</option>
    <option value="peajes">Peajes/Parking</option>
    <option value="alojamiento">Alojamiento/Hotel</option>
    <option value="varios">Varios</option>
    <option value="ingreso">Ingreso</option>
  </select></label></div>
  <div><label class="text-sm font-medium">Proveedor<input id="fProveedor" class="w-full border rounded px-3 py-2"/></label></div>
  <div><label class="text-sm font-medium">Notas<textarea id="fNota" rows="2" class="w-full border rounded px-3 py-2"></textarea></label></div>
  <div><label class="text-sm font-medium">Importe (â‚¬)<input id="fCantidad" type="number" min="0.01" step="0.01" class="w-full border rounded px-3 py-2"/></label></div>
  <div><label class="text-sm font-medium">Foto<input id="fFile" type="file" accept="image/*" class="w-full border rounded px-3 py-2"/></label><img id="preview" class="mt-2 max-h-40 hidden rounded border"/></div>
  <button id="scanAI" class="w-full py-2 rounded bg-purple-600 text-white font-semibold">ðŸ“¸ Escanear ticket IA</button>
  <button id="btnGuardar" class="w-full py-3 rounded bg-green-600 text-white font-semibold">Guardar</button>
</section>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <h2 class="font-semibold">Ãšltimos gastos</h2>
  <div id="lista" class="space-y-2 text-sm"></div>
</section>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <h2 class="font-semibold">Exportar CSV</h2>
  <input id="month" type="month" class="border rounded px-2 py-1"/>
  <button id="exportCSV" class="px-4 py-2 rounded bg-orange-600 text-white">Descargar CSV</button>
</section>

<section class="bg-white border rounded-2xl p-4 space-y-3 shadow-sm">
  <h2 class="font-semibold">Ajustes</h2>
  <input id="apiKey" placeholder="API Key Google" class="w-full border rounded px-3 py-2"/>
  <button id="saveKey" class="w-full py-2 bg-gray-800 text-white rounded">Guardar API Key</button>
  <button id="testKey" class="w-full py-2 bg-gray-500 text-white rounded">Probar IA</button>
</section>

<pre id="out" class="text-xs text-gray-600 whitespace-pre-wrap"></pre>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, Timestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig={apiKey:"AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",authDomain:"gastos-2n.firebaseapp.com",projectId:"gastos-2n",storageBucket:"gastos-2n.firebasestorage.app",messagingSenderId:"55010048795",appId:"1:55010048795:web:4fb48d1e0f9006ebf7b1be"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app,"gs://gastos-2n.firebasestorage.app");

const $=id=>document.getElementById(id);
const log=m=>{$("out").textContent+=m+"\n"};
$("fFecha").value=new Date().toISOString().slice(0,10);

$("fFile").onchange=e=>{const f=e.target.files?.[0];if(!f)return $("preview").classList.add("hidden");$("preview").src=URL.createObjectURL(f);$("preview").classList.remove("hidden")};

$("btnLogin").onclick=async()=>{try{await signInWithPopup(auth,new GoogleAuthProvider())}catch(e){alert(e.message)}};
$("btnLogout").onclick=()=>signOut(auth);

onAuthStateChanged(auth,u=>{$("whoami").textContent=u?`Conectado como ${u.email}`:"No autenticado";if(u)cargar()});

async function guardar(){const u=auth.currentUser;if(!u)return alert("Login");const fecha=$("fFecha").value,categoria=$("fCategoria").value,proveedor=$("fProveedor").value.trim(),nota=$("fNota").value.trim(),cantidad=parseFloat($("fCantidad").value);if(!proveedor||!cantidad)return alert("Proveedor e importe");let photoURL="";const f=$("fFile").files?.[0];if(f){const y=fecha.slice(0,7),name=`${fecha}_${Date.now()}.${f.name.split('.').pop()}`,p=`tickets/${u.uid}/${y}/${name}`,r=ref(storage,p);await uploadBytes(r,f);photoURL=await getDownloadURL(r)}await addDoc(collection(db,`users/${u.uid}/entries`),{date:Timestamp.fromDate(new Date(fecha)),category:categoria,provider:proveedor,notes:nota,amount:cantidad,photoURL,isExpense:categoria!="ingreso",createdAt:Timestamp.now()});alert("Guardado");cargar()}
$("btnGuardar").onclick=guardar;

async function cargar(){const u=auth.currentUser;if(!u)return;const q=query(collection(db,`users/${u.uid}/entries`),orderBy('createdAt','desc'),limit(5)),s=await getDocs(q);$("lista").innerHTML="";s.forEach(d=>{const x=d.data(),fe=x.date.toDate().toISOString().slice(0,10),eu=(x.amount||0).toLocaleString('es-ES',{minimumFractionDigits:2});$("lista").innerHTML+=`<div class='flex justify-between border rounded p-2'><div>${x.provider}<br><span class='text-xs text-gray-500'>${fe} ${x.notes||''}</span></div><div class='text-right ${x.isExpense?'text-red-600':'text-green-600'}'>${x.isExpense?'-':'+'}${eu}â‚¬<br>${x.photoURL?`<a href='${x.photoURL}' target='_blank' class='text-xs underline'>ticket</a>`:''}</div></div>`})}

async function exportar(){const u=auth.currentUser;if(!u)return;const m=$("month").value;if(!m)return alert("Mes");const q=query(collection(db,`users/${u.uid}/entries`)),s=await getDocs(q),rows=["DATE;PROVIDER;CATEGORY;AMOUNT;NOTES;PHOTO"];s.forEach(d=>{const x=d.data(),fe=x.date.toDate().toISOString().slice(0,10);if(!fe.startsWith(m))return;rows.push([fe,x.provider,x.category,x.amount,x.notes,x.photoURL].map(v=>`"${v||''}"`).join(";"))});const blob=new Blob([rows.join("\n")],{type:"text/csv"}),a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`gastos_${m}.csv`;a.click()}
$("exportCSV").onclick=exportar;

$("saveKey").onclick=()=>{localStorage.setItem("gkey",$("apiKey").value);alert("API Guardada")};
$("apiKey").value=localStorage.getItem("gkey")||"";

async function callGemini(b64,mime){const key=localStorage.getItem("gkey");if(!key)throw Error("Sin API");const prompt="Extrae JSON {date,provider,amount}";const attempts=[
  ["https://generativelanguage.googleapis.com/v1beta","gemini-2.5-flash-preview-09-2025"],
  ["https://generativelanguage.googleapis.com/v1beta","gemini-1.5-flash"],
  ["https://generativelanguage.googleapis.com/v1","gemini-1.5-flash"],
  ["https://generativelanguage.googleapis.com/v1beta","gemini-1.5-flash-001"],
];const body={contents:[{role:"user",parts:[{text:prompt},{inlineData:{mimeType:mime,data:b64}}]}],generationConfig:{responseMimeType:"application/json"}};let last;for(const[a,u]of attempts){try{const r=await fetch(`${a}/models/${u}:generateContent?key=${key}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});const j=await r.json();const t=j?.candidates?.[0]?.content?.parts?.[0]?.text;if(t)return JSON.parse(t)}catch(e){last=e}}throw last||Error("IA err")}

$("scanAI").onclick=async()=>{try{const f=$("fFile").files?.[0];if(!f)return alert("Foto");const buf=await f.arrayBuffer(),b64=btoa(String.fromCharCode(...new Uint8Array(buf))),r=await callGemini(b64,f.type);if(r.provider)$("fProveedor").value=r.provider;if(r.amount)$("fCantidad").value=r.amount;if(r.date)$("fFecha").value=r.date}catch(e){alert(e.message)}};

$("testKey").onclick=async()=>{try{await callGemini(btoa("test"),"text/plain");alert("OK IA") }catch(e){alert(e.message)}};
</script>
</body>
</html>
