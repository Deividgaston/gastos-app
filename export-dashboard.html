<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos 2N ‚Äî Exportar</title>
  <style>
    :root{--blue:#007aff;--border:#e5e7eb;--muted:#6b7280;--bg:#f7f7fb}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto;background:var(--bg)}
    .topbar{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff;z-index:5}
    .topbar h1{margin:0;flex:1;font-size:18px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border:none}
    .content{max-width:980px;margin:0 auto;padding:14px}
    .panel{border:1px solid var(--border);border-radius:16px;padding:12px 14px;margin-top:12px;background:#fff}
    .muted{color:var(--muted)} .grid{display:grid;gap:10px}
    .g2{grid-template-columns:1fr 1fr} .g3{grid-template-columns:repeat(3,1fr)}
    .stat{display:flex;flex-direction:column;border:1px solid var(--border);padding:10px;border-radius:12px}
    .list{display:grid;gap:8px}
    .card{display:flex;gap:10px;align-items:center;border:1px solid var(--border);padding:8px;border-radius:12px}
    img.thumb{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .hidden{display:none!important}
    @media (max-width:700px){ .g3{grid-template-columns:1fr 1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header class="topbar">
    <button class="btn" onclick="history.back()">‚Üê Volver</button>
    <h1>Exportar</h1>
    <button id="btnLogin" class="btn">üü¢ Entrar con Google</button>
    <button id="btnLogout" class="btn hidden">Salir</button>
  </header>

  <main class="content">
    <section class="panel">
      <div class="row">
        <div>
          <label class="muted">Mes</label><br/>
          <input id="expMonth" type="month"/>
        </div>
        <div class="row" style="gap:6px;margin-left:auto">
          <button id="btnCSV" class="btn">‚¨áÔ∏è CSV</button>
          <button id="btnDLAll" class="btn primary">üì• Descargar todas las fotos</button>
        </div>
      </div>
      <p class="muted" id="whoami">No autenticado</p>
    </section>

    <section class="panel">
      <div class="grid g3">
        <div class="stat"><small class="muted">Gasto total</small><strong id="totGasto">0,00 ‚Ç¨</strong></div>
        <div class="stat"><small class="muted">N¬∫ tickets</small><strong id="totTick">0</strong></div>
        <div class="stat"><small class="muted">Media por ticket</small><strong id="totAvg">0,00 ‚Ç¨</strong></div>
      </div>
    </section>

    <section class="panel">
      <strong>Listado</strong>
      <div id="lista" class="list" style="margin-top:8px"></div>
    </section>

    <section class="panel">
      <strong>Logs</strong>
      <pre id="out" style="white-space:pre-wrap;background:#fafafa;border:1px dashed #eaeaea;border-radius:12px;padding:10px;max-height:260px;overflow:auto"></pre>
    </section>
  </main>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $=(id)=>document.getElementById(id);
    const log=(m)=>{ $('out').textContent += (typeof m==='string'?m:JSON.stringify(m,null,2))+'\\n'; };

    // === TU CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBTK8altmAR-fWqR9BjE74gEGavuiqk1Bs",
      authDomain: "gastos-2n.firebaseapp.com",
      projectId: "gastos-2n",
      storageBucket: "gastos-2n.firebasestorage.app",
      messagingSenderId: "55010048795",
      appId: "1:55010048795:web:4fb48d1e0f9006ebf7b1be"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();
    const storage=firebase.storage();

    // === Auth UI ===
    const provider = new firebase.auth.GoogleAuthProvider();
    $('btnLogin').onclick = async ()=>{ try{ await auth.signInWithPopup(provider);}catch(e){ log(e); alert(e.message||'Login error'); } };
    $('btnLogout').onclick = async ()=>{ await auth.signOut(); };
    auth.onAuthStateChanged(u=>{
      if(u){ $('whoami').textContent = 'Conectado como '+(u.email||u.uid); $('btnLogin').classList.add('hidden'); $('btnLogout').classList.remove('hidden'); autoLoad(); }
      else { $('whoami').textContent = 'No autenticado'; $('btnLogin').classList.remove('hidden'); $('btnLogout').classList.add('hidden'); }
    });

    // === Helpers ===
    function monthRange(ym){ const s=new Date(ym+'-01T00:00:00'); const e=new Date(s.getFullYear(), s.getMonth()+1, 1); return [s,e]; }
    async function listEntriesMonth(ym, uid){
      const [s,e]=monthRange(ym);
      const snap=await db.collection('users/'+uid+'/entries').where('date','>=',s).where('date','<',e).orderBy('date','asc').get();
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    function euro(n){ return Number(n||0).toLocaleString('es-ES',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨'; }

    // === Cargar y pintar ===
    async function loadMonth(){
      const u=auth.currentUser; if(!u) return;
      const ym=$('expMonth').value; if(!ym) return;
      const entries=await listEntriesMonth(ym, u.uid);
      paintList(entries);
      paintStats(entries);
      return entries;
    }
    function paintStats(entries){
      const gastos = entries.filter(e=>e.category!=='ingreso').map(e=>Number(e.amount||0));
      const total = gastos.reduce((a,b)=>a+b,0);
      const avg = gastos.length? total/gastos.length : 0;
      $('totGasto').textContent = euro(total);
      $('totTick').textContent = String(gastos.length);
      $('totAvg').textContent = euro(avg);
    }
    function paintList(entries){
      const list=$('lista'); list.innerHTML='';
      entries.forEach(e=>{
        const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
        const dateISO = d.toISOString().slice(0,10);
        const item=document.createElement('div');
        item.className='card';
        const thumb = document.createElement('img');
        thumb.className='thumb';
        if(e.photoURL){ thumb.src = e.photoURL; }
        else if(e.photoPath){ storage.ref(e.photoPath).getDownloadURL().then(u=>thumb.src=u).catch(()=>{}); }
        const meta=document.createElement('div');
        meta.style.flex='1';
        meta.innerHTML = '<div><strong>'+ (e.provider||'-') +'</strong> ¬∑ '+ (e.category||'') +'</div>' +
                         '<div class="muted">'+ dateISO + (e.notes?(' ¬∑ '+e.notes):'') +'</div>';
        const amt=document.createElement('div');
        amt.textContent = euro(e.amount||0);
        item.appendChild(thumb); item.appendChild(meta); item.appendChild(amt);
        list.appendChild(item);
      });
    }

    // Eventos
    $('expMonth').value = new Date().toISOString().slice(0,7);
    $('expMonth').addEventListener('change', loadMonth);
    async function autoLoad(){ await loadMonth(); }

    // === CSV ===
    const COLUMNS=["DATE","CLIENT / PROVIDER","TOLLS & PARKINGS","HOTEL","GASOLINE","TICKETS TRAVELING","OTHER TRANSPORTS (Taxi)","INVITATIONS","MEALS","VARIOUS","TOTAL","DESCRIPTION"];
    const MAP={"comida":"MEALS","transporte":"OTHER TRANSPORTS (Taxi)","servicios":"VARIOUS","ocio":"INVITATIONS","gasolina":"GASOLINE","peajes":"TOLLS & PARKINGS","alojamiento":"HOTEL","varios":"VARIOUS"};
    function toCSVValue(col, value){
      if(col!=="DATE"&&col!=="CLIENT / PROVIDER"&&col!=="DESCRIPTION"){
        const n=Number(value||0); return (isFinite(n)?n:0).toFixed(2).replace(".",",");
      }
      const s=String(value||"").replace(/"/g,'""'); return '"' + s + '"';
    }
    function buildCSV(rows, monthlabel, today){
      const head=',,,,,   EXPENSES REPORT,,,,,,\\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,'+today+'\\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,'+monthlabel+',,,,,,\\n,,,,,,,,,,,,\\n';
      const h1=COLUMNS.map(h=>'"'+h+'"').join(";")+"\\n";
      const h2=",,PARKINGS ,,,,,TRAVELING,,,\\n";
      const data=rows.map(r=>COLUMNS.map(c=>toCSVValue(c,r[c])).join(";")).join("\\n");
      return head+h1+h2+data+"\\n";
    }
    function toCSVRecords(entries){
      const rows=[];
      for(const e of entries){
        if(e.category==="ingreso") continue;
        const col=MAP[e.category]||"VARIOUS";
        const rec={}; COLUMNS.forEach(c=>rec[c]=(["DATE","CLIENT / PROVIDER","DESCRIPTION"].includes(c)?"":0));
        const d=e.date?.toDate?e.date.toDate():new Date(e.date);
        rec["DATE"]=d.toLocaleDateString("es-ES");
        rec["CLIENT / PROVIDER"]=e.provider||"";
        rec["DESCRIPTION"]=e.notes||"";
        const amount=Number(e.amount||0);
        if(COLUMNS.includes(col)) rec[col]=amount; else rec["VARIOUS"]=amount;
        let total=0; for(let i=2;i<=9;i++) total+=Number(rec[COLUMNS[i]]||0);
        rec["TOTAL"]=total; rows.push(rec);
      }
      return rows;
    }
    $('btnCSV').addEventListener('click', async ()=>{
      try{
        const u=auth.currentUser; if(!u) return alert('Haz login');
        const ym=$('expMonth').value; if(!ym) return alert('Mes');
        const entries=await loadMonth();
        if(!entries || !entries.length) return alert('Sin gastos');
        const rows=toCSVRecords(entries);
        const monthlabel=new Date(ym+"-01").toLocaleDateString("es-ES",{month:"long",year:"numeric"});
        const today=new Date().toLocaleDateString("es-ES");
        const csv=buildCSV(rows, monthlabel, today);
        saveAs(new Blob([csv], {type:"text/csv;charset=utf-8"}), "Informe_Gastos_"+ym+".csv");
      }catch(e){ log(e); alert('CSV error: '+(e.message||'')); }
    });

    // === Descargar TODAS sin ZIP (descargas nativas de navegador) ===
    async function downloadAllPhotos(){
      try{
        const u=auth.currentUser; if(!u) return alert('Haz login');
        const ym=$('expMonth').value; if(!ym) return alert('Mes');
        const entries=await loadMonth();
        const photos=entries.filter(e=>e.photoURL || e.photoPath);
        if(!photos.length) return alert('Sin fotos');

        let count=0, fail=0;
        for(const e of photos){
          try{
            let url = e.photoURL || null;
            if(!url && e.photoPath){ url = await storage.ref(e.photoPath).getDownloadURL(); }
            if(!url){ fail++; log({fallo_sin_url:e}); continue; }
            // nombre bonito
            const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
            const dateISO = d.toISOString().slice(0,10);
            const prov = (e.provider||'ticket').toString().replace(/[^a-zA-Z0-9-_ ]/g,'').slice(0,40).replace(/\s+/g,'_');
            const ext = (url.toLowerCase().includes('.png'))?'.png':'.jpg';
            const a=document.createElement('a');
            a.href=url; a.download = `${dateISO}_${prov}${ext}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            count++;
            await new Promise(r=>setTimeout(r,350)); // peque√±o delay para evitar bloqueos
          }catch(err){
            fail++; log({fallo_descarga_directa: (e.photoURL||e.photoPath), err: (err.message||String(err)) });
          }
        }
        log(`üì• Descargas lanzadas: ${count} ok, ${fail} fallos`);
      }catch(e){ log(e); alert('Descarga error: '+(e.message||'')); }
    }
    $('btnDLAll').addEventListener('click', downloadAllPhotos);

    // Auto login persistencia por defecto (ya lo maneja Firebase)
  })();
  </script>
</body>
</html>
