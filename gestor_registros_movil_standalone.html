<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor de Registros Móvil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"></noscript>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .mobile-frame{ width:95vw; max-width:450px; min-height:88vh; border-radius:40px; border:4px solid #1f2937;
      box-shadow:0 25px 50px -12px rgba(0,0,0,.25); }
    .notch{ height:40px; width:112px; background-color:#000; border-radius:0 0 15px 15px; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button{ -webkit-appearance: none; margin:0; }
    input[type="month"]{ appearance:none; background-color:white; padding-right:1.5rem; }
    .btn { @apply w-full p-4 rounded-3xl font-bold text-xl shadow-lg transition active:scale-95 disabled:bg-gray-300 disabled:text-gray-500; }
  </style>
</head>
<body class="flex justify-center items-start pt-6 pb-10">
  <div class="mobile-frame bg-white mx-auto overflow-hidden flex flex-col relative">
    <!-- Status bar -->
    <div class="bg-gray-800 h-10 flex items-center justify-center relative">
      <div class="notch absolute top-0"></div>
      <span id="status-time" class="text-xs text-white font-semibold absolute left-5 top-2.5"></span>
      <span id="status-auth" class="text-xs text-white font-semibold absolute right-5 top-2.5">⏳ Cargando...</span>
    </div>

    <!-- App content -->
    <div id="app-content" class="flex-1 overflow-y-auto p-4">
      <div class="flex items-center justify-center h-full text-gray-500">Cargando aplicación...</div>
    </div>

    <!-- Modal -->
    <div id="modal-container" class="hidden fixed inset-0 z-50 bg-black/70 items-center justify-center p-4">
      <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
        <h3 class="text-xl font-bold mb-3 text-indigo-700">Notificación</h3>
        <p id="modal-message" class="text-gray-700 mb-6 whitespace-pre-wrap"></p>
        <button onclick="closeModal()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition">Aceptar</button>
      </div>
    </div>

    <!-- Hidden file input (camera) -->
    <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden">
  </div>

<script type="module">
/** ========== CONFIGURACIÓN RÁPIDA ==========
 * 1) Pega tu API key de Google AI Studio para habilitar el escaneo con cámara (Gemini Vision).
 *    - Crea una API key en https://aistudio.google.com/app/apikey
 *    - Restringe por *HTTP referer* al dominio donde hospedes este HTML (recomendado).
 * 2) (Opcional) Si quieres sincronizar en la nube, pega tu config de Firebase y habilita Auth anónima + Firestore.
 *    - Proyecto -> Configuración -> Tus apps -> SDK Firebase -> Config.
 */
let GOOGLE_API_KEY = localStorage.getItem("grm_api_key") || "PEGAR_API_KEY_AQUI"; // <- pega aquí o usa Ajustes
let firebaseConfig = null;
// Si quieres usar Firebase, sustituye por tu objeto de configuración:
// firebaseConfig = { apiKey:"...", authDomain:"...", projectId:"...", storageBucket:"...", messagingSenderId:"...", appId:"..." };

// ====== Estado global ======
let db = null, auth = null;
let userId = null;
let isAuthReady = false;
let isProcessing = false;
let view = "home"; // 'home' | 'entry' | 'export'
let entryMode = "manual"; // 'manual' | 'scan'
let entries = []; // lista en memoria
let HAS_FIREBASE = false;

// Estado formulario
let formData = { date: new Date().toISOString().slice(0,10), category: "comida", provider: "", notes: "", amount: "" };

// Categorías y columnas CSV
const CATEGORIES = [
  { value: 'comida', label: 'Comida/Mercado', column: 'MEALS' },
  { value: 'transporte', label: 'Otros Transportes', column: 'OTHER TRANSPORTS (Taxi)' },
  { value: 'servicios', label: 'Servicios/Varios', column: 'VARIOUS' },
  { value: 'ocio', label: 'Ocio/Invitaciones', column: 'INVITATIONS' },
  { value: 'ingreso', label: 'Ingreso', column: null },
  { value: 'gasolina', label: 'Gasolina', column: 'GASOLINE' },
  { value: 'peajes', label: 'Peajes/Parking', column: 'TOLLS & PARKINGS' },
  { value: 'alojamiento', label: 'Alojamiento/Hotel', column: 'HOTEL' },
  { value: 'varios', label: 'Varios', column: 'VARIOUS' },
];
const CSV_COLUMNS = ['DATE','CLIENT / PROVIDER','TOLLS & PARKINGS','HOTEL','GASOLINE','TICKETS TRAVELING','OTHER TRANSPORTS (Taxi)','INVITATIONS','MEALS','VARIOUS','TOTAL','DESCRIPTION'];

// ====== Utilidades UI ======
window.showModal = (msg) => { document.getElementById('modal-message').textContent = msg; const m=document.getElementById('modal-container'); m.classList.remove('hidden'); m.classList.add('flex'); };
window.closeModal = () => { const m=document.getElementById('modal-container'); m.classList.remove('flex'); m.classList.add('hidden'); };
const updateStatus = (text) => { document.getElementById('status-auth').textContent = text; };
document.getElementById('status-time').textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });

// ====== LocalStorage Modo ======
const LS_KEY = "grm_entries_v1";
const LS_USER = "grm_user_id";
function loadLocal() {
  const id = localStorage.getItem(LS_USER) || crypto.randomUUID();
  localStorage.setItem(LS_USER, id);
  userId = id;
  const raw = localStorage.getItem(LS_KEY);
  entries = raw ? JSON.parse(raw) : [];
}
function saveLocal() {
  localStorage.setItem(LS_KEY, JSON.stringify(entries));
}

// ====== Firebase (opcional) ======
async function initFirebaseIfAvailable() {
  try {
    if (!firebaseConfig || !firebaseConfig.apiKey) return false;
    const [{ initializeApp }, { getAuth, signInAnonymously, onAuthStateChanged }, { getFirestore, collection, query, onSnapshot, Timestamp, addDoc, setLogLevel }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
      import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"),
      import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),
    ]);
    setLogLevel("error");
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    return new Promise((resolve) => {
      onAuthStateChanged(auth, async (user) => {
        try {
          if (user) {
            userId = user.uid;
          } else {
            const res = await signInAnonymously(auth);
            userId = res.user.uid;
          }
          // Suscripción a entradas
          const path = `artifacts/simple-app/users/${userId}/entries`;
          const q = query(collection(db, path));
          onSnapshot(q, (snap) => {
            entries = snap.docs.map(d => {
              const data = d.data();
              return {
                id: d.id,
                ...data,
                date: (data.date && data.date.toDate) ? data.date.toDate().toISOString().slice(0,10) : (data.date || new Date().toISOString().slice(0,10)),
                amount: data.amount || 0,
              };
            }).sort((a,b)=> new Date(b.date)-new Date(a.date));
            renderApp();
          });
          resolve(true);
        } catch (e) {
          console.error("Auth/DB error:", e);
          resolve(false);
        }
      });
    });
  } catch (e) {
    console.error("Firebase init error:", e);
    return false;
  }
}

// ====== Gemini Vision ======
async function fileToBase64(file) {
  const buf = await file.arrayBuffer();
  const bytes = new Uint8Array(buf);
  let binary = ""; for (let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
async function fetchWithRetry(url, options, retries=3) {
  for (let i=0;i<retries;i++){
    try{
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res;
    }catch(err){
      if (i===retries-1) throw err;
      await new Promise(r=>setTimeout(r, Math.pow(2,i)*1000));
    }
  }
}
async function callGeminiVision(base64Image, mimeType) {
  if (!GOOGLE_API_KEY || GOOGLE_API_KEY === "PEGAR_API_KEY_AQUI") {
    throw new Error("Falta la API key de Google AI Studio. Toca el icono ⚙️ Ajustes para guardarla.");
  }
  const prompt = `Extrae la siguiente información de la imagen (recibo/factura o texto a mano) y devuélvela SOLO como JSON:
{
  "date": "YYYY-MM-DD",
  "provider": "Nombre del local o concepto (máx. 20 palabras)",
  "amount": 0.00
}
Si falta info: date="${new Date().toISOString().slice(0,10)}", provider="Datos no encontrados", amount=0.00`;

  const payload = {
    contents:[{ role:"user", parts:[ {text:prompt}, { inlineData:{ mimeType, data: base64Image }} ] }],
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type:"OBJECT",
        properties:{ date:{type:"STRING"}, provider:{type:"STRING"}, amount:{type:"NUMBER"} },
        propertyOrdering:["date","provider","amount"]
      }
    }
  };
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(GOOGLE_API_KEY)}`;
  const res = await fetchWithRetry(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  const jsonText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!jsonText) throw new Error("Respuesta inválida de la API.");
  return JSON.parse(jsonText);
}

// ====== Eventos ======
document.getElementById("file-input").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file || entryMode !== "scan") return;
  isProcessing = true; renderEntryScreen(); showModal("Escaneando imagen...");

  try {
    const b64 = await fileToBase64(file);
    const extracted = await callGeminiVision(b64, file.type);
    formData.date = extracted.date || formData.date;
    formData.provider = extracted.provider || formData.provider;
    formData.amount = String(extracted.amount ?? "").replace(",", ".");
    showModal("Datos extraídos. Revísalos y guarda.");
  } catch (err) {
    console.error(err);
    showModal("Error al escanear: " + (err?.message || err));
    entryMode = "manual";
  } finally {
    isProcessing = false; e.target.value = null; renderEntryScreen();
  }
});

// ====== Acciones UI ======
window.setView = (v) => { view = v; renderApp(); };
window.handleStartEntry = (mode) => {
  entryMode = mode;
  formData = { date: new Date().toISOString().slice(0,10), category: CATEGORIES[0].value, provider:"", notes:"", amount:"" };
  setView("entry");
  if (mode === "scan") setTimeout(()=> document.getElementById("file-input").click(), 100);
};
window.handleChange = (e) => { formData[e.target.name] = e.target.value; };
window.handleSave = async () => {
  // Validación
  const { date, category, provider, notes, amount } = formData;
  const numericAmount = parseFloat(String(amount).replace(",", "."));
  if (!date || !category || !provider || isNaN(numericAmount) || numericAmount<=0){
    showModal("Completa Fecha, Categoría, Proveedor y un Monto válido (>0).");
    return;
  }
  isProcessing = true; renderEntryScreen();

  const newEntry = {
    id: crypto.randomUUID(),
    date, category, provider, notes, amount: numericAmount,
    isExpense: category !== "ingreso",
    createdAt: new Date().toISOString()
  };

  try {
    if (HAS_FIREBASE && db && userId) {
      // Guardar en Firestore
      const { collection, addDoc, Timestamp, getFirestore } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
      const path = `artifacts/simple-app/users/${userId}/entries`;
      await addDoc(collection(getFirestore(), path), {
        ...newEntry,
        date: Timestamp.fromDate(new Date(date)),
        createdAt: Timestamp.now()
      });
    } else {
      // Guardar Local
      entries.unshift(newEntry);
      entries.sort((a,b)=> new Date(b.date)-new Date(a.date));
      saveLocal();
      renderApp();
    }
    showModal("Registro guardado.");
    setView("home");
  } catch (e) {
    console.error("Save error:", e);
    showModal("Error al guardar: " + e.message);
  } finally {
    isProcessing = false;
  }
};

// ====== Exportar CSV ======
let exportMonth = new Date().toISOString().slice(0,7);
let exportReportData = []; let exportMessage = '';
window.handleMonthChange = (e) => { exportMonth = e.target.value; renderExportScreen(); };

function generateExportData(month){
  exportMessage = '';
  if (!month) { exportMessage = 'Selecciona un mes.'; return []; }
  const filtered = entries.filter(en => en.category !== "ingreso" && en.date?.startsWith(month)).map(entry => {
    const catMap = CATEGORIES.find(c=>c.value===entry.category);
    const columnName = catMap ? catMap.column : 'VARIOUS';
    const rec = CSV_COLUMNS.reduce((acc,col)=>{ acc[col]=0.00; return acc; }, {});
    rec['DATE'] = new Date(entry.date).toLocaleDateString('es-ES');
    rec['CLIENT / PROVIDER'] = entry.provider || '';
    rec['DESCRIPTION'] = entry.notes || '';
    const amount = entry.amount || 0;
    if (columnName && CSV_COLUMNS.includes(columnName)) rec[columnName] = amount;
    else rec['VARIOUS'] = amount;
    let total=0; for (let i=2;i<=9;i++){ total += rec[CSV_COLUMNS[i]] || 0; }
    rec['TOTAL'] = total;
    return rec;
  });
  exportMessage = filtered.length? `Informe listo: ${filtered.length} gastos.` : `Sin gastos en ${month}.`;
  return filtered;
}
function downloadCSV(data){
  if (!data.length) { showModal("No hay datos para exportar."); return; }
  const monthYear = new Date(exportMonth+'-01').toLocaleDateString('es-ES',{month:'long', year:'numeric'});
  const today = new Date().toLocaleDateString('es-ES');
  const headerRow5 = CSV_COLUMNS.map(col=>`"${col}"`).join(';')+'\n';
  const headerRow6 = `,,PARKINGS ,,,,,TRAVELING,,,\n`;
  const rows = data.map(rec => CSV_COLUMNS.map(col => {
    let v = rec[col];
    if (col!=='DATE' && col!=='CLIENT / PROVIDER' && col!=='DESCRIPTION'){
      v = typeof v === 'number' ? v.toFixed(2).replace('.',',') : v;
    }
    if (v===undefined || v===null) v='';
    if (typeof v === 'string') v = `"${v.replace(/"/g,'""')}"`;
    return v;
  }).join(';')).join('\n');
  const templateHeader = `,,,,,   EXPENSES REPORT,,,,,,,\nNOM,,Gaston Ortigosa,,,,,,,,,DATE:,,${today}\nPRENOM:,David,COST CENTER:,7420,,MONTH/YEAR:,,${monthYear},,,,,,\n,,,,,,,,,,,,\n`;
  const csv = templateHeader + headerRow5 + headerRow6 + rows;
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`Informe_Gastos_${exportMonth}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showModal(`CSV exportado: ${data.length} registros.`);
}

// ====== Render ======
function renderEntryScreen(){
  const opts = CATEGORIES.map(c=>`<option value="${c.value}" ${formData.category===c.value?'selected':''}>${c.label}</option>`).join('');
  const content = `
    <div class="p-4 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">Entrada ${entryMode==='scan'?'Escaneada':'Manual'}</h2>
        <button onclick="openSettings()" class="text-sm px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50">⚙️ Ajustes</button>
      </div>
      <p class="text-sm text-gray-500">Revise y complete los datos antes de guardar.</p>

      <label class="block"><span class="text-gray-700 font-medium">Fecha</span>
        <input type="date" name="date" value="${formData.date}" onchange="handleChange(event)" required class="mt-1 block w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-lg shadow-sm"/>
      </label>

      <label class="block"><span class="text-gray-700 font-medium">Categoría</span>
        <div class="relative mt-1">
          <select name="category" onchange="handleChange(event)" required class="block w-full p-3 border border-gray-300 rounded-xl bg-white text-lg shadow-sm appearance-none pr-10 focus:ring-indigo-500 focus:border-indigo-500">${opts}</select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
            <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
          </div>
        </div>
      </label>

      <label class="block"><span class="text-gray-700 font-medium">Local/Proveedor</span>
        <input type="text" name="provider" value="${formData.provider}" onchange="handleChange(event)" required placeholder="Ej: Gasolinera Repsol" class="mt-1 block w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-lg shadow-sm"/>
      </label>

      <label class="block"><span class="text-gray-700 font-medium">Observaciones</span>
        <textarea name="notes" onchange="handleChange(event)" placeholder="Ej: Comida de trabajo con cliente X" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-lg shadow-sm">${formData.notes||""}</textarea>
      </label>

      <label class="block"><span class="text-gray-700 font-medium">Monto (€) (positivo)</span>
        <input type="number" name="amount" value="${formData.amount}" onchange="handleChange(event)" required step="0.01" min="0.01" placeholder="0.00" class="mt-1 block w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-lg shadow-sm"/>
      </label>

      <button onclick="handleSave()" ${isProcessing?'disabled':''} class="btn bg-green-600 text-white hover:bg-green-700">${isProcessing?'Guardando...':'Guardar Registro'}</button>
      <button onclick="setView('home')" class="w-full text-indigo-600 border border-indigo-600 p-3 rounded-3xl font-bold text-lg hover:bg-indigo-50 transition">Cancelar</button>
    </div>`;
  document.getElementById("app-content").innerHTML = content;
}

function renderExportScreen(){
  exportReportData = generateExportData(exportMonth);
  const content = `
    <div class="p-4 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">Exportar Informe</h2>
        <button onclick="openSettings()" class="text-sm px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50">⚙️ Ajustes</button>
      </div>
      <p class="text-sm text-gray-500">Seleccione el mes para el CSV compatible con la plantilla.</p>

      <label class="block"><span class="text-gray-700 font-medium">Mes y Año</span>
        <input type="month" id="month-select" value="${exportMonth}" onchange="handleMonthChange(event)" required class="mt-1 block w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-lg shadow-sm"/>
      </label>

      <div class="p-3 rounded-lg text-sm ${exportMessage.includes('Sin gastos') ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${exportMessage}</div>

      <button onclick="downloadCSV(exportReportData)" ${exportReportData.length===0?'disabled':''} class="btn bg-orange-600 text-white hover:bg-orange-700 flex items-center justify-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        <span>Descargar CSV</span>
      </button>

      <button onclick="setView('home')" class="w-full text-indigo-600 border border-indigo-600 p-3 rounded-3xl font-bold text-lg hover:bg-indigo-50 transition">Volver</button>

      <h3 class="text-lg font-semibold mt-6 text-gray-800">Vista previa</h3>
      <div class="bg-gray-50 p-3 rounded-xl max-h-48 overflow-y-auto text-xs font-mono text-gray-700 shadow-inner"><pre>${JSON.stringify(exportReportData,null,2)}</pre></div>
    </div>`;
  document.getElementById("app-content").innerHTML = content;
}

function renderHomeScreen(){
  const last5 = entries.slice(0,5).map(entry => {
    const catLabel = CATEGORIES.find(c=>c.value===entry.category)?.label || entry.category;
    const isIncome = entry.category === "ingreso";
    const amountFormatted = (entry.amount||0).toLocaleString('es-ES', { minimumFractionDigits:2 });
    const providerText = entry.provider || 'Sin proveedor';
    return `<div class="flex justify-between items-center border-b pb-2 last:border-b-0">
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium truncate text-gray-900">${providerText}</p>
        <p class="text-xs text-gray-500">${entry.date?.slice(5,10)} - ${catLabel}</p>
        ${entry.notes ? `<p class="text-xs italic text-gray-400 truncate mt-0.5">Nota: ${entry.notes}</p>` : ''}
      </div>
      <p class="text-base font-extrabold ml-4 ${isIncome?'text-green-600':'text-red-600'}">${isIncome?'+':'-'}€${amountFormatted}</p>
    </div>`;
  }).join('');

  const totalGastos = entries.filter(e=>e.category!=="ingreso").reduce((s,e)=> s+(e.amount||0), 0);
  const totalIngresos = entries.filter(e=>e.category==="ingreso").reduce((s,e)=> s+(e.amount||0), 0);
  const balance = totalIngresos - totalGastos;

  const content = `
    <div class="p-4 space-y-6 flex flex-col h-full justify-center">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-extrabold text-gray-800">Gestión de Registros</h1>
        <button onclick="openSettings()" class="text-sm px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50">⚙️ Ajustes</button>
      </div>
      <p class="text-xs text-center text-gray-500 -mt-2 mb-2">ID de Usuario: ${userId||'...'}</p>

      <div class="bg-gray-100 p-4 rounded-xl shadow-md space-y-2">
        <div class="flex justify-between"><span class="text-sm text-gray-600">Total Gastos:</span><span class="font-bold text-red-600">-€${totalGastos.toLocaleString('es-ES',{minimumFractionDigits:2})}</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Total Ingresos:</span><span class="font-bold text-green-600">+€${totalIngresos.toLocaleString('es-ES',{minimumFractionDigits:2})}</span></div>
        <div class="flex justify-between border-t pt-2 mt-2"><span class="text-lg font-extrabold">Balance:</span><span class="text-lg font-extrabold ${balance>=0?'text-green-700':'text-red-700'}">€${balance.toLocaleString('es-ES',{minimumFractionDigits:2})}</span></div>
      </div>

      <button onclick="handleStartEntry('scan')" ${isProcessing ? 'disabled':''} class="btn bg-indigo-600 text-white hover:bg-indigo-700 shadow-2xl shadow-indigo-400/50 flex items-center justify-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 5.5l-2.73 2.72c-.17.17-.38.3-.61.37"/><path d="M6 19.5L8.73 16.78c.17-.17.38-.3.61-.37"/><path d="M10 2H8a2 2 0 0 0-2 2v2"/><path d="M14 2h2a2 2 0 0 1 2 2v2"/><path d="M10 22h-2a2 2 0 0 1-2-2v-2"/><path d="M14 22h2a2 2 0 0 0 2-2v-2"/></svg>
        <span>${isProcessing?'Preparando...':'Escanear (cámara)'}</span>
      </button>

      <div class="text-center text-sm text-gray-400">O</div>

      <button onclick="handleStartEntry('manual')" ${isProcessing ? 'disabled':''} class="btn bg-teal-600 text-white hover:bg-teal-700 flex items-center justify-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
        <span>Ingreso Manual</span>
      </button>

      <div class="mt-6 pt-4 border-t border-gray-100">
        <h3 class="text-xl font-semibold mb-3 text-gray-800">Últimos 5 Registros</h3>
        <div class="bg-white p-4 rounded-2xl shadow-inner max-h-48 overflow-y-auto space-y-3 border border-gray-200">
          ${last5 || '<p class="text-center text-sm text-gray-400">¡Aún no hay registros!</p>'}
        </div>
        <button onclick="setView('export')" class="w-full mt-4 text-sm text-gray-600 bg-gray-100 p-3 rounded-xl font-semibold hover:bg-gray-200 transition">Exportar Informe CSV (${entries.length} totales)</button>
      </div>
    </div>`;
  document.getElementById("app-content").innerHTML = content;
}

function renderApp(){
  switch (view){
    case "entry": renderEntryScreen(); break;
    case "export": renderExportScreen(); break;
    default: renderHomeScreen(); break;
  }
}

// ====== Ajustes rápidos (guardar API key en localStorage) ======
window.openSettings = () => {
  const current = GOOGLE_API_KEY && GOOGLE_API_KEY!=="PEGAR_API_KEY_AQUI" ? " (oculta)" : " (vacía)";
  const val = prompt("Pega tu API Key de Google AI Studio.\nSe guardará en este dispositivo y podrás cambiarla cuando quieras.\nActual: "+current, "");
  if (val !== null) {
    GOOGLE_API_KEY = (val||"").trim();
    if (GOOGLE_API_KEY) localStorage.setItem("grm_api_key", GOOGLE_API_KEY);
    else localStorage.removeItem("grm_api_key");
    showModal(GOOGLE_API_KEY ? "API Key guardada." : "API Key eliminada.");
  }
};

// ====== Inicio ======
(async function start(){
  updateStatus("⏳ Iniciando...");
  // Si hay Firebase config definida, intenta usarla; si no, modo local
  HAS_FIREBASE = await initFirebaseIfAvailable();
  if (!HAS_FIREBASE) {
    loadLocal();
    isAuthReady = true;
    updateStatus(GOOGLE_API_KEY && GOOGLE_API_KEY!=="PEGAR_API_KEY_AQUI" ? "✅ Modo local (AI OK)" : "✅ Modo local");
  } else {
    isAuthReady = true;
    updateStatus("✅ Firebase");
  }
  renderApp();
})();

</script>
</body>
</html>
