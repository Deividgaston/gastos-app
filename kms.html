<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Gastos 2N ¬∑ KM</title>

  <link rel="stylesheet" href="assets/style.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <!-- Config Firebase -->
  <script src="config.js"></script>

  <style>
    .km-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:6px 8px;
      border-radius:8px;
      margin-bottom:4px;
      background:rgba(0,0,0,0.1);
    }
    .km-row-main {
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:12px;
    }
    .km-row-main strong {
      font-size:12px;
    }
    .km-row-meta {
      font-size:11px;
      opacity:0.8;
    }
    .km-row button {
      white-space:nowrap;
    }
  </style>
</head>
<body>

<header class="topbar">
  <h1>
    <img src="assets/2n-logo-black.png" alt="2N" style="height:20px;border-radius:4px;">
    Gastos 2N ¬∑ KM
  </h1>

  <a class="badge" href="index.html">üè† Inicio</a>
  <a class="badge active" href="kms.html">üöó KM</a>
  <a class="badge" href="export.html">üì§ Export</a>
  <a class="badge" href="summary.html">üìÑ Summary</a>

  <div class="header-actions">
    <span id="whoami" class="badge">No autenticado</span>
    <button id="btnLogin" class="btn">Iniciar sesi√≥n</button>
    <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
  </div>
</header>

<main class="content">
  <div class="grid">

    <!-- FORMULARIO KM -->
    <div class="card">
      <h2>Nuevo registro de KM</h2>

      <div class="row" style="flex-wrap:wrap;gap:10px">
        <div>
          <label>Fecha</label><br>
          <input id="kmDate" type="date">
        </div>
        <div>
          <label>KM recorridos</label><br>
          <input id="kmDistance" type="number" step="0.1" style="width:120px">
        </div>
        <div>
          <label>Tipo</label><br>
          <select id="kmType">
            <option value="empresa" selected>Empresa</option>
            <option value="personal">Personal</option>
          </select>
        </div>
      </div>

      <div class="row" style="flex-wrap:wrap;gap:10px;margin-top:10px">
        <div>
          <label>Precio combustible (‚Ç¨/L)</label><br>
          <input id="kmFuelPrice" type="number" step="0.01" style="width:140px">
        </div>
        <div>
          <label>KM totales coche (auto)</label><br>
          <input id="kmOdometer" type="number" step="1" style="width:140px" readonly>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Notas</label><br>
        <textarea id="kmNotes" rows="3" style="width:100%" placeholder="Trayecto, motivo, cliente, etc."></textarea>
      </div>

      <div class="row" style="margin-top:12px;gap:8px;flex-wrap:wrap">
        <button id="btnSaveKm" class="btn primary">Guardar KM</button>
        <button id="btnClearKm" class="btn">Limpiar formulario</button>
        <span id="kmStatus" class="small" style="min-height:1.5em"></span>
      </div>
    </div>

    <!-- LISTA KM -->
    <div class="card">
      <h2>Registros de KM</h2>
      <div id="kmList" class="list small" style="max-height:260px;overflow:auto;"></div>
      <div class="small" style="margin-top:6px">
        Se muestran los √∫ltimos 20 registros de KM. Puedes borrar cada l√≠nea con el bot√≥n üóë.
      </div>
    </div>

    <!-- RESUMEN -->
    <div class="card">
      <h2>Resumen r√°pido</h2>
      <div id="kmTotals" class="small"></div>
    </div>

  </div>
</main>

<!-- FIREBASE + AUTH -->
<script>
(function(){
  try{
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FBCONFIG__);
    }

    var auth = firebase.auth();

    if (firebase.auth.Auth.Persistence) {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
    }
    if (auth.getRedirectResult) {
      auth.getRedirectResult().catch(function(){});
    }

    function updateUser(u){
      var who = document.getElementById('whoami');
      var bL  = document.getElementById('btnLogin');
      var bO  = document.getElementById('btnLogout');

      if (u){
        if (who) who.textContent = 'Conectado: ' + (u.email || u.uid);
        if (bL)  bL.style.display = 'none';
        if (bO)  bO.style.display = '';
      } else {
        if (who) who.textContent = 'No autenticado';
        if (bL)  bL.style.display = '';
        if (bO)  bO.style.display = 'none';
      }

      try{
        document.dispatchEvent(new CustomEvent('auth-changed',{ detail:{ user:u } }));
      }catch(e){}
    }

    auth.onAuthStateChanged(updateUser);

    window.__APPCTX__ = {
      auth : auth,
      db   : firebase.firestore()
    };

    var prov   = new firebase.auth.GoogleAuthProvider();
    var btnIn  = document.getElementById('btnLogin');
    var btnOut = document.getElementById('btnLogout');

    if (btnIn){
      btnIn.addEventListener('click', function(){
        auth.signInWithPopup(prov).catch(function(err){
          if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user')){
            auth.signInWithRedirect(prov);
          } else {
            alert('Error login: ' + (err && err.message || ''));
          }
        });
      });
    }

    if (btnOut){
      btnOut.addEventListener('click', function(){
        auth.signOut();
      });
    }
  }catch(e){
    console.error(e);
  }
})();
</script>

<!-- L√ìGICA KM -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  // √öltimo od√≥metro conocido (para auto-sumar)
  window.__LAST_ODOMETER__ = null;

  // Fecha por defecto = hoy
  (function initForm(){
    var hoy = new Date().toISOString().slice(0,10);
    var f = $('kmDate');
    if (f && !f.value) f.value = hoy;
  })();

  function setKmStatus(msg){
    var el = $('kmStatus');
    if (!el) return;
    el.textContent = msg || '';
  }

  function leerLocalKmRaw(){
    return JSON.parse(localStorage.getItem('kms_local') || '[]');
  }

  function leerLocalKm(){
    var raw = leerLocalKmRaw();
    // a√±adimos √≠ndice original para poder borrar luego
    return raw.map(function(o, idx){
      o._date = new Date(o.date);
      o._localIndex = idx;
      o._src = 'local';
      return o;
    }).sort(function(a,b){
      return b._date - a._date;
    }).slice(0,20);
  }

  function guardarLocalKm(entry){
    var arr = leerLocalKmRaw();
    arr.push(entry);
    localStorage.setItem('kms_local', JSON.stringify(arr));
  }

  /* ====== RECALCULAR ODOMETRO AUTO ====== */
  function recalcOdometer(){
    var dist = Number($('kmDistance').value || 0);
    var last = window.__LAST_ODOMETER__;
    var odoInput = $('kmOdometer');
    if (!odoInput) return;

    if (!dist || isNaN(dist)){
      if (last != null){
        odoInput.value = last;
      } else {
        odoInput.value = '';
      }
      return;
    }

    if (last != null){
      odoInput.value = (last + dist).toFixed(0);
    } else {
      odoInput.value = dist.toFixed(0);
    }
  }

  function actualizarLastOdometer(list){
    var last = null;
    list.forEach(function(e){
      if (e.totalKm != null && e.totalKm !== ''){
        var n = Number(e.totalKm);
        if (!isNaN(n)) last = n;
      }
    });
    window.__LAST_ODOMETER__ = last;
    recalcOdometer();
  }

  /* ====== LEER KM (Firebase si hay login, si no local) ====== */
  async function loadKmEntries(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    if (user && db){
      var snap = await db.collection('users/'+user.uid+'/kms')
                         .orderBy('date','desc')
                         .limit(20)
                         .get();
      var result = [];
      snap.forEach(function(doc){
        var o = doc.data();
        o.id   = doc.id;
        o._src = 'remote';
        o._date = o.date && o.date.toDate ? o.date.toDate() : new Date(o.date);
        result.push(o);
      });
      return result;
    }

    // sin login ‚Üí local
    return leerLocalKm();
  }

  /* ====== PINTAR LISTA ====== */
  function renderKmList(list){
    var cont = $('kmList');
    if (!cont) return;
    cont.innerHTML = '';

    if (!list.length){
      cont.innerHTML = '<div class="small">Sin registros de KM todav√≠a.</div>';
      return;
    }

    list.forEach(function(e){
      var row = document.createElement('div');
      row.className = 'km-row';

      var d = e._date instanceof Date ? e._date : new Date(e._date || e.date);
      var fecha = d.toISOString().slice(0,10);

      var tipo = (e.type || '').toLowerCase().includes('per')
        ? 'Personal'
        : 'Empresa';

      var kmVal = Number(e.km || e.distance || 0) || 0;
      var fuel  = (e.fuelPrice != null && e.fuelPrice !== '')
        ? Number(e.fuelPrice)
        : null;

      var main = document.createElement('div');
      main.className = 'km-row-main';

      var l1 = document.createElement('strong');
      l1.textContent = fecha + ' ¬∑ ' + kmVal.toFixed(1) + ' km ¬∑ ' + tipo;

      var meta = document.createElement('div');
      meta.className = 'km-row-meta';
      var parts = [];
      if (fuel != null && !isNaN(fuel) && fuel > 0){
        parts.push('Comb: ' + fuel.toFixed(2) + ' ‚Ç¨/L');
      }
      if (e.totalKm != null && e.totalKm !== ''){
        parts.push('Od√≥metro: ' + e.totalKm);
      }
      if (e.notes){
        parts.push('Notas: ' + e.notes);
      }
      meta.textContent = parts.join(' ¬∑ ');

      main.appendChild(l1);
      if (parts.length) main.appendChild(meta);

      var btn = document.createElement('button');
      btn.className = 'btn danger';
      btn.textContent = 'üóë';
      btn.style.padding = '2px 8px';
      btn.addEventListener('click', function(ev){
        ev.stopPropagation();
        deleteKm(e);
      });

      row.appendChild(main);
      row.appendChild(btn);

      cont.appendChild(row);
    });
  }

  /* ====== RESUMEN ====== */
  function renderKmTotals(list){
    var cont = $('kmTotals');
    if (!cont) return;

    if (!list.length){
      cont.innerHTML = '<div class="small">Sin datos para resumir.</div>';
      return;
    }

    var total = 0;
    var emp   = 0;
    var per   = 0;

    list.forEach(function(e){
      var km = Number(e.km || e.distance || 0) || 0;
      total += km;
      if ((e.type || '').toLowerCase().includes('per')) per += km;
      else emp += km;
    });

    cont.innerHTML =
      '<b>KM totales (√∫ltimos 20 registros):</b> ' + total.toFixed(1) + ' km<br>' +
      '<b>KM empresa:</b> ' + emp.toFixed(1) + ' km<br>' +
      '<b>KM personales:</b> ' + per.toFixed(1) + ' km<br>' +
      '<span class="small" style="display:block;margin-top:4px;">' +
      'Los datos se muestran seg√∫n el usuario actual (Firebase o este dispositivo).' +
      '</span>';
  }

  async function refreshKm(){
    setKmStatus('Cargando registros‚Ä¶');
    try{
      var list = await loadKmEntries();
      renderKmList(list);
      renderKmTotals(list);
      actualizarLastOdometer(list);
      setKmStatus('');
    }catch(e){
      console.error(e);
      setKmStatus('Error cargando registros de KM.');
    }
  }

  /* ====== BORRAR KM ====== */
  async function deleteKm(entry){
    if (!confirm('¬øSeguro que quieres borrar este registro de KM?')){
      return;
    }

    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    setKmStatus('Borrando‚Ä¶');

    try{
      if (user && db && entry._src === 'remote' && entry.id){
        await db.collection('users/'+user.uid+'/kms').doc(entry.id).delete();
      } else {
        // LocalStorage
        var arr = leerLocalKmRaw();
        if (typeof entry._localIndex === 'number'){
          if (entry._localIndex >= 0 && entry._localIndex < arr.length){
            arr.splice(entry._localIndex, 1);
          }
        } else {
          // Fallback por coincidencia de campos
          var idx = arr.findIndex(function(x){
            return x.date === entry.date &&
                   Number(x.km || x.distance || 0) === Number(entry.km || entry.distance || 0) &&
                   (x.type || '') === (entry.type || '');
          });
          if (idx >= 0) arr.splice(idx, 1);
        }
        localStorage.setItem('kms_local', JSON.stringify(arr));
      }

      setKmStatus('KM eliminado ‚úÖ');
      document.dispatchEvent(new CustomEvent('kms-updated'));
      refreshKm();
    }catch(e){
      console.error(e);
      alert('Error al borrar KM: ' + (e && e.message || ''));
      setKmStatus('Error al borrar KM.');
    }
  }

  /* ====== GUARDAR KM ====== */
  async function saveKm(){
    var ctx  = window.__APPCTX__ || {};
    var auth = ctx.auth;
    var db   = ctx.db;
    var user = auth && auth.currentUser;

    var dateISO  = $('kmDate').value || new Date().toISOString().slice(0,10);
    var distance = Number($('kmDistance').value || 0);
    var type     = $('kmType').value;
    var fuel     = $('kmFuelPrice').value;
    var odoVal   = $('kmOdometer').value;
    var notes    = $('kmNotes').value;

    if (!distance || distance <= 0){
      alert('Introduce los KM recorridos.');
      return;
    }

    var totalKm = odoVal !== '' ? Number(odoVal) : null;
    if ((totalKm == null || isNaN(totalKm)) && window.__LAST_ODOMETER__ != null){
      totalKm = window.__LAST_ODOMETER__ + distance;
    }

    var entryBase = {
      date    : dateISO,
      km      : distance,
      type    : type,
      fuelPrice: fuel !== '' ? Number(fuel) : null,
      totalKm : totalKm,
      notes   : notes || ''
    };

    setKmStatus('Guardando‚Ä¶');

    try{
      if (user && db){
        await db.collection('users/'+user.uid+'/kms').add({
          date     : new Date(dateISO),
          km       : distance,
          type     : type,
          fuelPrice: fuel !== '' ? Number(fuel) : null,
          totalKm  : totalKm,
          notes    : notes || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        setKmStatus('KM guardado en Firebase ‚úÖ');
      } else {
        guardarLocalKm(entryBase);
        setKmStatus('KM guardado en este dispositivo (sin login) ‚úÖ');
      }

      if (totalKm != null && !isNaN(totalKm)){
        window.__LAST_ODOMETER__ = totalKm;
      }

      $('kmDistance').value = '';
      $('kmNotes').value    = '';
      recalcOdometer();

      document.dispatchEvent(new CustomEvent('kms-updated'));
      refreshKm();
    }catch(e){
      console.error(e);
      alert('Error guardando KM en Firebase: ' + (e && e.message || ''));
      setKmStatus('Error al guardar en Firebase. Revisa las reglas de Firestore.');
    }
  }

  function clearKmForm(){
    var hoy = new Date().toISOString().slice(0,10);
    if ($('kmDate'))      $('kmDate').value      = hoy;
    if ($('kmDistance'))  $('kmDistance').value  = '';
    if ($('kmFuelPrice')) $('kmFuelPrice').value = '';
    if ($('kmOdometer'))  $('kmOdometer').value  = '';
    if ($('kmNotes'))     $('kmNotes').value     = '';
    if ($('kmType'))      $('kmType').value      = 'empresa';
    setKmStatus('');
    recalcOdometer();
  }

  /* EVENTOS */
  if ($('btnSaveKm'))  $('btnSaveKm').addEventListener('click', saveKm);
  if ($('btnClearKm')) $('btnClearKm').addEventListener('click', clearKmForm);
  if ($('kmDistance')) $('kmDistance').addEventListener('input', recalcOdometer);

  document.addEventListener('auth-changed',  refreshKm, false);
  document.addEventListener('kms-updated',   refreshKm, false);

  // Primera carga
  refreshKm();
})();
</script>

</body>
</html>
